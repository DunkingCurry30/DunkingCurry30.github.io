---
title: 前台数据报表查询——大数据量下的解决方案初探
date: 2022/7/31 20:00:00
tags: 
  - java
  - mysql
  - oracle
  - jenkins
  - docker
categories: 
  - Java后端
  - 实战系列
---



# 一、需求概述

前台支持根据条件查询多项数据指标

## 需求背景

- 需要查询的各项数据指标来自不同数据库的多张数据源表
- 数据源表存在大表（`1000w`-`2亿`数据量不等）
- 部分表日增量超过`100w`，且需要每日同步
- 前台查询响应时间不能太长

## 需求分析

工欲善其事，必先利其器。依据上述需求背景，设计方案如下：

- *多数据源表同步至统一的数据仓库*：
  - 存量数据同步：因存量数据量大，将`datax` 环境打包成 `docker` 镜像，使用 `jenkins` 调度多台服务器执行多个容器实现多表并行同步，缩短数据同步时间
  - 每日的增量数据同步：使用 `crontab` 配合 `datax` 实现
- *中间表减少联表计算*：为避免指标查询过程中过多的连表操作，根据指标所需字段设计中间表（需考虑索引，这能极大程度提高查询效率），通过 `Java` **定时任务提前对数据源表进行处理**，做好部分计算和汇总至中间表中，操作时间在数据源表同步完成后
- *多线程加快查询*：`Java` 查询中间表，计算出各类指标数据，一般不存在依赖关系的指标可以**多线程**并发计算，最后汇总结果返回，将查询时间由**多个查询的时间和**优化为**最长查询所需时间**

现在我们有了初步方案，接下来就可以开始详细设计开发了。



# 二、实战开发



## 1. 多数据源表同步 

在需求分析中我们已经了解到，本次所需要数据来自于多个不同数据库的数据源表。当然`oracle`  的 `dblink` 、`mysql` 的 `federated` 都可以帮我们实现在一个数据库实例中访问，但这种方式存在以下明显的缺陷：

- 链接仅限同类数据库，即 `oracle` 只能连 `oracle` ，`mysql` 只能连 `mysql`，如果存在从 `oracle` 同步到 `mysql` 的情况就抓瞎了
- 链接依赖于网络，速度不稳定且比同库访问慢很多
- 应用自身无备份数据，无法自定义数据处理（例如指标数据通常需要看不同年份的环比数据，而数据源表的清理周期不一定与需求查询周期一致）
- 直接对数据源表进行查询，也增大了数据库服务器的压力

因此基于以上缺点，同步数据库至统一的数据仓库显然是更好的选择：

- `datax` 支持同步不同类型的数据库，即可以从 `oracle` 同步至 `mysql` 
- `datax` 数据同步效率高，数据量同步速率可达`1w/s` 
-  统一的数据仓库也更方便数据的管理，和自定义处理（例如可根据需要对同步的数据源表增加索引）
-  中间表的计算也基于同一数据库的表，效率更高

`datax` 同步多数据源表操作可参考该文章：[高效数据同步工具 DataX 的使用](/2022/07/29/高效数据同步工具DataX的使用) 



## 2. 中间表减少联表计算

在数据源表同步至数据仓库后，一些指标涉及到多张表的复杂查询，这仍会大大降低查询效率，例如以下场景：

现需统计A应用在6月版本测试案例在6月的`自动化案例执行通过率`，指标计算公式如下：
$$
自动化案例执行通过率 = 自动化执行通过的案例数 / 当前版本案例总数
$$

> 自动化脚本通过的案例是指：
>
> - **案例执行通过**：案例下关联的全部自动化**脚本执行通过**
> - **自动化脚本执行通过**：该脚本在6月内存在执行通过的记录，即多次调度有一次通过即算作通过

![1659012565648](../blog-assets/多数据源大表查询思路/1659012565648.png)

该场景涉及到以下数据源表：

- **案例表**：包含案例和应用的关联关系；
- **案例与自动化脚本挂接关联表**：包含案例和自动化脚本的关联关系；
- **自动化脚本的执行明细表**：包含脚本在指定时间内的执行记录。

通过以上信息，我们可以知道`自动化脚本通过率`这个指标的查询：

- 涉及到三张表的**关联嵌套查询**；
- 查询中包含着两个**计算**（案例是否通过，脚本是否执行通过）；
- 实际上脚本执行明细表数据量是非常大，实际单日增量在70w左右，存量数据上亿级别，即使有索引对该表的直接查询也很慢；

因此，如果能提前将一些数据计算出来放入一张中间表，就能极大减少查询时间，在这个场景里，可以新建一张中间表包含以下字段：

| script_id | month        | is_pass              |
| --------- | ------------ | -------------------- |
| 脚本ID    | 按月维度计算 | 脚本是否执行通过标志 |

该表记录了某个脚本在某个月份的执行通过信息，显然`is_allpass` 即为我们需要提前计算

的值，计算逻辑如下：

依据脚本执行明细中的执行时间，按时间对应月份 `month` 对执行记录进行分组 



1. datax 同步多数据源数据库
2. crontab设置定时任务，实现datax 每日定时同步
3. java中的定时任务 @Schedule
4. java中的多线程查询后，汇总返回（countdownlatch）： [java效率之异步查询汇总数据_weixin_43030390的博客-CSDN博客_java异步查询数据库](https://blog.csdn.net/weixin_43030390/article/details/86015523?ops_request_misc=%7B%22request%5Fid%22%3A%22165874492716782395392770%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=165874492716782395392770&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-86015523-null-null.142^v33^new_blog_pos_by_title,185^v2^control&utm_term=异步查询数据库%2C汇总&spm=1018.2226.3001.4187) 
5. 多线程执行时，变量赋值的问题
6. 线程池应保证单例，不能在方法里new
7. 涉及group by的慢查询： [【mysql】group by 特别慢，优化方法_乱七八糟的兔子的博客-CSDN博客](https://blog.csdn.net/qq_31949853/article/details/84984305) 
8. 数据库大表，索引和分区的建立