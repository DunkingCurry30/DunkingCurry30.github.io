---
title: 高并发解决方案——负载均衡
date: 2022/8/25 20:00:00
tags: 
  - HAProxy
  - Nginx
  - Apache
categories: 
  - 系统架构
---

# 一、什么是负载均衡 ？

当一台服务器的性能达到极限时，我们可以使用服务器集群来提高网站的整体性能。那么，在服务器集群中，需要有一台服务器充当调度者的角色，**用户的所有请求都会首先由它接收，调度者再根据每台服务器的负载情况将请求分配给某一台后端服务器去处理**。

那么在这个过程中，**调度者如何合理分配任务，保证所有后端服务器都将性能充分发挥，从而保持服务器集群的整体性能最优，这就是负载均衡问题**。

 下面详细介绍负载均衡的四种实现方式 ：

## 1. HTTP重定向实现负载均衡

### 1.1 过程描述

- 当用户向服务器发起请求时，请求首先被集群调度者截获；
- 调度者根据某种分配策略，选择一台服务器，并将选中的服务器的 `IP` 地址封装在 `HTTP`响应消息头部的 `Location`字段中，并将响应消息的状态码设为 `302`，最后将这个响应消息返回给浏览器；
- 当浏览器收到响应消息后，解析`Location`字段，并向该`URL`发起请求，然后指定的服务器处理该用户的请求，最后将结果返回给用户。 

在使用HTTP重定向来实现服务器集群负载均衡的过程中，需要一台服务器作为请求调度者。用户的一项操作需要发起两次HTTP请求，**一次向调度服务器发送请求**，获取后端服务器的`IP`，**第二次向后端服务器发送请求**，获取处理结果。 

### 1.2 调度策略

调度服务器收到用户的请求后，究竟选择哪台后端服务器处理请求，这由调度服务器所使用的调度策略决定：

- **随机分配策略** ： 当调度服务器收到用户请求后，可以随机决定使用哪台后端服务器，然后将该服务器的`IP`封装在`HTTP`响应消息的`Location`属性中，返回给浏览器即可；
- **轮询策略(RR)**  ： 调度服务器需要维护一个值，用于记录上次分配的后端服务器的`IP`。那么当新的请求到来时，调度者将请求依次分配给下一台服务器。 

由于轮询策略需要调度者维护一个值用于记录上次分配的服务器`IP`，因此需要额外的开销；此外，由于这个值属于互斥资源，那么**当多个请求同时到来时，为了避免线程的安全问题，因此需要锁定互斥资源，从而降低了性能**。而随机分配策略不需要维护额外的值，也就不存在线程安全问题，因此性能比轮询要高。 

### 1.3 优缺点分析

采用HTTP重定向来实现服务器集群的负载均衡**实现起来较为容易，逻辑比较简单**，但缺点也较为明显。 

在HTTP重定向方法中，调度服务器只在客户端第一次向网站发起请求的时候起作用。当调度服务器向浏览器返回响应信息后，**客户端此后的操作都基于新的URL进行**的(也就是后端服务器)，此后浏览器就不会与调度服务器产生关系，进而会产生如下几个问题：

- 由于不同用户的访问时间、访问页面深度有所不同，从而每个用户对各自的后端服务器所造成的压力也不同。而调度服务器在调度时，无法知道当前用户将会对服务器造成多大的压力，**因此这种方式无法实现真正意义上的负载均衡，只不过是把请求次数平均分配给每台服务器罢了** ；
- 若分配给该用户的后端服务器出现故障，并且如果页面被浏览器缓存，那么**当用户再次访问网站时，请求都会发给出现故障的服务器，从而导致访问失败**。



## 2.  `DNS` 负载均衡

### 2.1 什么是 `DNS`  ？

在了解 `DNS` 负载均衡之前，我们首先需要了解 `DNS` 域名解析的过程。 

我们知道，数据包采用`IP`地址在网络中传播，而为了方便用户记忆，我们使用域名来访问网站。那么，我们通过域名访问网站之前，首先需要将域名解析成`IP`地址，这个工作是由 `DNS` 完成的，也就是域名服务器。 

我们提交的请求不会直接发送给想要访问的网站，而是首先发给域名服务器，它会帮我们把域名解析成`IP`地址并返回给我们。我们收到`IP`之后才会向该`IP`发起请求。

那么， `DNS` 服务器有一个天然的优势，如果一个域名指向了多个`IP`地址，那么每次进行域名解析时， `DNS` 只要选一个`IP`返回给用户，就能够实现服务器集群的负载均衡。

### 2.2 具体做法

- 首先需要将我们的域名指向多个后端服务器(将一个域名解析到多个`IP`上)；

- 再设置一下调度策略。

那么我们的准备工作就完成了，接下来的负载均衡就完全由 `DNS` 服务器来实现。 当用户向我们的域名发起请求时， `DNS` 服务器会自动地根据我们事先设定好的调度策略选一个合适的`IP`返回给用户，用户再向该`IP`发起请求。   

### 2.3 调度策略

一般 `DNS` 提供商会提供一些调度策略供我们选择，如随机分配、轮询、根据请求者的地域分配离他最近的服务器。 

### 2.4 动态 `DNS` 

动态 `DNS` 能够让我们通过程序动态修改 `DNS` 服务器中的域名解析。从而当我们的监控程序发现某台服务器挂了之后，能立即通知 `DNS` 将其删掉。 

### 2.5 优缺点分析

我们先说优点：

-  `DNS` 负载均衡最大的优点就是**配置简单**。服务器集群的调度工作完全由 `DNS` 服务器承担，那么我们就可以把精力放在后端服务器上，**保证他们的稳定性与吞吐量**。而且完全不用担心 `DNS` 服务器的性能，即便是使用了轮询策略，它的吞吐率依然卓越；

-  `DNS` 负载均衡具有**较强的扩展性**，你完全可以为一个域名解析较多的`IP`，而且不用担心性能问题。

同时也存在以下缺点：

- 由于把集群调度权交给了 `DNS` 服务器，从而我们没办法随心所欲地控制调度者，没办法定制调度策略；
-  `DNS` 服务器也没办法了解每台服务器的负载情况，因此**没办法实现真正意义上的负载均衡。它和HTTP重定向一样，只不过把所有请求平均分配给后端服务器罢了**；
- 此外，当我们发现某一台后端服务器发生故障时，即使我们立即将该服务器从域名解析中去除，但由于 `DNS` 服务器会有缓存，该`IP`仍然会在 `DNS` 中保留一段时间，那么就会导致一部分用户无法正常访问网站。这是一个致命的问题！好在这个问题可以用**动态 `DNS` **来解决。  

综上所述， `DNS` 负载均衡是一种粗犷的负载均衡方法，这里只做介绍，**不推荐**使用。 



## 3. 反向代理负载均衡

### 3.1 什么是反向代理负载均衡？

反向代理服务器是一个位于实际服务器之前的服务器，**所有向我们网站发来的请求都首先要经过反向代理服务器**，服务器根据用户的请求要么直接将结果返回给用户，要么将请求交给后端服务器处理，再返回给用户。 

因为所有发送给我们网站的请求都首先经过反向代理服务器。因此，反向代理服务器就可以充当服务器集群的调度者，它**可以根据当前后端服务器的负载情况，将请求转发给一台合适的服务器，并将处理结果返回给用户**。  

### 3.2 优缺点分析

先说优点：

- **隐藏后端服务器**。 与HTTP重定向相比，反向代理能够隐藏后端服务器，***所有浏览器都不会与后端服务器直接交互***，从而能够确保调度者的控制权，提升集群的整体性能；
- **故障转移**。 与`DNS`负载均衡相比，反向代理能够更快速地移除故障结点。当监控程序发现某一后端服务器出现故障时，能够及时通知反向代理服务器，并立即将其删除；
- **合理分配任务**。 HTTP重定向和`DNS`负载均衡都无法实现真正意义上的负载均衡，也就是调度服务器无法根据后端服务器的实际负载情况分配任务。但反向代理服务器支持手动设定每台后端服务器的权重。我们可以***根据服务器的配置设置不同的权重，权重的不同会导致被调度者选中的概率的不同***。 

再说缺点：

- **调度者压力过大**。由于所有的请求都先由反向代理服务器处理，那么当请求量超过调度服务器的最大负载时，调度服务器的吞吐率降低会直接降低集群的整体性能；
- **制约扩展**。当后端服务器也无法满足巨大的吞吐量时，就需要增加后端服务器的数量，可没办法无限量地增加，因为会受到调度服务器的最大吞吐量的制约。 

### 3.3 粘滞会话

反向代理服务器会引起一个问题：若某台后端服务器处理了用户的请求，并保存了该用户的session或存储了缓存，那么当该用户再次发送请求时，**无法保证该请求仍然由保存了其Session或缓存的服务器处理**，若由其他服务器处理，先前的Session或缓存就找不到了。 

通常以下两种解决方法：

- 可以修改反向代理服务器的任务分配策略，以用户`IP`作为标识较为合适。相同的用户`IP`会交由同一台后端服务器处理，从而就避免了粘滞会话的问题；
- 可以在Cookie中标注请求的服务器ID，当再次提交请求时，调度者将该请求分配给Cookie中标注的服务器处理即可。 



## 4. 2层 or 3层做负载均衡

### 4.1 2层负载均衡

即**在数据链路层做负载均衡**。通过修改数据链路层的`mac`地址，`IP`使用的是虚拟`IP`，来实现负载均衡，解决响应数据体量过大效率低的问题。当客户端请求服务器时，负载均衡服务器替换`mac`地址为计算服务器，替换`IP`为负载均衡服务器`IP`，计算服务器直接响应数据到客户端。

**这种负载均衡方式吞吐量最高，大型互联网公司都是采用这种负载均衡方式**。LVS负载均衡是结合了`IP`层和数据链路层的负载均衡方式，linux通过配置可以实现这两种负载均衡方式。

### 4.2 3层负载均衡

网络层负载均衡。对网络层的`IP`地址进行替换，不需要在http层（应用层）工作，直接在操作系统内核的`IP`数据包中替换地址，效率比基于HTTP层的反向代理高。但是有个缺点是：请求和响应度需要经过负载均衡服务器进行`IP`层替换，响应数据会成为后期的瓶颈。 



# 二、负载均衡组件

## 1. Apache

它是Apache软件基金会的一个开放源代码的跨平台的网页服务器，属于老牌的web服务器了，支持基于Ip或者域名的虚拟主机，支持代理服务器，支持安全Socket层(SSL)等等，目前互联网主要使用它做静态资源服务器，也可以做代理服务器转发请求(如：图片链等)，结合tomcat等servlet容器处理jsp。 
## 2. Nginx

俄罗斯人开发的一个高性能的 HTTP和反向代理服务器。由于Nginx 超越 Apache 的高性能和稳定性，使得**国内使用 Nginx 作为 Web 服务器的网站也越来越多，其中包括新浪博客、新浪播客、网易新闻、腾讯网、搜狐博客等门户网站频道等**，在3w以上的高并发环境下，ngnix处理能力相当于apache的10倍。

## 3. lvs

​    Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。由毕业于国防科技大学的章文嵩博士于1998年5月创立，可以实现LINUX平台下的简单负载均衡。了解更多，访问官网：http://zh.linuxvirtualserver.org。

## 4. HAProxy

**HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案**。HAProxy特别适用于那些负载特大的web站点， 这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。

## 5. keepalived

这里说的keepalived不是apache或者tomcat等某个组件上的属性字段，它也是一个组件，可以实现web服务器的高可用(HA high availably)。它可以检测web服务器的工作状态，如果该服务器出现故障被检测到，将其剔除服务器群中，直至正常工作后，keepalive会自动检测到并加入到服务器群里面。实现主备服务器发生故障时ip瞬时无缝交接。它是LVS集群节点健康检测的一个用户空间守护进程，也是LVS的引导故障转移模块（director failover）。Keepalived守护进程可以检查LVS池的状态。如果LVS服务器池当中的某一个服务器宕机了。keepalived会通过一 个setsockopt呼叫通知内核将这个节点从LVS拓扑图中移除。

## 6. memcached

它是一个高性能分布式内存对象缓存系统。当初是Danga Interactive为了LiveJournal快速发展开发的系统，用于对业务查询数据缓存，减轻数据库的负载。其守护进程(daemon)是用C写的，但是客户端支持几乎所有语言，服务端和客户端通过简单的协议通信；在memcached里面缓存的数据必须序列化。

## 7. terracotta

一款由美国Terracotta公司开发的著名开源Java集群平台。它在JVM与Java应用之间实现了一个专门处理集群功能的抽象层，允许用户在不改变系统代码的情况下实现java应用的集群。支持数据的持久化、session的复制以及高可用(HA)。
